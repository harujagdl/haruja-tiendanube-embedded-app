<!DOCTYPE html>
<html lang="es">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <title>Panel Haruja – v0.0 | Panel</title>
    <style>
      :root {
        color-scheme: light;
        --bg: #f6f7fb;
        --card: #ffffff;
        --text: #1f2937;
        --muted: #6b7280;
        --primary: #1f6feb;
        --primary-dark: #1a55b5;
        --border: #e5e7eb;
        --shadow: 0 10px 24px rgba(15, 23, 42, 0.08);
        --radius: 16px;
      }

      * {
        box-sizing: border-box;
      }

      body {
        margin: 0;
        font-family: "Inter", "Segoe UI", system-ui, -apple-system, sans-serif;
        color: var(--text);
        background: var(--bg);
      }

      .app {
        min-height: 100vh;
        display: flex;
        flex-direction: column;
      }

      header {
        background: var(--card);
        border-bottom: 1px solid var(--border);
        padding: 24px 32px;
      }

      header h1 {
        margin: 0 0 8px;
        font-size: 24px;
      }

      header p {
        margin: 0;
        color: var(--muted);
        font-size: 14px;
      }

      main {
        padding: 32px;
        display: flex;
        flex-direction: column;
        gap: 24px;
      }

      .grid {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(220px, 1fr));
        gap: 20px;
      }

      .card {
        background: var(--card);
        border: 1px solid var(--border);
        border-radius: var(--radius);
        box-shadow: var(--shadow);
        padding: 20px;
        display: flex;
        flex-direction: column;
        gap: 12px;
        text-decoration: none;
        color: inherit;
      }

      .card h2 {
        margin: 0;
        font-size: 18px;
      }

      .card p {
        margin: 0;
        color: var(--muted);
        font-size: 14px;
      }

      .card .cta {
        margin-top: auto;
        font-weight: 600;
        color: var(--primary);
      }

      .section {
        background: var(--card);
        border: 1px solid var(--border);
        border-radius: var(--radius);
        box-shadow: var(--shadow);
        padding: 24px;
      }

      .section h2 {
        margin: 0 0 12px;
        font-size: 20px;
      }

      .section p {
        margin: 0 0 20px;
        color: var(--muted);
        font-size: 14px;
      }

      .form {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(180px, 1fr));
        gap: 16px;
        align-items: end;
      }

      label {
        display: block;
        font-size: 13px;
        color: var(--muted);
        margin-bottom: 6px;
      }

      input {
        width: 100%;
        padding: 10px 12px;
        border-radius: 10px;
        border: 1px solid var(--border);
        font-size: 14px;
      }

      select {
        width: 100%;
        padding: 10px 12px;
        border-radius: 10px;
        border: 1px solid var(--border);
        font-size: 14px;
        background: #fff;
      }

      button {
        padding: 12px 16px;
        border-radius: 12px;
        border: none;
        background: var(--primary);
        color: #fff;
        font-weight: 600;
        cursor: pointer;
      }

      button:hover {
        background: var(--primary-dark);
      }

      .status {
        font-size: 14px;
        color: var(--muted);
        min-height: 20px;
      }

      .status.success {
        color: #15803d;
      }

      .status.error {
        color: #b91c1c;
      }

      .status.warning {
        color: #b45309;
      }

      .result-card {
        margin-top: 16px;
        padding: 16px;
        border-radius: 12px;
        border: 1px solid var(--border);
        background: #f8fafc;
      }

      .result-code {
        font-size: 24px;
        font-weight: 700;
        letter-spacing: 0.5px;
        margin: 8px 0 16px;
      }

      .result-actions {
        display: flex;
        flex-wrap: wrap;
        gap: 12px;
      }

      .muted {
        color: var(--muted);
        font-size: 13px;
      }

      .zpl-output {
        margin-top: 16px;
      }

      textarea {
        width: 100%;
        min-height: 180px;
        padding: 12px;
        border-radius: 12px;
        border: 1px solid var(--border);
        font-size: 13px;
        font-family: "SFMono-Regular", "Consolas", "Liberation Mono", monospace;
      }

      .hidden {
        display: none;
      }

      table {
        width: 100%;
        border-collapse: collapse;
        font-size: 14px;
      }

      th,
      td {
        padding: 10px 12px;
        border-bottom: 1px solid var(--border);
        text-align: left;
      }

      th {
        color: var(--muted);
        font-weight: 600;
      }

      .panel-controls {
        display: flex;
        flex-direction: column;
        gap: 16px;
        margin-bottom: 16px;
      }

      .filters-grid {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(180px, 1fr));
        gap: 12px;
        align-items: end;
      }

      .filters-grid .inline-toggle {
        display: flex;
        align-items: center;
        gap: 10px;
        padding: 10px 12px;
        border-radius: 10px;
        border: 1px solid var(--border);
        background: #f8fafc;
      }

      .filters-grid .inline-toggle input {
        width: auto;
      }

      .counters {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(140px, 1fr));
        gap: 12px;
      }

      .counter-card {
        border-radius: 12px;
        padding: 12px;
        border: 1px solid var(--border);
        background: #f8fafc;
      }

      .counter-card span {
        display: block;
        font-size: 12px;
        color: var(--muted);
      }

      .counter-card strong {
        font-size: 18px;
      }

      .table-wrapper {
        width: 100%;
        overflow-x: auto;
      }

      .badge {
        display: inline-block;
        padding: 4px 8px;
        border-radius: 999px;
        font-size: 12px;
        font-weight: 600;
      }

      .badge-new {
        background: #e0ecff;
        color: #1d4ed8;
      }

      .badge-old {
        background: #e8f5e9;
        color: #166534;
      }

      .badge-sold {
        background: #fee2e2;
        color: #b91c1c;
      }

      .row-new {
        background: #f5f8ff;
      }

      .row-old {
        background: #f3fbf6;
      }

      .loader {
        display: flex;
        align-items: center;
        gap: 10px;
        color: var(--muted);
        font-size: 14px;
      }

      .spinner {
        width: 18px;
        height: 18px;
        border-radius: 50%;
        border: 2px solid #d1d5db;
        border-top-color: var(--primary);
        animation: spin 0.9s linear infinite;
      }

      @keyframes spin {
        to {
          transform: rotate(360deg);
        }
      }

      .alert {
        padding: 12px 16px;
        border-radius: 10px;
        border: 1px solid #fecaca;
        background: #fef2f2;
        color: #991b1b;
        font-size: 14px;
      }

      .pagination {
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin-top: 16px;
        gap: 12px;
        flex-wrap: wrap;
      }

      .pagination button {
        min-width: 120px;
      }

      .admin-only {
        display: none;
      }

      .admin-enabled .admin-only {
        display: table-cell;
      }

      .modal {
        position: fixed;
        inset: 0;
        background: rgba(15, 23, 42, 0.4);
        display: flex;
        align-items: center;
        justify-content: center;
        padding: 20px;
        z-index: 999;
      }

      .modal-card {
        background: var(--card);
        border-radius: 16px;
        padding: 20px;
        width: min(420px, 100%);
        box-shadow: var(--shadow);
      }

      .modal-card h3 {
        margin: 0 0 8px;
      }

      .modal-actions {
        display: flex;
        justify-content: flex-end;
        gap: 10px;
        margin-top: 16px;
      }

      @media (max-width: 600px) {
        header,
        main {
          padding: 20px;
        }
      }
    </style>
  </head>
  <body>
    <div class="app">
      <header>
        <h1>Panel Haruja</h1>
        <p>Gestión rápida de prendas, precios y etiquetas dentro de Tiendanube.</p>
      </header>

      <main>
        <section class="grid">
          <a class="card" href="#registro">
            <h2>Registro de nuevas prendas</h2>
            <p>Carga nuevas prendas y atributos esenciales en minutos.</p>
            <span class="cta">Empezar</span>
          </a>
          <a class="card" href="#precios">
            <h2>Asignar precios</h2>
            <p>Define precios finales por categoría y canal de venta.</p>
            <span class="cta">Configurar</span>
          </a>
          <a class="card" href="#calculadora">
            <h2>Calculadora de precios</h2>
            <p>Calcula márgenes y proyecciones de rentabilidad.</p>
            <span class="cta">Abrir</span>
          </a>
          <a class="card" href="#etiquetas">
            <h2>Impresión de etiquetas (ZPL)</h2>
            <p>Genera etiquetas listas para impresión y control interno.</p>
            <span class="cta">Preparar</span>
          </a>
          <a class="card" href="#base-datos-codigos">
            <h2>Base de datos códigos HarujaGdl</h2>
            <p>Consulta códigos existentes, nuevos y detalles clave de prendas.</p>
            <span class="cta">Abrir</span>
          </a>
        </section>

        <section class="section" id="registro">
          <h2>Registro de nuevas prendas</h2>
          <p>Selecciona los atributos clave para generar el código y guardar la prenda en Firestore.</p>
          <form class="form" id="registro-form">
            <div>
              <label for="registro-producto">Tipo / Producto *</label>
              <select id="registro-producto" name="producto" required>
                <option value="">Seleccionar</option>
              </select>
            </div>
            <div>
              <label for="registro-proveedor">Proveedor *</label>
              <select id="registro-proveedor" name="proveedor" required>
                <option value="">Seleccionar</option>
              </select>
            </div>
            <div>
              <label for="registro-color">Color *</label>
              <select id="registro-color" name="color" required>
                <option value="">Seleccionar</option>
              </select>
            </div>
            <div>
              <label for="registro-talla">Talla *</label>
              <select id="registro-talla" name="talla" required>
                <option value="">Seleccionar</option>
              </select>
            </div>
            <div>
              <label for="registro-costo">Costo (opcional)</label>
              <input id="registro-costo" name="costo" type="number" min="0" step="0.01" placeholder="0" />
            </div>
            <div>
              <label for="registro-created-by">Creado por (opcional)</label>
              <input id="registro-created-by" name="createdBy" type="text" placeholder="Nombre" />
            </div>
            <div>
              <label for="registro-detalles">Detalles (opcional)</label>
              <input id="registro-detalles" name="detalles" type="text" placeholder="Ej: Pelly estampada" />
            </div>
            <button type="submit">Generar código</button>
          </form>
          <p id="registro-status" class="status"></p>
          <div id="registro-result" class="result-card hidden">
            <span class="muted">Código generado</span>
            <div id="registro-codigo" class="result-code">HA00000/--</div>
            <div class="result-actions">
              <button type="button" id="registro-copy">Copiar</button>
              <button type="button" id="registro-reset">Crear otro</button>
            </div>
          </div>
        </section>

        <section class="section" id="etiquetas">
          <h2>Impresión de etiquetas</h2>
          <p>Ingresa el código y la cantidad de etiquetas a generar.</p>
          <form class="form" id="zpl-form">
            <div>
              <label for="zpl-codigo">Código (SKU)</label>
              <input id="zpl-codigo" name="codigo" type="text" placeholder="HA2A007/NG-M" />
            </div>
            <div>
              <label for="zpl-cantidad">Cantidad</label>
              <input id="zpl-cantidad" name="cantidad" type="number" min="1" value="1" />
            </div>
            <button type="submit">Imprimir etiqueta</button>
          </form>
          <p id="zpl-status" class="status"></p>
          <div class="zpl-output hidden" id="zpl-output">
            <label for="zpl-textarea">ZPL generado</label>
            <textarea id="zpl-textarea" readonly></textarea>
            <div class="result-actions" style="margin-top: 12px;">
              <button type="button" id="zpl-copy">Copiar ZPL</button>
            </div>
          </div>
        </section>

        <section class="section" id="base-datos-codigos">
          <h2>Base de datos códigos HarujaGdl</h2>
          <p>Explora la base de prendas 2025 con búsqueda, filtros y estado de novedades.</p>
          <div class="panel-controls">
            <div class="filters-grid">
              <div>
                <label for="prendas-search">Buscar por código o descripción</label>
                <input id="prendas-search" type="text" placeholder="Ej: HA12A003 o sudadera" />
              </div>
              <div>
                <label for="prendas-status">Status</label>
                <select id="prendas-status">
                  <option value="todos">Todos</option>
                  <option value="disponible">Disponible</option>
                  <option value="vendido">Vendido</option>
                </select>
              </div>
              <div>
                <label for="prendas-proveedor">Proveedor</label>
                <select id="prendas-proveedor">
                  <option value="todos">Todos</option>
                </select>
              </div>
              <div>
                <label for="prendas-tipo">Tipo</label>
                <select id="prendas-tipo">
                  <option value="todos">Todos</option>
                </select>
              </div>
              <div class="inline-toggle">
                <input id="adminSwitch" type="checkbox" />
                <label for="adminSwitch">Modo admin</label>
              </div>
            </div>
            <div class="counters">
              <div class="counter-card">
                <span>Total</span>
                <strong id="prendas-total">0</strong>
              </div>
              <div class="counter-card">
                <span>Nuevos (7 días)</span>
                <strong id="prendas-nuevos">0</strong>
              </div>
              <div class="counter-card">
                <span>Existentes</span>
                <strong id="prendas-existentes">0</strong>
              </div>
            </div>
          </div>
          <div id="prendas-alert" class="alert hidden"></div>
          <div id="prendas-loader" class="loader hidden">
            <span class="spinner"></span>
            <span>Cargando base de datos...</span>
          </div>
          <div class="table-wrapper">
            <table>
              <thead>
                <tr>
                  <th>Código</th>
                  <th>Descripción</th>
                  <th>Color</th>
                  <th>Talla</th>
                  <th>Proveedor</th>
                  <th>Status</th>
                  <th>Disponibilidad</th>
                  <th>Fecha</th>
                  <th class="admin-only">(Admin) Costo</th>
                  <th class="admin-only">(Admin) Margen</th>
                </tr>
              </thead>
              <tbody id="prendas-tbody"></tbody>
            </table>
          </div>
          <div class="pagination">
            <button type="button" id="prendas-prev">Anterior</button>
            <span id="prendas-page">Página 1</span>
            <button type="button" id="prendas-next">Siguiente</button>
          </div>
          <div id="adminModal" class="modal hidden">
            <div class="modal-card">
              <h3>Activar modo admin</h3>
              <p class="muted">Ingresa la contraseña para ver costos y márgenes.</p>
              <label for="adminPassword">Contraseña</label>
              <input id="adminPassword" type="password" placeholder="********" />
              <p id="adminError" class="status error hidden"></p>
              <div class="modal-actions">
                <button type="button" id="adminCancelBtn">Cancelar</button>
                <button type="button" id="adminConfirmBtn">Confirmar</button>
              </div>
            </div>
          </div>
        </section>
      </main>
    </div>
    <script type="module">
      import { initializeApp } from "https://www.gstatic.com/firebasejs/9.22.2/firebase-app.js";
      import {
        getFirestore,
        collection,
        addDoc,
        doc,
        getDocs,
        query,
        orderBy,
        runTransaction,
        serverTimestamp,
        where,
        limit
      } from "https://www.gstatic.com/firebasejs/9.22.2/firebase-firestore.js";

      // TODO: Reemplazar estos valores con la configuración real del proyecto Firebase.
      const firebaseConfig = {
        apiKey: "REEMPLAZAR_API_KEY",
        authDomain: "haruja-tiendanube.firebaseapp.com",
        projectId: "haruja-tiendanube",
        storageBucket: "haruja-tiendanube.appspot.com",
        messagingSenderId: "REEMPLAZAR_SENDER_ID",
        appId: "REEMPLAZAR_APP_ID"
      };

      const app = initializeApp(firebaseConfig);
      const db = getFirestore(app);
      const prendasRef = collection(db, "prendas");
      const registroForm = document.getElementById("registro-form");
      const registroStatus = document.getElementById("registro-status");
      const registroResult = document.getElementById("registro-result");
      const registroCodigo = document.getElementById("registro-codigo");
      const registroCopy = document.getElementById("registro-copy");
      const registroReset = document.getElementById("registro-reset");
      const registroSubmit = registroForm.querySelector("button[type='submit']");
      const registroProducto = document.getElementById("registro-producto");
      const registroProveedor = document.getElementById("registro-proveedor");
      const registroColor = document.getElementById("registro-color");
      const registroTalla = document.getElementById("registro-talla");
      const registroDetalles = document.getElementById("registro-detalles");

      const zplForm = document.getElementById("zpl-form");
      const zplStatus = document.getElementById("zpl-status");
      const zplOutput = document.getElementById("zpl-output");
      const zplTextarea = document.getElementById("zpl-textarea");
      const zplCopy = document.getElementById("zpl-copy");

      const prendasSearch = document.getElementById("prendas-search");
      const prendasStatus = document.getElementById("prendas-status");
      const prendasProveedor = document.getElementById("prendas-proveedor");
      const prendasTipo = document.getElementById("prendas-tipo");
      const prendasTotal = document.getElementById("prendas-total");
      const prendasNuevos = document.getElementById("prendas-nuevos");
      const prendasExistentes = document.getElementById("prendas-existentes");
      const prendasTbody = document.getElementById("prendas-tbody");
      const prendasPrev = document.getElementById("prendas-prev");
      const prendasNext = document.getElementById("prendas-next");
      const prendasPage = document.getElementById("prendas-page");
      const prendasLoader = document.getElementById("prendas-loader");
      const prendasAlert = document.getElementById("prendas-alert");
      const prendasPanel = document.getElementById("base-datos-codigos");
      const adminSwitch = prendasPanel.querySelector("#adminSwitch");
      const adminModal = prendasPanel.querySelector("#adminModal");
      const adminPassword = prendasPanel.querySelector("#adminPassword");
      const adminError = prendasPanel.querySelector("#adminError");
      const adminCancel = prendasPanel.querySelector("#adminCancelBtn");
      const adminConfirm = prendasPanel.querySelector("#adminConfirmBtn");

      const setRegistroStatus = (message, type = "") => {
        registroStatus.textContent = message;
        registroStatus.className = `status ${type}`.trim();
      };

      const setZplStatus = (message, type = "") => {
        zplStatus.textContent = message;
        zplStatus.className = `status ${type}`.trim();
      };

      const safeString = (value) => {
        if (value === null || value === undefined) return "";
        return String(value);
      };

      const normalizeText = (value) =>
        safeString(value)
          .toLowerCase()
          .normalize("NFD")
          .replace(/[\u0300-\u036f]/g, "");

      const formatDateDDMMYYYY = (date) => {
        if (!(date instanceof Date) || Number.isNaN(date.getTime())) {
          return "--";
        }
        const day = String(date.getDate()).padStart(2, "0");
        const month = String(date.getMonth() + 1).padStart(2, "0");
        const year = date.getFullYear();
        return `${day}/${month}/${year}`;
      };

      const toDateValue = (value) => {
        if (!value) return null;
        if (value instanceof Date) return value;
        if (typeof value?.toDate === "function") return value.toDate();
        if (typeof value === "number") return new Date(value);
        if (typeof value === "string") {
          const parsed = new Date(value);
          return Number.isNaN(parsed.getTime()) ? null : parsed;
        }
        return null;
      };

      const isNew = (createdAt, days = 7) => {
        const createdDate = toDateValue(createdAt);
        if (!createdDate) return false;
        const diff = Date.now() - createdDate.getTime();
        return diff <= days * 24 * 60 * 60 * 1000;
      };

      const buildOption = ({ clave, valor }) => {
        const option = document.createElement("option");
        option.value = clave;
        option.textContent = `${clave} - ${valor}`;
        option.dataset.nombre = valor;
        return option;
      };

      const setSelectLoading = (selectEl, message) => {
        selectEl.innerHTML = "";
        const option = document.createElement("option");
        option.value = "";
        option.textContent = message;
        selectEl.appendChild(option);
        selectEl.disabled = true;
      };

      const fillSelect = (selectEl, entries) => {
        selectEl.innerHTML = "";
        const placeholder = document.createElement("option");
        placeholder.value = "";
        placeholder.textContent = "Seleccionar";
        selectEl.appendChild(placeholder);
        entries.forEach((item) => selectEl.appendChild(buildOption(item)));
        selectEl.disabled = false;
      };

      const collectOption = (map, codigo, nombre) => {
        if (!codigo) return;
        if (!map.has(codigo)) {
          map.set(codigo, nombre || codigo);
        }
      };

      const COLLECTIONS = {
        tipos: "diccionario_tipos",
        proveedores: "diccionario_proveedores",
        colores: "diccionario_colores",
        tallas: "diccionario_tallas"
      };

      const CODE_PATTERN = /^HA(\d+)([A-Z])(\d{3})\/([A-Z0-9]+)-([A-Z0-9]+)$/;
      const PRENDAS_2025_COLLECTION = "HarujaPrendas_2025";
      const PRENDAS_PAGE_SIZE = 50;
      const ADMIN_PASSWORD = "HARUJA_ADMIN";
      const ADMIN_SESSION_KEY = "haruja_admin_ok";

      const prendas2025Ref = collection(db, PRENDAS_2025_COLLECTION);
      const prendasState = {
        data: [],
        filtered: [],
        page: 1,
        isAdmin: false
      };

      const loadCategoryEntries = async (category, collectionName) => {
        const snapshot = await getDocs(collection(db, collectionName));
        if (snapshot.empty) {
          return { category, entries: [], empty: true };
        }

        const entries = snapshot.docs
          .map((docSnap) => {
            const data = docSnap.data() || {};
            const clave = data.clave || docSnap.id;
            const valor = data.valor || data.nombre || clave;
            return { clave, valor };
          })
          .filter((entry) => entry.clave && entry.valor);

        return { category, entries, empty: entries.length === 0 };
      };

      const loadDictionary = async () => {
        const categories = Object.keys(COLLECTIONS);
        const results = await Promise.all(
          categories.map((category) =>
            loadCategoryEntries(category, COLLECTIONS[category])
          )
        );
        const missing = results.filter((result) => result.empty).map((result) => result.category);

        return {
          empty: missing.length === categories.length,
          missing,
          tipos: results.find((result) => result.category === "tipos")?.entries ?? [],
          proveedores: results.find((result) => result.category === "proveedores")?.entries ?? [],
          colores: results.find((result) => result.category === "colores")?.entries ?? [],
          tallas: results.find((result) => result.category === "tallas")?.entries ?? []
        };
      };

      const setPrendasLoading = (isLoading) => {
        prendasLoader.classList.toggle("hidden", !isLoading);
      };

      const setPrendasAlert = (message = "") => {
        if (message) {
          prendasAlert.textContent = message;
          prendasAlert.classList.remove("hidden");
        } else {
          prendasAlert.textContent = "";
          prendasAlert.classList.add("hidden");
        }
      };

      const getPrendaDate = (data) =>
        toDateValue(data?.createdAt) ||
        toDateValue(data?.fecha) ||
        toDateValue(data?.updatedAt);

      const buildFilterOptions = (selectEl, values) => {
        const current = selectEl.value;
        selectEl.innerHTML = "";
        const allOption = document.createElement("option");
        allOption.value = "todos";
        allOption.textContent = "Todos";
        selectEl.appendChild(allOption);
        values.forEach((value) => {
          const option = document.createElement("option");
          option.value = value;
          option.textContent = value;
          selectEl.appendChild(option);
        });
        if (current) {
          selectEl.value = current;
        }
      };

      const updateFiltersFromData = (data) => {
        const proveedores = new Set();
        const tipos = new Set();
        data.forEach((item) => {
          const proveedor = safeString(item.proveedor || item.proveedorNombre);
          const tipo = safeString(item.tipo || item.tipoNombre);
          if (proveedor) proveedores.add(proveedor);
          if (tipo) tipos.add(tipo);
        });
        buildFilterOptions(prendasProveedor, Array.from(proveedores).sort());
        buildFilterOptions(prendasTipo, Array.from(tipos).sort());
      };

      const renderPrendasPanel = (data) => {
        const total = data.length;
        const nuevos = data.filter((item) => isNew(getPrendaDate(item))).length;
        prendasTotal.textContent = total;
        prendasNuevos.textContent = nuevos;
        prendasExistentes.textContent = total - nuevos;

        const totalPages = Math.max(1, Math.ceil(total / PRENDAS_PAGE_SIZE));
        prendasState.page = Math.min(prendasState.page, totalPages);
        const start = (prendasState.page - 1) * PRENDAS_PAGE_SIZE;
        const pageData = data.slice(start, start + PRENDAS_PAGE_SIZE);

        prendasPage.textContent = `Página ${prendasState.page} de ${totalPages}`;
        prendasPrev.disabled = prendasState.page <= 1;
        prendasNext.disabled = prendasState.page >= totalPages;

        prendasTbody.innerHTML = "";
        if (!pageData.length) {
          const emptyRow = document.createElement("tr");
          const cell = document.createElement("td");
          cell.colSpan = 10;
          cell.textContent = "No hay resultados con los filtros actuales.";
          emptyRow.appendChild(cell);
          prendasTbody.appendChild(emptyRow);
          return;
        }

        pageData.forEach((item) => {
          const codigo = safeString(item.code || item.codigo) || "--";
          const descripcion = safeString(item.descripcion) || "--";
          const color = safeString(item.color) || "--";
          const talla = safeString(item.talla) || "--";
          const proveedor = safeString(item.proveedor || item.proveedorNombre) || "--";
          const status = safeString(item.status) || "--";
          const disponibilidad = safeString(item.disponibilidad) || "--";
          const fechaTexto = safeString(item.fechaTexto);
          const dateValue = getPrendaDate(item);
          const fecha = fechaTexto || formatDateDDMMYYYY(dateValue);
          const costo = safeString(item.costo) || "--";
          const margen = safeString(item.margen) || "--";
          const isNewItem = isNew(dateValue);
          const statusBadge =
            normalizeText(status) === "vendido"
              ? `<span class="badge badge-sold">Vendido</span>`
              : "";
          const newBadge = isNewItem
            ? `<span class="badge badge-new">Nuevo</span>`
            : `<span class="badge badge-old">Existente</span>`;

          const row = document.createElement("tr");
          row.className = isNewItem ? "row-new" : "row-old";
          row.innerHTML = `
            <td>${codigo}</td>
            <td>${descripcion}</td>
            <td>${color}</td>
            <td>${talla}</td>
            <td>${proveedor}</td>
            <td>
              <div>${status}</div>
              <div>${newBadge} ${statusBadge}</div>
            </td>
            <td>${disponibilidad}</td>
            <td>${fecha}</td>
            <td class="admin-only">${costo}</td>
            <td class="admin-only">${margen}</td>
          `;
          prendasTbody.appendChild(row);
        });
      };

      const applyFiltersAndRender = () => {
        const searchTerm = normalizeText(prendasSearch.value);
        const statusFilter = normalizeText(prendasStatus.value);
        const proveedorFilter = normalizeText(prendasProveedor.value);
        const tipoFilter = normalizeText(prendasTipo.value);

        const filtered = prendasState.data.filter((item) => {
          const codigo = safeString(item.code || item.codigo);
          const descripcion = safeString(item.descripcion);
          const textMatch = normalizeText(`${codigo} ${descripcion}`);
          if (searchTerm && !textMatch.includes(searchTerm)) {
            return false;
          }

          const statusValue = normalizeText(item.status || item.disponibilidad);
          if (statusFilter !== "todos" && statusValue !== statusFilter) {
            return false;
          }

          const proveedorValue = normalizeText(item.proveedor || item.proveedorNombre);
          if (proveedorFilter !== "todos" && proveedorValue !== proveedorFilter) {
            return false;
          }

          const tipoValue = normalizeText(item.tipo || item.tipoNombre);
          if (tipoFilter !== "todos" && tipoValue !== tipoFilter) {
            return false;
          }

          return true;
        });

        prendasState.filtered = filtered;
        renderPrendasPanel(filtered);
      };

      const loadPrendas2025 = async () => {
        setPrendasAlert("");
        setPrendasLoading(true);
        try {
          let snapshot;
          try {
            snapshot = await getDocs(
              query(prendas2025Ref, orderBy("createdAt", "desc"), limit(500))
            );
          } catch (error) {
            console.warn("Fallback por createdAt falló, intentando fecha.", error);
            try {
              snapshot = await getDocs(
                query(prendas2025Ref, orderBy("fecha", "desc"), limit(500))
              );
            } catch (fallbackError) {
              console.warn("Fallback por fecha falló, intentando updatedAt.", fallbackError);
              snapshot = await getDocs(
                query(prendas2025Ref, orderBy("updatedAt", "desc"), limit(500))
              );
            }
          }

          const data = snapshot.docs.map((docSnap) => ({
            id: docSnap.id,
            ...docSnap.data()
          }));

          data.sort((a, b) => {
            const dateA = getPrendaDate(a)?.getTime() || 0;
            const dateB = getPrendaDate(b)?.getTime() || 0;
            return dateB - dateA;
          });

          prendasState.data = data;
          prendasState.page = 1;
          updateFiltersFromData(data);
          applyFiltersAndRender();
        } catch (error) {
          console.error(error);
          setPrendasAlert("No se pudo cargar la base de datos de códigos.");
        } finally {
          setPrendasLoading(false);
        }
      };

      const ensureRequired = () => {
        if (!registroProveedor.value || !registroProducto.value || !registroColor.value || !registroTalla.value) {
          setRegistroStatus("Completa Proveedor, Producto, Color y Talla.", "error");
          return false;
        }
        return true;
      };

      const getSelectedName = (selectEl) => {
        const option = selectEl.options[selectEl.selectedIndex];
        return option?.dataset?.nombre || option?.textContent?.split(" - ")[1] || option?.textContent || "";
      };

      const HISTORICOS_URL = "../Data/codigos_historicos.json";
      let historicosCache = null;

      const loadHistoricosMap = async () => {
        if (historicosCache) {
          return historicosCache;
        }
        historicosCache = fetch(HISTORICOS_URL)
          .then((response) => {
            if (!response.ok) {
              throw new Error("No se pudo cargar el histórico de códigos.");
            }
            return response.json();
          })
          .then((codes) => {
            const maxPorKey = {};
            const pattern = /^HA(\d+)([A-Z])(\d{3})\//i;
            codes.forEach((code) => {
              const match = pattern.exec(String(code).trim().toUpperCase());
              if (!match) return;
              const key = `prov${match[1]}_tipo${match[2]}`;
              const seq = Number(match[3]);
              if (!Number.isFinite(seq)) return;
              if (!maxPorKey[key] || seq > maxPorKey[key]) {
                maxPorKey[key] = seq;
              }
            });
            return maxPorKey;
          })
          .catch((error) => {
            console.warn("No se pudo cargar el histórico de códigos.", error);
            return {};
          });
        return historicosCache;
      };

      const getNextCounter = async (providerCode, typeCode) => {
        const key = `prov${providerCode}_tipo${typeCode}`;
        const counterRef = doc(db, "counters", key);

        return runTransaction(db, async (transaction) => {
          const snapshot = await transaction.get(counterRef);
          const data = snapshot.data() || {};
          let counterValue = Number(data.value);

          if (!Number.isFinite(counterValue)) {
          counterValue = Number(data.lastNumber);
          }

          if (!Number.isFinite(counterValue)) {
          const maxPorKey = await loadHistoricosMap();
          counterValue = Number(maxPorKey[key] ?? 0);
          }
          if (!Number.isFinite(counterValue)) {
            throw new Error(`Contador inválido para ${key}. Revisa counters/${key}.`);
          }
          console.log("COUNTER READ", { key, data, counterValue });
          const nextValue = counterValue + 1;
          transaction.set(counterRef, { value: nextValue, lastNumber: nextValue }, { merge: true });
          return { nextValue, key };
        });
      };

      registroForm.addEventListener("submit", async (event) => {
        event.preventDefault();
        setRegistroStatus("");

        if (!ensureRequired()) {
          return;
        }

        const providerCode = registroProveedor.value;
        const typeCode = registroProducto.value;
        const colorClave = registroColor.value;
        const tallaClave = registroTalla.value;
        try {
          registroSubmit.disabled = true;
          const { nextValue, key } = await getNextCounter(providerCode, typeCode);
          const consecutivo = String(nextValue).padStart(3, "0");
          const codigo = `HA${providerCode}${typeCode}${consecutivo}/${colorClave}-${tallaClave}`;
          console.info(`Generando código ${codigo} para counter ${key}.`);

          const costoValue = Number(document.getElementById("registro-costo").value);
          const createdByValue = document.getElementById("registro-created-by").value.trim();
          const detallesValue = registroDetalles.value.trim();
          const tipoNombre = getSelectedName(registroProducto).trim();
          const proveedorNombre = getSelectedName(registroProveedor).trim();
          const colorNombre = getSelectedName(registroColor).trim();
          const tallaNombre = getSelectedName(registroTalla).trim();
          const descripcion = [tipoNombre, proveedorNombre, colorNombre, tallaNombre]
            .filter(Boolean)
            .join(" ");

          const data = {
            codigo,
            proveedor: providerCode,
            tipo: typeCode,
            color: colorClave,
            talla: tallaClave,
            descripcion: descripcion || null,
            detalles: detallesValue || null,
            costo: Number.isFinite(costoValue) ? costoValue : 0,
            code: codigo,
            providerCode,
            typeCode,
            seqNumber: nextValue,
            colorCode: colorClave,
            sizeCode: tallaClave,
            creadoPor: createdByValue || null,
            createdAt: serverTimestamp()
          };

          const codeQuery = query(prendasRef, where("code", "==", codigo));
          const legacyQuery = query(prendasRef, where("codigo", "==", codigo));
          const [codeSnapshot, legacySnapshot] = await Promise.all([
            getDocs(codeQuery),
            getDocs(legacyQuery)
          ]);
          const duplicateFound = !codeSnapshot.empty || !legacySnapshot.empty;

          await addDoc(prendasRef, data);

          registroCodigo.textContent = codigo;
          registroResult.classList.remove("hidden");
          if (duplicateFound) {
            setRegistroStatus("Código ya existe (duplicado).", "warning");
          } else {
            setRegistroStatus("Prenda guardada correctamente.", "success");
          }
        } catch (error) {
          const message =
            error?.message?.includes("contador") || error?.message?.includes("Contador")
              ? error.message
              : "No se pudo generar el código. Intenta nuevamente.";
          setRegistroStatus(message, "error");
          console.error(error);
        } finally {
          registroSubmit.disabled = false;
        }
      });

      registroCopy.addEventListener("click", async () => {
        try {
          await navigator.clipboard.writeText(registroCodigo.textContent.trim());
          setRegistroStatus("Código copiado al portapapeles.", "success");
        } catch (error) {
          setRegistroStatus("No se pudo copiar el código.", "error");
          console.error(error);
        }
      });

      registroReset.addEventListener("click", () => {
        registroForm.reset();
        registroResult.classList.add("hidden");
        setRegistroStatus("");
      });

      zplForm.addEventListener("submit", (event) => {
        event.preventDefault();
        setZplStatus("");

        const codigo = document.getElementById("zpl-codigo").value.trim();
        const cantidadValue = Number(document.getElementById("zpl-cantidad").value);
        const cantidad = Number.isFinite(cantidadValue) && cantidadValue > 0 ? cantidadValue : 1;

        const formatoValido = CODE_PATTERN.test(codigo.toUpperCase());
        if (!codigo || !formatoValido) {
          setZplStatus("Ingresa un código válido (HA{#}{A}{NNN}/COLOR-TALLA).", "error");
          zplOutput.classList.add("hidden");
          return;
        }

        const template = `^XA
^CF0,40
^FO30,30^FD${codigo}^FS
^CF0,30
^FO30,90^FDPRECIO$^FS
^FO30,140^BQN,2,6^FDLA,${codigo}^FS
^XZ`;

        const zpl = Array.from({ length: cantidad }, () => template).join("\n");
        zplTextarea.value = zpl;
        zplOutput.classList.remove("hidden");
        setZplStatus("ZPL generado correctamente.", "success");
      });

      zplCopy.addEventListener("click", async () => {
        try {
          await navigator.clipboard.writeText(zplTextarea.value);
          setZplStatus("ZPL copiado al portapapeles.", "success");
        } catch (error) {
          setZplStatus("No se pudo copiar el ZPL.", "error");
          console.error(error);
        }
      });

      const isAdminEnabled = () => sessionStorage.getItem(ADMIN_SESSION_KEY) === "1";

      const applyAdminVisibility = (enabled) => {
        prendasState.isAdmin = enabled;
        prendasPanel.classList.toggle("admin-enabled", enabled);
        if (adminSwitch) {
          adminSwitch.checked = enabled;
        }
        if (enabled) {
          sessionStorage.setItem(ADMIN_SESSION_KEY, "1");
        } else {
          sessionStorage.removeItem(ADMIN_SESSION_KEY);
        }
      };

      const openAdminModal = () => {
        adminPassword.value = "";
        adminError.textContent = "";
        adminError.classList.add("hidden");
        adminModal.classList.remove("hidden");
        adminPassword.focus();
      };

      const closeAdminModal = () => {
        adminModal.classList.add("hidden");
      };

      const confirmAdminPassword = () => {
        const value = adminPassword.value.trim();
        if (value === ADMIN_PASSWORD) {
          applyAdminVisibility(true);
          closeAdminModal();
          applyFiltersAndRender();
        } else {
          adminError.textContent = "Contraseña incorrecta. Intenta nuevamente.";
          adminError.classList.remove("hidden");
        }
      };

      const resetAdminSwitch = () => {
        if (adminSwitch) {
          adminSwitch.checked = false;
        }
        applyAdminVisibility(false);
      };

      prendasPanel.addEventListener("change", (event) => {
        if (event.target?.id !== "adminSwitch") return;
        if (event.target.checked) {
          if (isAdminEnabled()) {
            applyAdminVisibility(true);
          } else {
            event.target.checked = false;
            openAdminModal();
          }
        } else {
          applyAdminVisibility(false);
        }
      });

      prendasPanel.addEventListener("click", (event) => {
        if (event.target?.id === "adminConfirmBtn") {
          event.preventDefault();
          confirmAdminPassword();
          return;
        }
        if (event.target?.id === "adminCancelBtn") {
          event.preventDefault();
          closeAdminModal();
          resetAdminSwitch();
          return;
        }
        if (event.target === adminModal) {
          closeAdminModal();
          resetAdminSwitch();
        }
      });

      prendasPanel.addEventListener("keydown", (event) => {
        if (event.target?.id === "adminPassword" && event.key === "Enter") {
          event.preventDefault();
          confirmAdminPassword();
        }
      });

      [prendasSearch, prendasStatus, prendasProveedor, prendasTipo].forEach((element) => {
        element.addEventListener("input", () => {
          prendasState.page = 1;
          applyFiltersAndRender();
        });
        element.addEventListener("change", () => {
          prendasState.page = 1;
          applyFiltersAndRender();
        });
      });

      prendasPrev.addEventListener("click", () => {
        prendasState.page = Math.max(1, prendasState.page - 1);
        renderPrendasPanel(prendasState.filtered);
      });

      prendasNext.addEventListener("click", () => {
        const totalPages = Math.max(1, Math.ceil(prendasState.filtered.length / PRENDAS_PAGE_SIZE));
        prendasState.page = Math.min(totalPages, prendasState.page + 1);
        renderPrendasPanel(prendasState.filtered);
      });

      const init = async () => {
        try {
          setRegistroStatus("Cargando diccionario...");
          registroSubmit.disabled = true;
          setSelectLoading(registroProducto, "Cargando...");
          setSelectLoading(registroProveedor, "Cargando...");
          setSelectLoading(registroColor, "Cargando...");
          setSelectLoading(registroTalla, "Cargando...");

          const dictionary = await loadDictionary();
          const dictionaryReady = !dictionary.empty && dictionary.missing.length === 0;
          if (dictionary.empty) {
            setRegistroStatus("Diccionario vacío: corre el workflow Seed Firestore.", "error");
          } else if (dictionary.missing.length) {
            setRegistroStatus(
              `Faltan datos en: ${dictionary.missing.join(", ")}.`,
              "error"
            );
          } else {
            setRegistroStatus("");
          }

          if (dictionary.tipos.length) {
            fillSelect(
              registroProducto,
              dictionary.tipos.sort((a, b) => a.clave.localeCompare(b.clave))
            );
          } else {
            setSelectLoading(registroProducto, "Sin opciones disponibles");
          }

          if (dictionary.proveedores.length) {
            fillSelect(
              registroProveedor,
              dictionary.proveedores.sort((a, b) => a.clave.localeCompare(b.clave))
            );
          } else {
            setSelectLoading(registroProveedor, "Sin opciones disponibles");
          }

          if (dictionary.colores.length) {
            fillSelect(
              registroColor,
              dictionary.colores.sort((a, b) => a.clave.localeCompare(b.clave))
            );
          } else {
            setSelectLoading(registroColor, "Sin opciones disponibles");
          }

          if (dictionary.tallas.length) {
            fillSelect(
              registroTalla,
              dictionary.tallas.sort((a, b) => a.clave.localeCompare(b.clave))
            );
          } else {
            setSelectLoading(registroTalla, "Sin opciones disponibles");
          }

          registroSubmit.disabled = !dictionaryReady;
        } catch (error) {
          setRegistroStatus("No pudimos cargar el diccionario.", "error");
          registroSubmit.disabled = true;
          console.error(error);
        } finally {
          applyAdminVisibility(isAdminEnabled());
          await loadPrendas2025();
        }
      };

      init();
    </script>
  </body>
</html>
