<!DOCTYPE html>
<html lang="es">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <title>Panel Haruja ‚Äì TD | Panel</title>
    <style>
      :root {
        color-scheme: light;
        --bg: #f6f7fb;
        --card: #ffffff;
        --text: #1f2937;
        --muted: #6b7280;
        --primary: #1f6feb;
        --primary-dark: #1a55b5;
        --border: #e5e7eb;
        --shadow: 0 10px 24px rgba(15, 23, 42, 0.08);
        --radius: 16px;
      }

      * {
        box-sizing: border-box;
      }

      body {
        margin: 0;
        font-family: "Inter", "Segoe UI", system-ui, -apple-system, sans-serif;
        color: var(--text);
        background: var(--bg);
      }

      .app {
        min-height: 100vh;
        display: flex;
        flex-direction: column;
      }

      header {
        background: var(--card);
        border-bottom: 1px solid var(--border);
        padding: 24px 32px;
      }

      header h1 {
        margin: 0 0 8px;
        font-size: 24px;
      }

      header p {
        margin: 0;
        color: var(--muted);
        font-size: 14px;
      }

      main {
        padding: 32px;
        display: flex;
        flex-direction: column;
        gap: 24px;
      }

      .grid {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(220px, 1fr));
        gap: 20px;
      }

      .card {
        background: var(--card);
        border: 1px solid var(--border);
        border-radius: var(--radius);
        box-shadow: var(--shadow);
        padding: 20px;
        display: flex;
        flex-direction: column;
        gap: 12px;
        text-decoration: none;
        color: inherit;
      }

      .card h2 {
        margin: 0;
        font-size: 18px;
      }

      .card p {
        margin: 0;
        color: var(--muted);
        font-size: 14px;
      }

      .card .cta {
        margin-top: auto;
        font-weight: 600;
        color: var(--primary);
      }

      .section {
        background: var(--card);
        border: 1px solid var(--border);
        border-radius: var(--radius);
        box-shadow: var(--shadow);
        padding: 24px;
      }

      .section h2 {
        margin: 0 0 12px;
        font-size: 20px;
      }

      .section p {
        margin: 0 0 20px;
        color: var(--muted);
        font-size: 14px;
      }

      .form {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(180px, 1fr));
        gap: 16px;
        align-items: end;
      }

      label {
        display: block;
        font-size: 13px;
        color: var(--muted);
        margin-bottom: 6px;
      }

      input {
        width: 100%;
        padding: 10px 12px;
        border-radius: 10px;
        border: 1px solid var(--border);
        font-size: 14px;
      }

      select {
        width: 100%;
        padding: 10px 12px;
        border-radius: 10px;
        border: 1px solid var(--border);
        font-size: 14px;
        background: #fff;
      }

      button {
        padding: 12px 16px;
        border-radius: 12px;
        border: none;
        background: var(--primary);
        color: #fff;
        font-weight: 600;
        cursor: pointer;
      }

      button:hover {
        background: var(--primary-dark);
      }

      button.secondary {
        background: #e5e7eb;
        color: #1f2937;
      }

      button.secondary:hover {
        background: #d1d5db;
      }

      .status {
        font-size: 14px;
        color: var(--muted);
        min-height: 20px;
      }

      .status.success {
        color: #15803d;
      }

      .status.error {
        color: #b91c1c;
      }

      .status.warning {
        color: #b45309;
      }

      .result-card {
        margin-top: 16px;
        padding: 16px;
        border-radius: 12px;
        border: 1px solid var(--border);
        background: #f8fafc;
      }

      .result-code {
        font-size: 24px;
        font-weight: 700;
        letter-spacing: 0.5px;
        margin: 8px 0 16px;
      }

      .result-actions {
        display: flex;
        flex-wrap: wrap;
        gap: 12px;
      }

      .muted {
        color: var(--muted);
        font-size: 13px;
      }

      .zpl-output {
        margin-top: 16px;
      }

      textarea {
        width: 100%;
        min-height: 180px;
        padding: 12px;
        border-radius: 12px;
        border: 1px solid var(--border);
        font-size: 13px;
        font-family: "SFMono-Regular", "Consolas", "Liberation Mono", monospace;
      }

      .hidden {
        display: none;
      }

      table {
        width: 100%;
        border-collapse: collapse;
        font-size: 14px;
      }

      th,
      td {
        padding: 10px 12px;
        border-bottom: 1px solid var(--border);
        text-align: left;
      }


      th {
        color: var(--muted);
        font-weight: 600;
      }

      th[data-filter-key] {
        white-space: nowrap;
      }

      .th-filter {
        display: inline-flex;
        align-items: center;
        gap: 8px;
      }

      .filter-btn {
        position: relative;
        border: 1px solid #d0d5dd;
        background: #fff;
        border-radius: 8px;
        font-size: 12px;
        width: 24px;
        height: 24px;
        line-height: 1;
        color: #475467;
        cursor: pointer;
        display: inline-flex;
        align-items: center;
        justify-content: center;
        transition: all 0.2s ease;
      }

      .filter-btn:hover {
        border-color: #98a2b3;
        background: #f9fafb;
      }

      .filter-btn:focus-visible {
        outline: 3px solid #bfdbfe;
        outline-offset: 1px;
      }

      .filter-btn.active {
        border-color: #2563eb;
        color: #2563eb;
        background: #eff6ff;
      }

      .filter-btn.active::after {
        content: "";
        position: absolute;
        top: -2px;
        right: -2px;
        width: 8px;
        height: 8px;
        border-radius: 999px;
        background: #2563eb;
        border: 2px solid #fff;
      }

      .filter-popover {
        position: absolute;
        z-index: 80;
        width: 300px;
        max-height: 420px;
        overflow: hidden;
        border-radius: 14px;
        border: 1px solid #e4e7ec;
        background: #fff;
        box-shadow: 0 18px 35px rgba(16, 24, 40, 0.16);
        display: grid;
        grid-template-rows: auto auto auto 1fr auto;
      }

      .filter-popover .popover-head {
        padding: 12px 12px 8px;
        border-bottom: 1px solid #f2f4f7;
      }

      .filter-popover .popover-title {
        margin: 0;
        font-size: 13px;
        color: #344054;
        font-weight: 600;
      }

      .filter-popover .search-wrap {
        position: relative;
        padding: 10px 12px 0;
      }

      .filter-popover .search-wrap::before {
        content: "üîé";
        position: absolute;
        left: 20px;
        top: 19px;
        font-size: 12px;
        opacity: 0.7;
      }

      .filter-popover input[type="text"],
      .filter-popover input[type="number"] {
        width: 100%;
        border: 1px solid #d0d5dd;
        border-radius: 10px;
        font-size: 13px;
        padding: 8px 10px;
        background: #fff;
      }

      .filter-popover .search-wrap input {
        padding-left: 28px;
      }

      .filter-popover input:focus-visible {
        outline: 3px solid #bfdbfe;
        border-color: #93c5fd;
      }

      .filter-popover .meta {
        font-size: 12px;
        color: #667085;
        padding: 8px 12px 0;
      }

      .filter-popover .option-all {
        display: flex;
        align-items: center;
        gap: 8px;
        padding: 8px 12px;
        font-size: 13px;
        border-bottom: 1px solid #f2f4f7;
      }

      .filter-popover .options {
        padding: 8px;
        max-height: 210px;
        overflow: auto;
      }

      .filter-popover .option-row {
        display: flex;
        align-items: center;
        gap: 8px;
        padding: 7px 8px;
        border-radius: 8px;
        font-size: 13px;
      }

      .filter-popover .option-row:hover {
        background: #f2f4f7;
      }

      .filter-popover .actions {
        position: sticky;
        bottom: 0;
        display: flex;
        gap: 8px;
        padding: 10px;
        border-top: 1px solid #f2f4f7;
        background: #fff;
      }

      .filter-popover .actions button {
        flex: 1;
        padding: 9px 12px;
        border-radius: 10px;
        font-size: 13px;
      }

      .filter-popover .range-fields {
        display: grid;
        gap: 8px;
        padding: 10px 12px;
      }

      .filter-popover .hint {
        font-size: 12px;
        color: #b45309;
        padding: 0 12px 8px;
      }

      .panel-controls {
        display: flex;
        flex-direction: column;
        gap: 16px;
        margin-bottom: 16px;
      }

      .filters-grid {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(180px, 1fr));
        gap: 12px;
        align-items: end;
      }

      .filters-grid .price-range {
        display: flex;
        gap: 8px;
      }

      .filters-grid .price-range input {
        width: 100%;
      }

      .filters-grid .inline-toggle {
        display: flex;
        align-items: center;
        gap: 10px;
        padding: 10px 12px;
        border-radius: 10px;
        border: 1px solid var(--border);
        background: #f8fafc;
      }

      .filters-grid .inline-toggle input {
        width: auto;
      }

      .counters {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(140px, 1fr));
        gap: 12px;
      }

      .counter-card {
        border-radius: 12px;
        padding: 12px;
        border: 1px solid var(--border);
        background: #f8fafc;
      }

      .counter-card span {
        display: block;
        font-size: 12px;
        color: var(--muted);
      }

      .counter-card strong {
        font-size: 18px;
      }

      .table-wrapper {
        width: 100%;
        overflow-x: auto;
      }

      .badge {
        display: inline-block;
        padding: 4px 8px;
        border-radius: 999px;
        font-size: 12px;
        font-weight: 600;
      }

      .badge-success {
        background: #e8f5e9;
        color: #166534;
      }

      .badge-danger {
        background: #fee2e2;
        color: #b91c1c;
      }

      .row-new {
        background: #f5f8ff;
      }

      .row-old {
        background: #f3fbf6;
      }

      .loading-row {
        display: flex;
        align-items: center;
        gap: 8px;
        padding: 8px 0;
        color: #667085;
        font-size: 13px;
      }

      .loading-spinner {
        width: 14px;
        height: 14px;
        border-radius: 50%;
        border: 2px solid #e4e7ec;
        border-top-color: #667085;
        animation: spin 0.8s linear infinite;
      }

      @keyframes spin {
        to {
          transform: rotate(360deg);
        }
      }

      .loading-text {
        user-select: none;
      }

      .alert {
        padding: 12px 16px;
        border-radius: 10px;
        border: 1px solid #fecaca;
        background: #fef2f2;
        color: #991b1b;
        font-size: 14px;
      }

      .pagination {
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin-top: 16px;
        gap: 12px;
        flex-wrap: wrap;
      }

      .pagination span {
        color: var(--muted);
        font-size: 14px;
      }

      .pagination button {
        min-width: 120px;
      }

      .pagination .page-indicator {
        font-weight: 600;
        color: var(--text);
      }

      .admin-optional {
        display: flex;
        align-items: center;
        justify-content: space-between;
        gap: 12px;
        flex-wrap: wrap;
        padding: 12px;
        border-radius: 12px;
        border: 1px dashed #d1d5db;
        background: #f8fafc;
      }

      #dbCodigosSection .admin-only {
        display: none !important;
      }

      #dbCodigosSection.admin-enabled .admin-only {
        display: revert !important;
      }

      #dbCodigosSection .admin-panel {
        display: grid;
        gap: 12px;
        padding: 12px;
        border-radius: 12px;
        border: 1px solid #e5e7eb;
        background: #f8fafc;
        margin-top: 12px;
      }

      #dbCodigosSection .admin-login-row {
        display: flex;
        gap: 8px;
        flex-wrap: wrap;
        align-items: center;
      }

      #dbCodigosSection .admin-login-row input {
        flex: 1;
        min-width: 180px;
      }

      #dbCodigosSection .admin-actions {
        display: grid;
        gap: 8px;
      }

      #dbCodigosSection .admin-actions.hidden {
        display: none;
      }

      @media (max-width: 600px) {
        header,
        main {
          padding: 20px;
        }
      }
    </style>
  </head>
  <body>
    <div style="
  background: red;
  color: white;
  padding: 12px;
  text-align: center;
  font-weight: bold;
">
  TEST DEPLOY NUEVO üöÄ
</div>
    <div class="app">
      <header>
        <h1>Panel Haruja-Prueba </h1>
        <p>Gesti√≥n r√°pida de prendas, precios y etiquetas dentro de Tiendanube.</p>
      </header>

      <main>
        <section class="grid">
          <a class="card" href="#registro">
            <h2>Registro de nuevas prendas</h2>
            <p>Carga nuevas prendas y atributos esenciales en minutos.</p>
            <span class="cta">Empezar</span>
          </a>
          <a class="card" href="#precios">
            <h2>Asignar precios</h2>
            <p>Define precios finales por categor√≠a y canal de venta.</p>
            <span class="cta">Configurar</span>
          </a>
          <a class="card" href="#calculadora">
            <h2>Calculadora de precios</h2>
            <p>Calcula m√°rgenes y proyecciones de rentabilidad.</p>
            <span class="cta">Abrir</span>
          </a>
          <a class="card" href="#etiquetas">
            <h2>Impresi√≥n de etiquetas (ZPL)</h2>
            <p>Genera etiquetas listas para impresi√≥n y control interno.</p>
            <span class="cta">Preparar</span>
          </a>
          <a class="card" href="#base-datos-codigos">
            <h2>Base de datos c√≥digos HarujaGdl</h2>
            <p>Consulta c√≥digos existentes, nuevos y detalles clave de prendas.</p>
            <span class="cta">Abrir</span>
          </a>
        </section>

        <section class="section" id="registro">
          <h2>Registro de nuevas prendas</h2>
          <p>Selecciona los atributos clave para generar el c√≥digo y guardar la prenda en Firestore.</p>
          <form class="form" id="registro-form">
            <div>
              <label for="registro-producto">Tipo / Producto *</label>
              <select id="registro-producto" name="producto" required>
                <option value="">Seleccionar</option>
              </select>
            </div>
            <div>
              <label for="registro-proveedor">Proveedor *</label>
              <select id="registro-proveedor" name="proveedor" required>
                <option value="">Seleccionar</option>
              </select>
            </div>
            <div>
              <label for="registro-color">Color *</label>
              <select id="registro-color" name="color" required>
                <option value="">Seleccionar</option>
              </select>
            </div>
            <div>
              <label for="registro-talla">Talla *</label>
              <select id="registro-talla" name="talla" required>
                <option value="">Seleccionar</option>
              </select>
            </div>
            <div>
              <label for="registro-costo">Costo (opcional)</label>
              <input id="registro-costo" name="costo" type="number" min="0" step="0.01" placeholder="0" />
            </div>
            <div>
              <label for="registro-created-by">Creado por (opcional)</label>
              <input id="registro-created-by" name="createdBy" type="text" placeholder="Nombre" />
            </div>
            <div>
              <label for="registro-detalles">Detalles (opcional)</label>
              <input id="registro-detalles" name="detalles" type="text" placeholder="Ej: Pelly estampada" />
            </div>
            <button type="submit">Generar c√≥digo</button>
          </form>
          <p id="registro-status" class="status"></p>
          <div id="registro-result" class="result-card hidden">
            <span class="muted">C√≥digo generado</span>
            <div id="registro-codigo" class="result-code">HA00000/--</div>
            <div class="result-actions">
              <button type="button" id="registro-copy">Copiar</button>
              <button type="button" id="registro-reset">Crear otro</button>
            </div>
          </div>
        </section>

        <section class="section" id="etiquetas">
          <h2>Impresi√≥n de etiquetas</h2>
          <p>Ingresa el c√≥digo y la cantidad de etiquetas a generar.</p>
          <form class="form" id="zpl-form">
            <div>
              <label for="zpl-codigo">C√≥digo (SKU)</label>
              <input id="zpl-codigo" name="codigo" type="text" placeholder="HA2A007/NG-M" />
            </div>
            <div>
              <label for="zpl-cantidad">Cantidad</label>
              <input id="zpl-cantidad" name="cantidad" type="number" min="1" value="1" />
            </div>
            <button type="submit">Imprimir etiqueta</button>
          </form>
          <p id="zpl-status" class="status"></p>
          <div class="zpl-output hidden" id="zpl-output">
            <label for="zpl-textarea">ZPL generado</label>
            <textarea id="zpl-textarea" readonly></textarea>
            <div class="result-actions" style="margin-top: 12px;">
              <button type="button" id="zpl-copy">Copiar ZPL</button>
            </div>
          </div>
        </section>

        <section class="section" id="base-datos-codigos">
          <div id="dbCodigosSection">
            <h2>Base de datos c√≥digos HarujaGdl</h2>
            <p>Explora la base de prendas 2025 con b√∫squeda, filtros y estado de novedades.</p>
            <div class="panel-controls">
              <div class="filters-grid">
                <div>
                  <label for="prendas-search">Buscar por c√≥digo o descripci√≥n</label>
                  <input id="prendas-search" type="text" placeholder="Ej: HA12A003 o sudadera" />
                </div>
                <div>
                  <label for="prendas-year">A√±o alta</label>
                  <select id="prendas-year">
                    <option value="">Todos</option>
                  </select>
                </div>
                <div>
                  <label for="prendas-month">Mes alta</label>
                  <select id="prendas-month">
                    <option value="">Todos</option>
                  </select>
                </div>
                <div>
                  <label>Precio (rango)</label>
                  <div class="price-range">
                    <input id="prendas-precio-min" type="number" min="0" placeholder="M√≠n" />
                    <input id="prendas-precio-max" type="number" min="0" placeholder="M√°x" />
                  </div>
                </div>
                <div class="inline-toggle">
                  <input id="prendas-precio-sin" type="checkbox" checked />
                  <label for="prendas-precio-sin">Incluir sin precio</label>
                </div>
                <div>
                  <label>&nbsp;</label>
                  <button type="button" id="prendas-precio-apply">Aplicar filtros</button>
                </div>
                <div>
                  <label>&nbsp;</label>
                  <button type="button" id="prendas-filters-clear" class="secondary">Limpiar</button>
                </div>
                <div>
                  <label for="prendas-page-size">Registros por p√°gina</label>
                  <select id="prendas-page-size">
                    <option value="30">30</option>
                    <option value="50">50</option>
                    <option value="80" selected>80</option>
                    <option value="100">100</option>
                  </select>
                </div>
              </div>
              <div class="admin-optional" id="admin-optional">
                <span class="muted">Admin opcional: configura despu√©s si no necesitas costos.</span>
                <button type="button" id="admin-optional-toggle" class="secondary">
                  Mostrar admin
                </button>
              </div>
              <div class="admin-panel" id="admin-panel">
                <div>
                  <label for="admin-password">Admin</label>
                  <div class="admin-login-row">
                    <input
                      id="admin-password"
                      type="password"
                      placeholder="Contrase√±a admin"
                      autocomplete="current-password"
                    />
                    <button type="button" id="admin-login">Ingresar</button>
                    <button type="button" id="admin-logout" class="secondary hidden">Salir</button>
                  </div>
                  <div id="admin-login-status" class="status"></div>
                </div>
                <div class="admin-actions hidden" id="admin-actions">
                  <div class="inline-toggle">
                    <input id="adminToggleDb" type="checkbox" />
                    <label for="adminToggleDb">Modo admin (mostrar costos y m√°rgenes)</label>
                  </div>
                  <button type="button" id="admin-backfill">
                    Preparar buscador (1 vez)
                  </button>
                  <div id="admin-backfill-status" class="status"></div>
                </div>
              </div>
              <div class="counters">
                <div class="counter-card">
                  <span>Total</span>
                  <strong id="prendas-total" data-count-total>‚Äî</strong>
                </div>
                <div class="counter-card">
                  <span>Nuevos (7 d√≠as)</span>
                  <strong id="prendas-nuevos">‚Äî</strong>
                </div>
                <div class="counter-card">
                  <span>Existentes</span>
                  <strong id="prendas-existentes">‚Äî</strong>
                </div>
              </div>
              <p id="prendas-count-note" class="muted"></p>
            </div>
            <div id="prendas-alert" class="alert hidden"></div>
            <div id="loadingRow" class="loading-row" style="display:none" data-db-loader>
              <span class="loading-spinner"></span>
              <span class="loading-text">Cargando base de datos...</span>
            </div>
            <div class="table-wrapper">
              <table id="tablaPrendas" data-prendas-table>
                <thead>
                  <tr>
                    <th>C√≥digo</th>
                    <th>Descripci√≥n</th>
                    <th data-filter-key="tipo"><span class="th-filter">Tipo <button type="button" class="filter-btn" data-open-header-filter="tipo" aria-label="Filtrar Tipo">‚åÑ</button></span></th>
                    <th data-filter-key="color"><span class="th-filter">Color <button type="button" class="filter-btn" data-open-header-filter="color" aria-label="Filtrar Color">‚åÑ</button></span></th>
                    <th data-filter-key="talla"><span class="th-filter">Talla <button type="button" class="filter-btn" data-open-header-filter="talla" aria-label="Filtrar Talla">‚åÑ</button></span></th>
                    <th data-filter-key="proveedor"><span class="th-filter">Proveedor <button type="button" class="filter-btn" data-open-header-filter="proveedor" aria-label="Filtrar Proveedor">‚åÑ</button></span></th>
                    <th data-filter-key="status"><span class="th-filter">Status <button type="button" class="filter-btn" data-open-header-filter="status" aria-label="Filtrar Status">‚åÑ</button></span></th>
                    <th data-filter-key="disponibilidad"><span class="th-filter">Disponibilidad <button type="button" class="filter-btn" data-open-header-filter="disponibilidad" aria-label="Filtrar Disponibilidad">‚åÑ</button></span></th>
                    <th>Fecha</th>
                    <th data-filter-key="pventa"><span class="th-filter">P. Venta <button type="button" class="filter-btn" data-open-header-filter="pventa" aria-label="Filtrar P. Venta">‚åÑ</button></span></th>
                    <th class="admin-only">(Admin) Costo</th>
                    <th class="admin-only">(Admin) Margen</th>
                    <th class="admin-only">(Admin) Utilidad</th>
                  </tr>
                </thead>
                <tbody id="prendas-tbody" data-prendas-tbody></tbody>
              </table>
              <template id="noResultsRow" data-empty-row>
                <tr>
                  <td colspan="13">No hay resultados con los filtros actuales.</td>
                </tr>
              </template>
            </div>
            <div class="pagination">
              <span id="prendas-showing" data-count-shown>Mostrando 0</span>
              <span id="prendas-page-indicator" class="page-indicator">P√°gina 1</span>
              <div>
                <button type="button" id="prendas-prev">Anterior</button>
                <button type="button" id="prendas-next">Siguiente</button>
              </div>
            </div>
          </div>
        </section>
      </main>
    </div>
    <script type="module">
      import { initializeApp } from "https://www.gstatic.com/firebasejs/9.22.2/firebase-app.js";
      import {
        getFirestore,
        initializeFirestore,
        collection,
        addDoc,
        doc,
        getDoc,
        getDocs,
        query,
        orderBy,
        documentId,
        runTransaction,
        serverTimestamp,
        startAfter,
        where,
        limit,
        persistentLocalCache,
        persistentMultipleTabManager,
        memoryLocalCache
      } from "https://www.gstatic.com/firebasejs/9.22.2/firebase-firestore.js";
      import {
        getFunctions,
        httpsCallable
      } from "https://www.gstatic.com/firebasejs/9.22.2/firebase-functions.js";

      // TODO: Reemplazar estos valores con la configuraci√≥n real del proyecto Firebase.
      const firebaseConfig = {
        apiKey: "REEMPLAZAR_API_KEY",
        authDomain: "haruja-tiendanube.firebaseapp.com",
        projectId: "haruja-tiendanube",
        storageBucket: "haruja-tiendanube.appspot.com",
        messagingSenderId: "REEMPLAZAR_SENDER_ID",
        appId: "REEMPLAZAR_APP_ID"
      };

      const app = initializeApp(firebaseConfig);
      const FUNCTIONS_REGION =
        window.HARUJA_FUNCTIONS_REGION ||
        firebaseConfig.functionsRegion ||
        "us-central1";
      const functions = getFunctions(app, FUNCTIONS_REGION);
      let db;
      try {
        db = initializeFirestore(app, {
          localCache: persistentLocalCache({
            tabManager: persistentMultipleTabManager()
          })
        });
      } catch (error) {
        console.warn(
          "[Firestore] Persistencia multi-tab no disponible, usando cach√© en memoria",
          error?.code || error?.message
        );
        db = initializeFirestore(app, {
          localCache: memoryLocalCache()
        });
      }
      const prendasRef = collection(db, "prendas");
      const registroForm = document.getElementById("registro-form");
      const registroStatus = document.getElementById("registro-status");
      const registroResult = document.getElementById("registro-result");
      const registroCodigo = document.getElementById("registro-codigo");
      const registroCopy = document.getElementById("registro-copy");
      const registroReset = document.getElementById("registro-reset");
      const registroSubmit = registroForm.querySelector("button[type='submit']");
      const registroProducto = document.getElementById("registro-producto");
      const registroProveedor = document.getElementById("registro-proveedor");
      const registroColor = document.getElementById("registro-color");
      const registroTalla = document.getElementById("registro-talla");
      const registroDetalles = document.getElementById("registro-detalles");

      const zplForm = document.getElementById("zpl-form");
      const zplStatus = document.getElementById("zpl-status");
      const zplOutput = document.getElementById("zpl-output");
      const zplTextarea = document.getElementById("zpl-textarea");
      const zplCopy = document.getElementById("zpl-copy");

      const prendasSearch = document.getElementById("prendas-search");
      const headerFilterButtons = document.querySelectorAll("[data-open-header-filter]");
      const prendasYear = document.getElementById("prendas-year");
      const prendasMonth = document.getElementById("prendas-month");
      const prendasPrecioMin = document.getElementById("prendas-precio-min");
      const prendasPrecioMax = document.getElementById("prendas-precio-max");
      const prendasPrecioSin = document.getElementById("prendas-precio-sin");
      const prendasPrecioApply = document.getElementById("prendas-precio-apply");
      const prendasFiltersClear = document.getElementById("prendas-filters-clear");
      const prendasPageSize = document.getElementById("prendas-page-size");
      const prendasTotal = document.querySelector("[data-count-total]") || document.getElementById("prendas-total");
      const prendasNuevos = document.getElementById("prendas-nuevos");
      const prendasExistentes = document.getElementById("prendas-existentes");
      const prendasCountNote = document.getElementById("prendas-count-note");
      const prendasTable =
        document.querySelector("[data-prendas-table]") ||
        document.getElementById("tablaPrendas");
      const prendasTbody =
        prendasTable?.querySelector("tbody") ||
        document.querySelector("[data-prendas-tbody]") ||
        document.getElementById("prendas-tbody");
      const prendasShowing =
        document.querySelector("[data-count-shown]") || document.getElementById("prendas-showing");
      const prendasPrev = document.getElementById("prendas-prev");
      const prendasNext = document.getElementById("prendas-next");
      const prendasPageIndicator = document.getElementById("prendas-page-indicator");
      const loadingRow =
        document.querySelector("[data-db-loader]") || document.getElementById("loadingRow");
      const prendasEmptyRow =
        document.querySelector("[data-empty-row]") || document.getElementById("noResultsRow");
      const prendasAlert = document.getElementById("prendas-alert");
      const prendasPanel = document.getElementById("base-datos-codigos");
      const dbCodigosSection = document.getElementById("dbCodigosSection");
      const adminToggleDb = prendasPanel.querySelector("#adminToggleDb");
      const adminPasswordInput = document.getElementById("admin-password");
      const adminLoginButton = document.getElementById("admin-login");
      const adminLogoutButton = document.getElementById("admin-logout");
      const adminLoginStatus = document.getElementById("admin-login-status");
      const adminPanel = document.getElementById("admin-panel");
      const adminActions = document.getElementById("admin-actions");
      const adminBackfillButton = document.getElementById("admin-backfill");
      const adminBackfillStatus = document.getElementById("admin-backfill-status");
      const adminOptional = document.getElementById("admin-optional");
      const adminOptionalToggle = document.getElementById("admin-optional-toggle");
      console.assert(prendasTable, "No existe tabla de prendas");
      console.assert(prendasTbody, "No existe tbody de prendas");
      console.assert(loadingRow, "No existe loader de prendas");
      console.assert(prendasShowing, "No existe contador de prendas mostradas");
      console.assert(prendasTotal, "No existe contador total de prendas");
      console.assert(prendasEmptyRow, "No existe template de filas vac√≠as");

      const setRegistroStatus = (message, type = "") => {
        registroStatus.textContent = message;
        registroStatus.className = `status ${type}`.trim();
      };

      const setZplStatus = (message, type = "") => {
        zplStatus.textContent = message;
        zplStatus.className = `status ${type}`.trim();
      };

      const safeString = (value) => {
        if (value === null || value === undefined) return "";
        return String(value);
      };

      const normalizeText = (value) =>
        safeString(value)
          .toLowerCase()
          .trim()
          .normalize("NFD")
          .replace(/[\u0300-\u036f]/g, "");

      const normalizeDictionaryValue = (value) =>
        safeString(value).trim().replace(/\s+/g, " ");

      const normalizeSku = (input) =>
        safeString(input)
          .trim()
          .toUpperCase()
          .replace(/\s+/g, " ")
          .replace(/\//g, "__");

      const normalizeSkuPrefix = (input) =>
        safeString(input)
          .trim()
          .toLowerCase()
          .replace(/\s+/g, "");

      const toNumberOrNull = (value) => {
        if (value === null || value === undefined) return null;
        if (String(value).trim() === "") return null;
        const parsed = Number(value);
        return Number.isFinite(parsed) ? parsed : null;
      };

      const debounce = (fn, wait = 200) => {
        let timeoutId;
        return (...args) => {
          if (timeoutId) {
            clearTimeout(timeoutId);
          }
          timeoutId = setTimeout(() => fn(...args), wait);
        };
      };

      const formatDateDDMMYYYY = (date) => {
        if (!(date instanceof Date) || Number.isNaN(date.getTime())) {
          return "--";
        }
        const day = String(date.getDate()).padStart(2, "0");
        const month = String(date.getMonth() + 1).padStart(2, "0");
        const year = date.getFullYear();
        return `${day}/${month}/${year}`;
      };

      const toDateValue = (value) => {
        if (!value) return null;
        if (value instanceof Date) return value;
        if (typeof value?.toDate === "function") return value.toDate();
        if (typeof value === "number") return new Date(value);
        if (typeof value === "string") {
          const parsed = new Date(value);
          return Number.isNaN(parsed.getTime()) ? null : parsed;
        }
        return null;
      };

      const parseDateTextValue = (value) => {
        const raw = safeString(value).trim();
        if (!raw) return null;
        const match = /^(\d{1,2})\/(\d{1,2})\/(\d{4})$/.exec(raw);
        if (!match) return null;
        const day = Number(match[1]);
        const month = Number(match[2]);
        const year = Number(match[3]);
        if (!Number.isInteger(day) || !Number.isInteger(month) || !Number.isInteger(year)) {
          return null;
        }
        const parsed = new Date(year, month - 1, day, 0, 0, 0, 0);
        if (
          Number.isNaN(parsed.getTime()) ||
          parsed.getFullYear() !== year ||
          parsed.getMonth() !== month - 1 ||
          parsed.getDate() !== day
        ) {
          return null;
        }
        return parsed;
      };

      const resolveComparableDate = (item) => {
        return (
          toDateValue(item?.fechaAlta) ||
          toDateValue(item?.fecha) ||
          parseDateTextValue(item?.fechaAltaTexto) ||
          parseDateTextValue(item?.fechaTexto) ||
          null
        );
      };

      const isInDateRange = (item, dateRange) => {
        if (!dateRange?.start || !dateRange?.end) return true;
        const value = resolveComparableDate(item);
        if (!value) return false;
        return value >= dateRange.start && value < dateRange.end;
      };

      const compareItemsByDateDesc = (a, b) => {
        const dateA = resolveComparableDate(a);
        const dateB = resolveComparableDate(b);
        const timeA = dateA ? dateA.getTime() : Number.NEGATIVE_INFINITY;
        const timeB = dateB ? dateB.getTime() : Number.NEGATIVE_INFINITY;
        if (timeA !== timeB) return timeB - timeA;
        return safeString(b?.codigo).localeCompare(safeString(a?.codigo));
      };

      const isNew = (createdAt, days = 7) => {
        const createdDate = toDateValue(createdAt);
        if (!createdDate) return false;
        const diff = Date.now() - createdDate.getTime();
        return diff <= days * 24 * 60 * 60 * 1000;
      };

      const buildOption = ({ clave, valor }) => {
        const option = document.createElement("option");
        option.value = clave;
        option.textContent = `${clave} - ${valor}`;
        option.dataset.nombre = valor;
        return option;
      };

      const setSelectLoading = (selectEl, message) => {
        selectEl.innerHTML = "";
        const option = document.createElement("option");
        option.value = "";
        option.textContent = message;
        selectEl.appendChild(option);
        selectEl.disabled = true;
      };

      const fillDictionarySelect = (selectEl, entries) => {
        selectEl.innerHTML = "";
        const placeholder = document.createElement("option");
        placeholder.value = "";
        placeholder.textContent = "Seleccionar";
        selectEl.appendChild(placeholder);
        entries.forEach((item) => selectEl.appendChild(buildOption(item)));
        selectEl.disabled = false;
      };

      const buildUniqueSelectValues = (values) => {
        const map = new Map();
        values.forEach((value) => {
          const trimmed = safeString(value).trim();
          if (!trimmed) return;
          const normalized = normalizeText(trimmed);
          if (!map.has(normalized)) {
            map.set(normalized, trimmed);
          }
        });
        return [...map.values()].sort((a, b) => a.localeCompare(b));
      };

      const fillSelect = (selectEl, values) => {
        const current = selectEl.value;
        selectEl.innerHTML = "";
        const allOption = document.createElement("option");
        allOption.value = "todos";
        allOption.textContent = "Todos";
        selectEl.appendChild(allOption);
        const uniqueValues = buildUniqueSelectValues(values);
        uniqueValues.forEach((value) => {
          const option = document.createElement("option");
          option.value = value;
          option.textContent = value;
          selectEl.appendChild(option);
        });
        if (current) {
          const normalizedCurrent = normalizeText(current);
          const matched = uniqueValues.find(
            (value) => normalizeText(value) === normalizedCurrent
          );
          selectEl.value = matched || "todos";
        } else {
          selectEl.value = "todos";
        }
        selectEl.disabled = false;
      };

      const collectOption = (map, codigo, nombre) => {
        if (!codigo) return;
        if (!map.has(codigo)) {
          map.set(codigo, nombre || codigo);
        }
      };

      const COLLECTIONS = {
        tipos: "diccionario_tipos",
        proveedores: "diccionario_proveedores",
        colores: "diccionario_colores",
        tallas: "diccionario_tallas"
      };

      const CODE_PATTERN = /^HA(\d+)([A-Z])(\d{3})\/([A-Z0-9]+)-([A-Z0-9]+)$/;
      const PRENDAS_2025_COLLECTION = "HarujaPrendas_2025";
      const PRENDAS_PAGE_SIZE_DEFAULT = 80;
      const PRENDAS_SCAN_PAGE_SIZE = 200;
      const PRENDAS_SCAN_MAX_PAGES = 12;
      const PRENDAS_DATE_FALLBACK_LIMIT = 1200;
      const PRENDAS_COUNT_SCAN_LIMIT = 2000;
      const PRENDAS_COUNT_BATCH_SIZE = 250;
      const PRENDAS_RENDER_CHUNK = 20;
      const PRENDAS_SEARCH_DEBOUNCE = 250;
      const PRENDAS_YEAR_MIN = 2024;
      const DATE_FIELD_PRIMARY = "fechaAlta";
      const DATE_FIELD_FALLBACK = "fecha";
      const QUERY_MODE_EQUALITY = "equality";
      const QUERY_MODE_DATE = "dateRange";
      const QUERY_MODE_PRICE = "priceRange";
      const MONTH_OPTIONS = [
        { value: 1, label: "Enero" },
        { value: 2, label: "Febrero" },
        { value: 3, label: "Marzo" },
        { value: 4, label: "Abril" },
        { value: 5, label: "Mayo" },
        { value: 6, label: "Junio" },
        { value: 7, label: "Julio" },
        { value: 8, label: "Agosto" },
        { value: 9, label: "Septiembre" },
        { value: 10, label: "Octubre" },
        { value: 11, label: "Noviembre" },
        { value: 12, label: "Diciembre" }
      ];
      const HEADER_FILTER_KEYS = [
        "status",
        "proveedor",
        "tipo",
        "color",
        "talla",
        "disponibilidad"
      ];
      const HEADER_RANGE_KEY = "pventa";
      const createEmptyHeaderFilters = () => ({
        status: new Set(),
        proveedor: new Set(),
        tipo: new Set(),
        color: new Set(),
        talla: new Set(),
        disponibilidad: new Set(),
        pventaMin: null,
        pventaMax: null
      });
      const ADMIN_SESSION_KEY = "haruja_admin_session";
      const ADMIN_VIEW_KEY = "haruja_admin_view";
      const ADMIN_SESSION_TTL = 12 * 60 * 60 * 1000;
      const DICTS_CACHE_KEY = "haruja_dicts_cache_v2";
      const METADATA_COUNTS_DOC = {
        collection: "metadata",
        doc: "counters"
      };

      const prendas2025Ref = collection(db, PRENDAS_2025_COLLECTION);
      const prendasState = {
        filtered: [],
        baseRows: [],
        rowsAfterGlobal: [],
        rowsAfterAll: [],
        uniqueOptions: {},
        isAdmin: false,
        pageIndex: 0,
        hasNextPage: false,
        dicts: {
          proveedores: [],
          tipos: [],
          colores: [],
          tallas: []
        },
        dictsLoaded: false,
        isDone: false,
        isLoadingInitial: false,
        filters: {
          global: null,
          header: createEmptyHeaderFilters()
        },
        filtersActive: false,
        renderToken: 0,
        searchToken: 0,
        isSkuSearch: false,
        showingTotal: null,
        queryKey: "",
        reqId: 0,
        countToken: 0,
        metadataTotal: null,
        metadataLoaded: false,
        headerPopover: null
      };
      let isBooting = true;

      const loadCategoryEntries = async (category, collectionName) => {
        const snapshot = await getDocs(collection(db, collectionName));
        if (snapshot.empty) {
          return { category, entries: [], empty: true };
        }

        const entries = snapshot.docs
          .map((docSnap) => {
            const data = docSnap.data() || {};
            const clave = data.clave || docSnap.id;
            const valor = data.valor || data.nombre || clave;
            return { clave, valor };
          })
          .filter((entry) => entry.clave && entry.valor);

        return { category, entries, empty: entries.length === 0 };
      };

      const loadDictionary = async () => {
        const categories = Object.keys(COLLECTIONS);
        const results = await Promise.all(
          categories.map((category) =>
            loadCategoryEntries(category, COLLECTIONS[category])
          )
        );
        const missing = results.filter((result) => result.empty).map((result) => result.category);

        return {
          empty: missing.length === categories.length,
          missing,
          tipos: results.find((result) => result.category === "tipos")?.entries ?? [],
          proveedores: results.find((result) => result.category === "proveedores")?.entries ?? [],
          colores: results.find((result) => result.category === "colores")?.entries ?? [],
          tallas: results.find((result) => result.category === "tallas")?.entries ?? []
        };
      };

      const loadDictionariesOnce = async () => {
        if (prendasState.dictsLoaded) {
          return prendasState.dicts;
        }
        const cached = localStorage.getItem(DICTS_CACHE_KEY);
        if (cached) {
          try {
            const parsed = JSON.parse(cached);
            if (
              parsed?.version === "2" &&
              parsed?.dicts &&
              ["proveedores", "tipos", "colores", "tallas"].every((key) =>
                Array.isArray(parsed.dicts[key])
              )
            ) {
              prendasState.dicts = parsed.dicts;
              prendasState.dictsLoaded = true;
              return prendasState.dicts;
            }
          } catch (error) {
            console.warn("Cache de diccionarios inv√°lida, recargando.", error);
          }
        }
        const categories = Object.keys(COLLECTIONS);
        const results = await Promise.all(
          categories.map(async (category) => {
            const snapshot = await getDocs(collection(db, COLLECTIONS[category]));
            const values = snapshot.docs
              .map((docSnap) => {
                const data = docSnap.data() || {};
                return (
                  data.valor ??
                  data.Valor ??
                  data.nombre ??
                  data.Nombre ??
                  data.clave ??
                  data.Clave ??
                  docSnap.id
                );
              })
              .map((value) => safeString(value).trim())
              .filter((value) => value);
            return { category, values };
          })
        );

        prendasState.dicts.proveedores =
          results.find((result) => result.category === "proveedores")?.values ?? [];
        prendasState.dicts.tipos =
          results.find((result) => result.category === "tipos")?.values ?? [];
        prendasState.dicts.colores =
          results.find((result) => result.category === "colores")?.values ?? [];
        prendasState.dicts.tallas =
          results.find((result) => result.category === "tallas")?.values ?? [];
        prendasState.dictsLoaded = true;
        localStorage.setItem(
          DICTS_CACHE_KEY,
          JSON.stringify({ version: "2", dicts: prendasState.dicts })
        );
        return prendasState.dicts;
      };

      const setLoading = (isLoading, message = "Cargando base de datos...") => {
        if (!loadingRow) return;
        const text = loadingRow.querySelector(".loading-text");
        if (text) {
          text.textContent = message;
        }
        loadingRow.style.display = isLoading ? "flex" : "none";
      };

      const setCounter = (shown, total) => {
        if (prendasShowing) {
          if (Number.isFinite(total)) {
            prendasShowing.textContent = `Mostrando ${shown} de ${total}`;
          } else {
            prendasShowing.textContent = `Mostrando ${shown} de ?`;
          }
        }
      };

      const resetCounters = () => {
        if (prendasTotal) {
          prendasTotal.textContent = "‚Äî";
        }
        if (prendasNuevos) {
          prendasNuevos.textContent = "‚Äî";
        }
        if (prendasExistentes) {
          prendasExistentes.textContent = "‚Äî";
        }
        if (prendasCountNote) {
          prendasCountNote.textContent = "";
        }
      };

      const updatePaginationUi = () => {
        if (!prendasPrev || !prendasNext || !prendasPageIndicator) return;
        const isSkuSearch = prendasState.isSkuSearch;
        const pageIndex = prendasState.pageIndex;
        const hasPrev = pageIndex > 0;
        const hasNext = prendasState.hasNextPage;
        const isBusy = prendasState.isLoadingInitial;
        prendasPrev.disabled = isSkuSearch || isBusy || !hasPrev;
        prendasNext.disabled = isSkuSearch || isBusy || !hasNext;
        prendasPrev.classList.toggle("hidden", isSkuSearch);
        prendasNext.classList.toggle("hidden", isSkuSearch);
        prendasPageIndicator.textContent = `P√°gina ${pageIndex + 1}`;
      };

      const formatApproxCount = (value, isApprox) =>
        isApprox ? `‚âà ${value}+` : `${value}`;

      const setApproxCounts = ({
        total,
        nuevos,
        existentes,
        isApprox,
        preferMetadata = false
      }) => {
        const useMetadata =
          preferMetadata && Number.isFinite(prendasState.metadataTotal);
        if (prendasTotal) {
          prendasTotal.textContent = useMetadata
            ? formatApproxCount(prendasState.metadataTotal, false)
            : Number.isFinite(total)
              ? formatApproxCount(total, isApprox)
            : "‚Äî";
        }
        if (prendasNuevos) {
          prendasNuevos.textContent = Number.isFinite(nuevos)
            ? formatApproxCount(nuevos, isApprox)
            : "‚Äî";
        }
        if (prendasExistentes) {
          prendasExistentes.textContent = Number.isFinite(existentes)
            ? formatApproxCount(existentes, isApprox)
            : "‚Äî";
        }
        if (prendasCountNote) {
          if (useMetadata) {
            prendasCountNote.textContent =
              "Total global le√≠do desde metadata (sin filtros).";
          } else {
            prendasCountNote.textContent = isApprox
              ? "Conteos aproximados para evitar errores de √≠ndices."
              : "Conteos basados en escaneo para evitar errores de √≠ndices.";
          }
        }
      };

      const setExactCountsFromItems = (items) => {
        const total = items.length;
        const nuevos = items.filter((item) => isNew(getPrendaDate(item))).length;
        const existentes = total - nuevos;
        setApproxCounts({ total, nuevos, existentes, isApprox: false });
      };

      const setPrendasAlert = (message = "", { isHtml = false } = {}) => {
        if (message) {
          if (isHtml) {
            prendasAlert.innerHTML = message;
          } else {
            prendasAlert.textContent = message;
          }
          prendasAlert.classList.remove("hidden");
        } else {
          prendasAlert.textContent = "";
          prendasAlert.classList.add("hidden");
        }
      };

      const isFullSku = (input) => {
        const value = safeString(input).trim().toUpperCase();
        if (!value) return false;
        return CODE_PATTERN.test(value);
      };

      const getPrendaDate = (data) =>
        toDateValue(data?.fechaAlta) ||
        toDateValue(data?.fecha) ||
        toDateValue(data?.updatedAt) ||
        toDateValue(data?.createdAt);

      const normalizeStatus = (raw) => {
        const normalized = normalizeText(raw);
        if (!normalized) return "";
        if (normalized === "vendido") return "Vendido";
        if (["existente", "en stock", "disponible", "activo"].includes(normalized)) {
          return "Disponible";
        }
        return "";
      };

      const normalizeDisponibilidad = (raw, statusCanon) => {
        if (statusCanon === "Vendido") return "No disponible";
        const normalized = normalizeText(raw);
        if (!normalized) return "Disponible";
        if (["no disponible", "agotado", "sin stock", "0"].includes(normalized)) {
          return "No disponible";
        }
        if (["disponible", "en stock", "1", "si"].includes(normalized)) {
          return "Disponible";
        }
        return "Disponible";
      };

      const getBadgeClassByLabel = (label) => {
        if (label === "Disponible") return "badge-success";
        if (label === "No disponible" || label === "Vendido") return "badge-danger";
        return "";
      };

      const renderBadgeCell = (label) => {
        const cell = document.createElement("td");
        if (label === "--") {
          cell.textContent = "--";
          return cell;
        }
        cell.appendChild(buildBadge(label, getBadgeClassByLabel(label)));
        return cell;
      };

      const renderStatusCell = (status) =>
        renderBadgeCell(normalizeStatus(status) || "--");

      const renderDisponibilidadCell = (disponibilidad, status) =>
        renderBadgeCell(normalizeDisponibilidad(disponibilidad, status));

      const resolvePVenta = (data) => {
        const precioBase = toNumberOrNull(
          pickFirstValue(data?.precio, data?.Precio, data?.price)
        );
        const pVenta = toNumberOrNull(
          pickFirstValue(data?.pVenta, data?.PVenta, data?.p_venta)
        );
        const precioConIvaLegacy = toNumberOrNull(
          pickFirstValue(data?.precioConIva, data?.precioConIVA)
        );
        if (Number.isFinite(pVenta)) return pVenta;
        if (Number.isFinite(precioConIvaLegacy)) return precioConIvaLegacy;
        if (Number.isFinite(precioBase)) return Number((precioBase * 1.16).toFixed(2));
        return null;
      };

      const getPrendaPrice = (data) => resolvePVenta(data);

      const currencyFormatter = new Intl.NumberFormat("es-MX", {
        style: "currency",
        currency: "MXN",
        maximumFractionDigits: 2
      });

      const formatCurrency = (value) => currencyFormatter.format(value);

      const formatPercent = (value) => {
        const ratio = value > 1 ? value / 100 : value;
        return `${(ratio * 100).toFixed(1)}%`;
      };

      const formatMoney = (value) => {
        const amount = Number(value);
        if (!Number.isFinite(amount)) return "--";
        return formatCurrency(amount);
      };

      const formatDateCell = (item) => {
        const date = getPrendaDate(item);
        return date ? formatDateDDMMYYYY(date) : "--";
      };

      const buildSearchKey = (data) => {
        const codigo = safeString(data.codigo || data.code || data.Codigo || data.Code);
        const descripcion = safeString(data.descripcion || data.Descripcion || data.detalles);
        return normalizeText(`${codigo} ${descripcion}`.trim());
      };

      const pickFirstValue = (...values) => {
        for (const value of values) {
          if (value !== undefined && value !== null && value !== "") {
            return value;
          }
        }
        return null;
      };

      const normalizeDoc = (docSnap) => {
        const data = docSnap.data() || {};
        const codigo = safeString(
          data.codigo ??
            data.Codigo ??
            data.CODIGO ??
            data.SKU ??
            data.code ??
            data.Code ??
            docSnap.id
        ).trim();
        const descripcion = safeString(
          data.descripcion ??
            data.Descripcion ??
            data.detalles ??
            data.Detalles ??
            ""
        ).trim();
        const proveedor = safeString(data.proveedor || data.Proveedor || "").trim();
        const tipo = safeString(data.tipo || data.Tipo || "").trim();
        const color = safeString(data.color || data.Color || "").trim();
        const talla = safeString(data.talla || data.Talla || "").trim();
        const statusRaw = safeString(data.statusCanon ?? data.status ?? data.Status ?? "").trim();
        const statusCanon = normalizeStatus(statusRaw);
        const costoRaw = pickFirstValue(
          data.costo,
          data.Costo,
          data.cost,
          data.costoUnitario,
          data.costo_unitario,
          data.costoTotal,
          data.costo_total,
          data.costoSinIva,
          data.costo_sin_iva,
          data.costoConIva,
          data.costoConIVA
        );
        const precioRaw = pickFirstValue(
          data.precio,
          data.Precio,
          data.price,
          data.precioFinal,
          data.precio_final
        );
        const margenRaw = pickFirstValue(
          data.margen,
          data.Margen,
          data.margenUtilidad,
          data.margen_utilidad,
          data.porcentajeMargen,
          data.porcentaje_margen,
          data.margenEstimado,
          data.margen_estimado
        );
        const utilidadRaw = pickFirstValue(
          data.utilidad,
          data.Utilidad,
          data.utilidadNeta,
          data.utilidad_neta,
          data.ganancia,
          data.gananciaEstimada
        );
        const precio = toNumberOrNull(precioRaw);
        const precioConIva = toNumberOrNull(
          pickFirstValue(data.precioConIva, data.precioConIVA)
        );
        const pVenta = resolvePVenta(data);
        const iva = toNumberOrNull(data.iva ?? data.IVA);
        const costo = toNumberOrNull(costoRaw);
        const basePrice = pVenta;
        const utilidadCalculada =
          Number.isFinite(basePrice) || Number.isFinite(costo)
            ? Number((basePrice ?? 0) - (costo ?? 0))
            : null;
        const utilidad = Number.isFinite(toNumberOrNull(utilidadRaw))
          ? toNumberOrNull(utilidadRaw)
          : utilidadCalculada;
        const margenCalculado =
          Number.isFinite(basePrice) && basePrice !== 0 && Number.isFinite(utilidad)
            ? Number((utilidad / basePrice).toFixed(3))
            : null;
        const margen = Number.isFinite(toNumberOrNull(margenRaw))
          ? toNumberOrNull(margenRaw)
          : margenCalculado;
        const createdAt = data.createdAt ?? data.CreatedAt ?? null;
        const fechaAlta = data.fechaAlta ?? data.FechaAlta ?? null;
        const fecha = data.fecha ?? data.Fecha ?? null;
        const fechaAltaTexto = safeString(
          data.fechaAltaTexto ?? data.FechaAltaTexto ?? data.fechaTexto ?? data.FechaTexto ?? ""
        ).trim();
        const fechaTexto = safeString(data.fechaTexto ?? data.FechaTexto ?? "").trim();
        const descripcionLower = descripcion.toLowerCase();
        const codigoUpper = codigo.toUpperCase();
        const _searchKey = `${codigo} ${descripcion}`.toLowerCase().trim();

        return {
          id: docSnap.id,
          codigo,
          descripcion,
          color,
          talla,
          proveedor,
          tipo,
          status: statusCanon,
          statusCanon,
          disponibilidad: normalizeDisponibilidad(
            safeString((data.disponibilidadCanon ?? data.disponibilidad ?? data.Disponibilidad ?? "")).trim(),
            statusCanon
          ),
          disponibilidadCanon: normalizeDisponibilidad(
            safeString((data.disponibilidadCanon ?? data.disponibilidad ?? data.Disponibilidad ?? "")).trim(),
            statusCanon
          ),
          precio,
          pVenta,
          precioConIva,
          iva,
          costo,
          margen,
          utilidad,
          createdAt,
          fechaAlta,
          fecha,
          fechaAltaTexto,
          fechaTexto,
          descripcionLower,
          codigoUpper,
          _searchKey
        };
      };

      const getSearchInput = () => safeString(prendasSearch.value);
      const getSearchTerm = () => normalizeText(prendasSearch.value);
      const getSearchRaw = () => safeString(prendasSearch.value).trim();
      const normalizeSelectValue = (value) => (isAllFilter(value) ? null : value);
      const getDateRangeFromFilters = (yearValue, monthValue) => {
        const year = Number(yearValue);
        if (!Number.isInteger(year) || year < 1900) {
          return null;
        }

        const month = Number(monthValue);
        if (Number.isInteger(month) && month >= 1 && month <= 12) {
          return {
            start: new Date(year, month - 1, 1, 0, 0, 0, 0),
            end: new Date(year, month, 1, 0, 0, 0, 0),
            granularity: "month"
          };
        }

        return {
          start: new Date(year, 0, 1, 0, 0, 0, 0),
          end: new Date(year + 1, 0, 1, 0, 0, 0, 0),
          granularity: "year"
        };
      };

      const populateYearFilter = () => {
        if (!prendasYear) return;
        const current = prendasYear.value;
        const thisYear = new Date().getFullYear();
        const years = [];
        for (let year = thisYear; year >= PRENDAS_YEAR_MIN; year -= 1) {
          years.push(year);
        }
        prendasYear.innerHTML = '<option value="">Todos</option>';
        years.forEach((year) => {
          const option = document.createElement("option");
          option.value = String(year);
          option.textContent = String(year);
          prendasYear.appendChild(option);
        });
        prendasYear.value = years.includes(Number(current)) ? current : "";
      };

      const populateMonthFilter = () => {
        if (!prendasMonth) return;
        const current = prendasMonth.value;
        prendasMonth.innerHTML = '<option value="">Todos</option>';
        MONTH_OPTIONS.forEach(({ value, label }) => {
          const option = document.createElement("option");
          option.value = String(value);
          option.textContent = `${String(value).padStart(2, "0")} - ${label}`;
          prendasMonth.appendChild(option);
        });
        prendasMonth.value = MONTH_OPTIONS.some(({ value }) => String(value) === current)
          ? current
          : "";
      };

      const syncDateFilterUi = () => {
        if (!prendasYear || !prendasMonth) return;
        const hasYear = Boolean(safeString(prendasYear.value).trim());
        prendasMonth.disabled = !hasYear;
        if (!hasYear) {
          prendasMonth.value = "";
        }
      };

      const clearFiltersUi = () => {
        prendasSearch.value = "";
        if (prendasYear) prendasYear.value = "";
        if (prendasMonth) prendasMonth.value = "";
        prendasPrecioMin.value = "";
        prendasPrecioMax.value = "";
        if (prendasPrecioSin) prendasPrecioSin.checked = true;
        syncDateFilterUi();
      };

      const clearHeaderFilters = () => {
        prendasState.filters.header = createEmptyHeaderFilters();
        updateHeaderFilterButtonsState();
      };

      const looksLikeCodeSearch = (value) => {
        const raw = safeString(value).trim().toUpperCase();
        if (!raw) return false;
        return raw.startsWith("HA") || raw.includes("/") || raw.includes("-");
      };

      const getCurrentGlobalFilters = () => ({
        searchText: getSearchRaw(),
        year: safeString(prendasYear?.value).trim(),
        month: safeString(prendasMonth?.value).trim(),
        priceMin: toNumberOrNull(prendasPrecioMin.value),
        priceMax: toNumberOrNull(prendasPrecioMax.value),
        includeNoPrice: prendasPrecioSin?.checked ?? true
      });

      const getCurrentFilters = () => ({
        global: getCurrentGlobalFilters(),
        header: prendasState.filters.header
      });

      const isHeaderFilterActive = (key) => {
        if (key === HEADER_RANGE_KEY) {
          return (
            prendasState.filters.header.pventaMin !== null ||
            prendasState.filters.header.pventaMax !== null
          );
        }
        return (prendasState.filters.header[key]?.size || 0) > 0;
      };

      const applyGlobalFilters = (rows, globalFilters) => {
        const searchText = normalizeText(globalFilters.searchText);
        const dateRange = getDateRangeFromFilters(globalFilters.year, globalFilters.month);
        return rows.filter((item) => {
          const precio = toNum(item.pVenta);
          const isNoPrice = precio === null || precio === 0;
          if (isNoPrice && !globalFilters.includeNoPrice) {
            return false;
          }
          if (!isNoPrice) {
            if (globalFilters.priceMin != null && precio < globalFilters.priceMin) return false;
            if (globalFilters.priceMax != null && precio > globalFilters.priceMax) return false;
          }
          if (dateRange?.start && dateRange?.end && !isInDateRange(item, dateRange)) {
            return false;
          }
          if (!searchText) return true;
          const codigo = normalizeFilterValue(item.codigo);
          const descripcion = normalizeFilterValue(item.descripcion);
          if (looksLikeCodeSearch(searchText)) {
            return codigo.toUpperCase().startsWith(searchText.toUpperCase());
          }
          return descripcion.includes(searchText);
        });
      };

      const applyHeaderFilters = (rows, headerFilters) =>
        rows.filter((item) => {
          const hasChecklistMatch = HEADER_FILTER_KEYS.every((key) => {
            const selected = headerFilters[key];
            if (!selected || !selected.size) return true;
            const itemValue = normalizeFilterValue(item[key]);
            return selected.has(itemValue);
          });
          if (!hasChecklistMatch) return false;
          const hasPriceRange = headerFilters.pventaMin != null || headerFilters.pventaMax != null;
          if (!hasPriceRange) return true;
          const price = toNum(item.pVenta);
          if (price === null) return false;
          if (headerFilters.pventaMin != null && price < headerFilters.pventaMin) return false;
          if (headerFilters.pventaMax != null && price > headerFilters.pventaMax) return false;
          return true;
        });

      const applyAllFilters = (rows) => {
        const globalFilters = getCurrentGlobalFilters();
        prendasState.filters.global = globalFilters;
        const rowsAfterGlobal = applyGlobalFilters(rows, globalFilters);
        prendasState.rowsAfterGlobal = rowsAfterGlobal;
        const rowsAfterAll = applyHeaderFilters(rowsAfterGlobal, prendasState.filters.header);
        prendasState.rowsAfterAll = rowsAfterAll;
        return rowsAfterAll;
      };

      const hasActiveFilters = (filters) => {
        if (!filters) return false;
        const globalFilters = filters.global || {};
        const headerFilters = filters.header || {};
        const hasSearch = Boolean(safeString(globalFilters.searchText).trim());
        const hasDate = Boolean(globalFilters.year);
        const hasPriceRange = globalFilters.priceMin !== null || globalFilters.priceMax !== null;
        const excludeNoPrice = globalFilters.includeNoPrice === false;
        const hasHeaderFilters = HEADER_FILTER_KEYS.some((key) => (headerFilters[key]?.size || 0) > 0);
        const hasHeaderPrice = headerFilters.pventaMin !== null || headerFilters.pventaMax !== null;
        return hasSearch || hasDate || hasPriceRange || excludeNoPrice || hasHeaderFilters || hasHeaderPrice;
      };

      const getUniqueOptions = (rows, key) => {
        const set = new Set();
        rows.forEach((row) => {
          const value = safeString(row[key]).trim();
          if (value) set.add(value);
        });
        return [...set].sort((a, b) => a.localeCompare(b, "es", { sensitivity: "base" }));
      };

      const handleIndexError = (error) => {
        const message = error?.message || "";
        const isIndexError =
          error?.code === "failed-precondition" ||
          /requires an index/i.test(message) ||
          /indexes/i.test(message);
        if (!isIndexError) {
          return false;
        }
        console.warn("[Prendas] Index error", error);
        return true;
      };

      const updateHeaderFilterButtonsState = () => {
        headerFilterButtons.forEach((button) => {
          const key = button.dataset.openHeaderFilter;
          button.classList.toggle("active", isHeaderFilterActive(key));
        });
      };

      const closeHeaderPopover = () => {
        if (prendasState.headerPopover?.container) {
          prendasState.headerPopover.container.remove();
        }
        prendasState.headerPopover = null;
      };

      const renderHeaderFilterPopover = (key, anchorButton) => {
        closeHeaderPopover();
        const container = document.createElement("div");
        container.className = "filter-popover";

        const rect = anchorButton.getBoundingClientRect();
        container.style.top = `${window.scrollY + rect.bottom + 6}px`;
        container.style.left = `${window.scrollX + rect.left}px`;

        if (key === HEADER_RANGE_KEY) {
          const currentMin = prendasState.filters.header.pventaMin;
          const currentMax = prendasState.filters.header.pventaMax;
          container.innerHTML = `
            <div class="popover-head"><p class="popover-title">Filtrar P. Venta</p></div>
            <div class="range-fields">
              <input type="number" min="0" step="0.01" placeholder="M√≠nimo" value="${currentMin ?? ""}" data-range-min />
              <input type="number" min="0" step="0.01" placeholder="M√°ximo" value="${currentMax ?? ""}" data-range-max />
            </div>
            <div class="hint" data-range-hint></div>
            <div class="actions">
              <button type="button" data-apply>Aplicar</button>
              <button type="button" class="secondary" data-clear>Limpiar</button>
            </div>
          `;
          document.body.appendChild(container);
          const minInput = container.querySelector("[data-range-min]");
          const maxInput = container.querySelector("[data-range-max]");
          const hintEl = container.querySelector("[data-range-hint]");

          container.querySelector("[data-clear]").addEventListener("click", async () => {
            prendasState.filters.header.pventaMin = null;
            prendasState.filters.header.pventaMax = null;
            closeHeaderPopover();
            await applyFilters();
          });

          container.querySelector("[data-apply]").addEventListener("click", async () => {
            let minValue = toNumberOrNull(minInput.value);
            let maxValue = toNumberOrNull(maxInput.value);
            if (minValue !== null && maxValue !== null && minValue > maxValue) {
              [minValue, maxValue] = [maxValue, minValue];
              hintEl.textContent = "Se ajust√≥ el rango autom√°ticamente (m√≠n ‚Üî m√°x).";
            }
            prendasState.filters.header.pventaMin = minValue;
            prendasState.filters.header.pventaMax = maxValue;
            closeHeaderPopover();
            await applyFilters();
          });

          prendasState.headerPopover = { key, container };
          return;
        }

        const options = prendasState.uniqueOptions[key] || [];
        const selected = new Set(prendasState.filters.header[key] || []);
        container.innerHTML = `
          <div class="popover-head"><p class="popover-title">Filtrar ${key}</p></div>
          <div class="search-wrap"><input type="text" placeholder="Buscar..." data-filter-search /></div>
          <div class="meta" data-filter-count></div>
          <label class="option-all"><input type="checkbox" data-select-all /> Seleccionar todo</label>
          <div class="options" data-options></div>
          <div class="actions">
            <button type="button" data-apply>Aplicar</button>
            <button type="button" class="secondary" data-clear>Limpiar</button>
          </div>
        `;
        document.body.appendChild(container);

        const optionsEl = container.querySelector("[data-options]");
        const searchEl = container.querySelector("[data-filter-search]");
        const selectAllEl = container.querySelector("[data-select-all]");
        const countEl = container.querySelector("[data-filter-count]");

        const updateCounters = () => {
          const total = options.length;
          const selectedCount = selected.size;
          countEl.textContent = `(${selectedCount} seleccionados / ${total} total)`;
          selectAllEl.checked = total > 0 && selectedCount === total;
        };

        const refreshList = () => {
          const q = normalizeText(searchEl.value);
          const visible = options.filter((value) => normalizeText(value).includes(q));
          optionsEl.textContent = "";
          visible.forEach((value) => {
            const row = document.createElement("label");
            row.className = "option-row";
            const checked = selected.has(normalizeFilterValue(value));
            row.innerHTML = `<input type="checkbox" value="${value}" ${checked ? "checked" : ""} /> ${value}`;
            const checkbox = row.querySelector("input");
            checkbox.addEventListener("change", () => {
              const normalized = normalizeFilterValue(value);
              if (checkbox.checked) selected.add(normalized);
              else selected.delete(normalized);
              updateCounters();
            });
            optionsEl.appendChild(row);
          });
          updateCounters();
        };

        selectAllEl.addEventListener("change", () => {
          if (selectAllEl.checked) {
            options.forEach((value) => selected.add(normalizeFilterValue(value)));
          } else {
            selected.clear();
          }
          refreshList();
        });

        searchEl.addEventListener("input", refreshList);

        container.querySelector("[data-clear]").addEventListener("click", async () => {
          prendasState.filters.header[key] = new Set();
          closeHeaderPopover();
          await applyFilters();
        });

        container.querySelector("[data-apply]").addEventListener("click", async () => {
          prendasState.filters.header[key] = selected;
          closeHeaderPopover();
          await applyFilters();
        });

        prendasState.headerPopover = { key, container };
        refreshList();
      };

      const loadBaseRows = async () => {
        if (prendasState.baseRows.length) {
          return prendasState.baseRows;
        }
        let cursor = null;
        let hasMore = true;
        const rows = [];
        while (hasMore) {
          const constraints = [orderBy(documentId(), "asc"), limit(PRENDAS_COUNT_BATCH_SIZE)];
          if (cursor) constraints.splice(1, 0, startAfter(cursor));
          const snap = await getDocs(query(prendas2025Ref, ...constraints));
          if (snap.empty) {
            hasMore = false;
            break;
          }
          snap.docs.forEach((docSnap) => rows.push(normalizeDoc(docSnap)));
          cursor = snap.docs[snap.docs.length - 1];
          if (snap.docs.length < PRENDAS_COUNT_BATCH_SIZE) {
            hasMore = false;
          }
        }
        prendasState.baseRows = rows.sort(compareItemsByDateDesc);
        return prendasState.baseRows;
      };

      const resetPrendasState = () => {
        prendasState.filtered = [];
        prendasState.rowsAfterGlobal = [];
        prendasState.rowsAfterAll = [];
        prendasState.isDone = false;
        prendasState.filtersActive = false;
        prendasState.showingTotal = null;
        prendasState.queryKey = "";
        prendasState.pageIndex = 0;
        prendasState.hasNextPage = false;
        prendasState.filters.global = getCurrentGlobalFilters();
        prendasState.filters.header = createEmptyHeaderFilters();
        prendasState.uniqueOptions = {};
        closeHeaderPopover();
        resetCounters();
      };

      const renderLoadingPlaceholder = () => {
        if (!prendasTbody) return;
        prendasTbody.textContent = "";
        const row = document.createElement("tr");
        const cell = document.createElement("td");
        cell.colSpan = 13;
        cell.textContent = "Cargando base de datos...";
        row.appendChild(cell);
        prendasTbody.appendChild(row);
        setCounter(0, prendasState.showingTotal);
      };

      const refreshExactCounts = (rowsAfterAll) => {
        const total = rowsAfterAll.length;
        const nuevos = rowsAfterAll.filter((item) => isNew(getPrendaDate(item))).length;
        const existentes = total - nuevos;
        setApproxCounts({ total, nuevos, existentes, isApprox: false });
      };

      const getLoadingMessageByReason = (reason) => {
        if (["filters", "filters-clear", "search-clear"].includes(reason)) {
          return "Aplicando filtros...";
        }
        if (["pagination-prev", "pagination-next"].includes(reason)) {
          return "Cargando p√°gina...";
        }
        if (reason === "page-size") {
          return "Actualizando cantidad por p√°gina...";
        }
        return "Cargando base de datos...";
      };

      const loadPrendasPage = async ({
        pageIndex = 0,
        reset = false,
        reason = "manual"
      } = {}) => {
        if (prendasState.isLoadingInitial) {
          return;
        }
        setSkuSearchMode(false);
        setPrendasAlert("");
        prendasState.isLoadingInitial = true;
        setLoading(true, getLoadingMessageByReason(reason));
        try {
          if (reset) {
            prendasState.pageIndex = 0;
            renderLoadingPlaceholder();
          }
          const baseRows = await loadBaseRows();
          const rowsAfterAll = applyAllFilters(baseRows);
          HEADER_FILTER_KEYS.forEach((key) => {
            prendasState.uniqueOptions[key] = getUniqueOptions(prendasState.rowsAfterGlobal, key);
          });
          updateHeaderFilterButtonsState();
          const pageSize = getPageSize();
          const totalRows = rowsAfterAll.length;
          const totalPages = Math.max(1, Math.ceil(totalRows / pageSize));
          const safePageIndex = Math.min(Math.max(pageIndex, 0), totalPages - 1);
          const start = safePageIndex * pageSize;
          const items = rowsAfterAll.slice(start, start + pageSize);

          prendasState.filtered = items;
          prendasState.pageIndex = safePageIndex;
          prendasState.hasNextPage = safePageIndex < totalPages - 1;
          prendasState.filtersActive = hasActiveFilters(getCurrentFilters());
          prendasState.showingTotal = totalRows;

          await renderDocs(items);
          refreshExactCounts(rowsAfterAll);

          if (prendasState.filtersActive && !items.length) {
            setPrendasAlert("No hay resultados con los filtros actuales.");
          }
        } catch (error) {
          console.error(error);
          setPrendasAlert("No se pudo cargar la base de datos de c√≥digos.");
        } finally {
          prendasState.isLoadingInitial = false;
          setLoading(false);
          updatePaginationUi();
        }
      };

      const applyFilters = async () => {
        await loadPrendasPage({ reset: true, reason: "filters" });
      };


      const normalizeFilterValue = (value) => normalizeText(value);
      const toNum = (value) => {
        const parsed = Number(value);
        return Number.isFinite(parsed) ? parsed : null;
      };

      const getPageSize = () => {
        const selected = Number(prendasPageSize?.value);
        if (Number.isFinite(selected) && selected > 0) {
          return selected;
        }
        return PRENDAS_PAGE_SIZE_DEFAULT;
      };

      const renderRowsChunked = (
        rows,
        tbody,
        chunkSize = PRENDAS_RENDER_CHUNK,
        token
      ) =>
        new Promise((resolve) => {
          let index = 0;
          const appendChunk = () => {
            if (token && token !== prendasState.renderToken) {
              resolve(0);
              return;
            }
            const fragment = document.createDocumentFragment();
            for (let i = 0; i < chunkSize && index < rows.length; i += 1) {
              fragment.appendChild(createPrendaRow(rows[index]));
              index += 1;
            }
            tbody.appendChild(fragment);
            if (index < rows.length) {
              requestAnimationFrame(appendChunk);
              return;
            }
            resolve(0);
          };
          requestAnimationFrame(appendChunk);
        });

      const buildBadge = (text, className) => {
        const badge = document.createElement("span");
        badge.className = `badge ${className}`;
        badge.textContent = text;
        return badge;
      };

      const createPrendaRow = (item) => {
        const codigo = safeString(item.codigo || item.code) || "--";
        const descripcion = safeString(item.descripcion) || "--";
        const tipo = safeString(item.tipo) || "--";
        const color = safeString(item.color) || "--";
        const talla = safeString(item.talla) || "--";
        const proveedor = safeString(item.proveedor) || "--";
        const statusCell = renderStatusCell(item.statusCanon || item.status);
        const disponibilidadCell = renderDisponibilidadCell(item.disponibilidadCanon || item.disponibilidad, item.statusCanon || item.status);
        const fecha = formatDateCell(item);
        const pVenta = formatMoney(item.pVenta);
        const costo = formatMoney(item.costo);
        const margen = formatPercent(item.margen);
        const utilidad = formatMoney(item.utilidad);

        const row = document.createElement("tr");
        row.className = isNew(getPrendaDate(item)) ? "row-new" : "row-old";
        const cells = [codigo, descripcion, tipo, color, talla, proveedor, statusCell, disponibilidadCell, fecha, pVenta, costo, margen, utilidad];
        cells.forEach((value, index) => {
          if (value instanceof HTMLElement) {
            if (index >= 10) value.classList.add("admin-only");
            row.appendChild(value);
            return;
          }
          const cell = document.createElement("td");
          cell.textContent = value;
          if (index >= 10) cell.classList.add("admin-only");
          row.appendChild(cell);
        });
        return row;
      };

      const renderDocs = async (rows) => {
        prendasState.renderToken += 1;
        const token = prendasState.renderToken;
        const showingTotal = Number.isFinite(prendasState.showingTotal)
          ? prendasState.showingTotal
          : null;
        setCounter(rows.length, showingTotal);
        updatePaginationUi();

        prendasTbody.textContent = "";
        if (!rows.length) {
          let emptyNode = null;
          if (prendasEmptyRow) {
            emptyNode = prendasEmptyRow instanceof HTMLTemplateElement
              ? prendasEmptyRow.content.cloneNode(true)
              : prendasEmptyRow.cloneNode(true);
          }
          if (!emptyNode) {
            const emptyRow = document.createElement("tr");
            const cell = document.createElement("td");
            cell.colSpan = 13;
            cell.textContent = "No hay resultados con los filtros actuales.";
            emptyRow.appendChild(cell);
            emptyNode = emptyRow;
          }
          prendasTbody.appendChild(emptyNode);
          setCounter(0, showingTotal);
          return;
        }
        await renderRowsChunked(rows, prendasTbody, PRENDAS_RENDER_CHUNK, token);
      };

      const setSkuSearchMode = (enabled) => {
        prendasState.isSkuSearch = enabled;
        updatePaginationUi();
      };

      const fetchBySku = async (rawInput) => {
        const rawUpper = safeString(rawInput).trim().toUpperCase();
        const normalizedSku = normalizeSku(rawUpper);
        if (!rawUpper) return null;
        const directSnap = await getDoc(doc(db, PRENDAS_2025_COLLECTION, normalizedSku));
        if (directSnap.exists()) return normalizeDoc(directSnap);
        const altSnap = await getDoc(doc(db, PRENDAS_2025_COLLECTION, rawUpper));
        if (altSnap.exists()) return normalizeDoc(altSnap);
        return null;
      };

      const runSkuSearch = async (rawInput) => {
        const rawUpper = safeString(rawInput).trim().toUpperCase();
        if (!rawUpper) return;
        setSkuSearchMode(true);
        setLoading(true, "Buscando c√≥digo...");
        try {
          const result = await fetchBySku(rawUpper);
          const items = result ? [result] : [];
          prendasState.filtered = items;
          prendasState.showingTotal = items.length;
          prendasState.pageIndex = 0;
          prendasState.hasNextPage = false;
          await renderDocs(items);
          refreshExactCounts(items);
        } finally {
          setLoading(false);
        }
      };

      const ensureRequired = () => {
        if (!registroProveedor.value || !registroProducto.value || !registroColor.value || !registroTalla.value) {
          setRegistroStatus("Completa Proveedor, Producto, Color y Talla.", "error");
          return false;
        }
        return true;
      };

      const getSelectedName = (selectEl) => {
        const option = selectEl.options[selectEl.selectedIndex];
        return option?.dataset?.nombre || option?.textContent?.split(" - ")[1] || option?.textContent || "";
      };

      const HISTORICOS_URL = "../Data/codigos_historicos.json";
      let historicosCache = null;

      const loadHistoricosMap = async () => {
        if (historicosCache) {
          return historicosCache;
        }
        historicosCache = fetch(HISTORICOS_URL)
          .then((response) => {
            if (!response.ok) {
              throw new Error("No se pudo cargar el hist√≥rico de c√≥digos.");
            }
            return response.json();
          })
          .then((codes) => {
            const maxPorKey = {};
            const pattern = /^HA(\d+)([A-Z])(\d{3})\//i;
            codes.forEach((code) => {
              const match = pattern.exec(String(code).trim().toUpperCase());
              if (!match) return;
              const key = `prov${match[1]}_tipo${match[2]}`;
              const seq = Number(match[3]);
              if (!Number.isFinite(seq)) return;
              if (!maxPorKey[key] || seq > maxPorKey[key]) {
                maxPorKey[key] = seq;
              }
            });
            return maxPorKey;
          })
          .catch((error) => {
            console.warn("No se pudo cargar el hist√≥rico de c√≥digos.", error);
            return {};
          });
        return historicosCache;
      };

      const getNextCounter = async (providerCode, typeCode) => {
        const key = `prov${providerCode}_tipo${typeCode}`;
        const counterRef = doc(db, "counters", key);

        return runTransaction(db, async (transaction) => {
          const snapshot = await transaction.get(counterRef);
          const data = snapshot.data() || {};
          let counterValue = Number(data.value);

          if (!Number.isFinite(counterValue)) {
          counterValue = Number(data.lastNumber);
          }

          if (!Number.isFinite(counterValue)) {
          const maxPorKey = await loadHistoricosMap();
          counterValue = Number(maxPorKey[key] ?? 0);
          }
          if (!Number.isFinite(counterValue)) {
            throw new Error(`Contador inv√°lido para ${key}. Revisa counters/${key}.`);
          }
          console.log("COUNTER READ", { key, data, counterValue });
          const nextValue = counterValue + 1;
          transaction.set(counterRef, { value: nextValue, lastNumber: nextValue }, { merge: true });
          return { nextValue, key };
        });
      };

      registroForm.addEventListener("submit", async (event) => {
        event.preventDefault();
        setRegistroStatus("");

        if (!ensureRequired()) {
          return;
        }

        const providerCode = registroProveedor.value;
        const typeCode = registroProducto.value;
        const colorClave = registroColor.value;
        const tallaClave = registroTalla.value;
        try {
          registroSubmit.disabled = true;
          const { nextValue, key } = await getNextCounter(providerCode, typeCode);
          const consecutivo = String(nextValue).padStart(3, "0");
          const codigo = `HA${providerCode}${typeCode}${consecutivo}/${colorClave}-${tallaClave}`;
          console.info(`Generando c√≥digo ${codigo} para counter ${key}.`);

          const costoValue = Number(document.getElementById("registro-costo").value);
          const createdByValue = document.getElementById("registro-created-by").value.trim();
          const detallesValue = registroDetalles.value.trim();
          const tipoNombre = getSelectedName(registroProducto).trim();
          const proveedorNombre = getSelectedName(registroProveedor).trim();
          const colorNombre = getSelectedName(registroColor).trim();
          const tallaNombre = getSelectedName(registroTalla).trim();
          const descripcion = [tipoNombre, proveedorNombre, colorNombre, tallaNombre]
            .filter(Boolean)
            .join(" ");

          const data = {
            codigo,
            proveedor: providerCode,
            tipo: typeCode,
            color: colorClave,
            talla: tallaClave,
            descripcion: descripcion || null,
            detalles: detallesValue || null,
            costo: Number.isFinite(costoValue) ? costoValue : 0,
            code: codigo,
            providerCode,
            typeCode,
            seqNumber: nextValue,
            colorCode: colorClave,
            sizeCode: tallaClave,
            creadoPor: createdByValue || null,
            createdAt: serverTimestamp()
          };

          const codeQuery = query(prendasRef, where("code", "==", codigo));
          const legacyQuery = query(prendasRef, where("codigo", "==", codigo));
          const [codeSnapshot, legacySnapshot] = await Promise.all([
            getDocs(codeQuery),
            getDocs(legacyQuery)
          ]);
          const duplicateFound = !codeSnapshot.empty || !legacySnapshot.empty;

          await addDoc(prendasRef, data);

          registroCodigo.textContent = codigo;
          registroResult.classList.remove("hidden");
          if (duplicateFound) {
            setRegistroStatus("C√≥digo ya existe (duplicado).", "warning");
          } else {
            setRegistroStatus("Prenda guardada correctamente.", "success");
          }
        } catch (error) {
          const message =
            error?.message?.includes("contador") || error?.message?.includes("Contador")
              ? error.message
              : "No se pudo generar el c√≥digo. Intenta nuevamente.";
          setRegistroStatus(message, "error");
          console.error(error);
        } finally {
          registroSubmit.disabled = false;
        }
      });

      registroCopy.addEventListener("click", async () => {
        try {
          await navigator.clipboard.writeText(registroCodigo.textContent.trim());
          setRegistroStatus("C√≥digo copiado al portapapeles.", "success");
        } catch (error) {
          setRegistroStatus("No se pudo copiar el c√≥digo.", "error");
          console.error(error);
        }
      });

      registroReset.addEventListener("click", () => {
        registroForm.reset();
        registroResult.classList.add("hidden");
        setRegistroStatus("");
      });

      zplForm.addEventListener("submit", (event) => {
        event.preventDefault();
        setZplStatus("");

        const codigo = document.getElementById("zpl-codigo").value.trim();
        const cantidadValue = Number(document.getElementById("zpl-cantidad").value);
        const cantidad = Number.isFinite(cantidadValue) && cantidadValue > 0 ? cantidadValue : 1;

        const formatoValido = CODE_PATTERN.test(codigo.toUpperCase());
        if (!codigo || !formatoValido) {
          setZplStatus("Ingresa un c√≥digo v√°lido (HA{#}{A}{NNN}/COLOR-TALLA).", "error");
          zplOutput.classList.add("hidden");
          return;
        }

        const template = `^XA
^CF0,40
^FO30,30^FD${codigo}^FS
^CF0,30
^FO30,90^FDPRECIO$^FS
^FO30,140^BQN,2,6^FDLA,${codigo}^FS
^XZ`;

        const zpl = Array.from({ length: cantidad }, () => template).join("\n");
        zplTextarea.value = zpl;
        zplOutput.classList.remove("hidden");
        setZplStatus("ZPL generado correctamente.", "success");
      });

      zplCopy.addEventListener("click", async () => {
        try {
          await navigator.clipboard.writeText(zplTextarea.value);
          setZplStatus("ZPL copiado al portapapeles.", "success");
        } catch (error) {
          setZplStatus("No se pudo copiar el ZPL.", "error");
          console.error(error);
        }
      });

      // ADMIN DB MODE START
      const DB_TAB_HASH = "#base-datos-codigos";
      const verifyAdminPassword = httpsCallable(functions, "verifyAdminPassword");
      const backfillSearchTokens = httpsCallable(functions, "backfillSearchTokens");

      const getAdminSession = () => {
        const raw = sessionStorage.getItem(ADMIN_SESSION_KEY);
        if (!raw) return null;
        try {
          const session = JSON.parse(raw);
          if (!session?.sessionId || !session?.expiresAt) return null;
          if (Date.now() > session.expiresAt) {
            sessionStorage.removeItem(ADMIN_SESSION_KEY);
            return null;
          }
          return session;
        } catch (error) {
          console.warn("Sesi√≥n admin inv√°lida, limpiando.", error);
          sessionStorage.removeItem(ADMIN_SESSION_KEY);
          return null;
        }
      };

      const setAdminSession = ({ sessionId, expiresAt }) => {
        sessionStorage.setItem(
          ADMIN_SESSION_KEY,
          JSON.stringify({ sessionId, expiresAt })
        );
      };

      const clearAdminSession = () => {
        sessionStorage.removeItem(ADMIN_SESSION_KEY);
      };

      const getAdminViewEnabled = () =>
        sessionStorage.getItem(ADMIN_VIEW_KEY) === "1";

      const setAdminViewEnabled = (enabled) => {
        sessionStorage.setItem(ADMIN_VIEW_KEY, enabled ? "1" : "0");
      };

      const setAdminLoginStatus = (message, type = "") => {
        if (!adminLoginStatus) return;
        adminLoginStatus.textContent = message;
        adminLoginStatus.className = `status ${type}`.trim();
      };

      const setAdminBackfillStatus = (message, type = "") => {
        if (!adminBackfillStatus) return;
        adminBackfillStatus.textContent = message;
        adminBackfillStatus.className = `status ${type}`.trim();
      };

      let adminPanelVisible = false;

      const setAdminPanelVisible = (visible) => {
        adminPanelVisible = visible;
        if (adminPanel) {
          adminPanel.classList.toggle("hidden", !visible);
        }
        if (adminOptionalToggle) {
          adminOptionalToggle.textContent = visible ? "Ocultar admin" : "Mostrar admin";
        }
      };

      const applyAdminUI = () => {
        const session = getAdminSession();
        const sessionActive = Boolean(session);
        if (!sessionActive) {
          setAdminViewEnabled(false);
        }
        const enabled = sessionActive && getAdminViewEnabled();
        prendasState.isAdmin = enabled;
        if (dbCodigosSection) {
          dbCodigosSection.classList.toggle("admin-enabled", enabled);
        }
        if (adminToggleDb) {
          adminToggleDb.checked = enabled;
          adminToggleDb.disabled = !sessionActive;
        }
        if (adminActions) {
          adminActions.classList.toggle("hidden", !sessionActive);
        }
        if (adminLoginButton) {
          adminLoginButton.classList.toggle("hidden", sessionActive);
        }
        if (adminLogoutButton) {
          adminLogoutButton.classList.toggle("hidden", !sessionActive);
        }
        if (prendasState.filtered.length) {
          renderDocs(prendasState.filtered);
        }
        setAdminPanelVisible(adminPanelVisible);
      };

      const handleAdminToggle = (event) => {
        if (!getAdminSession()) return;
        setAdminViewEnabled(event.target.checked);
        applyAdminUI();
      };

      const handleAdminLogin = async () => {
        const password = safeString(adminPasswordInput?.value).trim();
        if (!password) {
          setAdminLoginStatus("Ingresa la contrase√±a admin.", "error");
          return;
        }
        if (adminLoginButton) {
          adminLoginButton.disabled = true;
        }
        setAdminLoginStatus("Verificando...", "");
        try {
          const response = await verifyAdminPassword({ password });
          const data = response?.data || {};
          if (!data?.sessionId || !data?.expiresAt) {
            throw new Error("Respuesta inv√°lida del servidor.");
          }
          setAdminSession({ sessionId: data.sessionId, expiresAt: data.expiresAt });
          setAdminViewEnabled(true);
          if (adminPasswordInput) {
            adminPasswordInput.value = "";
          }
          setAdminLoginStatus("Modo admin habilitado.", "success");
          applyAdminUI();
        } catch (error) {
          console.error(error);
          setAdminLoginStatus(
            "Servicio admin no disponible / Falta desplegar functions.",
            "error"
          );
        } finally {
          if (adminLoginButton) {
            adminLoginButton.disabled = false;
          }
        }
      };

      const handleAdminLogout = () => {
        clearAdminSession();
        setAdminViewEnabled(false);
        setAdminLoginStatus("Sesi√≥n cerrada.", "");
        setAdminBackfillStatus("");
        applyAdminUI();
      };

      const handleBackfill = async () => {
        const session = getAdminSession();
        if (!session) {
          setAdminBackfillStatus("Inicia sesi√≥n admin para continuar.", "error");
          return;
        }
        if (adminBackfillButton) {
          adminBackfillButton.disabled = true;
        }
        setAdminBackfillStatus("Preparando buscador...", "");
        let cursor = null;
        let processed = 0;
        let updated = 0;
        let skipped = 0;
        try {
          let loops = 0;
          while (loops < 200) {
            const response = await backfillSearchTokens({
              sessionId: session.sessionId,
              cursor
            });
            const data = response?.data || {};
            processed += Number(data.processed || 0);
            updated += Number(data.updated || 0);
            skipped += Number(data.skipped || 0);
            cursor = data.lastDocId || null;
            setAdminBackfillStatus(
              `Procesados: ${processed} ¬∑ Actualizados: ${updated} ¬∑ Omitidos: ${skipped}`,
              ""
            );
            if (!data.hasMore) {
              break;
            }
            loops += 1;
          }
          setAdminBackfillStatus(
            `Listo: ${updated} actualizados, ${skipped} omitidos.`,
            "success"
          );
        } catch (error) {
          console.error(error);
          setAdminBackfillStatus("Error al preparar el buscador.", "error");
        } finally {
          if (adminBackfillButton) {
            adminBackfillButton.disabled = false;
          }
        }
      };

      const handleTabChange = (hash) => {
        if (hash === DB_TAB_HASH) {
          applyAdminUI();
        }
      };

      if (adminToggleDb) {
        adminToggleDb.addEventListener("change", handleAdminToggle);
      }
      if (adminLoginButton) {
        adminLoginButton.addEventListener("click", handleAdminLogin);
      }
      if (adminLogoutButton) {
        adminLogoutButton.addEventListener("click", handleAdminLogout);
      }
      if (adminBackfillButton) {
        adminBackfillButton.addEventListener("click", handleBackfill);
      }
      if (adminOptionalToggle) {
        adminOptionalToggle.addEventListener("click", () => {
          setAdminPanelVisible(!adminPanelVisible);
        });
      }
      if (adminPasswordInput) {
        adminPasswordInput.addEventListener("keydown", (event) => {
          if (event.key === "Enter") {
            event.preventDefault();
            handleAdminLogin();
          }
        });
      }

      window.addEventListener("hashchange", () => {
        handleTabChange(window.location.hash);
      });

      document.querySelectorAll('a.card[href^="#"]').forEach((link) => {
        link.addEventListener("click", (event) => {
          const hash = event.currentTarget.getAttribute("href") || "";
          handleTabChange(hash);
        });
      });
      // ADMIN DB MODE END

      const handleSearchInput = debounce(async () => {
        if (isBooting) return;
        const rawInput = getSearchInput();
        if (!rawInput.trim()) {
          await loadPrendasPage({ reset: true, reason: "search-clear" });
          return;
        }
        if (isFullSku(rawInput)) {
          await runSkuSearch(rawInput);
          return;
        }
        setSkuSearchMode(false);
        await applyFilters();
      }, PRENDAS_SEARCH_DEBOUNCE);

      const handleFilterApply = async () => {
        if (isBooting) return;
        const rawInput = getSearchInput();
        if (rawInput.trim() && isFullSku(rawInput)) {
          await runSkuSearch(rawInput);
          return;
        }
        await applyFilters();
      };

      const handleFilterClear = async () => {
        if (isBooting) return;
        setSkuSearchMode(false);
        clearFiltersUi();
        clearHeaderFilters();
        await loadPrendasPage({ reset: true, reason: "filters-clear" });
      };

      prendasSearch.addEventListener("input", handleSearchInput);
      headerFilterButtons.forEach((button) => {
        button.addEventListener("click", (event) => {
          event.stopPropagation();
          const key = button.dataset.openHeaderFilter;
          if (prendasState.headerPopover?.key === key) {
            closeHeaderPopover();
            return;
          }
          renderHeaderFilterPopover(key, button);
        });
      });
      document.addEventListener("click", (event) => {
        const target = event.target;
        if (prendasState.headerPopover?.container && !prendasState.headerPopover.container.contains(target)) {
          closeHeaderPopover();
        }
      });
      document.addEventListener("keydown", (event) => {
        if (event.key === "Escape") {
          closeHeaderPopover();
        }
      });
      prendasPrecioApply.addEventListener("click", handleFilterApply);
      if (prendasFiltersClear) {
        prendasFiltersClear.addEventListener("click", handleFilterClear);
      }
      if (prendasYear) {
        prendasYear.addEventListener("change", () => {
          syncDateFilterUi();
        });
      }
      if (prendasPageSize) {
        prendasPageSize.addEventListener("change", async () => {
          if (isBooting) return;
          await loadPrendasPage({ reset: true, reason: "page-size" });
        });
      }

      [prendasPrecioMin, prendasPrecioMax].forEach((input) => {
        input.addEventListener("keydown", (event) => {
          if (isBooting) return;
          if (event.key === "Enter") {
            event.preventDefault();
            handleFilterApply();
          }
        });
      });

      if (prendasPrev) {
        prendasPrev.addEventListener("click", async () => {
          if (isBooting) return;
          const prevIndex = Math.max(prendasState.pageIndex - 1, 0);
          await loadPrendasPage({ pageIndex: prevIndex, reason: "pagination-prev" });
        });
      }

      if (prendasNext) {
        prendasNext.addEventListener("click", async () => {
          if (isBooting) return;
          const nextIndex = prendasState.pageIndex + 1;
          await loadPrendasPage({ pageIndex: nextIndex, reason: "pagination-next" });
        });
      }

      const init = async () => {
        isBooting = true;
        resetPrendasState();
        resetCounters();
        populateYearFilter();
        populateMonthFilter();
        clearFiltersUi();
        try {
          setRegistroStatus("Cargando diccionario...");
          registroSubmit.disabled = true;
          setSelectLoading(registroProducto, "Cargando...");
          setSelectLoading(registroProveedor, "Cargando...");
          setSelectLoading(registroColor, "Cargando...");
          setSelectLoading(registroTalla, "Cargando...");

          const dictionary = await loadDictionary();
          const dictionaryReady = !dictionary.empty && dictionary.missing.length === 0;
          if (dictionary.empty) {
            setRegistroStatus("Diccionario vac√≠o: corre el workflow Seed Firestore.", "error");
          } else if (dictionary.missing.length) {
            setRegistroStatus(
              `Faltan datos en: ${dictionary.missing.join(", ")}.`,
              "error"
            );
          } else {
            setRegistroStatus("");
          }

          if (dictionary.tipos.length) {
            fillDictionarySelect(
              registroProducto,
              dictionary.tipos.sort((a, b) => a.clave.localeCompare(b.clave))
            );
          } else {
            setSelectLoading(registroProducto, "Sin opciones disponibles");
          }

          if (dictionary.proveedores.length) {
            fillDictionarySelect(
              registroProveedor,
              dictionary.proveedores.sort((a, b) => a.clave.localeCompare(b.clave))
            );
          } else {
            setSelectLoading(registroProveedor, "Sin opciones disponibles");
          }

          if (dictionary.colores.length) {
            fillDictionarySelect(
              registroColor,
              dictionary.colores.sort((a, b) => a.clave.localeCompare(b.clave))
            );
          } else {
            setSelectLoading(registroColor, "Sin opciones disponibles");
          }

          if (dictionary.tallas.length) {
            fillDictionarySelect(
              registroTalla,
              dictionary.tallas.sort((a, b) => a.clave.localeCompare(b.clave))
            );
          } else {
            setSelectLoading(registroTalla, "Sin opciones disponibles");
          }

          registroSubmit.disabled = !dictionaryReady;
        } catch (error) {
          setRegistroStatus("No pudimos cargar el diccionario.", "error");
          registroSubmit.disabled = true;
          console.error(error);
        } finally {
          // ADMIN DB MODE START
          setAdminPanelVisible(false);
          applyAdminUI();
          handleTabChange(window.location.hash);
          // ADMIN DB MODE END
          setSkuSearchMode(false);
          try {
            const baseSnapshot = await getDocs(query(prendas2025Ref, limit(10)));
            console.log("[Prendas] Base query (sin filtros) docs", {
              collection: PRENDAS_2025_COLLECTION,
              docs: baseSnapshot.size
            });
          } catch (error) {
            console.warn("[Prendas] No se pudo medir query base sin filtros", error);
          }
          try {
            if (typeof loadMetadataCounts === "function") {
              const total = await loadMetadataCounts();
              if (Number.isFinite(total) && !hasActiveFilters(getCurrentFilters())) {
                prendasState.showingTotal = total;
                setCounter(prendasState.filtered.length, total);
              }
            } else {
              console.warn("loadMetadataCounts() no existe, se omite.");
            }
          } catch (error) {
            console.warn("[Prendas] loadMetadataCounts fall√≥", error);
          }
          try {
            console.log("query filters", getCurrentFilters());
            console.log("baseRows", prendasState.baseRows?.length ?? 0, "filtered", prendasState.filtered?.length ?? 0);
            await loadPrendasPage({ reset: true, reason: "init" });
            console.log("baseRows", prendasState.baseRows?.length ?? 0, "filtered", prendasState.filtered?.length ?? 0);
          } finally {
            prendasState.isLoadingInitial = false;
            setLoading(false);
            isBooting = false;
          }
        }
      };

      init();
    </script>
  </body>
</html>
