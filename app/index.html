<!DOCTYPE html>
<html lang="es">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <title>Panel Haruja – v0.0 | Panel</title>
    <style>
      :root {
        color-scheme: light;
        --bg: #f6f7fb;
        --card: #ffffff;
        --text: #1f2937;
        --muted: #6b7280;
        --primary: #1f6feb;
        --primary-dark: #1a55b5;
        --border: #e5e7eb;
        --shadow: 0 10px 24px rgba(15, 23, 42, 0.08);
        --radius: 16px;
      }

      * {
        box-sizing: border-box;
      }

      body {
        margin: 0;
        font-family: "Inter", "Segoe UI", system-ui, -apple-system, sans-serif;
        color: var(--text);
        background: var(--bg);
      }

      .app {
        min-height: 100vh;
        display: flex;
        flex-direction: column;
      }

      header {
        background: var(--card);
        border-bottom: 1px solid var(--border);
        padding: 24px 32px;
      }

      header h1 {
        margin: 0 0 8px;
        font-size: 24px;
      }

      header p {
        margin: 0;
        color: var(--muted);
        font-size: 14px;
      }

      main {
        padding: 32px;
        display: flex;
        flex-direction: column;
        gap: 24px;
      }

      .grid {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(220px, 1fr));
        gap: 20px;
      }

      .card {
        background: var(--card);
        border: 1px solid var(--border);
        border-radius: var(--radius);
        box-shadow: var(--shadow);
        padding: 20px;
        display: flex;
        flex-direction: column;
        gap: 12px;
        text-decoration: none;
        color: inherit;
      }

      .card h2 {
        margin: 0;
        font-size: 18px;
      }

      .card p {
        margin: 0;
        color: var(--muted);
        font-size: 14px;
      }

      .card .cta {
        margin-top: auto;
        font-weight: 600;
        color: var(--primary);
      }

      .section {
        background: var(--card);
        border: 1px solid var(--border);
        border-radius: var(--radius);
        box-shadow: var(--shadow);
        padding: 24px;
      }

      .section h2 {
        margin: 0 0 12px;
        font-size: 20px;
      }

      .section p {
        margin: 0 0 20px;
        color: var(--muted);
        font-size: 14px;
      }

      .form {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(180px, 1fr));
        gap: 16px;
        align-items: end;
      }

      label {
        display: block;
        font-size: 13px;
        color: var(--muted);
        margin-bottom: 6px;
      }

      input {
        width: 100%;
        padding: 10px 12px;
        border-radius: 10px;
        border: 1px solid var(--border);
        font-size: 14px;
      }

      select {
        width: 100%;
        padding: 10px 12px;
        border-radius: 10px;
        border: 1px solid var(--border);
        font-size: 14px;
        background: #fff;
      }

      button {
        padding: 12px 16px;
        border-radius: 12px;
        border: none;
        background: var(--primary);
        color: #fff;
        font-weight: 600;
        cursor: pointer;
      }

      button:hover {
        background: var(--primary-dark);
      }

      .status {
        font-size: 14px;
        color: var(--muted);
        min-height: 20px;
      }

      .status.success {
        color: #15803d;
      }

      .status.error {
        color: #b91c1c;
      }

      .status.warning {
        color: #b45309;
      }

      .result-card {
        margin-top: 16px;
        padding: 16px;
        border-radius: 12px;
        border: 1px solid var(--border);
        background: #f8fafc;
      }

      .result-code {
        font-size: 24px;
        font-weight: 700;
        letter-spacing: 0.5px;
        margin: 8px 0 16px;
      }

      .result-actions {
        display: flex;
        flex-wrap: wrap;
        gap: 12px;
      }

      .muted {
        color: var(--muted);
        font-size: 13px;
      }

      .zpl-output {
        margin-top: 16px;
      }

      textarea {
        width: 100%;
        min-height: 180px;
        padding: 12px;
        border-radius: 12px;
        border: 1px solid var(--border);
        font-size: 13px;
        font-family: "SFMono-Regular", "Consolas", "Liberation Mono", monospace;
      }

      .hidden {
        display: none;
      }

      table {
        width: 100%;
        border-collapse: collapse;
        font-size: 14px;
      }

      th,
      td {
        padding: 10px 12px;
        border-bottom: 1px solid var(--border);
        text-align: left;
      }

      th {
        color: var(--muted);
        font-weight: 600;
      }

      .panel-controls {
        display: flex;
        flex-direction: column;
        gap: 16px;
        margin-bottom: 16px;
      }

      .filters-grid {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(180px, 1fr));
        gap: 12px;
        align-items: end;
      }

      .filters-grid .price-range {
        display: flex;
        gap: 8px;
      }

      .filters-grid .price-range input {
        width: 100%;
      }

      .filters-grid .inline-toggle {
        display: flex;
        align-items: center;
        gap: 10px;
        padding: 10px 12px;
        border-radius: 10px;
        border: 1px solid var(--border);
        background: #f8fafc;
      }

      .filters-grid .inline-toggle input {
        width: auto;
      }

      .counters {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(140px, 1fr));
        gap: 12px;
      }

      .counter-card {
        border-radius: 12px;
        padding: 12px;
        border: 1px solid var(--border);
        background: #f8fafc;
      }

      .counter-card span {
        display: block;
        font-size: 12px;
        color: var(--muted);
      }

      .counter-card strong {
        font-size: 18px;
      }

      .table-wrapper {
        width: 100%;
        overflow-x: auto;
      }

      .badge {
        display: inline-block;
        padding: 4px 8px;
        border-radius: 999px;
        font-size: 12px;
        font-weight: 600;
      }

      .badge-new {
        background: #e0ecff;
        color: #1d4ed8;
      }

      .badge-old {
        background: #e8f5e9;
        color: #166534;
      }

      .badge-sold {
        background: #fee2e2;
        color: #b91c1c;
      }

      .row-new {
        background: #f5f8ff;
      }

      .row-old {
        background: #f3fbf6;
      }

      .loader {
        display: flex;
        align-items: center;
        gap: 10px;
        color: var(--muted);
        font-size: 14px;
      }

      .spinner {
        width: 18px;
        height: 18px;
        border-radius: 50%;
        border: 2px solid #d1d5db;
        border-top-color: var(--primary);
        animation: spin 0.9s linear infinite;
      }

      @keyframes spin {
        to {
          transform: rotate(360deg);
        }
      }

      .alert {
        padding: 12px 16px;
        border-radius: 10px;
        border: 1px solid #fecaca;
        background: #fef2f2;
        color: #991b1b;
        font-size: 14px;
      }

      .pagination {
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin-top: 16px;
        gap: 12px;
        flex-wrap: wrap;
      }

      .pagination span {
        color: var(--muted);
        font-size: 14px;
      }

      .pagination button {
        min-width: 120px;
      }

      #dbCodigosSection .admin-only {
        display: none !important;
      }

      #dbCodigosSection.admin-enabled .admin-only {
        display: revert !important;
      }

      @media (max-width: 600px) {
        header,
        main {
          padding: 20px;
        }
      }
    </style>
  </head>
  <body>
    <div class="app">
      <header>
        <h1>Panel Haruja</h1>
        <p>Gestión rápida de prendas, precios y etiquetas dentro de Tiendanube.</p>
      </header>

      <main>
        <section class="grid">
          <a class="card" href="#registro">
            <h2>Registro de nuevas prendas</h2>
            <p>Carga nuevas prendas y atributos esenciales en minutos.</p>
            <span class="cta">Empezar</span>
          </a>
          <a class="card" href="#precios">
            <h2>Asignar precios</h2>
            <p>Define precios finales por categoría y canal de venta.</p>
            <span class="cta">Configurar</span>
          </a>
          <a class="card" href="#calculadora">
            <h2>Calculadora de precios</h2>
            <p>Calcula márgenes y proyecciones de rentabilidad.</p>
            <span class="cta">Abrir</span>
          </a>
          <a class="card" href="#etiquetas">
            <h2>Impresión de etiquetas (ZPL)</h2>
            <p>Genera etiquetas listas para impresión y control interno.</p>
            <span class="cta">Preparar</span>
          </a>
          <a class="card" href="#base-datos-codigos">
            <h2>Base de datos códigos HarujaGdl</h2>
            <p>Consulta códigos existentes, nuevos y detalles clave de prendas.</p>
            <span class="cta">Abrir</span>
          </a>
        </section>

        <section class="section" id="registro">
          <h2>Registro de nuevas prendas</h2>
          <p>Selecciona los atributos clave para generar el código y guardar la prenda en Firestore.</p>
          <form class="form" id="registro-form">
            <div>
              <label for="registro-producto">Tipo / Producto *</label>
              <select id="registro-producto" name="producto" required>
                <option value="">Seleccionar</option>
              </select>
            </div>
            <div>
              <label for="registro-proveedor">Proveedor *</label>
              <select id="registro-proveedor" name="proveedor" required>
                <option value="">Seleccionar</option>
              </select>
            </div>
            <div>
              <label for="registro-color">Color *</label>
              <select id="registro-color" name="color" required>
                <option value="">Seleccionar</option>
              </select>
            </div>
            <div>
              <label for="registro-talla">Talla *</label>
              <select id="registro-talla" name="talla" required>
                <option value="">Seleccionar</option>
              </select>
            </div>
            <div>
              <label for="registro-costo">Costo (opcional)</label>
              <input id="registro-costo" name="costo" type="number" min="0" step="0.01" placeholder="0" />
            </div>
            <div>
              <label for="registro-created-by">Creado por (opcional)</label>
              <input id="registro-created-by" name="createdBy" type="text" placeholder="Nombre" />
            </div>
            <div>
              <label for="registro-detalles">Detalles (opcional)</label>
              <input id="registro-detalles" name="detalles" type="text" placeholder="Ej: Pelly estampada" />
            </div>
            <button type="submit">Generar código</button>
          </form>
          <p id="registro-status" class="status"></p>
          <div id="registro-result" class="result-card hidden">
            <span class="muted">Código generado</span>
            <div id="registro-codigo" class="result-code">HA00000/--</div>
            <div class="result-actions">
              <button type="button" id="registro-copy">Copiar</button>
              <button type="button" id="registro-reset">Crear otro</button>
            </div>
          </div>
        </section>

        <section class="section" id="etiquetas">
          <h2>Impresión de etiquetas</h2>
          <p>Ingresa el código y la cantidad de etiquetas a generar.</p>
          <form class="form" id="zpl-form">
            <div>
              <label for="zpl-codigo">Código (SKU)</label>
              <input id="zpl-codigo" name="codigo" type="text" placeholder="HA2A007/NG-M" />
            </div>
            <div>
              <label for="zpl-cantidad">Cantidad</label>
              <input id="zpl-cantidad" name="cantidad" type="number" min="1" value="1" />
            </div>
            <button type="submit">Imprimir etiqueta</button>
          </form>
          <p id="zpl-status" class="status"></p>
          <div class="zpl-output hidden" id="zpl-output">
            <label for="zpl-textarea">ZPL generado</label>
            <textarea id="zpl-textarea" readonly></textarea>
            <div class="result-actions" style="margin-top: 12px;">
              <button type="button" id="zpl-copy">Copiar ZPL</button>
            </div>
          </div>
        </section>

        <section class="section" id="base-datos-codigos">
          <div id="dbCodigosSection">
            <h2>Base de datos códigos HarujaGdl</h2>
            <p>Explora la base de prendas 2025 con búsqueda, filtros y estado de novedades.</p>
            <div class="panel-controls">
              <div class="filters-grid">
                <div>
                  <label for="prendas-search">Buscar por código o descripción</label>
                  <input id="prendas-search" type="text" placeholder="Ej: HA12A003 o sudadera" />
                </div>
                <div>
                  <label for="prendas-status">Status</label>
                  <select id="prendas-status">
                    <option value="todos">Todos</option>
                    <option value="disponible">Disponible</option>
                    <option value="vendido">Vendido</option>
                  </select>
                </div>
                <div>
                  <label for="prendas-proveedor">Proveedor</label>
                  <select id="prendas-proveedor">
                    <option value="todos">Todos</option>
                  </select>
                </div>
                <div>
                  <label for="prendas-tipo">Tipo</label>
                  <select id="prendas-tipo">
                    <option value="todos">Todos</option>
                  </select>
                </div>
                <div>
                  <label for="prendas-color">Color</label>
                  <select id="prendas-color">
                    <option value="todos">Todos</option>
                  </select>
                </div>
                <div>
                  <label for="prendas-talla">Talla</label>
                  <select id="prendas-talla">
                    <option value="todos">Todos</option>
                  </select>
                </div>
                <div>
                  <label>Precio (rango)</label>
                  <div class="price-range">
                    <input id="prendas-precio-min" type="number" min="0" placeholder="Mín" />
                    <input id="prendas-precio-max" type="number" min="0" placeholder="Máx" />
                  </div>
                </div>
                <div class="inline-toggle">
                  <input id="prendas-precio-sin" type="checkbox" checked />
                  <label for="prendas-precio-sin">Incluir sin precio</label>
                </div>
                <div>
                  <label>&nbsp;</label>
                  <button type="button" id="prendas-precio-apply">Aplicar filtros</button>
                </div>
                <div class="inline-toggle">
                  <input id="adminToggleDb" type="checkbox" />
                  <label for="adminToggleDb">Modo admin (mostrar costos y márgenes)</label>
                </div>
              </div>
              <div class="counters">
                <div class="counter-card">
                  <span>Total</span>
                  <strong id="prendas-total" data-count-total>0</strong>
                </div>
                <div class="counter-card">
                  <span>Nuevos (7 días)</span>
                  <strong id="prendas-nuevos">0</strong>
                </div>
                <div class="counter-card">
                  <span>Existentes</span>
                  <strong id="prendas-existentes">0</strong>
                </div>
              </div>
            </div>
            <div id="prendas-alert" class="alert hidden"></div>
            <div id="prendas-loader" class="loader hidden" data-db-loader>
              <span class="spinner"></span>
              <span>Cargando base de datos...</span>
            </div>
            <div class="table-wrapper">
              <table id="tablaPrendas" data-prendas-table>
                <thead>
                  <tr>
                    <th>Código</th>
                    <th>Descripción</th>
                    <th>Color</th>
                    <th>Talla</th>
                    <th>Proveedor</th>
                    <th>Status</th>
                    <th>Disponibilidad</th>
                    <th>Fecha</th>
                    <th class="admin-only">(Admin) Costo</th>
                    <th class="admin-only">(Admin) Margen</th>
                    <th class="admin-only">(Admin) Utilidad</th>
                  </tr>
                </thead>
                <tbody id="prendas-tbody" data-prendas-tbody></tbody>
              </table>
              <template id="noResultsRow" data-empty-row>
                <tr>
                  <td colspan="11">No hay resultados con los filtros actuales.</td>
                </tr>
              </template>
            </div>
            <div class="pagination">
              <span id="prendas-showing" data-count-shown>Mostrando 0</span>
              <button type="button" id="prendas-load-more">Cargar más</button>
            </div>
          </div>
        </section>
      </main>
    </div>
    <script type="module">
      import { initializeApp } from "https://www.gstatic.com/firebasejs/9.22.2/firebase-app.js";
      import {
        getFirestore,
        initializeFirestore,
        collection,
        addDoc,
        doc,
        getDoc,
        getDocs,
        query,
        orderBy,
        runTransaction,
        serverTimestamp,
        startAfter,
        where,
        limit,
        getCountFromServer,
        persistentLocalCache
      } from "https://www.gstatic.com/firebasejs/9.22.2/firebase-firestore.js";

      // TODO: Reemplazar estos valores con la configuración real del proyecto Firebase.
      const firebaseConfig = {
        apiKey: "REEMPLAZAR_API_KEY",
        authDomain: "haruja-tiendanube.firebaseapp.com",
        projectId: "haruja-tiendanube",
        storageBucket: "haruja-tiendanube.appspot.com",
        messagingSenderId: "REEMPLAZAR_SENDER_ID",
        appId: "REEMPLAZAR_APP_ID"
      };

      const app = initializeApp(firebaseConfig);
      let db;
      try {
        db = initializeFirestore(app, {
          localCache: persistentLocalCache()
        });
      } catch (error) {
        console.warn(
          "[Firestore] Persistencia no disponible, usando caché en memoria",
          error?.code || error?.message
        );
        db = getFirestore(app);
      }
      const prendasRef = collection(db, "prendas");
      const registroForm = document.getElementById("registro-form");
      const registroStatus = document.getElementById("registro-status");
      const registroResult = document.getElementById("registro-result");
      const registroCodigo = document.getElementById("registro-codigo");
      const registroCopy = document.getElementById("registro-copy");
      const registroReset = document.getElementById("registro-reset");
      const registroSubmit = registroForm.querySelector("button[type='submit']");
      const registroProducto = document.getElementById("registro-producto");
      const registroProveedor = document.getElementById("registro-proveedor");
      const registroColor = document.getElementById("registro-color");
      const registroTalla = document.getElementById("registro-talla");
      const registroDetalles = document.getElementById("registro-detalles");

      const zplForm = document.getElementById("zpl-form");
      const zplStatus = document.getElementById("zpl-status");
      const zplOutput = document.getElementById("zpl-output");
      const zplTextarea = document.getElementById("zpl-textarea");
      const zplCopy = document.getElementById("zpl-copy");

      const prendasSearch = document.getElementById("prendas-search");
      const prendasStatus = document.getElementById("prendas-status");
      const prendasProveedor = document.getElementById("prendas-proveedor");
      const prendasTipo = document.getElementById("prendas-tipo");
      const prendasColor = document.getElementById("prendas-color");
      const prendasTalla = document.getElementById("prendas-talla");
      const prendasPrecioMin = document.getElementById("prendas-precio-min");
      const prendasPrecioMax = document.getElementById("prendas-precio-max");
      const prendasPrecioSin = document.getElementById("prendas-precio-sin");
      const prendasPrecioApply = document.getElementById("prendas-precio-apply");
      const prendasTotal = document.querySelector("[data-count-total]") || document.getElementById("prendas-total");
      const prendasNuevos = document.getElementById("prendas-nuevos");
      const prendasExistentes = document.getElementById("prendas-existentes");
      const prendasTable =
        document.querySelector("[data-prendas-table]") ||
        document.getElementById("tablaPrendas");
      const prendasTbody =
        prendasTable?.querySelector("tbody") ||
        document.querySelector("[data-prendas-tbody]") ||
        document.getElementById("prendas-tbody");
      const prendasShowing =
        document.querySelector("[data-count-shown]") || document.getElementById("prendas-showing");
      const prendasLoadMore = document.getElementById("prendas-load-more");
      const prendasLoader =
        document.querySelector("[data-db-loader]") || document.getElementById("prendas-loader");
      const prendasEmptyRow =
        document.querySelector("[data-empty-row]") || document.getElementById("noResultsRow");
      const prendasAlert = document.getElementById("prendas-alert");
      const prendasPanel = document.getElementById("base-datos-codigos");
      const dbCodigosSection = document.getElementById("dbCodigosSection");
      const adminToggleDb = prendasPanel.querySelector("#adminToggleDb");
      console.assert(prendasTable, "No existe tabla de prendas");
      console.assert(prendasTbody, "No existe tbody de prendas");
      console.assert(prendasLoader, "No existe loader de prendas");
      console.assert(prendasShowing, "No existe contador de prendas mostradas");
      console.assert(prendasTotal, "No existe contador total de prendas");
      console.assert(prendasEmptyRow, "No existe template de filas vacías");

      const setRegistroStatus = (message, type = "") => {
        registroStatus.textContent = message;
        registroStatus.className = `status ${type}`.trim();
      };

      const setZplStatus = (message, type = "") => {
        zplStatus.textContent = message;
        zplStatus.className = `status ${type}`.trim();
      };

      const safeString = (value) => {
        if (value === null || value === undefined) return "";
        return String(value);
      };

      const normalizeText = (value) =>
        safeString(value)
          .toLowerCase()
          .normalize("NFD")
          .replace(/[\u0300-\u036f]/g, "");

      const normalizeSku = (input) =>
        safeString(input)
          .trim()
          .toUpperCase()
          .replace(/\s+/g, " ")
          .replace(/\//g, "__");

      const toNumberOrNull = (value) => {
        if (value === null || value === undefined) return null;
        if (String(value).trim() === "") return null;
        const parsed = Number(value);
        return Number.isFinite(parsed) ? parsed : null;
      };

      const debounce = (fn, wait = 200) => {
        let timeoutId;
        return (...args) => {
          if (timeoutId) {
            clearTimeout(timeoutId);
          }
          timeoutId = setTimeout(() => fn(...args), wait);
        };
      };

      const formatDateDDMMYYYY = (date) => {
        if (!(date instanceof Date) || Number.isNaN(date.getTime())) {
          return "--";
        }
        const day = String(date.getDate()).padStart(2, "0");
        const month = String(date.getMonth() + 1).padStart(2, "0");
        const year = date.getFullYear();
        return `${day}/${month}/${year}`;
      };

      const toDateValue = (value) => {
        if (!value) return null;
        if (value instanceof Date) return value;
        if (typeof value?.toDate === "function") return value.toDate();
        if (typeof value === "number") return new Date(value);
        if (typeof value === "string") {
          const parsed = new Date(value);
          return Number.isNaN(parsed.getTime()) ? null : parsed;
        }
        return null;
      };

      const isNew = (createdAt, days = 7) => {
        const createdDate = toDateValue(createdAt);
        if (!createdDate) return false;
        const diff = Date.now() - createdDate.getTime();
        return diff <= days * 24 * 60 * 60 * 1000;
      };

      const buildOption = ({ clave, valor }) => {
        const option = document.createElement("option");
        option.value = clave;
        option.textContent = `${clave} - ${valor}`;
        option.dataset.nombre = valor;
        return option;
      };

      const setSelectLoading = (selectEl, message) => {
        selectEl.innerHTML = "";
        const option = document.createElement("option");
        option.value = "";
        option.textContent = message;
        selectEl.appendChild(option);
        selectEl.disabled = true;
      };

      const fillSelect = (selectEl, entries) => {
        selectEl.innerHTML = "";
        const placeholder = document.createElement("option");
        placeholder.value = "";
        placeholder.textContent = "Seleccionar";
        selectEl.appendChild(placeholder);
        entries.forEach((item) => selectEl.appendChild(buildOption(item)));
        selectEl.disabled = false;
      };

      const collectOption = (map, codigo, nombre) => {
        if (!codigo) return;
        if (!map.has(codigo)) {
          map.set(codigo, nombre || codigo);
        }
      };

      const COLLECTIONS = {
        tipos: "diccionario_tipos",
        proveedores: "diccionario_proveedores",
        colores: "diccionario_colores",
        tallas: "diccionario_tallas"
      };

      const CODE_PATTERN = /^HA(\d+)([A-Z])(\d{3})\/([A-Z0-9]+)-([A-Z0-9]+)$/;
      const PRENDAS_2025_COLLECTION = "HarujaPrendas_2025";
      const PRENDAS_PAGE_SIZE_FIRST = 50;
      const PRENDAS_PAGE_SIZE_NEXT = 50;
      const PRENDAS_RENDER_CHUNK = 20;
      const PRENDAS_SEARCH_DEBOUNCE = 250;
      const PRENDAS_COUNT_TTL = 180000;
      const PRENDAS_ORDER_FIELDS = ["createdAt", "fecha", "updatedAt"];

      const prendas2025Ref = collection(db, PRENDAS_2025_COLLECTION);
      const prendasState = {
        data: [],
        filtered: [],
        isAdmin: false,
        lastDoc: null,
        hasMore: true,
        isDone: false,
        isLoading: false,
        totalCount: null,
        newCount: null,
        countUnavailable: false,
        orderField: null,
        seenIds: new Set(),
        countCache: new Map(),
        activeFilters: null,
        renderToken: 0,
        searchToken: 0,
        isSkuSearch: false,
        showingTotal: null
      };
      let isBooting = true;

      const loadCategoryEntries = async (category, collectionName) => {
        const snapshot = await getDocs(collection(db, collectionName));
        if (snapshot.empty) {
          return { category, entries: [], empty: true };
        }

        const entries = snapshot.docs
          .map((docSnap) => {
            const data = docSnap.data() || {};
            const clave = data.clave || docSnap.id;
            const valor = data.valor || data.nombre || clave;
            return { clave, valor };
          })
          .filter((entry) => entry.clave && entry.valor);

        return { category, entries, empty: entries.length === 0 };
      };

      const loadDictionary = async () => {
        const categories = Object.keys(COLLECTIONS);
        const results = await Promise.all(
          categories.map((category) =>
            loadCategoryEntries(category, COLLECTIONS[category])
          )
        );
        const missing = results.filter((result) => result.empty).map((result) => result.category);

        return {
          empty: missing.length === categories.length,
          missing,
          tipos: results.find((result) => result.category === "tipos")?.entries ?? [],
          proveedores: results.find((result) => result.category === "proveedores")?.entries ?? [],
          colores: results.find((result) => result.category === "colores")?.entries ?? [],
          tallas: results.find((result) => result.category === "tallas")?.entries ?? []
        };
      };

      let loadingCount = 0;
      const setLoading = (isLoading) => {
        prendasLoader.classList.toggle("hidden", !isLoading);
      };
      const beginLoading = () => {
        loadingCount += 1;
        setLoading(true);
      };
      const endLoading = () => {
        loadingCount = Math.max(0, loadingCount - 1);
        if (loadingCount === 0) {
          setLoading(false);
        }
      };

      const setCounter = (shown, total) => {
        if (prendasShowing) {
          if (Number.isFinite(total)) {
            prendasShowing.textContent = `Mostrando ${shown} de ${total}`;
          } else {
            prendasShowing.textContent = `Mostrando ${shown}`;
          }
        }
      };

      const setPrendasAlert = (message = "", { isHtml = false } = {}) => {
        if (message) {
          if (isHtml) {
            prendasAlert.innerHTML = message;
          } else {
            prendasAlert.textContent = message;
          }
          prendasAlert.classList.remove("hidden");
        } else {
          prendasAlert.textContent = "";
          prendasAlert.classList.add("hidden");
        }
      };

      const isFullSku = (input) => {
        const value = safeString(input).trim().toUpperCase();
        if (!value) return false;
        return CODE_PATTERN.test(value);
      };

      const getPrendaDate = (data) =>
        toDateValue(data?.createdAt) ||
        toDateValue(data?.fecha) ||
        toDateValue(data?.updatedAt);

      const getPrendaPrice = (data) => {
        const price =
          data?.precio ?? data?.price ?? data?.precioConIva ?? data?.precioConIVA;
        return toNumberOrNull(price);
      };

      const buildSearchKey = (data) => {
        const codigo = safeString(data.codigo || data.code || data.Codigo || data.Code);
        const descripcion = safeString(data.descripcion || data.Descripcion || data.detalles);
        return normalizeText(`${codigo} ${descripcion}`.trim());
      };

      const normalizeDoc = (docSnap) => {
        const data = docSnap.data() || {};
        const codigo = safeString(
          data.codigo ??
            data.Codigo ??
            data.CODIGO ??
            data.SKU ??
            data.code ??
            data.Code ??
            docSnap.id
        );
        const descripcion = safeString(
          data.descripcion ?? data.Descripcion ?? data.detalles ?? data.Detalles
        );
        const color = safeString(data.color ?? data.Color ?? data.COLOR ?? "");
        const talla = safeString(data.talla ?? data.Talla ?? data.TALLA ?? "");
        const proveedor = safeString(data.proveedor ?? data.Proveedor ?? data.PROVEEDOR ?? "");
        const tipo = safeString(data.tipo ?? data.Tipo ?? data.TIPO ?? "");
        const status = safeString(data.status ?? data.Status ?? data.ESTATUS ?? "");
        const precio = toNumberOrNull(data.precio);
        const createdAt =
          data.createdAt ?? data.CreatedAt ?? data.fecha ?? data.Fecha ?? data.updatedAt;
        const _searchKey = `${codigo} ${descripcion}`.toLowerCase().trim();

        return {
          id: docSnap.id,
          codigo,
          descripcion,
          color,
          talla,
          proveedor,
          tipo,
          status,
          precio,
          createdAt,
          _searchKey
        };
      };

      const getBaseFilters = () => ({
        status: prendasStatus.value,
        proveedor: prendasProveedor.value,
        tipo: prendasTipo.value,
        color: prendasColor.value,
        talla: prendasTalla.value,
        priceMin: toNumberOrNull(prendasPrecioMin.value),
        priceMax: toNumberOrNull(prendasPrecioMax.value),
        includeNoPrice: prendasPrecioSin?.checked ?? true
      });

      const getSearchInput = () => safeString(prendasSearch.value);
      const getSearchTerm = () => normalizeText(prendasSearch.value);

      const shouldApplyPriceFilterToQuery = (filters) => {
        const hasRange = filters.priceMin !== null || filters.priceMax !== null;
        return hasRange && !filters.includeNoPrice;
      };

      const extractIndexUrl = (errorMessage = "") => {
        const match = errorMessage.match(
          /(https:\/\/console\.firebase\.google\.com[^\s]+)/i
        );
        return match ? match[1] : "";
      };

      const handleIndexError = (error) => {
        const message = error?.message || "";
        const isIndexError =
          error?.code === "failed-precondition" ||
          /requires an index/i.test(message) ||
          /indexes/i.test(message);
        if (!isIndexError) {
          return false;
        }
        const indexUrl = extractIndexUrl(message);
        const linkMarkup = indexUrl
          ? ` <a href="${indexUrl}" target="_blank" rel="noopener">Abrir índice</a>.`
          : "";
        setPrendasAlert(
          `Falta un índice para esta combinación de filtros.${linkMarkup}`,
          { isHtml: true }
        );
        return true;
      };

      const buildFilterOptions = (selectEl, values) => {
        const current = selectEl.value;
        selectEl.innerHTML = "";
        const allOption = document.createElement("option");
        allOption.value = "todos";
        allOption.textContent = "Todos";
        selectEl.appendChild(allOption);
        values.forEach((value) => {
          const option = document.createElement("option");
          option.value = value;
          option.textContent = value;
          selectEl.appendChild(option);
        });
        if (current) {
          selectEl.value = current;
        }
      };

      const updateFiltersFromData = (data) => {
        const proveedores = new Set();
        const tipos = new Set();
        const colores = new Set();
        const tallas = new Set();
        data.forEach((item) => {
          const proveedor = safeString(item.proveedor || item.proveedorNombre);
          const tipo = safeString(item.tipo || item.tipoNombre);
          const color = safeString(item.color || item.colorNombre);
          const talla = safeString(item.talla || item.tallaNombre);
          if (proveedor) proveedores.add(proveedor);
          if (tipo) tipos.add(tipo);
          if (color) colores.add(color);
          if (talla) tallas.add(talla);
        });
        buildFilterOptions(prendasProveedor, Array.from(proveedores).sort());
        buildFilterOptions(prendasTipo, Array.from(tipos).sort());
        buildFilterOptions(prendasColor, Array.from(colores).sort());
        buildFilterOptions(prendasTalla, Array.from(tallas).sort());
      };

      const renderRowsChunked = (
        rows,
        tbody,
        chunkSize = PRENDAS_RENDER_CHUNK,
        token
      ) =>
        new Promise((resolve) => {
          let index = 0;
          const renderStart = performance.now();

          const appendChunk = () => {
            if (token && token !== prendasState.renderToken) {
              resolve(0);
              return;
            }
            const fragment = document.createDocumentFragment();
            for (let i = 0; i < chunkSize && index < rows.length; i += 1) {
              fragment.appendChild(createPrendaRow(rows[index]));
              index += 1;
            }
            tbody.appendChild(fragment);
            if (index < rows.length) {
              requestAnimationFrame(appendChunk);
              return;
            }
            const totalMs = performance.now() - renderStart;
            console.info("[Prendas] Render DOM", {
              rows: rows.length,
              totalInDom: tbody.children.length,
              ms: Number(totalMs.toFixed(1))
            });
            resolve(Number(totalMs.toFixed(1)));
          };

          requestAnimationFrame(appendChunk);
        });

      const buildBadge = (text, className) => {
        const badge = document.createElement("span");
        badge.className = `badge ${className}`;
        badge.textContent = text;
        return badge;
      };

      const createPrendaRow = (item) => {
        const codigo = safeString(item.codigo || item.code) || "--";
        const descripcion = safeString(item.descripcion) || "--";
        const color = safeString(item.color || item.colorNombre) || "--";
        const talla = safeString(item.talla || item.tallaNombre) || "--";
        const proveedor = safeString(item.proveedor || item.proveedorNombre) || "--";
        const status = safeString(item.status) || "--";
        const disponibilidad = safeString(item.disponibilidad) || "--";
        const fechaTexto = safeString(item.fechaTexto);
        const dateValue = getPrendaDate(item) || toDateValue(item.createdAt);
        const fecha = fechaTexto || formatDateDDMMYYYY(dateValue);
        const costo = safeString(item.costo) || "--";
        const margen = safeString(item.margen) || "--";
        const utilidad = safeString(item.utilidad) || "--";
        const isNewItem = isNew(dateValue);

        const row = document.createElement("tr");
        row.className = isNewItem ? "row-new" : "row-old";

        const statusCell = document.createElement("td");
        const statusLine = document.createElement("div");
        statusLine.textContent = status;
        const badgesLine = document.createElement("div");
        badgesLine.appendChild(
          isNewItem ? buildBadge("Nuevo", "badge-new") : buildBadge("Existente", "badge-old")
        );
        if (normalizeText(status) === "vendido") {
          badgesLine.appendChild(buildBadge("Vendido", "badge-sold"));
        }
        statusCell.append(statusLine, badgesLine);

        const cells = [
          codigo,
          descripcion,
          color,
          talla,
          proveedor,
          statusCell,
          disponibilidad,
          fecha,
          costo,
          margen,
          utilidad
        ];

        cells.forEach((value, index) => {
          if (value instanceof HTMLElement) {
            if (index >= 8) {
              value.classList.add("admin-only");
            }
            row.appendChild(value);
            return;
          }
          const cell = document.createElement("td");
          cell.textContent = value;
          if (index >= 8) {
            cell.classList.add("admin-only");
          }
          row.appendChild(cell);
        });

        return row;
      };

      const renderDocs = async (rows) => {
        const renderStart = performance.now();
        console.assert(prendasTbody, "tbody no encontrado");
        prendasState.renderToken += 1;
        const token = prendasState.renderToken;
        const total =
          Number.isFinite(prendasState.totalCount)
            ? prendasState.totalCount
            : prendasState.countUnavailable
              ? null
              : rows.length;
        const nuevos =
          Number.isFinite(prendasState.newCount)
            ? prendasState.newCount
            : prendasState.countUnavailable
              ? null
              : rows.filter((item) => isNew(getPrendaDate(item))).length;
        const existentes =
          total !== null && nuevos !== null ? Math.max(0, total - nuevos) : null;
        prendasTotal.textContent = total ?? "—";
        prendasNuevos.textContent = nuevos ?? "—";
        prendasExistentes.textContent = existentes ?? "—";

        const showingTotal = Number.isFinite(prendasState.showingTotal)
          ? prendasState.showingTotal
          : total;
        setCounter(rows.length, showingTotal);
        const disableLoadMore =
          prendasState.isSkuSearch || prendasState.isDone || prendasState.isLoading;
        prendasLoadMore.disabled = disableLoadMore;
        prendasLoadMore.classList.toggle("hidden", prendasState.isSkuSearch);

        prendasTbody.textContent = "";
        if (!rows.length) {
          let emptyNode = null;
          if (prendasEmptyRow) {
            if (prendasEmptyRow instanceof HTMLTemplateElement) {
              emptyNode = prendasEmptyRow.content.cloneNode(true);
            } else {
              emptyNode = prendasEmptyRow.cloneNode(true);
            }
          }
          if (!emptyNode) {
            const emptyRow = document.createElement("tr");
            const cell = document.createElement("td");
            cell.colSpan = 11;
            cell.textContent = "No hay resultados con los filtros actuales.";
            emptyRow.appendChild(cell);
            emptyNode = emptyRow;
          }
          prendasTbody.appendChild(emptyNode);
          setCounter(0, showingTotal);
          return Number((performance.now() - renderStart).toFixed(1));
        }

        await renderRowsChunked(
          rows,
          prendasTbody,
          PRENDAS_RENDER_CHUNK,
          token
        );
        return Number((performance.now() - renderStart).toFixed(1));
      };

      const isAllFilter = (value) => !value || normalizeText(value) === "todos";

      const applyClientSideFilters = (data, filters) => {
        const filterStart = performance.now();
        const searchTerm = filters.searchTerm;
        const statusFilter = normalizeText(filters.status);
        const proveedorFilter = normalizeText(filters.proveedor);
        const tipoFilter = normalizeText(filters.tipo);
        const colorFilter = normalizeText(filters.color);
        const tallaFilter = normalizeText(filters.talla);
        const priceMin = filters.priceMin;
        const priceMax = filters.priceMax;
        const hasPriceRange = priceMin !== null || priceMax !== null;

        const filtered = data.filter((item) => {
          const searchKey = item._searchKey || buildSearchKey(item);
          if (searchTerm && !searchKey.includes(searchTerm)) {
            return false;
          }

          const statusValue = normalizeText(item.status || item.disponibilidad);
          if (!isAllFilter(statusFilter) && statusValue !== statusFilter) {
            return false;
          }

          const proveedorValue = normalizeText(item.proveedor || item.proveedorNombre);
          if (!isAllFilter(proveedorFilter) && proveedorValue !== proveedorFilter) {
            return false;
          }

          const tipoValue = normalizeText(item.tipo || item.tipoNombre);
          if (!isAllFilter(tipoFilter) && tipoValue !== tipoFilter) {
            return false;
          }

          const colorValue = normalizeText(item.color || item.colorNombre);
          if (!isAllFilter(colorFilter) && colorValue !== colorFilter) {
            return false;
          }

          const tallaValue = normalizeText(item.talla || item.tallaNombre);
          if (!isAllFilter(tallaFilter) && tallaValue !== tallaFilter) {
            return false;
          }

          const priceValue = item.precio ?? getPrendaPrice(item);
          if (!filters.includeNoPrice && priceValue === null) {
            return false;
          }
          if (hasPriceRange) {
            if (priceValue === null) {
              return filters.includeNoPrice;
            }
            if (priceMin !== null && priceValue < priceMin) {
              return false;
            }
            if (priceMax !== null && priceValue > priceMax) {
              return false;
            }
          }

          return true;
        });

        return {
          filtered,
          tFilter: Number((performance.now() - filterStart).toFixed(1))
        };
      };

      const applyFiltersAndRender = async () => {
        const baseFilters = getBaseFilters();
        const filters = {
          ...baseFilters,
          searchTerm: getSearchTerm()
        };
        prendasState.activeFilters = filters;
        const mappedCountBeforeFilters = prendasState.data.length;
        console.info("[Prendas] Filters in use", filters);
        console.info("[Prendas] First item normalized", {
          status: normalizeText(
            prendasState.data[0]?.status || prendasState.data[0]?.disponibilidad
          ),
          proveedor: normalizeText(
            prendasState.data[0]?.proveedor || prendasState.data[0]?.proveedorNombre
          ),
          tipo: normalizeText(prendasState.data[0]?.tipo || prendasState.data[0]?.tipoNombre),
          color: normalizeText(prendasState.data[0]?.color || prendasState.data[0]?.colorNombre),
          talla: normalizeText(prendasState.data[0]?.talla || prendasState.data[0]?.tallaNombre),
          precio:
            prendasState.data[0]?.precio ??
            getPrendaPrice(prendasState.data[0])
        });
        const { filtered, tFilter } = applyClientSideFilters(prendasState.data, filters);
        const allUiIsTodos =
          isAllFilter(filters.status) &&
          isAllFilter(filters.proveedor) &&
          isAllFilter(filters.tipo) &&
          isAllFilter(filters.color) &&
          isAllFilter(filters.talla);
        const noSearch = !filters.searchTerm;
        const noPriceRange = filters.priceMin === null && filters.priceMax === null;
        const shouldApplyFailsafe =
          prendasState.data.length > 0 &&
          filtered.length === 0 &&
          allUiIsTodos &&
          noSearch &&
          noPriceRange;
        const finalFiltered = shouldApplyFailsafe ? prendasState.data : filtered;
        if (shouldApplyFailsafe) {
          console.warn("[Prendas] FAILSAFE applied", {
            mapped: prendasState.data.length
          });
        }
        console.info("[Prendas] Filter counts", {
          mappedCountBeforeFilters,
          filteredCountAfterFilters: finalFiltered.length
        });

        prendasState.filtered = finalFiltered;
        const tRender = await renderDocs(finalFiltered);
        return { tFilter, tRender };
      };

      const setSkuSearchMode = (enabled) => {
        prendasState.isSkuSearch = enabled;
        if (!enabled) {
          prendasState.showingTotal = null;
        }
        prendasLoadMore.classList.toggle("hidden", enabled);
        prendasLoadMore.disabled =
          enabled || prendasState.isDone || prendasState.isLoading;
      };

      const fetchBySku = async (rawInput) => {
        const rawUpper = safeString(rawInput).trim().toUpperCase();
        const normalizedSku = normalizeSku(rawUpper);
        if (!rawUpper) {
          return null;
        }

        const directSnap = await getDoc(doc(db, PRENDAS_2025_COLLECTION, normalizedSku));
        if (directSnap.exists()) {
          return normalizeDoc(directSnap);
        }

        const altSnap = await getDoc(doc(db, PRENDAS_2025_COLLECTION, rawUpper));
        if (altSnap.exists()) {
          return normalizeDoc(altSnap);
        }

        const fallbackFields = [
          { field: "docId", value: normalizedSku },
          { field: "codigo", value: rawUpper },
          { field: "code", value: rawUpper }
        ];

        for (const { field, value } of fallbackFields) {
          const fallbackQuery = query(prendas2025Ref, where(field, "==", value), limit(1));
          const fallbackSnap = await getDocs(fallbackQuery);
          if (!fallbackSnap.empty) {
            return normalizeDoc(fallbackSnap.docs[0]);
          }
        }

        return null;
      };

      const runSkuSearch = async (rawInput) => {
        const rawUpper = safeString(rawInput).trim().toUpperCase();
        if (!rawUpper) {
          return;
        }
        const token = prendasState.searchToken + 1;
        prendasState.searchToken = token;
        setSkuSearchMode(true);
        setPrendasAlert("");
        beginLoading();
        prendasState.isLoading = true;
        try {
          const result = await fetchBySku(rawUpper);
          if (token !== prendasState.searchToken) {
            return;
          }
          const items = result ? [result] : [];
          prendasState.filtered = items;
          prendasState.showingTotal = items.length;
          await renderDocs(items);
          if (!items.length) {
            setPrendasAlert("No se encontró ese código. Revisa formato.");
          }
        } catch (error) {
          if (token !== prendasState.searchToken) {
            return;
          }
          console.error(error);
          setPrendasAlert("No se pudo buscar el código en Firestore.");
          prendasState.filtered = [];
          prendasState.showingTotal = 0;
          await renderDocs([]);
        } finally {
          if (token === prendasState.searchToken) {
            prendasState.isLoading = false;
          }
          endLoading();
        }
      };

      const buildPrendasQuery = ({
        orderField,
        filters,
        cursor,
        pageSize,
        forCount = false,
        forNew = false
      }) => {
        const constraints = [];
        const statusFilter = normalizeText(filters.status);
        const proveedorFilter = normalizeText(filters.proveedor);
        const tipoFilter = normalizeText(filters.tipo);
        const colorFilter = normalizeText(filters.color);
        const tallaFilter = normalizeText(filters.talla);
        const applyPriceFilter = shouldApplyPriceFilterToQuery(filters);

        if (statusFilter !== "todos") {
          constraints.push(where("status", "==", filters.status));
        }
        if (proveedorFilter !== "todos") {
          constraints.push(where("proveedor", "==", filters.proveedor));
        }
        if (tipoFilter !== "todos") {
          constraints.push(where("tipo", "==", filters.tipo));
        }
        if (colorFilter !== "todos") {
          constraints.push(where("color", "==", filters.color));
        }
        if (tallaFilter !== "todos") {
          constraints.push(where("talla", "==", filters.talla));
        }
        if (applyPriceFilter) {
          if (filters.priceMin !== null) {
            constraints.push(where("precio", ">=", filters.priceMin));
          }
          if (filters.priceMax !== null) {
            constraints.push(where("precio", "<=", filters.priceMax));
          }
          if (!forCount) {
            constraints.push(orderBy("precio", "asc"));
          }
        }
        if (forNew) {
          const cutoff = new Date(Date.now() - 7 * 24 * 60 * 60 * 1000);
          constraints.push(where(orderField, ">=", cutoff));
        }
        if (orderField && !forCount) {
          constraints.push(orderBy(orderField, "desc"));
        }
        if (cursor && !forCount) {
          constraints.push(startAfter(cursor));
        }
        if (!forCount) {
          constraints.push(limit(pageSize));
        }
        return query(prendas2025Ref, ...constraints);
      };

      const fetchPrendasPage = async ({ filters, cursor, pageSize }) => {
        const orderFields = prendasState.orderField
          ? [prendasState.orderField]
          : PRENDAS_ORDER_FIELDS;
        let lastError;
        for (const orderField of orderFields) {
          try {
            const pageQuery = buildPrendasQuery({ orderField, filters, cursor, pageSize });
            const snapshot = await getDocs(pageQuery);
            prendasState.orderField = orderField;
            return snapshot;
          } catch (error) {
            if (handleIndexError(error)) {
              throw error;
            }
            console.warn(`Fallback por ${orderField} falló.`, error);
            lastError = error;
          }
        }
        throw lastError;
      };

      const buildCountCacheKey = (filters) => {
        const { searchTerm, ...rest } = filters;
        return JSON.stringify(rest);
      };

      const fetchTotalCount = async (filters) => {
        const cacheKey = buildCountCacheKey(filters);
        const cached = prendasState.countCache.get(cacheKey);
        if (cached && cached.expiresAt > Date.now()) {
          return cached.value;
        }

        try {
          const hasPriceRange = filters.priceMin !== null || filters.priceMax !== null;
          const totalQuery = buildPrendasQuery({
            filters,
            orderField: prendasState.orderField || PRENDAS_ORDER_FIELDS[0],
            forCount: true
          });
          const totalSnapshot = await getCountFromServer(totalQuery);
          const totalCount = totalSnapshot.data().count ?? 0;

          let newCount = null;
          if (!hasPriceRange) {
            const newQuery = buildPrendasQuery({
              filters,
              orderField: prendasState.orderField || PRENDAS_ORDER_FIELDS[0],
              forCount: true,
              forNew: true
            });
            const newSnapshot = await getCountFromServer(newQuery);
            newCount = newSnapshot.data().count ?? 0;
          }

          const value = { totalCount, newCount };
          prendasState.countCache.set(cacheKey, {
            value,
            expiresAt: Date.now() + PRENDAS_COUNT_TTL
          });
          return value;
        } catch (error) {
          if (!handleIndexError(error)) {
            console.error(error);
          }
          return null;
        }
      };

      const resetPrendasState = () => {
        prendasState.data = [];
        prendasState.filtered = [];
        prendasState.lastDoc = null;
        prendasState.hasMore = true;
        prendasState.isDone = false;
        prendasState.seenIds.clear();
        prendasState.totalCount = null;
        prendasState.newCount = null;
        prendasState.countUnavailable = false;
      };

      const renderLoadingPlaceholder = () => {
        if (!prendasTbody) return;
        prendasTbody.textContent = "";
        const row = document.createElement("tr");
        const cell = document.createElement("td");
        cell.colSpan = 11;
        cell.textContent = "Cargando base de datos...";
        row.appendChild(cell);
        prendasTbody.appendChild(row);
        setCounter(0, prendasState.showingTotal ?? 0);
      };

      const fetchNextPage = async (filters, { reset = false } = {}) => {
        if (prendasState.isLoading || prendasState.isDone) return;
        setSkuSearchMode(false);
        setPrendasAlert("");
        beginLoading();
        prendasState.isLoading = true;
        prendasLoadMore.disabled = true;
        const pageSize = reset ? PRENDAS_PAGE_SIZE_FIRST : PRENDAS_PAGE_SIZE_NEXT;

        const queryStart = performance.now();

        try {
          const snapshot = await fetchPrendasPage({
            filters,
            cursor: reset ? null : prendasState.lastDoc,
            pageSize
          });
          console.info("[Prendas] Snapshot size", snapshot.size);
          if (snapshot.docs[0]) {
            console.info("[Prendas] First doc data", snapshot.docs[0].data());
          }
          const tQuery = Number((performance.now() - queryStart).toFixed(1));
          const lastDoc = snapshot.docs[snapshot.docs.length - 1] || null;
          const mapStart = performance.now();
          const pageData = snapshot.docs
            .map((docSnap) => normalizeDoc(docSnap))
            .filter((item) => {
              if (prendasState.seenIds.has(item.id)) return false;
              prendasState.seenIds.add(item.id);
              return true;
            });
          const tMap = Number((performance.now() - mapStart).toFixed(1));
          console.info("[Prendas] Mapped docs", {
            mappedCountBeforeFilters: pageData.length
          });

          console.info("[Prendas] Query Firestore", {
            ms: tQuery,
            docs: snapshot.docs.length,
            pageSize,
            lastDocId: lastDoc?.id || null
          });

          if (lastDoc) {
            prendasState.lastDoc = lastDoc;
          }
          if (snapshot.docs.length < pageSize) {
            prendasState.isDone = true;
            prendasState.hasMore = false;
          }

          if (reset) {
            prendasState.data = pageData;
          } else {
            prendasState.data = prendasState.data.concat(pageData);
          }

          updateFiltersFromData(prendasState.data);
        } catch (error) {
          if (!handleIndexError(error)) {
            console.error(error);
            setPrendasAlert("No se pudo cargar la base de datos de códigos.");
          }
        } finally {
          prendasState.isLoading = false;
          endLoading();
          prendasLoadMore.disabled = prendasState.isDone || prendasState.isSkuSearch;
        }
      };

      const refreshPrendasCounts = async (filters) => {
        try {
          const counts = await fetchTotalCount(filters);
          if (!counts) {
            throw new Error("Count unavailable");
          }
          prendasState.totalCount = counts.totalCount;
          prendasState.newCount = counts.newCount;
          prendasState.countUnavailable = false;
          await renderDocs(prendasState.filtered);
        } catch (error) {
          console.warn("No se pudo refrescar el total de prendas.", error);
          prendasState.totalCount = null;
          prendasState.newCount = null;
          prendasState.countUnavailable = true;
          setPrendasAlert(
            "No se pudo obtener el total real. Mostramos resultados parciales."
          );
          await renderDocs(prendasState.filtered);
        }
      };

      const reloadPrendasList = async ({ reason = "manual" } = {}) => {
        beginLoading();
        try {
          setSkuSearchMode(false);
          resetPrendasState();
          renderLoadingPlaceholder();
          prendasState.activeFilters = getBaseFilters();
          const filters = prendasState.activeFilters;
          await fetchNextPage(filters, { reset: true });
          const { tFilter, tRender } = await applyFiltersAndRender();
          console.log("[Perf]", {
            reason,
            tFilter,
            tRender,
            docs: prendasState.filtered.length
          });
          await refreshPrendasCounts(filters);
        } finally {
          endLoading();
        }
      };

      const ensureRequired = () => {
        if (!registroProveedor.value || !registroProducto.value || !registroColor.value || !registroTalla.value) {
          setRegistroStatus("Completa Proveedor, Producto, Color y Talla.", "error");
          return false;
        }
        return true;
      };

      const getSelectedName = (selectEl) => {
        const option = selectEl.options[selectEl.selectedIndex];
        return option?.dataset?.nombre || option?.textContent?.split(" - ")[1] || option?.textContent || "";
      };

      const HISTORICOS_URL = "../Data/codigos_historicos.json";
      let historicosCache = null;

      const loadHistoricosMap = async () => {
        if (historicosCache) {
          return historicosCache;
        }
        historicosCache = fetch(HISTORICOS_URL)
          .then((response) => {
            if (!response.ok) {
              throw new Error("No se pudo cargar el histórico de códigos.");
            }
            return response.json();
          })
          .then((codes) => {
            const maxPorKey = {};
            const pattern = /^HA(\d+)([A-Z])(\d{3})\//i;
            codes.forEach((code) => {
              const match = pattern.exec(String(code).trim().toUpperCase());
              if (!match) return;
              const key = `prov${match[1]}_tipo${match[2]}`;
              const seq = Number(match[3]);
              if (!Number.isFinite(seq)) return;
              if (!maxPorKey[key] || seq > maxPorKey[key]) {
                maxPorKey[key] = seq;
              }
            });
            return maxPorKey;
          })
          .catch((error) => {
            console.warn("No se pudo cargar el histórico de códigos.", error);
            return {};
          });
        return historicosCache;
      };

      const getNextCounter = async (providerCode, typeCode) => {
        const key = `prov${providerCode}_tipo${typeCode}`;
        const counterRef = doc(db, "counters", key);

        return runTransaction(db, async (transaction) => {
          const snapshot = await transaction.get(counterRef);
          const data = snapshot.data() || {};
          let counterValue = Number(data.value);

          if (!Number.isFinite(counterValue)) {
          counterValue = Number(data.lastNumber);
          }

          if (!Number.isFinite(counterValue)) {
          const maxPorKey = await loadHistoricosMap();
          counterValue = Number(maxPorKey[key] ?? 0);
          }
          if (!Number.isFinite(counterValue)) {
            throw new Error(`Contador inválido para ${key}. Revisa counters/${key}.`);
          }
          console.log("COUNTER READ", { key, data, counterValue });
          const nextValue = counterValue + 1;
          transaction.set(counterRef, { value: nextValue, lastNumber: nextValue }, { merge: true });
          return { nextValue, key };
        });
      };

      registroForm.addEventListener("submit", async (event) => {
        event.preventDefault();
        setRegistroStatus("");

        if (!ensureRequired()) {
          return;
        }

        const providerCode = registroProveedor.value;
        const typeCode = registroProducto.value;
        const colorClave = registroColor.value;
        const tallaClave = registroTalla.value;
        try {
          registroSubmit.disabled = true;
          const { nextValue, key } = await getNextCounter(providerCode, typeCode);
          const consecutivo = String(nextValue).padStart(3, "0");
          const codigo = `HA${providerCode}${typeCode}${consecutivo}/${colorClave}-${tallaClave}`;
          console.info(`Generando código ${codigo} para counter ${key}.`);

          const costoValue = Number(document.getElementById("registro-costo").value);
          const createdByValue = document.getElementById("registro-created-by").value.trim();
          const detallesValue = registroDetalles.value.trim();
          const tipoNombre = getSelectedName(registroProducto).trim();
          const proveedorNombre = getSelectedName(registroProveedor).trim();
          const colorNombre = getSelectedName(registroColor).trim();
          const tallaNombre = getSelectedName(registroTalla).trim();
          const descripcion = [tipoNombre, proveedorNombre, colorNombre, tallaNombre]
            .filter(Boolean)
            .join(" ");

          const data = {
            codigo,
            proveedor: providerCode,
            tipo: typeCode,
            color: colorClave,
            talla: tallaClave,
            descripcion: descripcion || null,
            detalles: detallesValue || null,
            costo: Number.isFinite(costoValue) ? costoValue : 0,
            code: codigo,
            providerCode,
            typeCode,
            seqNumber: nextValue,
            colorCode: colorClave,
            sizeCode: tallaClave,
            creadoPor: createdByValue || null,
            createdAt: serverTimestamp()
          };

          const codeQuery = query(prendasRef, where("code", "==", codigo));
          const legacyQuery = query(prendasRef, where("codigo", "==", codigo));
          const [codeSnapshot, legacySnapshot] = await Promise.all([
            getDocs(codeQuery),
            getDocs(legacyQuery)
          ]);
          const duplicateFound = !codeSnapshot.empty || !legacySnapshot.empty;

          await addDoc(prendasRef, data);

          registroCodigo.textContent = codigo;
          registroResult.classList.remove("hidden");
          if (duplicateFound) {
            setRegistroStatus("Código ya existe (duplicado).", "warning");
          } else {
            setRegistroStatus("Prenda guardada correctamente.", "success");
          }
        } catch (error) {
          const message =
            error?.message?.includes("contador") || error?.message?.includes("Contador")
              ? error.message
              : "No se pudo generar el código. Intenta nuevamente.";
          setRegistroStatus(message, "error");
          console.error(error);
        } finally {
          registroSubmit.disabled = false;
        }
      });

      registroCopy.addEventListener("click", async () => {
        try {
          await navigator.clipboard.writeText(registroCodigo.textContent.trim());
          setRegistroStatus("Código copiado al portapapeles.", "success");
        } catch (error) {
          setRegistroStatus("No se pudo copiar el código.", "error");
          console.error(error);
        }
      });

      registroReset.addEventListener("click", () => {
        registroForm.reset();
        registroResult.classList.add("hidden");
        setRegistroStatus("");
      });

      zplForm.addEventListener("submit", (event) => {
        event.preventDefault();
        setZplStatus("");

        const codigo = document.getElementById("zpl-codigo").value.trim();
        const cantidadValue = Number(document.getElementById("zpl-cantidad").value);
        const cantidad = Number.isFinite(cantidadValue) && cantidadValue > 0 ? cantidadValue : 1;

        const formatoValido = CODE_PATTERN.test(codigo.toUpperCase());
        if (!codigo || !formatoValido) {
          setZplStatus("Ingresa un código válido (HA{#}{A}{NNN}/COLOR-TALLA).", "error");
          zplOutput.classList.add("hidden");
          return;
        }

        const template = `^XA
^CF0,40
^FO30,30^FD${codigo}^FS
^CF0,30
^FO30,90^FDPRECIO$^FS
^FO30,140^BQN,2,6^FDLA,${codigo}^FS
^XZ`;

        const zpl = Array.from({ length: cantidad }, () => template).join("\n");
        zplTextarea.value = zpl;
        zplOutput.classList.remove("hidden");
        setZplStatus("ZPL generado correctamente.", "success");
      });

      zplCopy.addEventListener("click", async () => {
        try {
          await navigator.clipboard.writeText(zplTextarea.value);
          setZplStatus("ZPL copiado al portapapeles.", "success");
        } catch (error) {
          setZplStatus("No se pudo copiar el ZPL.", "error");
          console.error(error);
        }
      });

      // ADMIN DB MODE START
      const ADMIN_KEY = "haruja_admin_db";
      const DB_TAB_HASH = "#base-datos-codigos";

      const getAdminEnabled = () => sessionStorage.getItem(ADMIN_KEY) === "1";

      const setAdminEnabled = (enabled) => {
        sessionStorage.setItem(ADMIN_KEY, enabled ? "1" : "0");
      };

      const applyAdminUI = () => {
        const enabled = getAdminEnabled();
        if (dbCodigosSection) {
          dbCodigosSection.classList.toggle("admin-enabled", enabled);
        }
        if (adminToggleDb) {
          adminToggleDb.checked = enabled;
        }
      };

      const handleAdminToggle = (event) => {
        setAdminEnabled(event.target.checked);
        applyAdminUI();
      };

      const handleTabChange = (hash) => {
        if (hash === DB_TAB_HASH) {
          applyAdminUI();
        }
      };

      if (adminToggleDb) {
        adminToggleDb.addEventListener("change", handleAdminToggle);
      }

      window.addEventListener("hashchange", () => {
        handleTabChange(window.location.hash);
      });

      document.querySelectorAll('a.card[href^="#"]').forEach((link) => {
        link.addEventListener("click", (event) => {
          const hash = event.currentTarget.getAttribute("href") || "";
          handleTabChange(hash);
        });
      });
      // ADMIN DB MODE END

      const handleSearchInput = debounce(async () => {
        if (isBooting) return;
        const rawInput = getSearchInput();
        if (!rawInput.trim()) {
          await reloadPrendasList();
          return;
        }
        if (isFullSku(rawInput)) {
          await runSkuSearch(rawInput);
          return;
        }
        setSkuSearchMode(false);
        await applyFiltersAndRender();
      }, PRENDAS_SEARCH_DEBOUNCE);

      const handleFilterApply = async () => {
        if (isBooting) return;
        const rawInput = getSearchInput();
        if (rawInput.trim() && isFullSku(rawInput)) {
          await runSkuSearch(rawInput);
          return;
        }
        await reloadPrendasList();
      };

      prendasSearch.addEventListener("input", handleSearchInput);
      prendasPrecioApply.addEventListener("click", handleFilterApply);

      [prendasPrecioMin, prendasPrecioMax].forEach((input) => {
        input.addEventListener("keydown", (event) => {
          if (isBooting) return;
          if (event.key === "Enter") {
            event.preventDefault();
            handleFilterApply();
          }
        });
      });

      prendasLoadMore.addEventListener("click", async () => {
        if (isBooting) return;
        const filters = prendasState.activeFilters || getBaseFilters();
        await fetchNextPage(filters, { reset: false });
        await applyFiltersAndRender();
      });

      const init = async () => {
        isBooting = true;
        resetPrendasState();
        prendasSearch.value = "";
        prendasStatus.value = "todos";
        prendasProveedor.value = "todos";
        prendasTipo.value = "todos";
        prendasColor.value = "todos";
        prendasTalla.value = "todos";
        try {
          setRegistroStatus("Cargando diccionario...");
          registroSubmit.disabled = true;
          setSelectLoading(registroProducto, "Cargando...");
          setSelectLoading(registroProveedor, "Cargando...");
          setSelectLoading(registroColor, "Cargando...");
          setSelectLoading(registroTalla, "Cargando...");

          const dictionary = await loadDictionary();
          const dictionaryReady = !dictionary.empty && dictionary.missing.length === 0;
          if (dictionary.empty) {
            setRegistroStatus("Diccionario vacío: corre el workflow Seed Firestore.", "error");
          } else if (dictionary.missing.length) {
            setRegistroStatus(
              `Faltan datos en: ${dictionary.missing.join(", ")}.`,
              "error"
            );
          } else {
            setRegistroStatus("");
          }

          if (dictionary.tipos.length) {
            fillSelect(
              registroProducto,
              dictionary.tipos.sort((a, b) => a.clave.localeCompare(b.clave))
            );
          } else {
            setSelectLoading(registroProducto, "Sin opciones disponibles");
          }

          if (dictionary.proveedores.length) {
            fillSelect(
              registroProveedor,
              dictionary.proveedores.sort((a, b) => a.clave.localeCompare(b.clave))
            );
          } else {
            setSelectLoading(registroProveedor, "Sin opciones disponibles");
          }

          if (dictionary.colores.length) {
            fillSelect(
              registroColor,
              dictionary.colores.sort((a, b) => a.clave.localeCompare(b.clave))
            );
          } else {
            setSelectLoading(registroColor, "Sin opciones disponibles");
          }

          if (dictionary.tallas.length) {
            fillSelect(
              registroTalla,
              dictionary.tallas.sort((a, b) => a.clave.localeCompare(b.clave))
            );
          } else {
            setSelectLoading(registroTalla, "Sin opciones disponibles");
          }

          registroSubmit.disabled = !dictionaryReady;
        } catch (error) {
          setRegistroStatus("No pudimos cargar el diccionario.", "error");
          registroSubmit.disabled = true;
          console.error(error);
        } finally {
          // ADMIN DB MODE START
          applyAdminUI();
          handleTabChange(window.location.hash);
          // ADMIN DB MODE END
          setSkuSearchMode(false);
          try {
            await reloadPrendasList({ reason: "init" });
          } finally {
            isBooting = false;
          }
        }
      };

      init();
    </script>
  </body>
</html>
