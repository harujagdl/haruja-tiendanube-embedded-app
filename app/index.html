<!DOCTYPE html>
<html lang="es">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <title>Panel Haruja – v0.0 | Panel</title>
    <style>
      :root {
        color-scheme: light;
        --bg: #f6f7fb;
        --card: #ffffff;
        --text: #1f2937;
        --muted: #6b7280;
        --primary: #1f6feb;
        --primary-dark: #1a55b5;
        --border: #e5e7eb;
        --shadow: 0 10px 24px rgba(15, 23, 42, 0.08);
        --radius: 16px;
      }

      * {
        box-sizing: border-box;
      }

      body {
        margin: 0;
        font-family: "Inter", "Segoe UI", system-ui, -apple-system, sans-serif;
        color: var(--text);
        background: var(--bg);
      }

      .app {
        min-height: 100vh;
        display: flex;
        flex-direction: column;
      }

      header {
        background: var(--card);
        border-bottom: 1px solid var(--border);
        padding: 24px 32px;
      }

      header h1 {
        margin: 0 0 8px;
        font-size: 24px;
      }

      header p {
        margin: 0;
        color: var(--muted);
        font-size: 14px;
      }

      main {
        padding: 32px;
        display: flex;
        flex-direction: column;
        gap: 24px;
      }

      .grid {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(220px, 1fr));
        gap: 20px;
      }

      .card {
        background: var(--card);
        border: 1px solid var(--border);
        border-radius: var(--radius);
        box-shadow: var(--shadow);
        padding: 20px;
        display: flex;
        flex-direction: column;
        gap: 12px;
        text-decoration: none;
        color: inherit;
      }

      .card h2 {
        margin: 0;
        font-size: 18px;
      }

      .card p {
        margin: 0;
        color: var(--muted);
        font-size: 14px;
      }

      .card .cta {
        margin-top: auto;
        font-weight: 600;
        color: var(--primary);
      }

      .section {
        background: var(--card);
        border: 1px solid var(--border);
        border-radius: var(--radius);
        box-shadow: var(--shadow);
        padding: 24px;
      }

      .section h2 {
        margin: 0 0 12px;
        font-size: 20px;
      }

      .section p {
        margin: 0 0 20px;
        color: var(--muted);
        font-size: 14px;
      }

      .form {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(180px, 1fr));
        gap: 16px;
        align-items: end;
      }

      label {
        display: block;
        font-size: 13px;
        color: var(--muted);
        margin-bottom: 6px;
      }

      input {
        width: 100%;
        padding: 10px 12px;
        border-radius: 10px;
        border: 1px solid var(--border);
        font-size: 14px;
      }

      select {
        width: 100%;
        padding: 10px 12px;
        border-radius: 10px;
        border: 1px solid var(--border);
        font-size: 14px;
        background: #fff;
      }

      button {
        padding: 12px 16px;
        border-radius: 12px;
        border: none;
        background: var(--primary);
        color: #fff;
        font-weight: 600;
        cursor: pointer;
      }

      button:hover {
        background: var(--primary-dark);
      }

      .status {
        font-size: 14px;
        color: var(--muted);
        min-height: 20px;
      }

      .status.success {
        color: #15803d;
      }

      .status.error {
        color: #b91c1c;
      }

      .status.warning {
        color: #b45309;
      }

      .result-card {
        margin-top: 16px;
        padding: 16px;
        border-radius: 12px;
        border: 1px solid var(--border);
        background: #f8fafc;
      }

      .result-code {
        font-size: 24px;
        font-weight: 700;
        letter-spacing: 0.5px;
        margin: 8px 0 16px;
      }

      .result-actions {
        display: flex;
        flex-wrap: wrap;
        gap: 12px;
      }

      .muted {
        color: var(--muted);
        font-size: 13px;
      }

      .zpl-output {
        margin-top: 16px;
      }

      textarea {
        width: 100%;
        min-height: 180px;
        padding: 12px;
        border-radius: 12px;
        border: 1px solid var(--border);
        font-size: 13px;
        font-family: "SFMono-Regular", "Consolas", "Liberation Mono", monospace;
      }

      .hidden {
        display: none;
      }

      table {
        width: 100%;
        border-collapse: collapse;
        font-size: 14px;
      }

      th,
      td {
        padding: 10px 12px;
        border-bottom: 1px solid var(--border);
        text-align: left;
      }

      th {
        color: var(--muted);
        font-weight: 600;
      }

      .panel-controls {
        display: flex;
        flex-direction: column;
        gap: 16px;
        margin-bottom: 16px;
      }

      .filters-grid {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(180px, 1fr));
        gap: 12px;
        align-items: end;
      }

      .filters-grid .price-range {
        display: flex;
        gap: 8px;
      }

      .filters-grid .price-range input {
        width: 100%;
      }

      .filters-grid .inline-toggle {
        display: flex;
        align-items: center;
        gap: 10px;
        padding: 10px 12px;
        border-radius: 10px;
        border: 1px solid var(--border);
        background: #f8fafc;
      }

      .filters-grid .inline-toggle input {
        width: auto;
      }

      .counters {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(140px, 1fr));
        gap: 12px;
      }

      .counter-card {
        border-radius: 12px;
        padding: 12px;
        border: 1px solid var(--border);
        background: #f8fafc;
      }

      .counter-card span {
        display: block;
        font-size: 12px;
        color: var(--muted);
      }

      .counter-card strong {
        font-size: 18px;
      }

      .table-wrapper {
        width: 100%;
        overflow-x: auto;
      }

      .badge {
        display: inline-block;
        padding: 4px 8px;
        border-radius: 999px;
        font-size: 12px;
        font-weight: 600;
      }

      .badge-new {
        background: #e0ecff;
        color: #1d4ed8;
      }

      .badge-old {
        background: #e8f5e9;
        color: #166534;
      }

      .badge-sold {
        background: #fee2e2;
        color: #b91c1c;
      }

      .row-new {
        background: #f5f8ff;
      }

      .row-old {
        background: #f3fbf6;
      }

      .loader {
        display: flex;
        align-items: center;
        gap: 10px;
        color: var(--muted);
        font-size: 14px;
      }

      .spinner {
        width: 18px;
        height: 18px;
        border-radius: 50%;
        border: 2px solid #d1d5db;
        border-top-color: var(--primary);
        animation: spin 0.9s linear infinite;
      }

      @keyframes spin {
        to {
          transform: rotate(360deg);
        }
      }

      .alert {
        padding: 12px 16px;
        border-radius: 10px;
        border: 1px solid #fecaca;
        background: #fef2f2;
        color: #991b1b;
        font-size: 14px;
      }

      .pagination {
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin-top: 16px;
        gap: 12px;
        flex-wrap: wrap;
      }

      .pagination span {
        color: var(--muted);
        font-size: 14px;
      }

      .pagination button {
        min-width: 120px;
      }

      #dbCodigosSection .admin-only {
        display: none !important;
      }

      #dbCodigosSection.admin-enabled .admin-only {
        display: revert !important;
      }

      #dbCodigosSection .admin-panel {
        display: grid;
        gap: 12px;
        padding: 12px;
        border-radius: 12px;
        border: 1px solid #e5e7eb;
        background: #f8fafc;
        margin-top: 12px;
      }

      #dbCodigosSection .admin-login-row {
        display: flex;
        gap: 8px;
        flex-wrap: wrap;
        align-items: center;
      }

      #dbCodigosSection .admin-login-row input {
        flex: 1;
        min-width: 180px;
      }

      #dbCodigosSection .admin-actions {
        display: grid;
        gap: 8px;
      }

      #dbCodigosSection .admin-actions.hidden {
        display: none;
      }

      @media (max-width: 600px) {
        header,
        main {
          padding: 20px;
        }
      }
    </style>
  </head>
  <body>
    <div class="app">
      <header>
        <h1>Panel Haruja</h1>
        <p>Gestión rápida de prendas, precios y etiquetas dentro de Tiendanube.</p>
      </header>

      <main>
        <section class="grid">
          <a class="card" href="#registro">
            <h2>Registro de nuevas prendas</h2>
            <p>Carga nuevas prendas y atributos esenciales en minutos.</p>
            <span class="cta">Empezar</span>
          </a>
          <a class="card" href="#precios">
            <h2>Asignar precios</h2>
            <p>Define precios finales por categoría y canal de venta.</p>
            <span class="cta">Configurar</span>
          </a>
          <a class="card" href="#calculadora">
            <h2>Calculadora de precios</h2>
            <p>Calcula márgenes y proyecciones de rentabilidad.</p>
            <span class="cta">Abrir</span>
          </a>
          <a class="card" href="#etiquetas">
            <h2>Impresión de etiquetas (ZPL)</h2>
            <p>Genera etiquetas listas para impresión y control interno.</p>
            <span class="cta">Preparar</span>
          </a>
          <a class="card" href="#base-datos-codigos">
            <h2>Base de datos códigos HarujaGdl</h2>
            <p>Consulta códigos existentes, nuevos y detalles clave de prendas.</p>
            <span class="cta">Abrir</span>
          </a>
        </section>

        <section class="section" id="registro">
          <h2>Registro de nuevas prendas</h2>
          <p>Selecciona los atributos clave para generar el código y guardar la prenda en Firestore.</p>
          <form class="form" id="registro-form">
            <div>
              <label for="registro-producto">Tipo / Producto *</label>
              <select id="registro-producto" name="producto" required>
                <option value="">Seleccionar</option>
              </select>
            </div>
            <div>
              <label for="registro-proveedor">Proveedor *</label>
              <select id="registro-proveedor" name="proveedor" required>
                <option value="">Seleccionar</option>
              </select>
            </div>
            <div>
              <label for="registro-color">Color *</label>
              <select id="registro-color" name="color" required>
                <option value="">Seleccionar</option>
              </select>
            </div>
            <div>
              <label for="registro-talla">Talla *</label>
              <select id="registro-talla" name="talla" required>
                <option value="">Seleccionar</option>
              </select>
            </div>
            <div>
              <label for="registro-costo">Costo (opcional)</label>
              <input id="registro-costo" name="costo" type="number" min="0" step="0.01" placeholder="0" />
            </div>
            <div>
              <label for="registro-created-by">Creado por (opcional)</label>
              <input id="registro-created-by" name="createdBy" type="text" placeholder="Nombre" />
            </div>
            <div>
              <label for="registro-detalles">Detalles (opcional)</label>
              <input id="registro-detalles" name="detalles" type="text" placeholder="Ej: Pelly estampada" />
            </div>
            <button type="submit">Generar código</button>
          </form>
          <p id="registro-status" class="status"></p>
          <div id="registro-result" class="result-card hidden">
            <span class="muted">Código generado</span>
            <div id="registro-codigo" class="result-code">HA00000/--</div>
            <div class="result-actions">
              <button type="button" id="registro-copy">Copiar</button>
              <button type="button" id="registro-reset">Crear otro</button>
            </div>
          </div>
        </section>

        <section class="section" id="etiquetas">
          <h2>Impresión de etiquetas</h2>
          <p>Ingresa el código y la cantidad de etiquetas a generar.</p>
          <form class="form" id="zpl-form">
            <div>
              <label for="zpl-codigo">Código (SKU)</label>
              <input id="zpl-codigo" name="codigo" type="text" placeholder="HA2A007/NG-M" />
            </div>
            <div>
              <label for="zpl-cantidad">Cantidad</label>
              <input id="zpl-cantidad" name="cantidad" type="number" min="1" value="1" />
            </div>
            <button type="submit">Imprimir etiqueta</button>
          </form>
          <p id="zpl-status" class="status"></p>
          <div class="zpl-output hidden" id="zpl-output">
            <label for="zpl-textarea">ZPL generado</label>
            <textarea id="zpl-textarea" readonly></textarea>
            <div class="result-actions" style="margin-top: 12px;">
              <button type="button" id="zpl-copy">Copiar ZPL</button>
            </div>
          </div>
        </section>

        <section class="section" id="base-datos-codigos">
          <div id="dbCodigosSection">
            <h2>Base de datos códigos HarujaGdl</h2>
            <p>Explora la base de prendas 2025 con búsqueda, filtros y estado de novedades.</p>
            <div class="panel-controls">
              <div class="filters-grid">
                <div>
                  <label for="prendas-search">Buscar por código o descripción</label>
                  <input id="prendas-search" type="text" placeholder="Ej: HA12A003 o sudadera" />
                </div>
                <div>
                  <label for="prendas-status">Status</label>
                  <select id="prendas-status">
                    <option value="todos">Todos</option>
                    <option value="disponible">Disponible</option>
                    <option value="vendido">Vendido</option>
                  </select>
                </div>
                <div>
                  <label for="prendas-proveedor">Proveedor</label>
                  <select id="prendas-proveedor">
                    <option value="todos">Todos</option>
                  </select>
                </div>
                <div>
                  <label for="prendas-tipo">Tipo</label>
                  <select id="prendas-tipo">
                    <option value="todos">Todos</option>
                  </select>
                </div>
                <div>
                  <label for="prendas-color">Color</label>
                  <select id="prendas-color">
                    <option value="todos">Todos</option>
                  </select>
                </div>
                <div>
                  <label for="prendas-talla">Talla</label>
                  <select id="prendas-talla">
                    <option value="todos">Todos</option>
                  </select>
                </div>
                <div>
                  <label>Precio (rango)</label>
                  <div class="price-range">
                    <input id="prendas-precio-min" type="number" min="0" placeholder="Mín" />
                    <input id="prendas-precio-max" type="number" min="0" placeholder="Máx" />
                  </div>
                </div>
                <div class="inline-toggle">
                  <input id="prendas-precio-sin" type="checkbox" checked />
                  <label for="prendas-precio-sin">Incluir sin precio</label>
                </div>
                <div>
                  <label>&nbsp;</label>
                  <button type="button" id="prendas-precio-apply">Aplicar filtros</button>
                </div>
                <div>
                  <label for="prendas-page-size">Registros por página</label>
                  <select id="prendas-page-size">
                    <option value="30">30</option>
                    <option value="50" selected>50</option>
                    <option value="100">100</option>
                  </select>
                </div>
              </div>
              <div class="admin-panel" id="admin-panel">
                <div>
                  <label for="admin-password">Admin</label>
                  <div class="admin-login-row">
                    <input
                      id="admin-password"
                      type="password"
                      placeholder="Contraseña admin"
                      autocomplete="current-password"
                    />
                    <button type="button" id="admin-login">Ingresar</button>
                    <button type="button" id="admin-logout" class="secondary hidden">Salir</button>
                  </div>
                  <div id="admin-login-status" class="status"></div>
                </div>
                <div class="admin-actions hidden" id="admin-actions">
                  <div class="inline-toggle">
                    <input id="adminToggleDb" type="checkbox" />
                    <label for="adminToggleDb">Modo admin (mostrar costos y márgenes)</label>
                  </div>
                  <button type="button" id="admin-backfill">
                    Preparar buscador (1 vez)
                  </button>
                  <div id="admin-backfill-status" class="status"></div>
                </div>
              </div>
              <div class="counters">
                <div class="counter-card">
                  <span>Total</span>
                  <strong id="prendas-total" data-count-total>—</strong>
                </div>
                <div class="counter-card">
                  <span>Nuevos (7 días)</span>
                  <strong id="prendas-nuevos">—</strong>
                </div>
                <div class="counter-card">
                  <span>Existentes</span>
                  <strong id="prendas-existentes">—</strong>
                </div>
              </div>
            </div>
            <div id="prendas-alert" class="alert hidden"></div>
            <div id="prendas-loader" class="loader hidden" data-db-loader>
              <span class="spinner"></span>
              <span>Cargando base de datos...</span>
            </div>
            <div class="table-wrapper">
              <table id="tablaPrendas" data-prendas-table>
                <thead>
                  <tr>
                    <th>Código</th>
                    <th>Descripción</th>
                    <th>Color</th>
                    <th>Talla</th>
                    <th>Proveedor</th>
                    <th>Status</th>
                    <th>Disponibilidad</th>
                    <th>Fecha</th>
                    <th class="admin-only">(Admin) Costo</th>
                    <th class="admin-only">(Admin) Margen</th>
                    <th class="admin-only">(Admin) Utilidad</th>
                  </tr>
                </thead>
                <tbody id="prendas-tbody" data-prendas-tbody></tbody>
              </table>
              <template id="noResultsRow" data-empty-row>
                <tr>
                  <td colspan="11">No hay resultados con los filtros actuales.</td>
                </tr>
              </template>
            </div>
            <div class="pagination">
              <span id="prendas-showing" data-count-shown>Mostrando 0</span>
              <button type="button" id="prendas-load-more">Cargar más</button>
            </div>
          </div>
        </section>
      </main>
    </div>
    <script type="module">
      import { initializeApp } from "https://www.gstatic.com/firebasejs/9.22.2/firebase-app.js";
      import {
        getFirestore,
        initializeFirestore,
        collection,
        addDoc,
        doc,
        getDoc,
        getDocs,
        query,
        orderBy,
        documentId,
        runTransaction,
        serverTimestamp,
        startAfter,
        startAt,
        where,
        limit,
        endAt,
        persistentLocalCache
      } from "https://www.gstatic.com/firebasejs/9.22.2/firebase-firestore.js";
      import {
        getFunctions,
        httpsCallable
      } from "https://www.gstatic.com/firebasejs/9.22.2/firebase-functions.js";

      // TODO: Reemplazar estos valores con la configuración real del proyecto Firebase.
      const firebaseConfig = {
        apiKey: "REEMPLAZAR_API_KEY",
        authDomain: "haruja-tiendanube.firebaseapp.com",
        projectId: "haruja-tiendanube",
        storageBucket: "haruja-tiendanube.appspot.com",
        messagingSenderId: "REEMPLAZAR_SENDER_ID",
        appId: "REEMPLAZAR_APP_ID"
      };

      const app = initializeApp(firebaseConfig);
      const functions = getFunctions(app);
      let db;
      try {
        db = initializeFirestore(app, {
          localCache: persistentLocalCache()
        });
      } catch (error) {
        console.warn(
          "[Firestore] Persistencia no disponible, usando caché en memoria",
          error?.code || error?.message
        );
        db = getFirestore(app);
      }
      const prendasRef = collection(db, "prendas");
      const registroForm = document.getElementById("registro-form");
      const registroStatus = document.getElementById("registro-status");
      const registroResult = document.getElementById("registro-result");
      const registroCodigo = document.getElementById("registro-codigo");
      const registroCopy = document.getElementById("registro-copy");
      const registroReset = document.getElementById("registro-reset");
      const registroSubmit = registroForm.querySelector("button[type='submit']");
      const registroProducto = document.getElementById("registro-producto");
      const registroProveedor = document.getElementById("registro-proveedor");
      const registroColor = document.getElementById("registro-color");
      const registroTalla = document.getElementById("registro-talla");
      const registroDetalles = document.getElementById("registro-detalles");

      const zplForm = document.getElementById("zpl-form");
      const zplStatus = document.getElementById("zpl-status");
      const zplOutput = document.getElementById("zpl-output");
      const zplTextarea = document.getElementById("zpl-textarea");
      const zplCopy = document.getElementById("zpl-copy");

      const prendasSearch = document.getElementById("prendas-search");
      const prendasStatus = document.getElementById("prendas-status");
      const prendasProveedor = document.getElementById("prendas-proveedor");
      const prendasTipo = document.getElementById("prendas-tipo");
      const prendasColor = document.getElementById("prendas-color");
      const prendasTalla = document.getElementById("prendas-talla");
      const prendasPrecioMin = document.getElementById("prendas-precio-min");
      const prendasPrecioMax = document.getElementById("prendas-precio-max");
      const prendasPrecioSin = document.getElementById("prendas-precio-sin");
      const prendasPrecioApply = document.getElementById("prendas-precio-apply");
      const prendasPageSize = document.getElementById("prendas-page-size");
      const prendasTotal = document.querySelector("[data-count-total]") || document.getElementById("prendas-total");
      const prendasNuevos = document.getElementById("prendas-nuevos");
      const prendasExistentes = document.getElementById("prendas-existentes");
      const prendasTable =
        document.querySelector("[data-prendas-table]") ||
        document.getElementById("tablaPrendas");
      const prendasTbody =
        prendasTable?.querySelector("tbody") ||
        document.querySelector("[data-prendas-tbody]") ||
        document.getElementById("prendas-tbody");
      const prendasShowing =
        document.querySelector("[data-count-shown]") || document.getElementById("prendas-showing");
      const prendasLoadMore = document.getElementById("prendas-load-more");
      const prendasLoader =
        document.querySelector("[data-db-loader]") || document.getElementById("prendas-loader");
      const prendasEmptyRow =
        document.querySelector("[data-empty-row]") || document.getElementById("noResultsRow");
      const prendasAlert = document.getElementById("prendas-alert");
      const prendasPanel = document.getElementById("base-datos-codigos");
      const dbCodigosSection = document.getElementById("dbCodigosSection");
      const adminToggleDb = prendasPanel.querySelector("#adminToggleDb");
      const adminPasswordInput = document.getElementById("admin-password");
      const adminLoginButton = document.getElementById("admin-login");
      const adminLogoutButton = document.getElementById("admin-logout");
      const adminLoginStatus = document.getElementById("admin-login-status");
      const adminActions = document.getElementById("admin-actions");
      const adminBackfillButton = document.getElementById("admin-backfill");
      const adminBackfillStatus = document.getElementById("admin-backfill-status");
      console.assert(prendasTable, "No existe tabla de prendas");
      console.assert(prendasTbody, "No existe tbody de prendas");
      console.assert(prendasLoader, "No existe loader de prendas");
      console.assert(prendasShowing, "No existe contador de prendas mostradas");
      console.assert(prendasTotal, "No existe contador total de prendas");
      console.assert(prendasEmptyRow, "No existe template de filas vacías");

      const setRegistroStatus = (message, type = "") => {
        registroStatus.textContent = message;
        registroStatus.className = `status ${type}`.trim();
      };

      const setZplStatus = (message, type = "") => {
        zplStatus.textContent = message;
        zplStatus.className = `status ${type}`.trim();
      };

      const safeString = (value) => {
        if (value === null || value === undefined) return "";
        return String(value);
      };

      const normalizeText = (value) =>
        safeString(value)
          .toLowerCase()
          .trim()
          .normalize("NFD")
          .replace(/[\u0300-\u036f]/g, "");

      const normalizeDictionaryValue = (value) =>
        safeString(value).trim().replace(/\s+/g, " ");

      const normalizeSku = (input) =>
        safeString(input)
          .trim()
          .toUpperCase()
          .replace(/\s+/g, " ")
          .replace(/\//g, "__");

      const normalizeSkuPrefix = (input) =>
        safeString(input)
          .trim()
          .toLowerCase()
          .replace(/\s+/g, "");

      const toNumberOrNull = (value) => {
        if (value === null || value === undefined) return null;
        if (String(value).trim() === "") return null;
        const parsed = Number(value);
        return Number.isFinite(parsed) ? parsed : null;
      };

      const debounce = (fn, wait = 200) => {
        let timeoutId;
        return (...args) => {
          if (timeoutId) {
            clearTimeout(timeoutId);
          }
          timeoutId = setTimeout(() => fn(...args), wait);
        };
      };

      const formatDateDDMMYYYY = (date) => {
        if (!(date instanceof Date) || Number.isNaN(date.getTime())) {
          return "--";
        }
        const day = String(date.getDate()).padStart(2, "0");
        const month = String(date.getMonth() + 1).padStart(2, "0");
        const year = date.getFullYear();
        return `${day}/${month}/${year}`;
      };

      const toDateValue = (value) => {
        if (!value) return null;
        if (value instanceof Date) return value;
        if (typeof value?.toDate === "function") return value.toDate();
        if (typeof value === "number") return new Date(value);
        if (typeof value === "string") {
          const parsed = new Date(value);
          return Number.isNaN(parsed.getTime()) ? null : parsed;
        }
        return null;
      };

      const isNew = (createdAt, days = 7) => {
        const createdDate = toDateValue(createdAt);
        if (!createdDate) return false;
        const diff = Date.now() - createdDate.getTime();
        return diff <= days * 24 * 60 * 60 * 1000;
      };

      const buildOption = ({ clave, valor }) => {
        const option = document.createElement("option");
        option.value = clave;
        option.textContent = `${clave} - ${valor}`;
        option.dataset.nombre = valor;
        return option;
      };

      const setSelectLoading = (selectEl, message) => {
        selectEl.innerHTML = "";
        const option = document.createElement("option");
        option.value = "";
        option.textContent = message;
        selectEl.appendChild(option);
        selectEl.disabled = true;
      };

      const fillDictionarySelect = (selectEl, entries) => {
        selectEl.innerHTML = "";
        const placeholder = document.createElement("option");
        placeholder.value = "";
        placeholder.textContent = "Seleccionar";
        selectEl.appendChild(placeholder);
        entries.forEach((item) => selectEl.appendChild(buildOption(item)));
        selectEl.disabled = false;
      };

      const fillSelect = (selectEl, values) => {
        const current = selectEl.value;
        selectEl.innerHTML = "";
        const allOption = document.createElement("option");
        allOption.value = "todos";
        allOption.textContent = "Todos";
        selectEl.appendChild(allOption);
        const uniqueValues = [
          ...new Set(
            values
              .map((value) => safeString(value).trim())
              .filter((value) => value)
          )
        ].sort((a, b) =>
          a.localeCompare(b)
        );
        uniqueValues.forEach((value) => {
          const option = document.createElement("option");
          option.value = value;
          option.textContent = value;
          selectEl.appendChild(option);
        });
        if (current && uniqueValues.includes(current)) {
          selectEl.value = current;
        } else {
          selectEl.value = "todos";
        }
        selectEl.disabled = false;
      };

      const collectOption = (map, codigo, nombre) => {
        if (!codigo) return;
        if (!map.has(codigo)) {
          map.set(codigo, nombre || codigo);
        }
      };

      const COLLECTIONS = {
        tipos: "diccionario_tipos",
        proveedores: "diccionario_proveedores",
        colores: "diccionario_colores",
        tallas: "diccionario_tallas"
      };

      const CODE_PATTERN = /^HA(\d+)([A-Z])(\d{3})\/([A-Z0-9]+)-([A-Z0-9]+)$/;
      const PRENDAS_2025_COLLECTION = "HarujaPrendas_2025";
      const PRENDAS_PAGE_SIZE_DEFAULT = 50;
      const PRENDAS_SCAN_PAGE_SIZE = 200;
      const PRENDAS_RENDER_CHUNK = 20;
      const PRENDAS_SEARCH_DEBOUNCE = 250;
      const ADMIN_SESSION_KEY = "haruja_admin_session";
      const ADMIN_VIEW_KEY = "haruja_admin_view";
      const ADMIN_SESSION_TTL = 12 * 60 * 60 * 1000;
      const DICTS_CACHE_KEY = "haruja_dicts_cache_v2";

      const prendas2025Ref = collection(db, PRENDAS_2025_COLLECTION);
      const prendasState = {
        data: [],
        filtered: [],
        isAdmin: false,
        dicts: {
          proveedores: [],
          tipos: [],
          colores: [],
          tallas: []
        },
        dictsLoaded: false,
        lastDocs: {
          main: null,
          noPrice: null,
          noPriceZero: null
        },
        hasMoreMain: true,
        hasMoreNoPrice: true,
        hasMore: true,
        isDone: false,
        isLoadingInitial: false,
        isLoadingMore: false,
        seenIds: new Set(),
        filters: null,
        filtersActive: false,
        renderToken: 0,
        searchToken: 0,
        isSkuSearch: false,
        showingTotal: null,
        queryKey: "",
        reqId: 0,
        scanMode: false,
        lastScanSnap: null,
        hasMoreScan: true,
        scanOrderField: "createdAt"
      };
      let isBooting = true;

      const loadCategoryEntries = async (category, collectionName) => {
        const snapshot = await getDocs(collection(db, collectionName));
        if (snapshot.empty) {
          return { category, entries: [], empty: true };
        }

        const entries = snapshot.docs
          .map((docSnap) => {
            const data = docSnap.data() || {};
            const clave = data.clave || docSnap.id;
            const valor = data.valor || data.nombre || clave;
            return { clave, valor };
          })
          .filter((entry) => entry.clave && entry.valor);

        return { category, entries, empty: entries.length === 0 };
      };

      const loadDictionary = async () => {
        const categories = Object.keys(COLLECTIONS);
        const results = await Promise.all(
          categories.map((category) =>
            loadCategoryEntries(category, COLLECTIONS[category])
          )
        );
        const missing = results.filter((result) => result.empty).map((result) => result.category);

        return {
          empty: missing.length === categories.length,
          missing,
          tipos: results.find((result) => result.category === "tipos")?.entries ?? [],
          proveedores: results.find((result) => result.category === "proveedores")?.entries ?? [],
          colores: results.find((result) => result.category === "colores")?.entries ?? [],
          tallas: results.find((result) => result.category === "tallas")?.entries ?? []
        };
      };

      const loadDictionariesOnce = async () => {
        if (prendasState.dictsLoaded) {
          return prendasState.dicts;
        }
        const cached = localStorage.getItem(DICTS_CACHE_KEY);
        if (cached) {
          try {
            const parsed = JSON.parse(cached);
            if (
              parsed?.version === "2" &&
              parsed?.dicts &&
              ["proveedores", "tipos", "colores", "tallas"].every((key) =>
                Array.isArray(parsed.dicts[key])
              )
            ) {
              prendasState.dicts = parsed.dicts;
              prendasState.dictsLoaded = true;
              return prendasState.dicts;
            }
          } catch (error) {
            console.warn("Cache de diccionarios inválida, recargando.", error);
          }
        }
        const categories = Object.keys(COLLECTIONS);
        const results = await Promise.all(
          categories.map(async (category) => {
            const snapshot = await getDocs(collection(db, COLLECTIONS[category]));
            const values = snapshot.docs
              .map((docSnap) => {
                const data = docSnap.data() || {};
                return (
                  data.valor ??
                  data.Valor ??
                  data.nombre ??
                  data.Nombre ??
                  data.clave ??
                  data.Clave ??
                  docSnap.id
                );
              })
              .map((value) => safeString(value).trim())
              .filter((value) => value);
            return { category, values };
          })
        );

        prendasState.dicts.proveedores =
          results.find((result) => result.category === "proveedores")?.values ?? [];
        prendasState.dicts.tipos =
          results.find((result) => result.category === "tipos")?.values ?? [];
        prendasState.dicts.colores =
          results.find((result) => result.category === "colores")?.values ?? [];
        prendasState.dicts.tallas =
          results.find((result) => result.category === "tallas")?.values ?? [];
        prendasState.dictsLoaded = true;
        localStorage.setItem(
          DICTS_CACHE_KEY,
          JSON.stringify({ version: "2", dicts: prendasState.dicts })
        );
        return prendasState.dicts;
      };

      const updateLoadingUi = () => {
        const isLoading = prendasState.isLoadingInitial || prendasState.isLoadingMore;
        prendasLoader.classList.toggle("hidden", !isLoading);
      };

      const setLoadingState = (mode, isLoading) => {
        if (mode === "initial") {
          prendasState.isLoadingInitial = isLoading;
        } else if (mode === "more") {
          prendasState.isLoadingMore = isLoading;
        }
        updateLoadingUi();
      };

      const setCounter = (shown, total) => {
        if (prendasShowing) {
          if (Number.isFinite(total)) {
            prendasShowing.textContent = `Mostrando ${shown} de ${total}`;
          } else {
            prendasShowing.textContent = `Mostrando ${shown}`;
          }
        }
      };

      const setPrendasAlert = (message = "", { isHtml = false } = {}) => {
        if (message) {
          if (isHtml) {
            prendasAlert.innerHTML = message;
          } else {
            prendasAlert.textContent = message;
          }
          prendasAlert.classList.remove("hidden");
        } else {
          prendasAlert.textContent = "";
          prendasAlert.classList.add("hidden");
        }
      };

      const isFullSku = (input) => {
        const value = safeString(input).trim().toUpperCase();
        if (!value) return false;
        return CODE_PATTERN.test(value);
      };

      const getPrendaDate = (data) =>
        toDateValue(data?.createdAt) ||
        toDateValue(data?.fecha) ||
        toDateValue(data?.updatedAt);

      const getPrendaPrice = (data) => {
        const price =
          data?.precio ?? data?.price ?? data?.precioConIva ?? data?.precioConIVA;
        return toNumberOrNull(price);
      };

      const buildSearchKey = (data) => {
        const codigo = safeString(data.codigo || data.code || data.Codigo || data.Code);
        const descripcion = safeString(data.descripcion || data.Descripcion || data.detalles);
        return normalizeText(`${codigo} ${descripcion}`.trim());
      };

      const normalizeDoc = (docSnap) => {
        const data = docSnap.data() || {};
        const codigo = safeString(
          data.codigo ??
            data.Codigo ??
            data.CODIGO ??
            data.SKU ??
            data.code ??
            data.Code ??
            docSnap.id
        ).trim();
        const descripcion = safeString(
          data.descripcion ??
            data.Descripcion ??
            data.detalles ??
            data.Detalles ??
            ""
        ).trim();
        const proveedor = safeString(data.proveedor || data.Proveedor || "").trim();
        const tipo = safeString(data.tipo || data.Tipo || "").trim();
        const color = safeString(data.color || data.Color || "").trim();
        const talla = safeString(data.talla || data.Talla || "").trim();
        const status = safeString(data.status || data.Status || "").trim();
        const precio = toNumberOrNull(data.precio ?? data.Precio ?? null);
        const precioConIva = toNumberOrNull(data.precioConIva ?? data.precioConIVA);
        const iva = toNumberOrNull(data.iva ?? data.IVA);
        const costo = toNumberOrNull(data.costo);
        const basePrice = precio ?? precioConIva;
        const utilidad =
          Number.isFinite(basePrice) || Number.isFinite(costo)
            ? Number((basePrice ?? 0) - (costo ?? 0))
            : null;
        const margenRaw = toNumberOrNull(data.margen);
        const margen =
          Number.isFinite(margenRaw)
            ? margenRaw
            : Number.isFinite(basePrice) && basePrice !== 0
              ? Number(((basePrice - (costo ?? 0)) / basePrice).toFixed(3))
              : null;
        const createdAt = data.createdAt ?? data.CreatedAt ?? null;
        const descripcionLower = descripcion.toLowerCase();
        const codigoUpper = codigo.toUpperCase();
        const _searchKey = `${codigo} ${descripcion}`.toLowerCase().trim();

        return {
          id: docSnap.id,
          codigo,
          descripcion,
          color,
          talla,
          proveedor,
          tipo,
          status,
          precio,
          precioConIva,
          iva,
          costo,
          margen,
          utilidad,
          createdAt,
          descripcionLower,
          codigoUpper,
          _searchKey
        };
      };

      const getSearchInput = () => safeString(prendasSearch.value);
      const getSearchTerm = () => normalizeText(prendasSearch.value);
      const getSearchRaw = () => safeString(prendasSearch.value).trim();
      const normalizeSelectValue = (value) => (isAllFilter(value) ? null : value);
      const looksLikeCodeSearch = (value) => {
        const raw = safeString(value).trim().toUpperCase();
        if (!raw) return false;
        return raw.startsWith("HA") || raw.includes("/") || raw.includes("-");
      };

      const getCurrentFilters = () => {
        const priceMin = toNumberOrNull(prendasPrecioMin.value);
        const priceMax = toNumberOrNull(prendasPrecioMax.value);
        const searchRaw = getSearchRaw();
        return {
          status: normalizeSelectValue(prendasStatus.value),
          proveedor: normalizeSelectValue(prendasProveedor.value),
          tipo: normalizeSelectValue(prendasTipo.value),
          color: normalizeSelectValue(prendasColor.value),
          talla: normalizeSelectValue(prendasTalla.value),
          priceMin,
          priceMax,
          minPrice: priceMin,
          maxPrice: priceMax,
          includeNoPrice: prendasPrecioSin?.checked ?? true,
          searchTerm: getSearchTerm(),
          searchRaw,
          query: searchRaw
        };
      };

      const handleIndexError = (error) => {
        const message = error?.message || "";
        const isIndexError =
          error?.code === "failed-precondition" ||
          /requires an index/i.test(message) ||
          /indexes/i.test(message);
        if (!isIndexError) {
          return false;
        }
        console.warn("[Prendas] Index error", error);
        return true;
      };

      const setFilterSelectLoading = (selectEl, message) => {
        selectEl.innerHTML = "";
        const option = document.createElement("option");
        option.value = "todos";
        option.textContent = message;
        selectEl.appendChild(option);
        selectEl.disabled = true;
      };

      const loadFilterDictionaries = async () => {
        setFilterSelectLoading(prendasProveedor, "Cargando opciones...");
        setFilterSelectLoading(prendasTipo, "Cargando opciones...");
        setFilterSelectLoading(prendasColor, "Cargando opciones...");
        setFilterSelectLoading(prendasTalla, "Cargando opciones...");
        const dicts = await loadDictionariesOnce();
        fillSelect(prendasProveedor, dicts.proveedores);
        fillSelect(prendasTipo, dicts.tipos);
        fillSelect(prendasColor, dicts.colores);
        fillSelect(prendasTalla, dicts.tallas);
      };

      const renderRowsChunked = (
        rows,
        tbody,
        chunkSize = PRENDAS_RENDER_CHUNK,
        token
      ) =>
        new Promise((resolve) => {
          let index = 0;
          const renderStart = performance.now();

          const appendChunk = () => {
            if (token && token !== prendasState.renderToken) {
              resolve(0);
              return;
            }
            const fragment = document.createDocumentFragment();
            for (let i = 0; i < chunkSize && index < rows.length; i += 1) {
              fragment.appendChild(createPrendaRow(rows[index]));
              index += 1;
            }
            tbody.appendChild(fragment);
            if (index < rows.length) {
              requestAnimationFrame(appendChunk);
              return;
            }
            const totalMs = performance.now() - renderStart;
            console.info("[Prendas] Render DOM", {
              rows: rows.length,
              totalInDom: tbody.children.length,
              ms: Number(totalMs.toFixed(1))
            });
            resolve(Number(totalMs.toFixed(1)));
          };

          requestAnimationFrame(appendChunk);
        });

      const buildBadge = (text, className) => {
        const badge = document.createElement("span");
        badge.className = `badge ${className}`;
        badge.textContent = text;
        return badge;
      };

      const createPrendaRow = (item) => {
        const codigo = safeString(item.codigo || item.code) || "--";
        const descripcion = safeString(item.descripcion) || "--";
        const color = safeString(item.color || item.colorNombre) || "--";
        const talla = safeString(item.talla || item.tallaNombre) || "--";
        const proveedor = safeString(item.proveedor || item.proveedorNombre) || "--";
        const status = safeString(item.status) || "--";
        const disponibilidad = safeString(item.disponibilidad) || "--";
        const fechaTexto = safeString(item.fechaTexto);
        const dateValue = getPrendaDate(item) || toDateValue(item.createdAt);
        const fecha = fechaTexto || formatDateDDMMYYYY(dateValue);
        const costo = safeString(item.costo) || "--";
        const margen = safeString(item.margen) || "--";
        const utilidad = safeString(item.utilidad) || "--";
        const isNewItem = isNew(dateValue);

        const row = document.createElement("tr");
        row.className = isNewItem ? "row-new" : "row-old";

        const statusCell = document.createElement("td");
        const statusLine = document.createElement("div");
        statusLine.textContent = status;
        const badgesLine = document.createElement("div");
        badgesLine.appendChild(
          isNewItem ? buildBadge("Nuevo", "badge-new") : buildBadge("Existente", "badge-old")
        );
        if (normalizeText(status) === "vendido") {
          badgesLine.appendChild(buildBadge("Vendido", "badge-sold"));
        }
        statusCell.append(statusLine, badgesLine);

        const cells = [
          codigo,
          descripcion,
          color,
          talla,
          proveedor,
          statusCell,
          disponibilidad,
          fecha,
          costo,
          margen,
          utilidad
        ];

        cells.forEach((value, index) => {
          if (value instanceof HTMLElement) {
            if (index >= 8) {
              value.classList.add("admin-only");
            }
            row.appendChild(value);
            return;
          }
          const cell = document.createElement("td");
          cell.textContent = value;
          if (index >= 8) {
            cell.classList.add("admin-only");
          }
          row.appendChild(cell);
        });

        return row;
      };

      const renderDocs = async (rows) => {
        const renderStart = performance.now();
        console.assert(prendasTbody, "tbody no encontrado");
        prendasState.renderToken += 1;
        const token = prendasState.renderToken;
        prendasTotal.textContent = "—";
        prendasNuevos.textContent = "—";
        prendasExistentes.textContent = "—";

        const showingTotal = Number.isFinite(prendasState.showingTotal)
          ? prendasState.showingTotal
          : null;
        setCounter(rows.length, showingTotal);
        const disableLoadMore =
          prendasState.isSkuSearch ||
          prendasState.isDone ||
          prendasState.isLoadingInitial ||
          prendasState.isLoadingMore;
        prendasLoadMore.disabled = disableLoadMore;
        prendasLoadMore.classList.toggle("hidden", prendasState.isSkuSearch);

        prendasTbody.textContent = "";
        if (!rows.length) {
          let emptyNode = null;
          if (prendasEmptyRow) {
            if (prendasEmptyRow instanceof HTMLTemplateElement) {
              emptyNode = prendasEmptyRow.content.cloneNode(true);
            } else {
              emptyNode = prendasEmptyRow.cloneNode(true);
            }
          }
          if (!emptyNode) {
            const emptyRow = document.createElement("tr");
            const cell = document.createElement("td");
            cell.colSpan = 11;
            cell.textContent = "No hay resultados con los filtros actuales.";
            emptyRow.appendChild(cell);
            emptyNode = emptyRow;
          }
          prendasTbody.appendChild(emptyNode);
          setCounter(0, showingTotal);
          return Number((performance.now() - renderStart).toFixed(1));
        }

        await renderRowsChunked(
          rows,
          prendasTbody,
          PRENDAS_RENDER_CHUNK,
          token
        );
        return Number((performance.now() - renderStart).toFixed(1));
      };

      const isAllFilter = (value) => !value || normalizeText(value) === "todos";

      const hasActiveFilters = (filters) => {
        if (!filters) return false;
        const hasStatus = Boolean(filters.status);
        const hasProveedor = Boolean(filters.proveedor);
        const hasTipo = Boolean(filters.tipo);
        const hasColor = Boolean(filters.color);
        const hasTalla = Boolean(filters.talla);
        const hasSearch = Boolean(
          safeString(filters.query || filters.searchRaw).trim()
        );
        const hasPriceRange = filters.minPrice !== null || filters.maxPrice !== null;
        const excludeNoPrice = filters.includeNoPrice === false;
        return (
          hasStatus ||
          hasProveedor ||
          hasTipo ||
          hasColor ||
          hasTalla ||
          hasSearch ||
          hasPriceRange ||
          excludeNoPrice
        );
      };

      const applyFiltersAndRender = async () => {
        const filters = prendasState.filters || getCurrentFilters();
        prendasState.filters = filters;
        const filtersActive = hasActiveFilters(filters);
        prendasState.filtersActive = filtersActive;
        if (!prendasState.isSkuSearch) {
          prendasState.showingTotal = null;
        }
        console.info("[Prendas] Filters in use", filters);
        const filterStart = performance.now();
        const finalFiltered = prendasState.data.filter((item) =>
          matchFilters(item, filters)
        );
        const tFilter = Number((performance.now() - filterStart).toFixed(1));
        prendasState.filtered = finalFiltered;
        const tRender = await renderDocs(finalFiltered);
        if (!prendasState.isSkuSearch) {
          if (filtersActive) {
            setPrendasAlert(
              `Mostrando ${finalFiltered.length} resultados. Usa “Cargar más” para ver más.`
            );
          } else {
            setPrendasAlert("");
          }
        }
        return { tFilter, tRender };
      };

      const setSkuSearchMode = (enabled) => {
        prendasState.isSkuSearch = enabled;
        if (!enabled) {
          prendasState.showingTotal = null;
        }
        prendasLoadMore.classList.toggle("hidden", enabled);
        prendasLoadMore.disabled =
          enabled ||
          prendasState.isDone ||
          prendasState.isLoadingInitial ||
          prendasState.isLoadingMore;
      };

      const fetchBySku = async (rawInput) => {
        const rawUpper = safeString(rawInput).trim().toUpperCase();
        const normalizedSku = normalizeSku(rawUpper);
        if (!rawUpper) {
          return null;
        }

        const directSnap = await getDoc(doc(db, PRENDAS_2025_COLLECTION, normalizedSku));
        if (directSnap.exists()) {
          return normalizeDoc(directSnap);
        }

        const altSnap = await getDoc(doc(db, PRENDAS_2025_COLLECTION, rawUpper));
        if (altSnap.exists()) {
          return normalizeDoc(altSnap);
        }

        const fallbackFields = [
          { field: "docId", value: normalizedSku },
          { field: "codigo", value: rawUpper },
          { field: "code", value: rawUpper }
        ];

        for (const { field, value } of fallbackFields) {
          const fallbackQuery = query(prendas2025Ref, where(field, "==", value), limit(1));
          const fallbackSnap = await getDocs(fallbackQuery);
          if (!fallbackSnap.empty) {
            return normalizeDoc(fallbackSnap.docs[0]);
          }
        }

        return null;
      };

      const runSkuSearch = async (rawInput) => {
        const rawUpper = safeString(rawInput).trim().toUpperCase();
        if (!rawUpper) {
          return;
        }
        const token = prendasState.searchToken + 1;
        prendasState.searchToken = token;
        setSkuSearchMode(true);
        prendasState.filtersActive = true;
        setPrendasAlert("");
        setLoadingState("initial", true);
        try {
          const result = await fetchBySku(rawUpper);
          if (token !== prendasState.searchToken) {
            return;
          }
          const items = result ? [result] : [];
          prendasState.filtered = items;
          prendasState.showingTotal = items.length;
          await renderDocs(items);
          if (!items.length) {
            setPrendasAlert("No se encontró ese código. Revisa formato.");
          }
        } catch (error) {
          if (token !== prendasState.searchToken) {
            return;
          }
          console.error(error);
          setPrendasAlert("No se pudo buscar el código en Firestore.");
          prendasState.filtered = [];
          prendasState.showingTotal = 0;
          await renderDocs([]);
        } finally {
          setLoadingState("initial", false);
        }
      };

      const buildQueryKey = (filters, pageSize) =>
        JSON.stringify({
          filtersActive: hasActiveFilters(filters),
          status: filters?.status ?? null,
          proveedor: filters?.proveedor ?? null,
          tipo: filters?.tipo ?? null,
          color: filters?.color ?? null,
          talla: filters?.talla ?? null,
          minPrice: filters?.minPrice ?? null,
          maxPrice: filters?.maxPrice ?? null,
          includeNoPrice: filters?.includeNoPrice ?? null,
          query: safeString(filters?.query ?? filters?.searchRaw ?? "").trim(),
          pageSize
        });

      const buildBaseConstraints = (filters) => {
        const constraints = [];
        if (filters?.status) constraints.push(where("status", "==", filters.status));
        if (filters?.proveedor) constraints.push(where("proveedor", "==", filters.proveedor));
        if (filters?.tipo) constraints.push(where("tipo", "==", filters.tipo));
        if (filters?.color) constraints.push(where("color", "==", filters.color));
        if (filters?.talla) constraints.push(where("talla", "==", filters.talla));
        return constraints;
      };

      const buildListQuery = ({ cursor, pageSize, filters }) => {
        const hasPriceRange = filters?.minPrice !== null || filters?.maxPrice !== null;
        const constraints = buildBaseConstraints(filters);
        if (hasPriceRange) {
          if (filters?.minPrice !== null) {
            constraints.push(where("precio", ">=", filters.minPrice));
          }
          if (filters?.maxPrice !== null) {
            constraints.push(where("precio", "<=", filters.maxPrice));
          }
          constraints.push(orderBy("precio"), orderBy("createdAt"));
        } else {
          constraints.push(orderBy("createdAt", "desc"), orderBy(documentId(), "desc"));
        }
        if (cursor) {
          constraints.push(startAfter(cursor));
        }
        constraints.push(limit(pageSize));
        return query(prendas2025Ref, ...constraints);
      };

      const getPageSize = () => {
        const selected = Number(prendasPageSize?.value);
        if (Number.isFinite(selected) && selected > 0) {
          return selected;
        }
        return PRENDAS_PAGE_SIZE_DEFAULT;
      };

      const comparePrendas = (a, b) => {
        const dateA = getPrendaDate(a);
        const dateB = getPrendaDate(b);
        const timeA = dateA ? dateA.getTime() : 0;
        const timeB = dateB ? dateB.getTime() : 0;
        if (timeA !== timeB) {
          return timeB - timeA;
        }
        return safeString(b.id).localeCompare(safeString(a.id));
      };

      const normalizeExact = (value) => safeString(value).trim();
      const toNum = (value) => {
        const parsed = Number(value);
        return Number.isFinite(parsed) ? parsed : null;
      };

      const matchFilters = (item, filters) => {
        if (filters.status && normalizeExact(item.status) !== normalizeExact(filters.status)) {
          return false;
        }
        if (
          filters.proveedor &&
          normalizeExact(item.proveedor) !== normalizeExact(filters.proveedor)
        ) {
          return false;
        }
        if (filters.tipo && normalizeExact(item.tipo) !== normalizeExact(filters.tipo)) {
          return false;
        }
        if (filters.color && normalizeExact(item.color) !== normalizeExact(filters.color)) {
          return false;
        }
        if (filters.talla && normalizeExact(item.talla) !== normalizeExact(filters.talla)) {
          return false;
        }

        const precio = toNum(item.precio);
        const isNoPrice = precio === null || precio === 0;
        if (isNoPrice) {
          if (!filters.includeNoPrice) return false;
        } else {
          if (filters.minPrice != null && precio < filters.minPrice) return false;
          if (filters.maxPrice != null && precio > filters.maxPrice) return false;
        }

        const q = normalizeExact(filters.query || filters.searchRaw);
        if (q) {
          const codigo = normalizeExact(item.codigo).toUpperCase();
          const descripcion = normalizeExact(item.descripcion).toLowerCase();
          const qTrim = q.trim();
          const qUpper = qTrim.toUpperCase();
          const qLower = qTrim.toLowerCase();
          if (looksLikeCodeSearch(qTrim)) {
            if (!codigo.startsWith(qUpper)) return false;
          } else if (!descripcion.includes(qLower)) {
            return false;
          }
        }
        return true;
      };

      const buildScanQuery = ({ cursor }) => {
        const constraints = [
          orderBy("createdAt", "desc"),
          orderBy(documentId(), "desc")
        ];
        if (cursor) {
          constraints.push(startAfter(cursor));
        }
        constraints.push(limit(PRENDAS_SCAN_PAGE_SIZE));
        return query(prendas2025Ref, ...constraints);
      };

      const fetchScanBatch = async ({ cursor }) => {
        const snap = await getDocs(buildScanQuery({ cursor }));
        return { snap };
      };

      const scanUntilFilled = async ({ filters, pageSize, reset }) => {
        if (reset) {
          prendasState.lastScanSnap = null;
          prendasState.hasMoreScan = true;
          prendasState.scanMode = true;
        }
        let cursor = prendasState.lastScanSnap;
        let hasMore = prendasState.hasMoreScan;
        let pagesScanned = 0;
        let filteredCount = prendasState.filtered.length;

        while (filteredCount < pageSize && hasMore && pagesScanned < 10) {
          const { snap } = await fetchScanBatch({ cursor });
          const docsFetched = snap.docs.length;
          pagesScanned += 1;
          if (!docsFetched) {
            hasMore = false;
            break;
          }

          const normalized = snap.docs.map((docSnap) => normalizeDoc(docSnap));
          normalized.forEach((item) => {
            if (prendasState.seenIds.has(item.id)) return;
            prendasState.seenIds.add(item.id);
            prendasState.data.push(item);
          });

          cursor = snap.docs[docsFetched - 1];
          if (docsFetched < PRENDAS_SCAN_PAGE_SIZE) {
            hasMore = false;
          }

          await applyFiltersAndRender();
          filteredCount = prendasState.filtered.length;
          console.log("[Prendas] Scan progress", {
            fetched: docsFetched,
            showing: filteredCount
          });
        }

        prendasState.lastScanSnap = cursor;
        prendasState.hasMoreScan = hasMore;
        return { filteredCount, pagesScanned };
      };

      const fetchPrendasPage = async ({ cursor, pageSize, filters, mode = "main" }) => {
        console.log("[Prendas] Query ejecutada", {
          filters,
          mode,
          cursorId: cursor?.id ?? null,
          pageSize
        });
        const pageQuery = buildListQuery({ cursor, pageSize, filters });
        const snapshot = await getDocs(pageQuery);
        console.log("[Prendas] Docs recibidos", snapshot.docs.length);
        return snapshot;
      };

      const buildNoPriceQuery = ({ cursor, pageSize, filters, priceValue }) => {
        const constraints = buildBaseConstraints(filters);
        constraints.push(where("precio", "==", priceValue));
        constraints.push(orderBy("createdAt", "desc"), orderBy(documentId(), "desc"));
        if (cursor) {
          constraints.push(startAfter(cursor));
        }
        constraints.push(limit(pageSize));
        return query(prendas2025Ref, ...constraints);
      };

      const fetchNoPricePage = async ({ cursor, pageSize, filters, priceValue }) => {
        console.log("[Prendas] Query ejecutada", {
          filters,
          mode: priceValue === null ? "no-price-null" : "no-price-zero",
          cursorId: cursor?.id ?? null,
          pageSize
        });
        const pageQuery = buildNoPriceQuery({ cursor, pageSize, filters, priceValue });
        const snapshot = await getDocs(pageQuery);
        console.log("[Prendas] Docs recibidos", snapshot.docs.length);
        return snapshot;
      };

      const resetPrendasState = () => {
        prendasState.data = [];
        prendasState.filtered = [];
        prendasState.lastDocs = { main: null, noPrice: null, noPriceZero: null };
        prendasState.hasMore = true;
        prendasState.hasMoreMain = true;
        prendasState.hasMoreNoPrice = true;
        prendasState.isDone = false;
        prendasState.seenIds.clear();
        prendasState.filtersActive = false;
        prendasState.showingTotal = null;
        prendasState.queryKey = "";
        prendasState.scanMode = false;
        prendasState.lastScanSnap = null;
        prendasState.hasMoreScan = true;
      };

      const renderLoadingPlaceholder = () => {
        if (!prendasTbody) return;
        prendasTbody.textContent = "";
        const row = document.createElement("tr");
        const cell = document.createElement("td");
        cell.colSpan = 11;
        cell.textContent = "Cargando base de datos...";
        row.appendChild(cell);
        prendasTbody.appendChild(row);
        setCounter(0, prendasState.showingTotal ?? 0);
      };

      const fetchNextPage = async (filters, { reset = false } = {}) => {
        if (
          prendasState.isLoadingInitial ||
          prendasState.isLoadingMore ||
          prendasState.isDone
        )
          return;
        setSkuSearchMode(false);
        setPrendasAlert("");
        setLoadingState(reset ? "initial" : "more", true);
        prendasLoadMore.disabled = true;
        const pageSize = getPageSize();
        const hasPriceRange = filters.minPrice !== null || filters.maxPrice !== null;
        const includeNoPrice = Boolean(filters.includeNoPrice && hasPriceRange);

        const queryStart = performance.now();
        const rid = ++prendasState.reqId;

        try {

          const mainSnapshot = await fetchPrendasPage({
            cursor: reset ? null : prendasState.lastDocs.main,
            pageSize,
            filters,
            mode: hasPriceRange ? "price-range" : "list"
          });
          if (rid !== prendasState.reqId) {
            return;
          }
          const tQuery = Number((performance.now() - queryStart).toFixed(1));

          const mapStart = performance.now();
          const mainDocs = mainSnapshot
            ? mainSnapshot.docs.map((docSnap) => normalizeDoc(docSnap))
            : [];
          let combinedDocs = [...mainDocs];

          if (includeNoPrice) {
            const [nullSnapshot, zeroSnapshot] = await Promise.all([
              fetchNoPricePage({
                cursor: reset ? null : prendasState.lastDocs.noPrice,
                pageSize,
                filters,
                priceValue: null
              }),
              fetchNoPricePage({
                cursor: reset ? null : prendasState.lastDocs.noPriceZero,
                pageSize,
                filters,
                priceValue: 0
              })
            ]);
            if (rid !== prendasState.reqId) {
              return;
            }
            const nullDocs = nullSnapshot
              ? nullSnapshot.docs.map((docSnap) => normalizeDoc(docSnap))
              : [];
            const zeroDocs = zeroSnapshot
              ? zeroSnapshot.docs.map((docSnap) => normalizeDoc(docSnap))
              : [];
            combinedDocs = combinedDocs.concat(nullDocs, zeroDocs);

            if (nullSnapshot && nullSnapshot.docs.length) {
              prendasState.lastDocs.noPrice = nullSnapshot.docs[nullSnapshot.docs.length - 1];
            }
            if (zeroSnapshot && zeroSnapshot.docs.length) {
              prendasState.lastDocs.noPriceZero = zeroSnapshot.docs[zeroSnapshot.docs.length - 1];
            }
            prendasState.hasMoreNoPrice =
              Boolean(nullSnapshot?.docs.length) || Boolean(zeroSnapshot?.docs.length);
          }

          const combined = combinedDocs
            .filter((item) => {
              if (prendasState.seenIds.has(item.id)) return false;
              prendasState.seenIds.add(item.id);
              return true;
            })
            .sort((a, b) => comparePrendas(a, b));

          const tMap = Number((performance.now() - mapStart).toFixed(1));
          console.info("[Prendas] Query Firestore", {
            ms: tQuery,
            docs: combined.length,
            pageSize,
            tMap
          });

          if (mainSnapshot && mainSnapshot.docs.length) {
            prendasState.lastDocs.main = mainSnapshot.docs[mainSnapshot.docs.length - 1];
          }
          const mainHasMore = mainSnapshot && mainSnapshot.docs.length === pageSize;
          const noPriceHasMore = includeNoPrice ? prendasState.hasMoreNoPrice : false;
          prendasState.isDone = !mainHasMore && !noPriceHasMore;

          if (reset) {
            prendasState.data = combined;
          } else {
            prendasState.data = prendasState.data.concat(combined);
          }
        } catch (error) {
          if (!handleIndexError(error)) {
            console.error(error);
            setPrendasAlert("No se pudo cargar la base de datos de códigos.");
          }
        } finally {
          if (rid !== prendasState.reqId) {
            return;
          }
          setLoadingState(reset ? "initial" : "more", false);
          prendasLoadMore.disabled = prendasState.isDone || prendasState.isSkuSearch;
        }
      };

      const reloadPrendasList = async ({ reason = "manual" } = {}) => {
        setLoadingState("initial", true);
        const rid = ++prendasState.reqId;
        try {
          setSkuSearchMode(false);
          resetPrendasState();
          renderLoadingPlaceholder();
          const filters = getCurrentFilters();
          prendasState.filters = filters;
          prendasState.filtersActive = hasActiveFilters(filters);
          const pageSize = getPageSize();
          prendasState.queryKey = buildQueryKey(filters, pageSize);
          await fetchNextPage(filters, { reset: true });
          if (rid !== prendasState.reqId) {
            return;
          }
          const { tFilter, tRender } = await applyFiltersAndRender();
          console.log("[Perf]", {
            reason,
            tFilter,
            tRender,
            docs: prendasState.filtered.length
          });
        } finally {
          if (rid !== prendasState.reqId) {
            return;
          }
          setLoadingState("initial", false);
        }
      };

      const applyFilters = async () => {
        prendasState.filters = getCurrentFilters();
        await reloadPrendasList({ reason: "filters" });
      };

      const ensureRequired = () => {
        if (!registroProveedor.value || !registroProducto.value || !registroColor.value || !registroTalla.value) {
          setRegistroStatus("Completa Proveedor, Producto, Color y Talla.", "error");
          return false;
        }
        return true;
      };

      const getSelectedName = (selectEl) => {
        const option = selectEl.options[selectEl.selectedIndex];
        return option?.dataset?.nombre || option?.textContent?.split(" - ")[1] || option?.textContent || "";
      };

      const HISTORICOS_URL = "../Data/codigos_historicos.json";
      let historicosCache = null;

      const loadHistoricosMap = async () => {
        if (historicosCache) {
          return historicosCache;
        }
        historicosCache = fetch(HISTORICOS_URL)
          .then((response) => {
            if (!response.ok) {
              throw new Error("No se pudo cargar el histórico de códigos.");
            }
            return response.json();
          })
          .then((codes) => {
            const maxPorKey = {};
            const pattern = /^HA(\d+)([A-Z])(\d{3})\//i;
            codes.forEach((code) => {
              const match = pattern.exec(String(code).trim().toUpperCase());
              if (!match) return;
              const key = `prov${match[1]}_tipo${match[2]}`;
              const seq = Number(match[3]);
              if (!Number.isFinite(seq)) return;
              if (!maxPorKey[key] || seq > maxPorKey[key]) {
                maxPorKey[key] = seq;
              }
            });
            return maxPorKey;
          })
          .catch((error) => {
            console.warn("No se pudo cargar el histórico de códigos.", error);
            return {};
          });
        return historicosCache;
      };

      const getNextCounter = async (providerCode, typeCode) => {
        const key = `prov${providerCode}_tipo${typeCode}`;
        const counterRef = doc(db, "counters", key);

        return runTransaction(db, async (transaction) => {
          const snapshot = await transaction.get(counterRef);
          const data = snapshot.data() || {};
          let counterValue = Number(data.value);

          if (!Number.isFinite(counterValue)) {
          counterValue = Number(data.lastNumber);
          }

          if (!Number.isFinite(counterValue)) {
          const maxPorKey = await loadHistoricosMap();
          counterValue = Number(maxPorKey[key] ?? 0);
          }
          if (!Number.isFinite(counterValue)) {
            throw new Error(`Contador inválido para ${key}. Revisa counters/${key}.`);
          }
          console.log("COUNTER READ", { key, data, counterValue });
          const nextValue = counterValue + 1;
          transaction.set(counterRef, { value: nextValue, lastNumber: nextValue }, { merge: true });
          return { nextValue, key };
        });
      };

      registroForm.addEventListener("submit", async (event) => {
        event.preventDefault();
        setRegistroStatus("");

        if (!ensureRequired()) {
          return;
        }

        const providerCode = registroProveedor.value;
        const typeCode = registroProducto.value;
        const colorClave = registroColor.value;
        const tallaClave = registroTalla.value;
        try {
          registroSubmit.disabled = true;
          const { nextValue, key } = await getNextCounter(providerCode, typeCode);
          const consecutivo = String(nextValue).padStart(3, "0");
          const codigo = `HA${providerCode}${typeCode}${consecutivo}/${colorClave}-${tallaClave}`;
          console.info(`Generando código ${codigo} para counter ${key}.`);

          const costoValue = Number(document.getElementById("registro-costo").value);
          const createdByValue = document.getElementById("registro-created-by").value.trim();
          const detallesValue = registroDetalles.value.trim();
          const tipoNombre = getSelectedName(registroProducto).trim();
          const proveedorNombre = getSelectedName(registroProveedor).trim();
          const colorNombre = getSelectedName(registroColor).trim();
          const tallaNombre = getSelectedName(registroTalla).trim();
          const descripcion = [tipoNombre, proveedorNombre, colorNombre, tallaNombre]
            .filter(Boolean)
            .join(" ");

          const data = {
            codigo,
            proveedor: providerCode,
            tipo: typeCode,
            color: colorClave,
            talla: tallaClave,
            descripcion: descripcion || null,
            detalles: detallesValue || null,
            costo: Number.isFinite(costoValue) ? costoValue : 0,
            code: codigo,
            providerCode,
            typeCode,
            seqNumber: nextValue,
            colorCode: colorClave,
            sizeCode: tallaClave,
            creadoPor: createdByValue || null,
            createdAt: serverTimestamp()
          };

          const codeQuery = query(prendasRef, where("code", "==", codigo));
          const legacyQuery = query(prendasRef, where("codigo", "==", codigo));
          const [codeSnapshot, legacySnapshot] = await Promise.all([
            getDocs(codeQuery),
            getDocs(legacyQuery)
          ]);
          const duplicateFound = !codeSnapshot.empty || !legacySnapshot.empty;

          await addDoc(prendasRef, data);

          registroCodigo.textContent = codigo;
          registroResult.classList.remove("hidden");
          if (duplicateFound) {
            setRegistroStatus("Código ya existe (duplicado).", "warning");
          } else {
            setRegistroStatus("Prenda guardada correctamente.", "success");
          }
        } catch (error) {
          const message =
            error?.message?.includes("contador") || error?.message?.includes("Contador")
              ? error.message
              : "No se pudo generar el código. Intenta nuevamente.";
          setRegistroStatus(message, "error");
          console.error(error);
        } finally {
          registroSubmit.disabled = false;
        }
      });

      registroCopy.addEventListener("click", async () => {
        try {
          await navigator.clipboard.writeText(registroCodigo.textContent.trim());
          setRegistroStatus("Código copiado al portapapeles.", "success");
        } catch (error) {
          setRegistroStatus("No se pudo copiar el código.", "error");
          console.error(error);
        }
      });

      registroReset.addEventListener("click", () => {
        registroForm.reset();
        registroResult.classList.add("hidden");
        setRegistroStatus("");
      });

      zplForm.addEventListener("submit", (event) => {
        event.preventDefault();
        setZplStatus("");

        const codigo = document.getElementById("zpl-codigo").value.trim();
        const cantidadValue = Number(document.getElementById("zpl-cantidad").value);
        const cantidad = Number.isFinite(cantidadValue) && cantidadValue > 0 ? cantidadValue : 1;

        const formatoValido = CODE_PATTERN.test(codigo.toUpperCase());
        if (!codigo || !formatoValido) {
          setZplStatus("Ingresa un código válido (HA{#}{A}{NNN}/COLOR-TALLA).", "error");
          zplOutput.classList.add("hidden");
          return;
        }

        const template = `^XA
^CF0,40
^FO30,30^FD${codigo}^FS
^CF0,30
^FO30,90^FDPRECIO$^FS
^FO30,140^BQN,2,6^FDLA,${codigo}^FS
^XZ`;

        const zpl = Array.from({ length: cantidad }, () => template).join("\n");
        zplTextarea.value = zpl;
        zplOutput.classList.remove("hidden");
        setZplStatus("ZPL generado correctamente.", "success");
      });

      zplCopy.addEventListener("click", async () => {
        try {
          await navigator.clipboard.writeText(zplTextarea.value);
          setZplStatus("ZPL copiado al portapapeles.", "success");
        } catch (error) {
          setZplStatus("No se pudo copiar el ZPL.", "error");
          console.error(error);
        }
      });

      // ADMIN DB MODE START
      const DB_TAB_HASH = "#base-datos-codigos";
      const verifyAdminPassword = httpsCallable(functions, "verifyAdminPassword");
      const backfillSearchTokens = httpsCallable(functions, "backfillSearchTokens");

      const getAdminSession = () => {
        const raw = sessionStorage.getItem(ADMIN_SESSION_KEY);
        if (!raw) return null;
        try {
          const session = JSON.parse(raw);
          if (!session?.sessionId || !session?.expiresAt) return null;
          if (Date.now() > session.expiresAt) {
            sessionStorage.removeItem(ADMIN_SESSION_KEY);
            return null;
          }
          return session;
        } catch (error) {
          console.warn("Sesión admin inválida, limpiando.", error);
          sessionStorage.removeItem(ADMIN_SESSION_KEY);
          return null;
        }
      };

      const setAdminSession = ({ sessionId, expiresAt }) => {
        sessionStorage.setItem(
          ADMIN_SESSION_KEY,
          JSON.stringify({ sessionId, expiresAt })
        );
      };

      const clearAdminSession = () => {
        sessionStorage.removeItem(ADMIN_SESSION_KEY);
      };

      const getAdminViewEnabled = () =>
        sessionStorage.getItem(ADMIN_VIEW_KEY) === "1";

      const setAdminViewEnabled = (enabled) => {
        sessionStorage.setItem(ADMIN_VIEW_KEY, enabled ? "1" : "0");
      };

      const setAdminLoginStatus = (message, type = "") => {
        if (!adminLoginStatus) return;
        adminLoginStatus.textContent = message;
        adminLoginStatus.className = `status ${type}`.trim();
      };

      const setAdminBackfillStatus = (message, type = "") => {
        if (!adminBackfillStatus) return;
        adminBackfillStatus.textContent = message;
        adminBackfillStatus.className = `status ${type}`.trim();
      };

      const applyAdminUI = () => {
        const session = getAdminSession();
        const sessionActive = Boolean(session);
        if (!sessionActive) {
          setAdminViewEnabled(false);
        }
        const enabled = sessionActive && getAdminViewEnabled();
        prendasState.isAdmin = enabled;
        if (dbCodigosSection) {
          dbCodigosSection.classList.toggle("admin-enabled", enabled);
        }
        if (adminToggleDb) {
          adminToggleDb.checked = enabled;
          adminToggleDb.disabled = !sessionActive;
        }
        if (adminActions) {
          adminActions.classList.toggle("hidden", !sessionActive);
        }
        if (adminLoginButton) {
          adminLoginButton.classList.toggle("hidden", sessionActive);
        }
        if (adminLogoutButton) {
          adminLogoutButton.classList.toggle("hidden", !sessionActive);
        }
        if (prendasState.filtered.length) {
          renderDocs(prendasState.filtered);
        }
      };

      const handleAdminToggle = (event) => {
        if (!getAdminSession()) return;
        setAdminViewEnabled(event.target.checked);
        applyAdminUI();
      };

      const handleAdminLogin = async () => {
        const password = safeString(adminPasswordInput?.value).trim();
        if (!password) {
          setAdminLoginStatus("Ingresa la contraseña admin.", "error");
          return;
        }
        if (adminLoginButton) {
          adminLoginButton.disabled = true;
        }
        setAdminLoginStatus("Verificando...", "");
        try {
          const response = await verifyAdminPassword({ password });
          const data = response?.data || {};
          if (!data?.sessionId || !data?.expiresAt) {
            throw new Error("Respuesta inválida del servidor.");
          }
          setAdminSession({ sessionId: data.sessionId, expiresAt: data.expiresAt });
          setAdminViewEnabled(true);
          if (adminPasswordInput) {
            adminPasswordInput.value = "";
          }
          setAdminLoginStatus("Modo admin habilitado.", "success");
          applyAdminUI();
        } catch (error) {
          console.error(error);
          setAdminLoginStatus("Contraseña inválida o servicio no disponible.", "error");
        } finally {
          if (adminLoginButton) {
            adminLoginButton.disabled = false;
          }
        }
      };

      const handleAdminLogout = () => {
        clearAdminSession();
        setAdminViewEnabled(false);
        setAdminLoginStatus("Sesión cerrada.", "");
        setAdminBackfillStatus("");
        applyAdminUI();
      };

      const handleBackfill = async () => {
        const session = getAdminSession();
        if (!session) {
          setAdminBackfillStatus("Inicia sesión admin para continuar.", "error");
          return;
        }
        if (adminBackfillButton) {
          adminBackfillButton.disabled = true;
        }
        setAdminBackfillStatus("Preparando buscador...", "");
        let cursor = null;
        let processed = 0;
        let updated = 0;
        let skipped = 0;
        try {
          let loops = 0;
          while (loops < 200) {
            const response = await backfillSearchTokens({
              sessionId: session.sessionId,
              cursor
            });
            const data = response?.data || {};
            processed += Number(data.processed || 0);
            updated += Number(data.updated || 0);
            skipped += Number(data.skipped || 0);
            cursor = data.lastDocId || null;
            setAdminBackfillStatus(
              `Procesados: ${processed} · Actualizados: ${updated} · Omitidos: ${skipped}`,
              ""
            );
            if (!data.hasMore) {
              break;
            }
            loops += 1;
          }
          setAdminBackfillStatus(
            `Listo: ${updated} actualizados, ${skipped} omitidos.`,
            "success"
          );
        } catch (error) {
          console.error(error);
          setAdminBackfillStatus("Error al preparar el buscador.", "error");
        } finally {
          if (adminBackfillButton) {
            adminBackfillButton.disabled = false;
          }
        }
      };

      const handleTabChange = (hash) => {
        if (hash === DB_TAB_HASH) {
          applyAdminUI();
        }
      };

      if (adminToggleDb) {
        adminToggleDb.addEventListener("change", handleAdminToggle);
      }
      if (adminLoginButton) {
        adminLoginButton.addEventListener("click", handleAdminLogin);
      }
      if (adminLogoutButton) {
        adminLogoutButton.addEventListener("click", handleAdminLogout);
      }
      if (adminBackfillButton) {
        adminBackfillButton.addEventListener("click", handleBackfill);
      }
      if (adminPasswordInput) {
        adminPasswordInput.addEventListener("keydown", (event) => {
          if (event.key === "Enter") {
            event.preventDefault();
            handleAdminLogin();
          }
        });
      }

      window.addEventListener("hashchange", () => {
        handleTabChange(window.location.hash);
      });

      document.querySelectorAll('a.card[href^="#"]').forEach((link) => {
        link.addEventListener("click", (event) => {
          const hash = event.currentTarget.getAttribute("href") || "";
          handleTabChange(hash);
        });
      });
      // ADMIN DB MODE END

      const handleSearchInput = debounce(async () => {
        if (isBooting) return;
        const rawInput = getSearchInput();
        if (!rawInput.trim()) {
          await reloadPrendasList();
          return;
        }
        if (isFullSku(rawInput)) {
          await runSkuSearch(rawInput);
          return;
        }
        setSkuSearchMode(false);
        await applyFilters();
      }, PRENDAS_SEARCH_DEBOUNCE);

      const handleFilterApply = async () => {
        if (isBooting) return;
        const rawInput = getSearchInput();
        if (rawInput.trim() && isFullSku(rawInput)) {
          await runSkuSearch(rawInput);
          return;
        }
        await applyFilters();
      };

      prendasSearch.addEventListener("input", handleSearchInput);
      prendasPrecioApply.addEventListener("click", handleFilterApply);
      if (prendasPageSize) {
        prendasPageSize.addEventListener("change", async () => {
          if (isBooting) return;
          await reloadPrendasList({ reason: "page-size" });
        });
      }

      [prendasPrecioMin, prendasPrecioMax].forEach((input) => {
        input.addEventListener("keydown", (event) => {
          if (isBooting) return;
          if (event.key === "Enter") {
            event.preventDefault();
            handleFilterApply();
          }
        });
      });

      prendasLoadMore.addEventListener("click", async () => {
        if (isBooting) return;
        const filters = prendasState.filters || getCurrentFilters();
        const nextHash = buildQueryKey(filters, getPageSize());
        if (prendasState.queryKey && nextHash !== prendasState.queryKey) {
          await reloadPrendasList({ reason: "filters-changed" });
          return;
        }
        await fetchNextPage(filters, { reset: false });
        await applyFiltersAndRender();
      });

      const init = async () => {
        isBooting = true;
        resetPrendasState();
        prendasSearch.value = "";
        prendasStatus.value = "todos";
        prendasProveedor.value = "todos";
        prendasTipo.value = "todos";
        prendasColor.value = "todos";
        prendasTalla.value = "todos";
        try {
          setRegistroStatus("Cargando diccionario...");
          registroSubmit.disabled = true;
          setSelectLoading(registroProducto, "Cargando...");
          setSelectLoading(registroProveedor, "Cargando...");
          setSelectLoading(registroColor, "Cargando...");
          setSelectLoading(registroTalla, "Cargando...");

          const dictionary = await loadDictionary();
          const dictionaryReady = !dictionary.empty && dictionary.missing.length === 0;
          if (dictionary.empty) {
            setRegistroStatus("Diccionario vacío: corre el workflow Seed Firestore.", "error");
          } else if (dictionary.missing.length) {
            setRegistroStatus(
              `Faltan datos en: ${dictionary.missing.join(", ")}.`,
              "error"
            );
          } else {
            setRegistroStatus("");
          }

          if (dictionary.tipos.length) {
            fillDictionarySelect(
              registroProducto,
              dictionary.tipos.sort((a, b) => a.clave.localeCompare(b.clave))
            );
          } else {
            setSelectLoading(registroProducto, "Sin opciones disponibles");
          }

          if (dictionary.proveedores.length) {
            fillDictionarySelect(
              registroProveedor,
              dictionary.proveedores.sort((a, b) => a.clave.localeCompare(b.clave))
            );
          } else {
            setSelectLoading(registroProveedor, "Sin opciones disponibles");
          }

          if (dictionary.colores.length) {
            fillDictionarySelect(
              registroColor,
              dictionary.colores.sort((a, b) => a.clave.localeCompare(b.clave))
            );
          } else {
            setSelectLoading(registroColor, "Sin opciones disponibles");
          }

          if (dictionary.tallas.length) {
            fillDictionarySelect(
              registroTalla,
              dictionary.tallas.sort((a, b) => a.clave.localeCompare(b.clave))
            );
          } else {
            setSelectLoading(registroTalla, "Sin opciones disponibles");
          }

          registroSubmit.disabled = !dictionaryReady;
        } catch (error) {
          setRegistroStatus("No pudimos cargar el diccionario.", "error");
          registroSubmit.disabled = true;
          console.error(error);
        } finally {
          // ADMIN DB MODE START
          applyAdminUI();
          handleTabChange(window.location.hash);
          // ADMIN DB MODE END
          setSkuSearchMode(false);
          try {
            await loadFilterDictionaries();
            await reloadPrendasList({ reason: "init" });
          } catch (error) {
            console.warn("No se pudieron cargar los filtros completos.", error);
            await reloadPrendasList({ reason: "init" });
          } finally {
            isBooting = false;
          }
        }
      };

      init();
    </script>
  </body>
</html>
