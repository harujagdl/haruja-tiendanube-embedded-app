<!DOCTYPE html>
<html lang="es">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover">
    <title>Panel Haruja – TD | Panel</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/qrcodejs/1.0.0/qrcode.min.js"></script>
    <style>
      :root {
        color-scheme: light;
        --page-pad: 18px;
        --bg: #f6f7fb;
        --card: #ffffff;
        --text: #1f2937;
        --muted: #6b7280;
        --primary: #1f6feb;
        --primary-dark: #1a55b5;
        --border: #e5e7eb;
        --shadow: 0 10px 24px rgba(15, 23, 42, 0.08);
        --radius: 16px;
      }

      * {
        box-sizing: border-box;
      }

      body {
        margin: 0;
        font-family: "Inter", "Segoe UI", system-ui, -apple-system, sans-serif;
        color: var(--text);
        background: var(--bg);
        padding-bottom: env(safe-area-inset-bottom);
      }

      .app {
        min-height: 100vh;
        display: flex;
        flex-direction: column;
      }

      .haruja-header {
        background: #fff;
        border-bottom: 1px solid rgba(15, 23, 42, 0.08);
        padding: 18px 0;
        display: flex;
        align-items: center;
        justify-content: center;
      }

      .haruja-header img {
        height: 72px;
        width: auto;
        max-width: min(70vw, 260px);
        display: block;
      }

      @media (max-width: 768px) {
        :root { --page-pad: 14px; }

        .haruja-header {
          padding: 14px 0;
        }

        .haruja-header img {
          height: 56px;
          max-width: min(78vw, 240px);
        }
      }

      @media (max-width: 420px) {
        .haruja-header img {
          height: 48px;
          max-width: min(82vw, 220px);
        }
      }

      .app-shell {
        padding: 0 var(--page-pad) 24px;
        display: flex;
        flex-direction: column;
        gap: 24px;
      }

      .view { display: none; }
      .view.is-active { display: block; }

      .grid {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(220px, 1fr));
        gap: 20px;
      }

      .panel-grid {
        display: grid;
        grid-template-columns: repeat(2, minmax(0, 1fr));
        gap: 16px;
      }

      @media (max-width: 900px) {
        .panel-grid { grid-template-columns: 1fr; }
      }

      .card {
        background: var(--card);
        border: 1px solid var(--border);
        border-radius: var(--radius);
        box-shadow: var(--shadow);
        padding: 20px;
        display: flex;
        flex-direction: column;
        gap: 12px;
        text-decoration: none;
        color: inherit;
      }

      .card h2 {
        margin: 0;
        font-size: 18px;
      }

      .card p {
        margin: 0;
        color: var(--muted);
        font-size: 14px;
      }

      .card .cta {
        margin-top: auto;
        font-weight: 600;
        color: var(--primary);
      }

      .section {
        background: var(--card);
        border: 1px solid var(--border);
        border-radius: var(--radius);
        box-shadow: var(--shadow);
        padding: 24px;
      }

      .section h2 {
        margin: 0 0 12px;
        font-size: 20px;
      }

      .section p {
        margin: 0 0 20px;
        color: var(--muted);
        font-size: 14px;
      }

      .form {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(180px, 1fr));
        gap: 16px;
        align-items: end;
      }

      .form-row {
        display: grid;
        grid-template-columns: repeat(6, minmax(0, 1fr));
        gap: 12px;
      }

      @media (max-width: 900px) {
        .form-row { grid-template-columns: 1fr; }
      }

      label {
        display: block;
        font-size: 13px;
        color: var(--muted);
        margin-bottom: 6px;
      }

      input {
        width: 100%;
        padding: 10px 12px;
        border-radius: 10px;
        border: 1px solid var(--border);
        font-size: 14px;
      }

      select {
        width: 100%;
        padding: 10px 12px;
        border-radius: 10px;
        border: 1px solid var(--border);
        font-size: 14px;
        background: #fff;
      }

      button {
        padding: 12px 16px;
        border-radius: 12px;
        border: none;
        background: var(--primary);
        color: #fff;
        font-weight: 600;
        cursor: pointer;
      }

      .btn {
        min-height: 44px;
        padding: 10px 14px;
        border-radius: 999px;
      }

      button:hover {
        background: var(--primary-dark);
      }

      button.secondary {
        background: #e5e7eb;
        color: #1f2937;
      }

      button.secondary:hover {
        background: #d1d5db;
      }

      .status {
        font-size: 14px;
        color: var(--muted);
        min-height: 20px;
      }

      .status.success {
        color: #15803d;
      }

      .status.error {
        color: #b91c1c;
      }

      .status.warning {
        color: #b45309;
      }

      .result-card {
        margin-top: 16px;
        padding: 16px;
        border-radius: 12px;
        border: 1px solid var(--border);
        background: #f8fafc;
      }

      .result-code {
        font-size: 24px;
        font-weight: 700;
        letter-spacing: 0.5px;
        margin: 8px 0 16px;
      }

      .result-actions {
        display: flex;
        flex-wrap: wrap;
        gap: 12px;
      }

      .muted {
        color: var(--muted);
        font-size: 13px;
      }

      .zpl-output {
        margin-top: 16px;
      }

      textarea {
        width: 100%;
        min-height: 180px;
        padding: 12px;
        border-radius: 12px;
        border: 1px solid var(--border);
        font-size: 13px;
        font-family: "SFMono-Regular", "Consolas", "Liberation Mono", monospace;
      }

      .hidden {
        display: none !important;
      }

      .tool-page {
        width: 100%;
      }

      table {
        width: 100%;
        border-collapse: collapse;
        font-size: 14px;
      }

      th,
      td {
        padding: 10px 12px;
        border-bottom: 1px solid var(--border);
        text-align: left;
      }


      th {
        color: var(--muted);
        font-weight: 600;
      }

      th[data-filter-key] {
        white-space: nowrap;
      }

      .th-filter {
        position: relative;
        display: inline-flex;
        align-items: center;
        gap: 8px;
      }

      .filter-btn {
        position: relative;
        border: 1px solid #d0d5dd;
        background: linear-gradient(180deg, #ffffff 0%, #f8fafc 100%);
        border-radius: 10px;
        font-size: 12px;
        width: 26px;
        height: 26px;
        line-height: 1;
        color: #475467;
        cursor: pointer;
        display: inline-flex;
        align-items: center;
        justify-content: center;
        box-shadow: 0 1px 2px rgba(16, 24, 40, 0.08);
        transition: all 0.2s ease;
      }

      .filter-btn:hover {
        border-color: #98a2b3;
        background: #f8fafc;
        transform: translateY(-1px);
      }

      .filter-btn:focus-visible {
        outline: 3px solid #bfdbfe;
        outline-offset: 1px;
      }

      .filter-btn.active {
        border-color: #2563eb;
        color: #2563eb;
        background: #eff6ff;
      }

      .filter-btn.active::after {
        content: "";
        position: absolute;
        top: -2px;
        right: -2px;
        width: 8px;
        height: 8px;
        border-radius: 999px;
        background: #2563eb;
        border: 2px solid #fff;
      }

      .filter-popover {
        position: fixed;
        z-index: 9999;
        width: 300px;
        max-height: min(430px, calc(100vh - 24px));
        overflow: hidden;
        border-radius: 16px;
        border: 1px solid #e4e7ec;
        background: #fff;
        box-shadow:
          0 20px 36px rgba(16, 24, 40, 0.14),
          0 4px 10px rgba(16, 24, 40, 0.08);
        display: grid;
        grid-template-rows: auto auto auto 1fr auto;
        font-size: 13px;
      }

      .filter-popover.range-popover {
        width: clamp(280px, 30vw, 320px);
        grid-template-rows: auto auto auto;
      }

      .filter-popover .popover-head {
        padding: 12px 12px 8px;
        border-bottom: 1px solid #f2f4f7;
      }

      .filter-popover .popover-title {
        margin: 0;
        font-size: 13px;
        color: #344054;
        font-weight: 600;
      }

      .filter-popover .search-wrap {
        position: relative;
        padding: 10px 12px 0;
      }

      .filter-popover .search-wrap::before {
        content: "⌕";
        position: absolute;
        left: 21px;
        top: 18px;
        font-size: 14px;
        opacity: 0.7;
      }

      .filter-popover input[type="text"],
      .filter-popover input[type="number"] {
        width: 100%;
        border: 1px solid #d0d5dd;
        border-radius: 10px;
        font-size: 13px;
        padding: 8px 10px;
        background: #fff;
      }

      .filter-popover .search-wrap input {
        padding-left: 28px;
      }

      .filter-popover input:focus-visible {
        outline: 3px solid #bfdbfe;
        border-color: #93c5fd;
      }

      .filter-popover .meta {
        font-size: 12px;
        color: #667085;
        padding: 8px 12px 0;
      }

      .filter-popover .option-all {
        display: flex;
        align-items: center;
        gap: 8px;
        padding: 8px 12px;
        font-size: 13px;
        border-bottom: 1px solid #f2f4f7;
      }

      .filter-popover .options {
        padding: 8px;
        max-height: 220px;
        overflow: auto;
      }

      .filter-popover .option-row {
        display: flex;
        align-items: center;
        gap: 8px;
        padding: 7px 8px;
        border-radius: 8px;
        font-size: 13px;
        cursor: pointer;
      }

      .filter-popover .option-row input {
        margin: 0;
        width: 15px;
        height: 15px;
        flex: 0 0 auto;
      }

      .filter-popover .option-row:hover {
        background: #f2f4f7;
      }

      .filter-popover .actions {
        position: sticky;
        bottom: 0;
        display: flex;
        gap: 8px;
        padding: 10px;
        border-top: 1px solid #f2f4f7;
        background: #fff;
      }

      .filter-popover .actions button {
        flex: 1;
        padding: 9px 12px;
        border-radius: 10px;
        font-size: 13px;
      }

      .filter-popover .range-fields {
        display: grid;
        grid-template-columns: repeat(2, minmax(0, 1fr));
        gap: 10px;
        padding: 10px 12px;
      }

      .filter-popover .range-field {
        display: grid;
        gap: 6px;
      }

      .filter-popover .range-field label {
        margin: 0;
        font-size: 12px;
        color: #667085;
      }

      .filter-popover .hint {
        font-size: 12px;
        color: #b45309;
        padding: 0 12px 8px;
      }

      .panel-controls {
        display: flex;
        flex-direction: column;
        gap: 16px;
        margin-bottom: 16px;
      }

      .filters-grid {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(180px, 1fr));
        gap: 12px;
        align-items: end;
      }

      .filters-grid .price-range {
        display: flex;
        gap: 8px;
      }

      .filters-grid .price-range input {
        width: 100%;
      }

      .filters-grid .inline-toggle {
        display: flex;
        align-items: center;
        gap: 10px;
        padding: 10px 12px;
        border-radius: 10px;
        border: 1px solid var(--border);
        background: #f8fafc;
      }

      .filters-grid .inline-toggle input {
        width: auto;
      }

      .counters {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(140px, 1fr));
        gap: 12px;
      }

      .counter-card {
        border-radius: 12px;
        padding: 12px;
        border: 1px solid var(--border);
        background: #f8fafc;
      }

      .counter-card span {
        display: block;
        font-size: 12px;
        color: var(--muted);
      }

      .counter-card strong {
        font-size: 18px;
      }

      .table-wrapper {
        width: 100%;
        overflow-x: auto;
      }

      .badge {
        display: inline-block;
        padding: 4px 8px;
        border-radius: 999px;
        font-size: 12px;
        font-weight: 600;
      }

      .badge-success {
        background: #e8f5e9;
        color: #166534;
      }

      .badge-danger {
        background: #fee2e2;
        color: #b91c1c;
      }

      .row-new {
        background: #f5f8ff;
      }

      .row-old {
        background: #f3fbf6;
      }

      .loading-row {
        display: flex;
        align-items: center;
        gap: 8px;
        padding: 8px 0;
        color: #667085;
        font-size: 13px;
      }

      .loading-spinner {
        width: 14px;
        height: 14px;
        border-radius: 50%;
        border: 2px solid #e4e7ec;
        border-top-color: #667085;
        animation: spin 0.8s linear infinite;
      }

      @keyframes spin {
        to {
          transform: rotate(360deg);
        }
      }

      .loading-text {
        user-select: none;
      }

      .alert {
        padding: 12px 16px;
        border-radius: 10px;
        border: 1px solid #fecaca;
        background: #fef2f2;
        color: #991b1b;
        font-size: 14px;
      }

      .pagination {
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin-top: 16px;
        gap: 12px;
        flex-wrap: wrap;
      }

      .pagination span {
        color: var(--muted);
        font-size: 14px;
      }

      .pagination button {
        min-width: 120px;
      }

      .pagination .page-indicator {
        font-weight: 600;
        color: var(--text);
      }



      .admin-create-card {
        grid-column: 1 / -1;
        border: 1px solid #e5e7eb;
        background: #f8fafc;
        border-radius: 12px;
        padding: 12px;
        display: grid;
        gap: 10px;
      }

      .admin-create-card .admin-create-title {
        font-size: 13px;
        font-weight: 600;
        color: #374151;
      }

      .admin-create-card .admin-create-grid {
        display: grid;
        grid-template-columns: repeat(2, minmax(0, 1fr));
        gap: 12px;
      }

      @media (max-width: 720px) {
        .admin-create-card .admin-create-grid {
          grid-template-columns: 1fr;
        }
      }

      .admin-create-card small {
        color: #6b7280;
        font-size: 12px;
      }
      .admin-optional {
        display: flex;
        align-items: center;
        justify-content: space-between;
        gap: 12px;
        flex-wrap: wrap;
        padding: 12px;
        border-radius: 12px;
        border: 1px dashed #d1d5db;
        background: #f8fafc;
      }

      #dbCodigosSection .admin-only{display:none !important;}
    body.is-admin .admin-only{display:table-cell !important;}
    body.is-admin .admin-only.flex{display:flex !important;}

    /* Ensure table stays inside module and scrolls horizontally on small screens */
    #dbCodigosSection .table-wrapper{max-width:100%; overflow-x:auto; border-radius:16px;}
    #dbCodigosSection table{width:100%; border-collapse:separate; border-spacing:0;}
#dbCodigosSection th, #dbCodigosSection td{padding:10px 10px; font-size:13px;}
#dbCodigosSection th{white-space:nowrap;}
    #dbCodigosSection .table-toolbar{position:sticky; top:0; background:transparent;}


      #dbCodigosSection.admin-enabled .admin-only {
        display: revert !important;
      }

      #dbCodigosSection .admin-panel {
        display: grid;
        gap: 12px;
        padding: 12px;
        border-radius: 12px;
        border: 1px solid #e5e7eb;
        background: #f8fafc;
        margin-top: 12px;
      }

      #dbCodigosSection .admin-login-row {
        display: flex;
        gap: 8px;
        flex-wrap: wrap;
        align-items: center;
      }

      #dbCodigosSection .admin-login-row input {
        flex: 1;
        min-width: 180px;
      }

      #dbCodigosSection .admin-actions {
        display: grid;
        gap: 8px;
      }

      #dbCodigosSection .admin-actions.hidden {
        display: none;
      }

      #dbCodigosSection .rowEditBtn {
        width: 32px;
        height: 32px;
        border-radius: 10px;
        border: 1px solid #d0d5dd;
        background: #fff;
        color: #344054;
        display: inline-flex;
        align-items: center;
        justify-content: center;
        font-size: 16px;
        padding: 0;
      }

      #dbCodigosSection .rowEditBtn:hover {
        background: #f2f4f7;
      }

      #dbCodigosSection .col-actions {
        text-align: center;
      }

      #dbCodigosSection .labels-panel {
        display: grid;
        gap: 10px;
        margin: 0 10px 12px;
        padding: 12px;
        border: 1px solid #d0d5dd;
        border-radius: 12px;
        background: #f8fafc;
      }

      #dbCodigosSection .labels-panel.hidden {
        display: none;
      }

      #dbCodigosSection .labels-panel-title {
        font-size: 13px;
        font-weight: 700;
      }

      #dbCodigosSection .labels-scope-options {
        display: flex;
        flex-wrap: wrap;
        gap: 14px;
        font-size: 13px;
      }

      #dbCodigosSection .labels-scope-options label {
        display: inline-flex;
        align-items: center;
        gap: 6px;
        margin: 0;
      }

      #dbCodigosSection .col-select {
        width: 36px;
        text-align: center;
      }

      #dbCodigosSection .row-select {
        width: 16px;
        height: 16px;
      }

      .edit-modal {
        position: fixed;
        inset: 0;
        z-index: 10000;
      }

      .edit-modal.hidden {
        display: none;
      }

      .edit-modal-overlay {
        position: absolute;
        inset: 0;
        background: rgba(15, 23, 42, 0.5);
      }

      .edit-modal-sheet {
        position: relative;
        z-index: 1;
        max-width: 520px;
        margin: 8vh auto;
        background: #fff;
        border-radius: 16px;
        border: 1px solid #e5e7eb;
        box-shadow: 0 20px 40px rgba(15, 23, 42, 0.25);
        padding: 16px;
      }

      .edit-modal-grid {
        display: grid;
        grid-template-columns: repeat(2, minmax(0, 1fr));
        gap: 12px;
      }

      .edit-modal-meta {
        margin-top: 12px;
        display: grid;
        grid-template-columns: repeat(2, minmax(0, 1fr));
        gap: 8px;
        font-size: 13px;
        color: #475467;
      }

      .edit-modal-actions {
        margin-top: 14px;
        display: flex;
        justify-content: flex-end;
        gap: 8px;
      }

      @media (max-width: 640px) {
        #dbCodigosSection .rowEditBtn {
          width: 40px;
          height: 40px;
        }

        .edit-modal-sheet {
          position: fixed;
          left: 0;
          right: 0;
          bottom: 0;
          margin: 0;
          max-width: none;
          border-radius: 16px 16px 0 0;
        }
      }

      @media (max-width: 600px) {
        .app-shell {
          padding: 0 var(--page-pad) 24px;
        }
      }
    
/* --- Pro filters bar (compact, professional) --- */
#dbCodigosSection .panel-controls{
  display:flex;
  flex-direction:column;
  gap:14px;
  margin-top: 16px;
}
#dbCodigosSection .filters-grid{
  display:grid;
  grid-template-columns: 2.2fr 1.2fr;
  gap:14px;
}
#dbCodigosSection .filters-grid label{
  font-size: 12px;
  color: var(--muted, #6b7280);
  margin-bottom: 6px;
}
#dbCodigosSection .filters-row{
  display:flex;
  flex-wrap:wrap;
  gap:12px;
  align-items:center;
  justify-content:space-between;
}
#dbCodigosSection .filters-row .inline-toggle{
  display:flex;
  align-items:center;
  gap:10px;
  margin:0;
}
#dbCodigosSection .filters-actions{
  display:flex;
  gap:10px;
  align-items:center;
}
#dbCodigosSection #prendas-precio-apply,
#dbCodigosSection #prendas-filters-clear{
  height: 44px;
  padding: 0 16px;
  border-radius: 14px;
}
#dbCodigosSection .filters-pagesize > div{
  display:flex;
  flex-direction:column;
}
#dbCodigosSection .filters-pagesize label{
  font-size:12px;
  color: var(--muted, #6b7280);
  margin-bottom: 6px;
}

/* --- Table toolbar + Admin button --- */
.table-toolbar{
  display:flex;
  align-items:center;
  justify-content:space-between;
  gap:12px;
  padding: 10px 10px 12px 10px;
}
.admin-mode-btn{
  height: 38px;
  padding: 0 14px;
  border-radius: 12px;
  border: 1px solid rgba(15, 23, 42, 0.14);
  background: #ffffff;
  color: #0f172a;
  font-weight: 600;
  cursor: pointer;
}
.admin-mode-btn.is-on{
  background: #0b5cff;
  border-color: #0b5cff;
  color: #ffffff;
}
.admin-mode-btn.is-disabled{
  opacity: 0.55;
  cursor: not-allowed;
}

/* Reduce extra whitespace around db header */
#dbCodigosSection h2{ margin-bottom: 6px; }
#dbCodigosSection p{ margin-top: 0; }

/* --- Cleaner filter bar tweaks --- */
#dbCodigosSection .filters-grid{
  grid-template-columns: 2.4fr 1.2fr;
}
#dbCodigosSection .filters-row{
  justify-content: flex-start;
}
#dbCodigosSection .filters-actions{ display:none; } /* we auto-apply */
#dbCodigosSection #prendas-precio-apply.hidden{ display:none !important; }
#dbCodigosSection #prendas-filters-clear{
  height: 38px;
  padding: 0 12px;
  border-radius: 12px;
}
#dbCodigosSection .filters-pagesize{
  margin-left: auto;
}
#dbCodigosSection .inline-toggle label{
  color: var(--muted, #6b7280);
}
/* Reduce section padding a bit */
#dbCodigosSection .section{ padding-top: 12px; }

/* --- Minimal mode tweaks --- */
#admin-panel{ display:none !important; }
.dashboard-stats, .stats-grid, #statsSection{ display:none !important; }

#dbCodigosSection .panel-controls{ padding-bottom: 6px; }

/* --- Align checkbox with search + price --- */
#dbCodigosSection .filters-grid{
  grid-template-columns: 2.3fr 1.2fr auto;
  align-items: end;
}
#dbCodigosSection .inline-toggle-top{
  display:flex;
  gap:10px;
  align-items:center;
  padding-bottom: 8px;
}
#dbCodigosSection .inline-toggle-top label{
  margin:0;
  font-size: 13px;
  color: var(--muted, #6b7280);
}

/* --- Page size under table (pagination bar) --- */
.pagination{
  display:flex;
  flex-wrap:wrap;
  gap:12px;
  align-items:center;
}
.page-size-inline{
  display:flex;
  gap:8px;
  align-items:center;
}
.page-size-inline label{
  font-size:12px;
  color: var(--muted, #6b7280);
}
.page-size-inline select{
  height: 36px;
  border-radius: 12px;
  padding: 0 10px;
}

/* Make reset button subtler */
button.secondary.small{
  height: 38px;
  padding: 0 12px;
  border-radius: 12px;
  background: rgba(15, 23, 42, 0.06);
}

/* --- Filters row aligned (single line) --- */
#dbCodigosSection .filters-grid.filters-grid-4{
  display:grid;
  grid-template-columns: 2.2fr 0.9fr 0.9fr auto;
  gap:14px;
  align-items:end;
}
#dbCodigosSection .filters-grid.filters-grid-4 input[type="text"],
#dbCodigosSection .filters-grid.filters-grid-4 input[type="number"]{
  height: 46px;
  border-radius: 14px;
}
#dbCodigosSection .filters-grid.filters-grid-4 label{
  font-size:12px;
  color: var(--muted, #6b7280);
  margin-bottom: 6px;
}
#dbCodigosSection .filters-grid.filters-grid-4 .inline-toggle-top{
  height: 46px;
  padding: 0 14px;
  border-radius: 14px;
  border: 1px solid rgba(15, 23, 42, 0.08);
  background: rgba(15, 23, 42, 0.02);
  display:flex;
  align-items:center;
  gap:10px;
  margin-bottom: 0;
}
#dbCodigosSection .filters-grid.filters-grid-4 .inline-toggle-top label{
  margin:0;
  font-size: 13px;
}

/* --- Minimal header filters --- */
#dbCodigosSection .filters-grid.filters-grid-min{
  display:grid;
  grid-template-columns: 1fr auto;
  gap: 12px;
  align-items:center;
  margin-top: 14px;
}
#dbCodigosSection .filters-grid.filters-grid-min input{
  height: 46px;
  border-radius: 14px;
}
.btn-more-filters{
  height: 46px;
  padding: 0 14px;
  border-radius: 14px;
  border: 1px solid rgba(15, 23, 42, 0.14);
  background: #fff;
  color: #0f172a;
  font-weight: 600;
  cursor:pointer;
  display:flex;
  align-items:center;
  gap:10px;
}
.btn-more-filters .dot{
  width: 8px;
  height: 8px;
  border-radius: 999px;
  background: transparent;
}
.btn-more-filters.has-active .dot{ background: #0b5cff; }

.more-filters-panel{
  margin-top: 10px;
  padding: 12px;
  border-radius: 16px;
  border: 1px solid rgba(15, 23, 42, 0.08);
  background: rgba(15, 23, 42, 0.02);
}
.more-filters-row{
  display:flex;
  flex-wrap:wrap;
  gap: 10px;
  align-items:center;
}
.more-filters-row input[type="number"]{
  height: 42px;
  border-radius: 14px;
  min-width: 140px;
}
.check-pill{
  height: 42px;
  padding: 0 12px;
  border-radius: 999px;
  border: 1px solid rgba(15, 23, 42, 0.08);
  background: #fff;
  display:flex;
  align-items:center;
  gap:10px;
  color: rgba(15, 23, 42, 0.75);
}
.check-pill input{ width:16px; height:16px; }
.btn-link{
  background: transparent;
  border: none;
  color: rgba(15, 23, 42, 0.65);
  font-weight: 600;
  cursor: pointer;
  padding: 6px 8px;
}
.btn-link:hover{ text-decoration: underline; }

/* --- Keep table inside section --- */
.table-wrapper{
  width: 100%;
  overflow-x: auto;
  -webkit-overflow-scrolling: touch;
}
#tablaPrendas{
  width: 100%;
  min-width: 1100px;
}

/* --- Page size at very bottom --- */
.page-size-bottom{
  display:flex;
  justify-content:center;
  align-items:center;
  gap:10px;
  margin-top: 10px;
  padding-bottom: 6px;
  color: rgba(15, 23, 42, 0.65);
  font-size: 12px;
}
.page-size-bottom select{
  height: 36px;
  border-radius: 12px;
  padding: 0 10px;
}

/* --- Keep table inside same white module --- */
#dbCodigosSection{
  background: #ffffff;
  border: 1px solid rgba(15, 23, 42, 0.08);
  border-radius: 24px;
  padding: 28px;
  box-shadow: 0 10px 30px rgba(15, 23, 42, 0.06);
  overflow: hidden; /* keeps table/pagination visually inside */
}
@media (max-width: 900px){
  #dbCodigosSection{ padding: 18px; border-radius: 20px; }
}
/* ensure table scroll stays inside the module */
#dbCodigosSection .table-wrapper{
  border-radius: 18px;
  border: 1px solid rgba(15, 23, 42, 0.08);
  background: #fff;
  overflow-x: auto;
}
#dbCodigosSection table{ min-width: 980px; } /* horizontal scroll instead of breaking */

/* --- Unified module (filters + table) --- */
.db-module{
  background:#fff;
  border:1px solid rgba(15, 23, 42, 0.08);
  border-radius:24px;
  padding:28px;
  box-shadow:0 10px 30px rgba(15, 23, 42, 0.06);
  overflow:hidden; /* keeps table/pagination inside */
}
@media (max-width: 900px){
  .db-module{ padding:18px; border-radius:20px; }
}

/* Remove inner "card" look so it doesn't feel like 2 módulos */
#dbCodigosSection .panel-controls{
  background: transparent !important;
  border: 0 !important;
  box-shadow: none !important;
  padding: 0 !important;
  margin: 14px 0 14px !important;
}

/* Table stays within module on any screen */
#dbCodigosSection .table-wrapper{
  width: 100%;
  max-width: 100%;
  border-radius: 18px;
  border: 1px solid rgba(15, 23, 42, 0.08);
  background: #fff;
  overflow-x: auto;
  -webkit-overflow-scrolling: touch;
}
#dbCodigosSection table{
  width: 100%;
  min-width: 980px; /* horizontal scroll instead of breaking layout */
}
@media (max-width: 1100px){
  #dbCodigosSection table{ min-width: 900px; }
}
@media (max-width: 900px){
  #dbCodigosSection table{ min-width: 760px; }
}
@media (max-width: 700px){
  #dbCodigosSection table{ min-width: 680px; }
}

/* Bottom controls inside module */
.page-size-bottom{ padding-bottom: 0; }

/* === Make the WHOLE DB section a single module (so table doesn't look "outside") === */
#base-datos-codigos{
  background:#fff;
  border:1px solid rgba(15,23,42,0.08);
  border-radius:24px;
  padding:28px;
  box-shadow:0 10px 30px rgba(15,23,42,0.06);
  overflow:hidden;
  margin-bottom: 18px;
}
@media (max-width: 900px){
  #base-datos-codigos{ padding:18px; border-radius:20px; }
}

/* Turn the inner wrapper into a simple layout container (no second card) */
#base-datos-codigos > #dbCodigosSection.db-module{
  background:transparent !important;
  border:0 !important;
  box-shadow:none !important;
  padding:0 !important;
  border-radius:0 !important;
  overflow:visible !important;
}

/* Ensure table stays within module and scrolls horizontally when needed */
#base-datos-codigos .table-wrapper{
  width:100%;
  max-width:100%;
  overflow-x:auto;
  -webkit-overflow-scrolling:touch;
  border:1px solid rgba(15,23,42,0.08);
  border-radius:18px;
  background:#fff;
}
#base-datos-codigos table{
  width:100%;
  min-width: 980px;
}
@media (max-width: 900px){
  #base-datos-codigos table{ min-width: 760px; }
}
@media (max-width: 700px){
  #base-datos-codigos table{ min-width: 680px; }
}

/* Keep bottom bar inside the module */
#base-datos-codigos .pagination-bar,
#base-datos-codigos .page-size-bottom{
  max-width:100%;
}

/* --- DB meta + loader (auto-added) --- */
.prendas-meta{display:flex;gap:12px;align-items:center;justify-content:space-between;margin:10px 0 0 0;}
.prendas-count{font-size:14px;color:#6b7280;}
.prendas-alert{padding:10px 12px;border-radius:12px;border:1px solid #e5e7eb;background:#fff7ed;color:#9a3412;font-size:14px;}
.db-loader{display:flex;align-items:center;gap:10px;margin:12px 0;}
.spinner{width:16px;height:16px;border-radius:50%;border:2px solid #e5e7eb;border-top-color:#2563eb;animation:spin 1s linear infinite;}
@keyframes spin{to{transform:rotate(360deg);}}


/* --- DB module unified + responsive table --- */
#dbCodigosSection { overflow: hidden; }
#dbCodigosSection .db-controls { padding: 0 24px 10px 24px; }
#dbCodigosSection .db-controls-row { display:flex; gap:12px; align-items:center; padding: 18px 24px 0 24px; }
#dbCodigosSection .db-controls-row .input { flex:1; min-width: 220px; }
#dbCodigosSection .more-filters-panel { margin: 10px 24px 0 24px; padding: 14px; border:1px solid #e6e8ef; border-radius:16px; background:#fff; }
#dbCodigosSection .more-filters-grid { display:flex; gap:12px; align-items:center; flex-wrap:wrap; }
#dbCodigosSection .more-filters-grid .input { width: 160px; }
#dbCodigosSection .check { display:flex; gap:10px; align-items:center; padding: 10px 12px; border:1px solid #e6e8ef; border-radius:14px; background:#fafbff; }
#dbCodigosSection .check span { color:#6b7280; }
#dbCodigosSection .more-filters-actions { display:flex; justify-content:space-between; gap:12px; align-items:center; margin-top: 12px; flex-wrap:wrap; }

#dbCodigosSection .admin-only { display:none !important; }
#dbCodigosSection.admin-enabled .admin-only { display:table-cell !important; }
#dbCodigosSection .admin-only-block { display:none !important; width: 100%; }
#dbCodigosSection.admin-enabled .admin-only-block { display:block !important; }

#dbCodigosSection .db-metrics { display:grid; grid-template-columns: repeat(3, minmax(0,1fr)); gap:12px; padding: 14px 24px 0 24px; }
#dbCodigosSection .metric { background:#fafbff; border:1px solid #e6e8ef; border-radius:16px; padding:14px; }
#dbCodigosSection .metric-label { color:#6b7280; font-size:14px; }
#dbCodigosSection .metric-value { font-size:20px; font-weight:700; margin-top:2px; }

#dbCodigosSection .db-table { padding: 18px 24px 24px 24px; }
#dbCodigosSection .db-table-toolbar { display:flex; justify-content:flex-end; margin-bottom: 10px; }
#dbCodigosSection .table-wrap { width:100%; overflow:auto; border:1px solid #e6e8ef; border-radius:16px; background:#fff; }
#dbCodigosSection table.table { width: 100%; border-collapse: collapse; min-width: 980px; table-layout: fixed; }
#dbCodigosSection table.table th,
#dbCodigosSection table.table td {
  padding: 6px 8px;
  font-size: 13px;
  line-height: 1.25;
  vertical-align: middle;
}
#dbCodigosSection table.table td {
  overflow: hidden;
  text-overflow: ellipsis;
  white-space: nowrap;
}
#dbCodigosSection table.table .col-orden { min-width: 70px; width: 70px; }
#dbCodigosSection table.table .col-codigo { min-width: 140px; width: 140px; }
#dbCodigosSection table.table .col-descripcion { min-width: 320px; max-width: 420px; }
#dbCodigosSection table.table .col-tipo { min-width: 110px; }
#dbCodigosSection table.table .col-color { min-width: 110px; }
#dbCodigosSection table.table .col-talla { min-width: 90px; }
#dbCodigosSection table.table .col-proveedor { min-width: 130px; }
#dbCodigosSection table.table .col-status { min-width: 120px; }
#dbCodigosSection table.table .col-disponibilidad { min-width: 130px; }
#dbCodigosSection table.table .col-fecha { min-width: 120px; }
#dbCodigosSection table.table .col-pventa { min-width: 110px; }
#dbCodigosSection table.table .badge { padding: 2px 6px; font-size: 11px; }
#dbCodigosSection thead th { position: sticky; top: 0; background:#fff; z-index:2; }
#dbCodigosSection .th-filter { margin-left: 8px; border:1px solid #e6e8ef; background:#fff; border-radius: 10px; padding: 4px 8px; cursor:pointer; }
#dbCodigosSection .pager { display:flex; justify-content:space-between; align-items:center; gap:12px; margin-top: 12px; flex-wrap:wrap; }
#dbCodigosSection .pager-bottom { display:flex; justify-content:flex-end; margin-top: 10px; }
#dbCodigosSection .pager-size { display:flex; gap:10px; align-items:center; color:#6b7280; }

@media (max-width: 900px) {
  #dbCodigosSection .db-controls-row { flex-direction:column; align-items:stretch; }
  #dbCodigosSection .db-controls-row .btn { width:100%; }
  #dbCodigosSection .db-metrics { grid-template-columns: 1fr; }
  #dbCodigosSection .more-filters-grid .input { width: 100%; min-width: 180px; }
}

/* Admin-only cols hidden by default */
.admin-only{ display:none; }
body.admin-on .admin-only{ display:table-cell; }

#dbCodigosSection .th-sort {
  display: inline-flex;
  align-items: center;
  gap: 6px;
  padding: 8px 10px;
  border-radius: 12px;
  border: 1px solid #e5e7eb;
  background: #fff;
  color: #475467;
  font-weight: 600;
  cursor: pointer;
}
#dbCodigosSection .th-sort:active {
  transform: translateY(1px);
}
#dbCodigosSection .tableWrap {
  width: 100%;
  overflow-x: auto;
  -webkit-overflow-scrolling: touch;
}
#dbCodigosSection table.table {
  width: 100%;
  border-collapse: separate;
  border-spacing: 0;
  min-width: 920px;
}
#dbCodigosSection table.table .cell-desc {
  max-width: 320px;
  white-space: nowrap;
  overflow: hidden;
  text-overflow: ellipsis;
}
#dbCodigosSection .pager-right {
  display: flex;
  gap: 8px;
  flex-wrap: wrap;
}
@media (max-width: 768px) {
  #dbCodigosSection table.table th,
  #dbCodigosSection table.table td {
    padding: 8px 8px;
    font-size: 13px;
  }
  #dbCodigosSection .th-sort {
    padding: 10px 12px;
    white-space: nowrap;
  }
  #dbCodigosSection table.table .badge {
    padding: 1px 5px;
    font-size: 10px;
  }
  #dbCodigosSection table.table .cell-desc { max-width: 220px; }
  #dbCodigosSection .pager,
  #dbCodigosSection .pager-bottom {
    justify-content: flex-start;
    flex-wrap: wrap;
  }
  .filter-popover.mobile-sheet {
    left: 0 !important;
    right: 0 !important;
    bottom: 0 !important;
    top: auto !important;
    width: 100vw;
    max-width: 100vw;
    max-height: 78vh;
    border-radius: 16px 16px 0 0;
  }
}

#printRoot {
  display: none;
}

.label-page {
  width: 51mm;
  height: 25mm;
  page-break-after: always;
  overflow: hidden;
  background: #fff;
  color: #000;
  padding: 1.5mm;
  display: grid;
  grid-template-columns: 1fr 17.5mm;
  gap: 1.5mm;
  font-family: Arial, sans-serif;
}

.label-left {
  display: flex;
  flex-direction: column;
}

.label-code-title,
.label-price-title {
  font-size: 3.2mm;
  font-weight: 700;
  line-height: 1;
}

.label-sku {
  margin-top: 1mm;
  min-height: 3mm;
  font-size: 2.2mm;
  line-height: 1.1;
}

.label-price-title {
  margin-top: auto;
}

.label-price-value {
  margin-top: 0.8mm;
  font-size: 5.8mm;
  font-weight: 800;
  line-height: 1;
}

.label-right {
  display: flex;
  flex-direction: column;
  align-items: flex-end;
  justify-content: space-between;
}

.label-qr {
  width: 14mm;
  height: 14mm;
}

.label-qr img,
.label-qr canvas {
  width: 100% !important;
  height: 100% !important;
  display: block;
}

.label-logo {
  width: 13.5mm;
  height: 3.8mm;
  object-fit: contain;
}

@page {
  size: 51mm 25mm;
  margin: 0;
}

@media print {
  body {
    margin: 0;
    background: #fff;
    box-shadow: none;
  }

  body * {
    visibility: hidden;
  }

  #printRoot,
  #printRoot * {
    visibility: visible;
  }

  #printRoot {
    display: block;
  }
}


/* ===== Haruja header (logo) ===== */
.haruja-header{
  background:#fff;
  padding: 26px 16px;
  border-bottom: 1px solid rgba(15, 23, 42, 0.08);
}
.haruja-header .wrap{
  max-width: 1100px;
  margin: 0 auto;
  display:flex;
  justify-content:center;
}
.haruja-header img{
  width:100%;
  max-width: 520px;
  height:auto;
  display:block;
}
@media (max-width: 640px){
  .haruja-header{ padding: 18px 14px; }
  .haruja-header img{ max-width: 360px; }
}

/* ===== Launcher (PWA-style) ===== */
.launcher{
  background: #f6f7fb;
  padding: 28px 16px 24px;
}
.launcher-inner{
  max-width: 1100px;
  margin: 0 auto;
}
.launcher-title{
  margin: 0;
  text-align: center;
  font-weight: 800;
  font-size: 28px;
  letter-spacing: -0.02em;
  color: #0f172a;
}
.launcher-subtitle{
  margin: 8px 0 18px;
  text-align: center;
  color: rgba(15, 23, 42, 0.62);
  font-size: 13px;
}
.launcher-grid{
  display:grid;
  grid-template-columns: repeat(2, minmax(0, 1fr));
  gap: 16px;
}
@media (max-width: 900px){
  .launcher-grid{ grid-template-columns: 1fr; }
}

.toolcard{
  text-decoration:none;
  color:inherit;
  display:flex;
  gap: 14px;
  padding: 18px;
  border-radius: 16px;
  border: 1px solid rgba(15, 23, 42, 0.10);
  background: #fff;
  box-shadow: 0 12px 30px rgba(15, 23, 42, 0.08);
  transition: transform .12s ease, box-shadow .12s ease;
}
.toolcard:hover{
  transform: translateY(-1px);
  box-shadow: 0 18px 46px rgba(15, 23, 42, 0.12);
}
.toolcard-icon{
  width: 48px;
  height: 48px;
  border-radius: 999px;
  border: 1px solid rgba(37, 99, 235, 0.25);
  background: rgba(37, 99, 235, 0.08);
  color: #2563eb;
  display:flex;
  align-items:center;
  justify-content:center;
  flex: 0 0 48px;
}
.toolcard-icon svg{ width: 24px; height: 24px; }
.toolcard-title{
  font-weight: 800;
  font-size: 15px;
  margin-bottom: 4px;
}
.toolcard-desc{
  color: rgba(15, 23, 42, 0.62);
  font-size: 13px;
  line-height: 1.35;
}
.toolcard-actions{ margin-top: 10px; }
.launcher .btn{
  display:inline-flex;
  align-items:center;
  justify-content:center;
  min-height: 44px;
  padding: 10px 16px;
  border-radius: 999px;
  font-weight: 800;
  font-size: 13px;
}
.launcher .btn-primary{
  background: #2563eb;
  color: #fff;
}

</style>
  </head>
  <body>
  <header class="haruja-header">
  <img id="harujaLogo" src="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAl0AAAEvCAYAAAB/gHR8AAAAAXNSR0IArs4c6QAAAARnQU1BAACxjwv8YQUAAAAJcEhZcwAADsQAAA7EAZUrDhsAAEZaSURBVHhe7Z0J3FXT+seX+6dbRBpQKVMDDZooFZHQ7TYPGqk0uCoZGmSqREgaECEadUlCRYOxlHCVNGkSSqVJhiTu7br3/M9v/c9+/6fTPufsYa219z79vp/P6j3v2/ues/faa/itZz3reY6LxRGEEEIIIUQrf0p8JYQQQgghGqHoIoQQQggxAEUXIYQQQogBKLoIIYQQQgxA0UUIIYQQYgCKLkIIIYQQA1B0EUIIIYQYgKKLEEIIIcQAFF2EEEIIIQag6CKEEEIIMQBFFyGEEEKIASi6CCGEEEIMQNFFCCGEEGIAii5CCCGEEANQdBFCCCGEGICiixBCCCHEABRdhBBCCCEGoOgihBBCCDEARRchhBBCiAEougghhBBCDEDRRQghhBBiAIouQgghhBADUHQRQgghhBiAoosQQgghxAAUXYQQQgghBqDoIoQQQggxAEUXIYQQQogBKLoIIYQQQgxA0UUIIYQQYgCKLkIIIYQQA1B0EUIIIYQYgKKLEEIIIcQAFF2EEEIIIQag6CKEEEIIMQBFFyGEEEKIASi6CCGEEEIMQNFFCCGEEGIAii5CCCGEEANQdBFCCCGEGICiixBCCCHEABRdhBBCCCEGoOgihBBCCDEARRchhBBCiAEougghhBBCDEDRRQghhBBiAIouQgghhBADUHQRQgghhBiAoosQQgghxAAUXYQQQgghBqDoIoQQQggxAEUXIYQQQogBKLoIIYQQQgxA0UUIIYQQYgCKLkIIIYQQA1B0EUIIIYQYgKKLEEIIIcQAFF2EEEIIIQag6CKEEEIIMQBFFyGEEEKIASi6CCGEEEIMQNFFCCGEEGIAii5CCCGEEANQdBFCCCGEGICiixBCCCHEABRdhBBCCCEGoOgihBBCCDEARRchhBBCiAEougghhBBCDEDRRQghhBBiAIouQgghhBADUHQRQgghhBiAoosQQgghxAAUXYQQQgghBqDoIoQQQggxAEUXIYQQQogBKLoIIYQQQgxA0UUIyUm2b98uRo8eLerUqSNOOOEEcfzxx4vSpUuLevXqiQEDBoi5c+eK//73v4nfJoQQ/RwXi5N4TQghkQdi66677hKzZs2SogpDXPIwd9xxx+V9Pffcc8XDDz8srr32WvGnP3ENSgjRS6hF18aNG8W+ffsS3zkDq1lrVZv8Gl+TX1tfCxQokPhLQkjUeeedd8R1110nfvjhhyOEViYgtmD5GjFihPif//mfxE8JIU7AHP3zzz/L8vvvvyd+ejT/+c9/xB9//CH+/e9/O/pqlVatWokKFSrkLZaiTuhEF4RW9erVZWUDv5fn5EG9/PLLonXr1lzpEhJhnnnmGXHbbbfJQdstGCd69eolnnzySQovElqWL18u3nvvPbF3717x6aefihNPPDHxP0IcOnRIfP3111L8BIEuKfHKK69I4ZUr83PoRNecOXOkqR+q2BQQXW3btqXoIiSiQCzBWuVFcFlAeD399NPib3/7G8cCEjo2bNiQZ5BIN22HbDpXwquvvppToit0d9GiRQu5WjVZwZZVjRASPTAZDRw40JfgApiwbr75ZvHVV1/l5ORFog0OgZQsWVK2zXRFJ9dcc41o2LChOP300xM/MYPu+zJN6EQXVpujRo0S27ZtkwNp4cKFE/+jD55gIiS6qBBcFhgL+vXrZ9TSTogTTj75ZLF69WoxduxY0alTJ1GtWjWjvk7t2rUT8+fPF7t27RLfffedeOqpp6QI1E2u9cVQ2utg5YKqHzlypPjmm29E165dtVq+OMASEk2++OIL6eOicjW8cOFCsXPnzpxbYZPoU6hQIbkTNH36dLFy5Uqxbt06sWPHDtG9e3ftu0MQd/gM+DxCbPXp00esX79edOzY0ejOVNQJdU3hQZ566qli8uTJYsyYMdocXCm6CIkmU6dOVd5/IbbmzZtH0UVCiSV+LAF05plniueff14uFnAq3xS4DszPf//730WtWrW0Wdy4vRgAaFxQ982aNdPyYLm9SEg0+fDDD7UMyrAiUHSRqIA5Ej5XzZs3l69Ngs+79957tX1urs3PkbEJQmxVrlyZoosQkgd8XHSII2zZUHSRKIG58frrr9dmccpEkyZNtPl30dIVICVKlNDSoHh6kZBoomtA3rNnT+IVIdGhZs2agYgufCZONuqwdtHSFSBFihRJvFILV7SEkGSKFSuWeEVIdChVqpQ46aSTEt+ZpUaNGloEXxAiUieREl04MqsDOtITEk10HZmHc3KuDfbk2EDXjlA2dBlFGDIiQAoWLKilMXF7kZBooms7pUyZMhRdJJIEZaXF/EyyEznRpQM60hMSTTp06KDFjwSpyCi6SBTRtSOUDV1GETrSB0iBAgUSr9TC7UVCoslVV10l6tSpo3SwR6TvihUrUnSRSIJ5Moi2mz9//sQrtdCRPkD4UAkhyWByGT9+vNLAyUOGDDEe64gQVfz5z39OvDJLvnz5Eq/UQktXgOhqTBRdhEQXxO+bNGmSEuE1fPhwmXSfootElRNOOCHxyiy65meKrgCBpUuH2ZTbi4REF4wJnTt3loLJj/C64447xF133aUt3RghJjCZCigZWrqcQUtXHFq6CIk2EF4QTC+88IKn01tTpkwRI0aMCGzCIkQVQfhzAV19hz5dAaLz9CIDpBISbTDZdOzYUWzevFkMGjTI0RZh7dq1xT/+8Q/RpUsXWrhIThDU1riubU1aunIQbi8SkhtAeCFII6xWe/fuFRMmTBBdu3YV9evXF5dffrksjRo1EnfeeadYtmyZLLVq1aIPF8kZgrLWQnTpsLIFZbnTBUeaOIcPH068IoTkAhBR2Ga88cYbxeTJk8X7778vFi9eLMv8+fPFww8/LOrWrSutW7k2qJNjG12hlbKhS+wxIn3A6GhQtHQRkptAUEGA2RWKLZKLBCW6uL3ojMiJLh0Plo70hBBCcgFdp/yzocvSRdEVMDpEFy1dhBBCcoGgLLgnnnhi4pVaeHoxYHScMKLoIoQQQsIHLV0Bo8PxlaKLEEJILpBrIoWWroChTxchhBBiDw+IhBtuL8b5448/Eq8IIYSQ6EJLV7ih6IpDSxchhATLzz//LLZt2yZWr14tli5dKpYsWSLLypUrxa5du3JOTOiClq5wc1y8IUeqJVeqVEls3LhRaQfs1KmTzNnmR9AdOnRIfP3113JwwNfff/9dlChRQpx55pmiRo0a4pRTTkn8ZnT49ttv5b0gsvf+/fvloIh6T617HFEuXry4LNWqVRNnnHFG4n+IxYoVK+QE8ttvv8n6Q1urUqWKaNq0qYwZRUgy6Hdbt24Ve/bsEfv27RO//vrrEf0OKdEuuugi2efQ3woXLpz4n/Dzz3/+U3z66afis88+E2vXrpUia8OGDXn3lzq+AEtIVK5cWfabmjVriiuvvFLOB1EWGaiL9evXi++++06OsSj4Ge7p7LPPFueff76855NOOinxF9l56KGHxH333afcV3nixImiW7duGccrzHMHDx5MfKeGUaNGif79++fMOBk50VW1alWxbt06247pFeRrmz59umvRhZxt8+bNkwUdJ53FDB3oggsuEA0aNBBt2rSRqUjCOFAgWve7774rV5moYwjJ1HrONCACvIbYRGqVSy+9VA6MEGJhvF+dQKAuXLhQlnfeeUcOpqg7q/6s+sCkef/994vu3btTfB3DIGI+CvremjVr5KItua+l9jur/ST3q7POOkuULl1aVK9eXfY9jDNhWQBBPL7yyitiwYIF8j6tsdK6r9T7S0fqfeP+GjZsKBo3biwuvPBCOc4m10nY2LJlixxnFy1aJFatWiW++eabo+YN1EXyPeA1xlHMU9dee23WBTyyLQwdOjQQ0QXxj7FPJSNHjhQDBw6k6AoKTOBYHam87LZt24oZM2Y4El0//PCDGDNmjJgyZYr4/vvvjxo8MoHOg4IVDJR7nz59Am1IWF298cYb4q233pKDgGWFAX7r17pXUKFCBdGzZ09x6623er5fXCOskbC6wQKHorPp9u3bVz5nt0Icq7wHH3xQPPbYY3LQwzVmu07UCQara665RopVTB5ODoygfvF7VsmXL99Rr62vQUWp9gva5KRJk2T7RCJrTFo6nzvABAexrDOHHbbRIEDQrjEJq+p7Vp+z+h9EiN++54cdO3bISfO5555z3B/cYt2r9bpUqVKiTJky4pxzzhHnnnuuFKL4WerzRH2ceuqp4rTTTpOLH51gnIXFBgt1zBlu68G6R/TjXr16iXvuuUfmGLUjSNFVtGhR8eOPPya+U8Mjjzwi7rjjjkDarxbiDz5S1KhRIxZvfGitykrr1q1jf/zxR+IT7Nm/f3/s7rvvjsVXGbH4w7d9HzcF7xEfGGKffvppLN4JE5+in/jgHhs/fnysbt26sfggJK9DdX3aFXxO2bJlY/HBx9P91qtXz9i1otxyyy1Z20Qq69evj1WqVMlz+8C94W+9lrhAzFjiIjtxpdmJr8BjN910U6xBgwaxOnXqyLZi956qSlxoxv79738nPv3/WblyZSwuHI09dxTcs921+CW+YIsNGzYsFl84ynvGMzPV9+ICJBZftMTiE3HiavSya9euWHzhEosLfqPPzir4TKf9KbUtZivVq1d33D6WL18eq1q1qvw7VfWA98Hz/OSTT2zH0oceekh+nt3f+ilx0ZW1/RQrVsz2b/2UuOgy1m5NEDnRddFFFynvxC1btsw4wY4bN06Z2EoteM8nn3xSe6OC2Bo9enSsRIkS8jNV16HTgs++4YYbYj/99FPiypzRv39/LfWfrvTu3duV6IKYLFy4cGD16qTs2LEjcbXZefbZZ6XQwv2YuKfy5cvbTmSYVCBUTjrpJNu/01FUi65Dhw7FRowYIdtH0H2vVq1asS+++ELrQu+ZZ56JnXzyyb7vs0CBAlKgYiGD97P7nSBKlSpVHLWPoUOHahWdeJ6DBw8+apwKUnQVL17c9m/9FPQdiq4AueSSS5Q34mbNmtlOsLButWjRQksDTi7oPL169XI1ybthwoQJsVKlShkVLZkKnh+sXm4G/19++UUKIVP34EZ0Pfroo3JwtXufMJWtW7c6rm/8ro4BNF1JJ7oArvnXX3+NTZ48Oda4cWPtokWl6HrxxRdjZ599dqj6Hq7l8ccfVz6RHTx4MNa2bVtf4+W5554bmzZtWuyrr76S/Q/XiILXCxculKJR9/PPVrKJLlw7rMMmnjnqonLlyrFVq1bl9e0gRRcW9XZ/66c8+OCDFF1BokN0NWnS5KhOtHjx4thZZ51lrIPjc7p27apUeC1btkyawt12QAx8ffr0iQ0ZMiR27733xjp37hy77LLLlNcFVv6LFi1yLATQ8bBFgwkD16jz2TgVXQMGDJAWIbv3CFvBlqHTugZ79uyRW9HNmzfXPoFgqz2b0MG1W20A1i9d16RCdGGruX79+q77Hiw6rVq1kn0PlhKU7t27S0u73e97Lai79u3bxw4cOJC4Yn/s3r1b7kL4eSawgP/rX/9K20at53/nnXcaETTpSibRNWvWrEAs3qiPxx57TNZPkKLrzDPPtP1bP4WiK2B0iK6//vWvR3SiGTNmBGK5wH2p2mq8+eab87aH7D4rtVxwwQXSYgPrU/IKM7nA2oBtNKziVD0DDBYffPCBKzGA38U1YpDRMbigOBFdN954o7bP11G2bNniqp6BNdHt3btXWmN1TXbnnXeeK6GD64JVRcf1+BVdY8aMcbWtBCvfpEmTYps3b5afm9rvUGBFevrpp6U4VdX38D6wknhpF8lAzOMe/FxXx44dY4cPH068Y2ZQH/DzCarvpRNduKYgLd7oC7AEwx9VR79wIrqwo2L3t34KRVfAXHrppcoGHas0bNgwrxNhCyPojrN27Vpfg6AbE3/FihVjc+bMkffv5DOtSRhbAIUKFbJ9T7fl1FNPlQ7Tbu8Zv69r8IWgyiS6YAmMkuBC2bRpk692heeOAw2q+x8KtuDcCh20Wx3PwI/o6tGjh+NrQrt/6qmnpNhw2vfQJkeNGqX0vrHVD6umF7ANDcHsp00ULVpUunK4AXWhYy5wUuxE1+23367U4o06we7C5ZdfLgsOmji5V/yOrjoJSnTBqk3RFSA6OtpVV10lOxG2UsLgm4PO5nXQb9euneMBGdunGGy9TMT4m1dffVXZ4F+yZEnpC+H2WuAcrmN7L5Po6tevn5bJXnfZuHGjp2edDCyxOu4dbdFtm8c2o47+6kV0wQoMNwWnFgYIFbR3L5MJniFOrqls93BD+PHHHxOf4Ixt27YpsbyNHTvWUz2sWbMmkK39VNE1cuRIZdcxfPjw2Lp16+T7o06SC9rYzJkz5diERYoucZWuOBFdOq6LoitgdIgu+F6o7Dh+C+7v5Zdfdt3Qevbs6WpCxHain8aMwb9Dhw7KTNnY4nS74gU6Jt5u3brZii74uIWlnbgtGMz9ii447Oq4f6yQvSw0dPiQuBVdOBl85ZVXuuoH8+fP99334E+oqu9hzLnuuuuybqlbwBesQoUKvsdiWMu9+pWhDnDNqurAaUkWXQsWLFAy/sDquXTp0qz1j3tGu4EAgwuJyXun6FIDRVe85M+fP2PjxSku7Csj5gp8W9Axdu7cKSdgmIHt/sZvadSokauB/4knnnA9Gb700ku+GzMchlVOwl7iY+mIDWMnuuCrE1XBheJ32xrAt0iHyIWl04voql27tvLxwK3oQsgZt5OfCqsjfKlUtkfUo9Ntfjjhq5jwEQvObX9PBica/dQBHN+xvYtrcFqsMRNWdlXj/2uvveZ6LMbvT5061ZjVPSjRdd999/mep8JE5ETXFVdcofyhZiow91o+F6mDERoCxBf8olRfE94P2ydOeO+99zxNhKoac7ly5ZTdP94H2wZuJiQdHR0nNjHAWgR1uEJlST5W7gcdIhdHzb2IrqZNmyp/9m5EFw5zeJn077rrriPal1dUh1DI5ssIEIJGldhbsmSJrzYJK6OffonTol7jlsFpXYXw7NKli6e2D3Dd2LEwIbyciC6//n12BSd5VfSVsJAjcfXVc/rpp4u4mBF33323TKMSb0h5qSYs4h1OJrRGvkKkukn9fz/En41MCouvmUDaGaRmiHfaxE+cM23atLw0Rn6oW7eusnvH/T799NOurstNMlgvIDFv165dPdVxmIgPmIlX/kC+O5VtHeB5Z2vrdiCNi+prcQpS3CCxcHxCSPzEOWjj8UVV4jvv1KlTR+n9I11Npr6HNFxIyeLlnlNBony/14+0OH7eA+Nnq1atXKeuQRo45FRVMX4ir2BcNCW+cwfuG3+PnIyYj4ImqL4YJSInurwMzG5Bni4kno2veB11hpIlS0rhhYzwKhvdJ598kvV+kedv165die/cgfxvyGvnd+AoX7680vueOXOmTPjrlD//+c+JV+qw6gTXccMNN0RecAEVEwTIlnDXC16v7cQTT0y8Mg/ya/7666+J79zxyy+/SMHmVwhXrlxZad+DqPr666/TjjvDhw/3fM+pVK1aVcm1X3zxxb7eB/k8e/To4fhZIHk9hI4K4Ylk3X4X7PjbCRMmiHLlyiltC2FB1bgVFiInunQ3KliuYOFyKyQgvJBYVuVqY82aNRlFF5I+P/74474G7gEDBoiNGzf6ErNILKsSZKlfvXq142vSKboGDx4sNm3aZHsteOZI5AvRO378eFG2bFkl7fOKK67Q0s5VWboKFSqUeKWOqIkuiCZYO/xMCJgoV6xY4avvIaGz6raydu1a22v66quvZHtXNQkiubuKa1ch3mDhGzdunKN7GzJkiByjVHDdddcpmTPQJ2fMmOHZYhZmVLW3sBA50aWTwoULS4uVV8uN6sHvyy+/zDggT58+3fdEeujQIVerPDuQpV/1vWPrxulklC9fvsQrtbz//vviySeftK2bDh06yMkJQrtEiRKid+/eUiT369fP1yBaqVIl8eqrr4rjjz8+8RN1+Jnck4HQUf28vV4btqiC4LXXXpNbU37APQ8aNMhX3zvvvPMSr9SBcccObImqEu5AlYUcfcbv++BZwHqVbbH3+eefK9kdsGjUqJGyhXq1atWk9TVI4aVj3Mo1KLqSmDVrlvItQj+ks7BYvPjii0o6//Lly8XkyZM9v1fRokUTr9SxZ8+exKvswOdONfv27RPdu3e33UKA9QuCF/dttRV8hRgZNWqUmDt3rqc6wbb2m2++Kf8WviqqUTVh6rAueb02Hc/eCXhOXoViMsuWLRPz5s3z/F4Q/KrHK1jQ7a4H2/4qrQ5o7yquHZZ2Fe+De3vggQcy3iP6t6p+dOmll4oiRYokvvMP6uDmm28WTZs2Vd4miDoouhJgq6B+/fqhcEZMJp1/xXfffZfR98INeI+xY8d6HlB1OLIfOHAg8So7Op7ZokWLZB2n1u/o0aOlL066FR2upUmTJtLqBWuY02vDtvZbb72VN4HoWDGqmix0WJe8tuOgRNfWrVuV9b1HHnnE87PBs8BhApXYtfu3335bLkRUctZZZyVe+UPlog/bjOnGVVjfYeFUJTx1uBHg/bBtG7Z5zA+qxq2wELkno2KgS6VevXpybz2M++HpnOThX6GyLjZv3iy2b9/u6T11+FTBZ8LptegYYOw+u1evXuK2227LKogw8EFEwRIJIVWlSpWMg+sll1wiD25UrFgx7/d0tEVVk4WO7VyvAyvqSfXE5QQ7YeIVWJrTWZecoNraZSeuYL1V1X4s4BOp6rrPPvtsJe+FZ/DCCy/Y3uszzzyjVABkGxe8oqpdekHHZwd5PzqInOjS0UixlaPjfVWwe/du20YHMaa6McJHyQtYbauuP/iaOcWEHwEG9REjRrj6LIjBq6++WqxatUosWLBA3HLLLXJ1e/nll8vSrFkzua2LLSb45iTXoQ4LjqoJQ5cPnReCWiipcqQG6Md+titVb+/bhU/w6/Bvh8rrRogfVaTb7p06dapS4QkfLB3zTpBzWVjn0TCROzbIHCWdbxOc/lU3cDgGexlYdYgeN6LLhCn9/vvv9xQqAc8I1/eXv/xFnjTFtuXixYtlmTNnjgxHYVd/+Jnq56tqwtAhCN0872SC2Ebx60BvB6xLXkWN6tOkqVbm3377LetJ6qBR6RuFxSdOpyYzf/588f333ye+8w9cMlIXWuTYgKIr5KSzdJUuXTrxSh06hJxXMNA7Rfc1Fy9eXHTs2NHXBG+Jr9SS7tp1CFlVokvHtXklCEvXySefnHgVDlQHiP3pp58Sr/6PdevWKRdcqv3Q8ExU1QHuFe4WyfeMgzMqrVxlypTRPm7lCvTpCpgwr7Z0gEB8dsD/B8JLZcdVFaxQBf/85z8dP2vd13zjjTcaFxph3l4Mo++jaVRvDWF7zOv7YbGkmuQAqIicr3rchaVHZf0VLFgw8UoNyT57WADOnj1bqehS5YN2LJBrc37kRJcO1Rvmh5ruFB86bLt27ZR13NatW0uH3LAA0RUWkGLD9AAZZksXRZcQbdu2lZZKVSAVjdc2pkN0Jfc/NyeJg0K1n2HyYvejjz5SKrgAwmXoIsj5TMdnU3QRo2Q6xde/f3957FqFIIDPUpgm03/961+JV8GCAI6q82o6QYfowoJFxQCmUmz4JahrQSBNxFlS0S4aN24sT7t6fS8d+SeTLc06RBfSaqmcTFWPXck+XQiSrFp00dJ17ELRFSfMjT/TKSlsSahI/YBgn0EIi0yEJdchYm4FMbHr2F5UNclBEIalrQQlunD/r7/+uu9+A8H01FNP+erDOixdyblPdSzGVOQtTEb1IiV50QfRpVIgAp27CkH2TR2frVrwBk3kRJeOB6C6Q6kk2yrTivGEVDxeQAiDoUOHhsrKBcIiulC/QQxiYd5eDJOlK8i+i5AHCPXgJ4sF8i/6tXroqINk0aE6JAU4fPhw4pUaVI8Xlo8YLH46Tm7ixKmucSXIPqHjs4O8Hx1QdMUJYlJ1ChxaMzU6XHvt2rWl8Lroootc3Qsy3CPooR+rCuJPId6U6pWr6vfziqqkvG5hnC5nBN13cewfwU1x2MKNGIXQ+uCDD6S/oFcRixyJXbt2lemqVPu6JosuP07+6Uh21FeBatFVrFgx+XXjxo1aJn0d1kmLIPtErgkkHUROdB1rOAmdgE52wQUXyMH/iSeeEDVr1sza8RBdHUEAvcb4wd/CCtS8eXPx6aefKu9sYRBdsB6qyg/nljBbuoJKMh1WEK4A0coRew1+lpkSMCNYLuK1IXEyAuR6EVyW2MLnIJSBjr6SbIkK0wGbdKg+eAPRhWeoKz6Z6pAZYSHXtgJ1QNEVctwGCe3bt6/4xz/+IY88T5w4UW4dJhekpkEcnvHjx3uypmA7Bdafli1byijVqpyzUwmD6IITfRCCC+hypFeBjoTXIEwnVt2Cvod0YkiIjOCaOP0GX6AxY8bILUT0SVhjkMPw1ltvlcE83bYtO7Gly7KQbOlCTCnEqlONSgd91c7+F154oXw+X3zxhZY6Vh3QNpcJy66HKiInunQ8AF0DVxBgoMAEgNUpth2GDRsmEzRbBUE+scpyu8JGoteLL75YHm3/7LPPtIktCzcCQdfqKsiI0WG2dCFtlg68XF9Qz8cOq++hQFRdeeWVol+/fnLrEQsVPFP8n9trRgLmbt26GRFbFqnbdbgXt2NGNnBCUNV9YCGp6r0Q//CMM86Qr3fu3Cm/qkZH6jSLIOczHZ8d5P3oIHKiK9cegBO8ruLQqZMnAi8DPixbCJravn17uSWiW2xZuBFdugavc889V9t7Z4Oiyxk6kq2rwup/VnELxFaPHj2k68C0adOMiC2L1MVtgwYNlPeF1FQ7fkAAV1XAbcISmBBdOupcR/8OA6qs6blM5ETXsfhQ4ddlWmy+++67cnUOyxbSgGQSWzq2HtxMwKonAws4OwcFBmXV96Wq72BbWkedexFdYXLqV8X27dvFTTfdJMXWlClTMootHScLASxdyZ/ZokUL5WJ77969iVf+wXauqjES92q1b6Rh00Guii4dqFoshoXIiS4dD0DXpK0Kk74ucMbHqca//vWvjrYRH330Uem8rzrkRLbPTcaLBc8J2GIIqm2EOU6XZQVQzbEuuiAcbrvtNlG2bFnx/PPPZxRb8KvD1iX8vHC6UDWpIR1w2q5Tp05Kn326vLJuwUnIdOnS3IK6RKYP6z537NihrN8ko8svEoR9PnOLjvoPEoquOGF/qKpj2tixadMmeXwdUbbfe++9rKKnbt26YuXKlWLAgAFyQFbd0d1YZXQNMl5jn6lAR9w0VZYuXTHdUre0nJALoguLKjjg4+AGAqWmWplS+ctf/iL76+jRo6XvmI6QDnanpuEfesoppyS+8w8O+6gA27CqxnD434UtZqFbgpzPMD+r/vwg70cHkRNdXgbmqKNTdO3bt09uZeC0DiJsZ1pdW2CwX7JkiahevbpcEerw8XEjrnVZXqxYPUGgQ0yoWrDompS8DK46LIImee6552Rw1bvuuks6g2d7Rg8//LAM1wJnb6vdqxRCFnbWdRzOUZkuTFUMLAhQFe8D8YqQH1EXXUGiQyDpeM8giZzoUrVaTybs5lgdQhOD6siRI+XqOttWhgV8tyC2sK2R7HOkI25TGEQXLF1BtQ0doktV39FV314Ie99NxwsvvCC3EXv37i19uLK1d/Q9hKAYNGjQUf5AOhY96VwabrnlFnHZZZcpqff169crmVBVhXV45JFHjoifpTqAazI6XUai2ifSoWqxGBYouiKA6mjLr776qswZd88998iTkU4GrDp16kh/L8QiSp10g7bK6FiZQkgGGQQ0zBHpdTkB59rgagcWLQi9gnAu2BZzcs9VqlSRAYgRtsGurevof+mCMmNCnzx5cl5IBT8g8KiK+FqIgeZXdCEd2vXXX3/E2KazPeZqWz8W+rBfIie6jsWHqsrStXnzZtGoUSPRoUMHsW3bNsd12bp1a5myBFsadqsoHZOwG6Gpo02cdNJJiVfBEGbRFabtxTBZ3TKBIMewaiEivRV6xQn169cXixYtStv3gI46gEtDuueB+HUIJeM3wCfeH+OKn/4LcYjFoB/RhdAwL7/88lF9Tse2rUWuzmM67ivX6ipyosvJNphbVL+fapKjQ3sBpux7771X+m298847riZfnGLEgJRpNa1DdP3++++JV9nR0SkR/ylIM72OOlUl3nUJHTzHsPdFL8Cig/Ar8N9yM341adJERrBHWIhMbVHH88i26EGe15deesl3O8V7+HnmM2fOdJW1IxUktp49e7YSy50bdPrp6upDTt5Xx04URVfA6HioQU6uTvAzWSLGFgZ8+CtkOxWVCnLD2a0AUwna8VRHm9B5pNsJOixdqgavMFm6wt53H3roIZkLdcOGDa7qH30PgsTJ1qGOSTbbmIN6x4IMKY78tAcIno8//tjzPSBcjdd2DTH71ltv5aX8sUNXuh4sKnU8NxBkn8g1gaQDiq4I4PWen3zySbkihfBy2xlq1KghB0SdJvYwE3RSZx1+Oqp8A3WJrlwasLF9j/ArSL3ltt6RAcJN3wtCdAFM7khPhNRESPrtBVw73sNLdHqcNPTqRI9DDB999JEMfZPJUgg3Ax0ixo0lPyw4mYd0zM+5NudHTnSpmjiiBBqdm4EFfg5t27aVpwy91Bd8NnAsHfG3nKDDKuMGt/XjhDBYulQP9qoGL53bi27B9laQK3s70HdgXf7kk09c1znEC6zLTvueLpxa11H38BFdtmyZDH3h5VngQAHGK6cR6uEu0atXLzFu3DhPbRrBnz/88ENHCe11+Xb62RINM6rGmGR0LCqCJHKiK1cbaybcNOQff/xRBk9EzC0vHQAWnldeeUUeUXc6gOrwP3KDjk4Z9D3psLS53V5OR5i2F8MGgpzi4Mn333/v6X6wXedEDCTjRehkw81iDZ+PLTqcsIQA8yLKEZAZ1vUXX3wxo/ieO3eu/CyEufEyvmG7d/78+Y7HN12Wfp3hKIJEZyiMXCFyoutYxOmqE1sa8AWB2dzrVs3QoUNFtWrVXA3kOqwybtCxugp6e1FHImc/voHJ6BKkXp5j0P6EyfTt21eGYfFqjYe1B8WtaNFheXTbVtD/4f/097//XcyaNUucc845rsYECNRdu3aJLl26yG1ZCKNk0QpLGnzI2rRpI7766ivX4xvyWC5dulQGoXXTfnUlvcfiOBcWGSZQNW6FBYquOGFv/E4mIwiuq666Sjrser0fBAbEsXa3E1mQggvo8AXS4VPlBh2iy+8pWAtdz9vLc9RxLV6EHOJuPfvss54nCPS9xx9/3JOg1eFy4bWtQAAiST4CnyIvq9usDmgDsJg1b95clCpVSsYmg/BB6Ayc5HQrzFGvY8aMEWvXrpVBXd0K1HLlyiVeqUVVrkg7dM1nOha3TtAxvgcJRVecoEVDNrIN5Fu3bpWCC1/9dDjkUYyi47yOThl0yAhd24sqCJMjvY5rcfvcEaUdEeb9TEp9+vTxHLZAhyXAz3ui/uATifEE/loPPvigzBHpFIxhaAuwfCGYLBaUqFs3Yxv6D+oUqYZuv/12z9b4MmXKaBkHfvjhh8Qr9egat3SJuWxQdAXIsejPBTIN5qgTrAr9Ci6AHIw6tip0o6NTBr29qMORX5WlS9f2opf2q2uCccpjjz0mLVx+rQAQCF4FZJgsXcng2WARhy1XnDL0ImDctgk4vmMLEUINp7fhu+VnTIOlS0cb27FjR2AixitBXW9QFjZdRGqG1RlQLsxkGlT/9re/+dpStEB6n6BPTHlFh+gK+kSmDtGnSnTpEuZeBtcgDzzAR+jOO+/0bWlq0KCBr+CcOsZFldYzRK+Hr+k333yjfOKGBQ1hH7C9O3XqVLFz507pLI/6VNFOEVpCh+j69ttvIye6svVPXWEwaOkKEB0ruiiQrnPihCJOGqpolDjxGEUrF9DRKYOuCyQxVj3YqzpZpKtuvDzHoEQXTp9holchTiC6/NSpjnExUxogp2BrsWnTpvI0J5zf3b4fgpcisGyzZs1Ejx49ZFaNp556Srz22mtixYoVcotu3759MvwDTjPCCR8+XCrbJ5Lew7dMdV9E3USNbP1TxzY3wOdGTaBmIlKzrIqBIJcYMWKEMtNrpqjMYUeH6NLlt+QUHfGBVK1EUTc62oqX5xjUcxo+fLjcwlIxHiGvoh90THZ+rWc4FICk+gsWLLAdo3CaENavFi1ayBPTCLCKuGY41Yf7QUHcLiSznjNnjkyh9MADD8htWDjqI+gzrFx4/hBZKLrGLzjxq35v5MGNmrtMtrlGl1FEl5gLikiJLlXbI6mEXcjZXd+7774rVq9erezadaW7MIEq4ZmMLmuOU3T4dCForor2oqtuvAyuQYiu7777TooKVe0Ofc/PpK5jsvNqFYWQgJAaOHCgvK7U9gYfK4xdyJKxePFiaa1H1P7rrrtOXHLJJdLFAc/UKpagsgrqySqmgDjU8Xkqx+9kdLwnyNbOdIkjHeN7kETO0qUDkx3YC3bXh7xsKi082M6KKjoGGV3CwilIxKsaL6lW7NAldKIiup555hmlEwwmFT9tWMe46OU9sdV39dVXy4j8dhNlxYoVxfLly+VJa2wL24mpMKLD0gUQGkPH2KWrHrOJH/QJHfdD0RUguixdUQQDm0rRBXO3rhWSV5yKBB2dUteqzSkQXaoHz59//jnxyh9hEl06fLqy3d+UKVOU9j2n6W/SEQZLF5zkcRgHQsKubpDeCMmldfhH6QaBXrEFrPq6EYVfZTvSTbb+qcsoomvbMigouiLImjVrlE2gFp9//nnoRJfTgV/HdQfd0U8//fTEK3UcOHBASV1BJOio87CIrkyT68cffywtOipZtGiRr/rUYWFwI7oQDuKKK64QW7ZsSXsd2G4sWbJk5ASXBZz5VV87ModEKfE15t9M7UzX/Bz0Alg1kRJd8EkhenwBcNwaTqxegB+H6usBOCHm5H11dMpc6+gA+QD9gmeC/Ho6rItehK7p7cVMwsIrOI3nJ86ejnHRaZ9etWqV3C6En1um3/eS3ihMIDSP6uvHc1u4cGFkrF3ZRJWq09Gp6LKgBQUtXREgdTDbs2dP4pU6YDnDkWy3k+nLL78s4+ToEClOT/eongSBrgHEDTiurhq/W1k4lo+UKjrq3EsbMh0yQrWVC6AuEb3d7eSLOGGVKlXyvFjKhJOtfSz+GjVq5Ci5t654V6ZAPSONkOp7QIJvlX3pp59+ypo03CvZxmNdY2auzfuRs3TpGOzDTqoQQsfSUQ8TJ06UKTucdFiszGFyv/7662W6Dh3gPp2gw+ri1MqmE4gu1YO8nzAHgwcPFm+88Ya2lTlWtG6vzbSlS1eiYgQQRVBPJ3W7e/duceONN/rOtZqJbNteEN6I7edEcAGnC6gwo8Pahef+5ZdfKnmGeGaIibZp0yYtbSIo0UVLV4DkQsf1Quq2i44OBfC+999/v0wrBD8Nu8/54IMPRLdu3UT58uXF/PnztQgeC1gVnNyrjvpQddLPDzosXV4nacRJGjlypNbn7cW/BZYukxYUXe0Cz2TYsGEyUCqSRds9Iwi+u+++W5x99tli0qRJ2rfA01nUEei0cePGjgUXwKlFHf3UJNhWV+1riTpxutDNRteuXaX1U9eiCD6hmdDl/hOGXQeVUHRFgNTBFcmYdYFBAAENq1atKlNp1KhRQ04E2EJEHjWsrqdNmyavSfcgilQZTtAhBHRs2bjlrLPOUi4oPvvsM9fPDT5Hffv21T7Jexm0dWwvWiEM7NARP80CzwWTZpUqVeSipmXLljKPIGJYVa9eXfZHCF8swnT3PWDnp4VTiggLAeu2m2tAjkqdgt0EaBNYlKq2rs6YMUM+dz/PtH///jLmmS7BBbI9c8zPOtqlrvcNikiJroMHDyZeHVukWrqKFSumdXWPBo7Oi5Us/DZg3UJkaNQ/fm6qA6Rb8cNaM27cODF79mx5PToGGl0n9NyAiN6qnzMCU7q5Lwjsjh07GjnN6UV05cuXL/FKHZnqXMeWbzJW34M1CVu5jz76qJyUcWLZxEInGXxm8udhPIAVfPv27a6v4+233xZ33HFH5IVXz549pQBW2QZQl0hz5HV+Q0JxJPfWXbfZcmfCJUMHTt1MokKkRBdM+yYHnbCQ6ssGC4gp8LlWSYeuRNmI65M8EWO7Eb4ssML169dPPPzww9pEFwZAXeZypyBvneoJHj5dc+fOzVpn2Orr1auXnGRMCC7gZdA2nZj8/PPPT7zST3Lfy9T/dIFDMlY7waILYsPr9jT+5oknnpCibeXKlYHcjwrQH3Efqq1d8JHFmOZWOGG7edSoUdqt0ACHrTLl0NQZgy3osVglkRJdqmNTRYVUPxLkHdO52nYDnKuxAtKxFbZ//37RuXNnadLHgIQtF8uXBZOBdZpIh+gCQQeMRX66WrVqKa/XQYMGpY3LBmsGHLrx2UgibGIwt0D/dlvfOjIpZJpQkYA5LH0PIgjbUnAB0HFNS5YskY7ZOKGILcVsYSGygb9FiAS0aaQ+gssCtk4xhqCPoyCnJZJaI+MGfhfXkKlAwO3YscNoP61Tp468btVO9Qi6i4WOE+EFSzyejSnBZQGLWrrxNpslzA9exobQEr+RyNCpU6dYvKGj5pWWhg0bxuKr+cSneGfMmDGx+IBt+xl+SseOHWPxjpX4lP+jSpUqsfhAa/v7JkrRokVjixcvzruusWPHarl33KNVkn9eunTpWFwgyM8uU6aMlrqYOHFiLD4Ays8Iivfffz92/PHH216fn4J+VLly5ViDBg1it9xyS6xnz56xuJiXn5WtjzVv3lxLP7z++uuPaudOOOGEE2zfz2tp1apVxuuoXbt2oH0PBWPN4cOHY/EJMDZ9+nQtfQ/Fru+pKtZ7Jxe0K7cF955aSpUqJZ9TmzZtYrfddpscn15//fVYfLERO3ToUOJJeufAgQOy/+Ca7e7Na8H7NWnSJLZ9+3b5bO3AuHTGGWco/2wnBZ8ZF8a242K3bt3k87D7O79l+fLlaesjakRKdF1++eVaGtqZZ54Z27p1q++H2rRpUy3XV6lSpaNE4ejRo+XgYvf7uku1atViX3755RH19csvv8SKFCli+/s6ygcffJD3+eecc46WercTu6bBPfbu3VvbYIZ6Sy52v5Nc7rnnntimTZu0CEFMkl4WP6ZF19NPPx1Y36tatWps7dq1R0x6aCPVq1fX0geiXJLbdapIq1OnTmzYsGGxuXPnyrHLC1u2bJGLT7vP9lNwvaeeeqrsa1OnTo298847sRdeeCE2ZMgQudjMNBace+65sR49emgbL1Dw3i1atIitXLkybwxevXp1rHDhwra/r6LMmjUr8AWwKiIlunSsLKxSrly52LfffnuEkHBD27ZttTb0DRs2HHFtv/76a6xEiRK2v6uz9O3bV66w7Rg8eLDWOrAKVlrWpIgBSYcAQClYsGBsx44d8nOCBM+6QoUK2tq+0wKhD1H01Vdfaalz3N/+/fsTd+0c1WIffTmT6MLzOP30023/VmcZMGBA2r735ptvBiYEo1jQ1lAwXqGf33DDDZ6sKW+//ba28ce6Pqtk6//ly5ePbdu2LfbQQw9pbwvWteFzUPDa7vdUFbT9oBfAqoiM6JowYYL2hlS2bFm5infT8WCqbtmypfZGB1H40UcfHXFtOrcVUgusjDDNZ2r4mDCLFStm+/eqCra2rIkHg4tqK0dqqVevXmzPnj3y84IEK8lTTjnF9hpNlOeeey7v2esSXSiNGzeOHTx4UH6OU4oXL277Xl5L+/btsw7wkydPNtb3zj//fGnZzXRNGBewVZxtYmaxL5aIuPrqq2PffPON4zkAvzdlyhRjbSFdwW7Izp075fWYEF2mC4QxrJJOn0uYCb3oWr9+faxz587GGhFEg9OHi4mwVq1a2gWXVfA5Xbt2zbPIocBnQefnYztj9uzZ0sLhpE50br3AugBhB+sT/B5MtAkMxth+hk8IRGdQnR6fC58U04MphB6sKMkTvk7RhfrG1s9nn33muK6x5WL3Xl4LfEeziS5cGxZbOkVO/vz5Y0OHDs3z3crGF198oe25QPi98sorgVj4TBY8T2yTudnOwrN54403pDCwe0/dBe4eu3fvzmsjuSi6UDDPDRo06Khdn6gRWtH1/PPPy5UbBhGdA5tdwcMtWbJkbODAgbaDLwafCy+8UDZs09eGz8PnYkWGrTX4I1x22WXKr+Pss8+W/gROxZYFfvfmm2/WIgSxjdSuXbvA2gQKnjuczufMmWPcxwB1a9LCAsvvmjVrjrpPnaILBc8Wdd2hQwdHQhfXqbI9YJGXTXSBn376SVoYdLRFOCVjq8htG9NxoGXEiBF5wk/HWBPGgvZ3++23O2oHAHWDnQgdPl6ZCizDWIgm95FcFV0o1tiAgwT169eXCyQvLglBEkrRhQEniIk1teDz7Rzsw+BfYzU+nCD8+eefpWOjimuC2MTA7XR1bQcmilGjRinr+DVr1sy7t6DrHcWq+2wO1zrAM3nttddihQoVsr02VaV169axH374wbYN6BZdVrHqGSI+Uz1XrFhRabuAf4/T54pTbKpObZ188snSZxKHVLwKejwvVaeocSp40aJFR9RFr169lNxrFAraFHYW3AivzZs3x6655hoj49TIkSNtD55AJOeq6EouqGOUSZMmGV8A+yF0omvVqlWhMmFjtZk68SSLgKDLAw88IAcFNDr4FkA02f1etoKtEjfbiNnAe8BK4nX7E4cE+vTpI33scH9hHOwLFCgQ27VrV+KOzYG6Rb3oOLGG7cRnn33WdjC3MCW6rIJ7zHTIRXU94PSX04kWoO/B5xR+l26vA20IjvszZ86UvmwqJg/UExy8zzvvPE/1ctJJJ8n+Bit6ap0/88wzx8SEbhXUHw4IuW0PWBjhJKHKdmkVPNdly5albSuqTrbjBCVCE8GfFwW+k7D067gnPwU7Tyr6jSmOwz/xCw8NuBwE4YsP7DLwX7wyE/9jjnijkgFIEQgR+c7wfTLxgUhGEI4/7MCSccZX9zIlyRVXXJEXzBF1h8i9EydOlBGkUYfIYG8FV0XuRKSWQe5GJG5FUMVLLrlE3mt8lS3vM/Ve/YDrQUHW+xdffFFs2bJFbNy4MW16H1C5cmUZBT0uuOR9xYWW/DnqHH+DnIhFihSRP0OAQLQR3GdcJMifmSA+Kcm6K126tAzYqrLO3IA6ueWWW0RcJMnXfkHC3KFDh4pzzjknY+DHr7/+WgZPjU9EiZ/opWzZsrI9Fy1aNPGTI0GQTfx/ujblFgSoRIBOq185AZ+NZzB9+nQ5NqCtf/LJJzJ/qHVdCCCMNhNfUMik1bjuhg0bynyOOvoermfFihUyMb3VT3bv3p13PRgDypQpkxfVv2DBgjIQKu4/ue8lg5QsaPP79+9P/CT3wXOZNWuWaNWqleOAqFb9jx07VvZPtAmr3r2CgLKIQI88i/FFT9r2gqDGvXv3djx3ov1VqlRJ9mmMvwi6W61aNTnOJn8Grh/f290HgpdiXEB+RozRaB+6cyXjGpGnNC5ulQeq1UnoRJeFdVlBXJ7V0NI1agtcW1DVl+kak68r9fqSf9/pfaogWRQgW/26deuOmLQxyGNyja+mZAdyek3p7lMnJustG6hX5Md8/PHHZWJqt+kyMHB16NBBdOrUSZx55pmOBi+kCFIpcjKBARViJZMAQrT0RYsWKbueW2+9VU6WbkSXRXJ7tLue5DaD17rbUPJ1ZLse4OSakH4L4jyIBXFQQICsXbtW9hE3oM7RR9E+J0+eLBfqyWOhEyC2kP/0vvvuk0I5Wx9FJH+kW7JbFEH0Y5xFv8LCvV69enIBab2n9ey9tMvU9mXX3lTipK2GkdCKLpLb2DW7KHagMIC6REHuwo8++khODlh1YnV9+PDhxG/9H6eeeqq0tMBa0aJFizyrltu6NzVsOLku5KhcsGCBsmsaMGCAGDlypCfRdSwA0X355ZdHOoeiF7xYQC2sPgorEHJaLl68WCYUT06dAws6+idy2WKHBYIICwrsRqCPOlkQASy8YAGCWMNOCBZWsGDhZ8lCJfUrMQNFFyE5hNWds3Xr5ME36rRp00bMmTPHtQUhHXfeeafMP0nRlR5smyKHIpLQHyugv+zcuVOULFky8RNvoG9axY5UMeSln8IKqeJ9iHqisxFKCMkKBlYUa2WcruTSAAwLgUry5cvHCSoL8EmD0E3nZ5eLQCTNmDHDt7i3+idEvV1J7qNe26Gq9yHqoegihEQaHBBRSf78+ROvSCZq164tffvKlSt3zEzqr7/+ujKLKjk2oegihEQanLxVSYECBRKvSCYgtOCUjVOabk72RRncq+5TeSS3oegihEQaWLpUWlooutyBLUaEVHjuueek83Yugy3GTCFvCMkGRRchJNKonugRt4i4A1au7t27i+HDh0t/olwmOfYaIW6h6CKERBrVPl2qtytzHYQ+QJBehDm4/fbbcz5+lxVsmhAvMGQEISTS4BTdtddeq2yyf+edd2R8JJ74ysyGDRvE4MGDxZtvvinr3u1Ugm3J8847z9d2LpzaLV8yREVHxP3vv/9efq+LCRMmyKwZx4IPG1EPRRchJNK8//77Mn2NqrREy5cvFxdffDFFVwb69esnxo8fL+vcyRQCcdWlSxdx5ZVXyvRHVt2qrmPrWhAYGNuASH2EgvRjCBqMOFt+p7yZM2dKkU/RRbxA0UUICRRE0oe16sMPP5R5V5GqpH79+qJt27aOJjacKEOEdFWiC9H8kSaFoutokFuvXbt2ss6dhk5A+pvOnTvn+XqZqldrakv+Cuvco48+Kl566SXPoR8++OAD2d7YPogXKLoIIYExe/ZscdNNN4kffvjhCAsEJjRYRJC89/zzz884wcGCgaTtqkQXUidZSaDJ/4Nk10hJA8uRk2kDvnFz586VqWjCZBWC2Pr0009lPsPt27c7updkEIX/tNNOS3xHiDtoHyWEBMKwYcOk1QQ+OJgIMflZBd8jjyQCcGJrKNPEWLBgwcQr/xxLEdbd0r59e2kFdCpS4BsXNsEFcD1oV8uWLXP9vJF8HfkRCfEKRRchxDgPPPCAzG+YyTqFyf3AgQPiwQcfzLgVhDRAqrZ6ypQpw20jG6ZMmSKTNDvdkmvevLn0iwur3xOecalSpWTeTjfXiOTqYb0nEg3YegghRoFPDISU0+3AefPmZRVdqkCEdYquoxk1apSr06FRESc1a9Z09byd+hkSkg62HkKIUW688UZX/lcHDx6U4QDSoXJ7sXLlyhRdKcD53KkflwUSYkehHitWrOj4OqtUqSIuvfRStg/iC4ouQogxsEW1bds2VxM4QL47t3/jhVq1anFSTQEnFt3W/Y8//mjkefnFjfgfNGhQzkfbJ/qh6CKEGGPlypWeJuPff/898coeFdYupBNiKICjST1Z6oTPPvssEqJr9erVjq4Tp2Nx6INbi8QvbEGEEGMghYqXyThb6hUVFojrrruOk6oN5cuXdy1EkfwaYi3sTJw40dHhgLFjx4rjjz8+8R0h3uEIQwgxBqxJXixJv/32W+KVPm677TaKLhsqVKjg+pnBD2/o0KGhzsM4ZMgQsX79+qyLAOSVpC8XUQVHGEKIMRAfycvktX///oyTo9+tLEysDBdhT/78+WUAW7eCFNYuxOry+2x0MHr0aPHII49kFYVwtB8+fDh9uYgyKLoIIcZAlPnixYsnvnPOli1bEq/sybb9mInq1avLSZgTa3ruvPNO16ILYguhI6ZNm+Y4vpducAoWeSPvvvvurE70SEe1YMECccoppyR+Qoh/KLoIIcaAJalXr16uBQ6SUKezmHg5DWmBVDVIRcS0P5lBINFnn33W9XOD2OrRo4fo1KmTPNEYFLt375YZEGDNHDduXFbBhQTdCxculBHoaf0kKmHuRUKIUXASsVKlSq7EEqwNO3fulCIplalTp4qePXt68h9CpPUuXbrQl8sBeFbwgxoxYoRryxWEC06YtmzZUgYYveqqq8SJJ56Y+F89bN68WcyfP18mU0eCbrQPJ+0NqYtmzpwpTj/9dAouohyKLkKIcd5++2259eQmTtKjjz4qBgwYcIRA+u6776SfGASZW+69915p/eCpNOdAbKHOkMLJy5YhRIxVGjRoIAUOAtIiqXm2xObZ2LRpk/jyyy/Fe++9J9566y3xzTffSJFlFSdg2/H++++n5ZNog6KLEGIcDDt9+vSRztZOJ2+IrZdeeikvFQusGH379hXffvut40nVonfv3nKbiYLLPXheS5cuFd26dfNU9xaW+LJeA5xuLVy4sChSpIhMLI3vUWDhxFcEyYX/HgrycqIgCTcOWgBci1XcAME3fvx4Ub9+ffr2Ea1QdBFCAgGTN4KRfvzxx44nSYitYsWKSUvEnj17PG0pYnts4MCBFFw+wPPCNvFjjz0m6xNiSCVuLF5+pjA4yyNUyK233irbgx9LGyFOoOgihAQGnKvh57Ns2TJfk6cT4KODk3TXXHMNrRmKwDNDmiDUKw4keM04YJo2bdqIG264QTRq1Ei2BYotYgqKLkJIoCDw6X333SejfnvxE3ICLBnw4TrttNM4wWoA0wjK9u3bxbx586RPFfJsmghq6wRsT1522WWicePGon379qJo0aKyHbAtENNQdBFCAgdiC6fNcNJsyZIlcssRUc29gtAASF6NSOLNmjWTIQ94QtEMlgBDgfBasWKFWLVqlfj888/znNt1cs4550gfLUTSv+CCC0SVKlVEzZo15fOn0CJBQ9FFCAkN1mSNsmHDBrF161axd+9esW/fPnH48OHEbx0NHK+xfYjAq9WqVZMhJqwJlpNscFjTi/VMAU4Z7tixQz5bxM/CFrPlFA+hjQCmeA1nebv8jbBW4nnjKwQWhBVEdtmyZeWzT37mqV8JCRqKLkJIaEkentINVakTKifY8GM9y3TP1Mm0ZCeo+OxJ2KHoIoQQQggxAJ0cCCGEEEIMQNFFCCGEEGIAii5CCCGEEANQdBFCCCGEGICiixBCCCHEABRdhBBCCCEGoOgihBBCCDEARRchhBBCiAEougghhBBCDEDRRQghhBBiAIouQgghhBADUHQRQgghhBiAoosQQgghxAAUXYQQQgghBqDoIoQQQggxAEUXIYQQQogBKLoIIYQQQgxA0UUIIYQQYgCKLkIIIYQQA1B0EUIIIYQYgKKLEEIIIcQAFF2EEEIIIQag6CKEEEIIMQBFFyGEEEKIAY6LxUm89s2TTz4pBg4cKP7zn/8kfkIIIYQQEi6WLl0q6tSpI4477rjET8ygVHSNGzdO9O/fn6KLEEIIIaFl2bJlom7dusZFF7cXCSGEEEIMQNFFCCGEEGIAii5CCCGEEANQdBFCCCHkmEKhO7srKLoIIYQQckxh2oHegqKLEEIIIcQAFF2EEEIIIQag6CKEEEIIMQBFFyGEEEKIAZRGpN+5c6f48ssvE98RQgghhISPiy66SBQqVCjxnTmUii4Q1DFMQgghhBAnBHV6UbnoIoQQQgghR0OfLkIIIYQQA1B0EUIIIYQYgKKLEEIIIcQAFF2EEEIIIQag6CKEEEIIMQBFFyGEEEKIASi6CCGEEEIMQNFFCCGEEGIAii5CCCGEEANQdBFCCCGEGICiixBCCCHEABRdhBBCCCEGoOgihBBCCDEARRchhBBCiAEougghhBBCDEDRRQghhBBiAIouQgghhBADUHQRQgghhBiAoosQQgghxAAUXYQQQgghBqDoIoQQQggxAEUXIYQQQogBKLoIIYQQQgxA0UUIIYQQYgCKLkIIIYQQA1B0EUIIIYQYgKKLEEIIIcQAFF2EEEIIIQag6CKEEEIIMQBFFyGEEEKIASi6CCGEEEIMQNFFCCGEEGIAii5CCCGEEANQdBFCCCGEGICiixBCCCHEABRdhBBCCCEGoOgihBBCCDEARRchhBBCiAEougghhBBCDEDRRQghhBBiAIouQgghhBADUHQRQgghhBiAoosQQgghxAAUXYQQQgghBqDoIoQQQggxAEUXIYQQQogBKLoIIYQQQgxA0UUIIYQQYgCKLkIIIYQQ7QjxvwaytmpzqtxIAAAAAElFTkSuQmCC" alt="HarujaGdl">
</header>
    
    <main class="app-shell main-wrap">
        <section id="view-panel" class="view is-active launcher">
          <div class="launcher-inner">
            <h1 class="launcher-title">Panel de Herramientas HarujaGdl</h1>
            <p class="launcher-subtitle">Selecciona una herramienta para empezar.</p>

            <div class="launcher-grid panel-grid">
              <div class="toolcard" aria-label="Abrir Registro de nuevas prendas">
                <div class="toolcard-icon" aria-hidden="true">
                  <!-- tag/label icon -->
                  <svg viewBox="0 0 24 24" fill="none">
                    <path d="M20 13l-7 7a2 2 0 0 1-2.8 0L3 12.8V4h8.8L20 11.2a2 2 0 0 1 0 2.8Z" stroke="currentColor" stroke-width="2" stroke-linejoin="round"/>
                    <path d="M7.5 7.5h.01" stroke="currentColor" stroke-width="3" stroke-linecap="round"/>
                  </svg>
                </div>
                <div class="toolcard-body">
                  <div class="toolcard-title">Registro de nuevas prendas</div>
                  <div class="toolcard-desc">Genera el código y guarda la prenda en Firestore.</div>
                  <div class="toolcard-actions">
                    <button type="button" class="btn btn-primary tool-open" id="btnOpenRegistro">Abrir</button>
                  </div>
                </div>
              </div>

              <div class="toolcard" aria-label="Abrir Base de datos códigos HarujaGdl">
                <div class="toolcard-icon" aria-hidden="true">
                  <!-- database icon -->
                  <svg viewBox="0 0 24 24" fill="none">
                    <ellipse cx="12" cy="5" rx="7" ry="3" stroke="currentColor" stroke-width="2"/>
                    <path d="M5 5v6c0 1.7 3.1 3 7 3s7-1.3 7-3V5" stroke="currentColor" stroke-width="2"/>
                    <path d="M5 11v6c0 1.7 3.1 3 7 3s7-1.3 7-3v-6" stroke="currentColor" stroke-width="2"/>
                  </svg>
                </div>
                <div class="toolcard-body">
                  <div class="toolcard-title">Base de datos códigos HarujaGdl</div>
                  <div class="toolcard-desc">Consulta códigos, imprime etiquetas y administra en modo admin.</div>
                  <div class="toolcard-actions">
                    <button type="button" class="btn btn-primary tool-open" id="btnOpenCodigos">Abrir</button>
                  </div>
                </div>
              </div>

              <div class="toolcard" aria-label="Abrir Registrar apartado">
                <div class="toolcard-icon" aria-hidden="true">
                  <svg viewBox="0 0 24 24" fill="none">
                    <path d="M6 4h12a2 2 0 0 1 2 2v12a2 2 0 0 1-2 2H6a2 2 0 0 1-2-2V6a2 2 0 0 1 2-2Z" stroke="currentColor" stroke-width="2"/>
                    <path d="M8 9h8M8 13h8M8 17h5" stroke="currentColor" stroke-width="2" stroke-linecap="round"/>
                  </svg>
                </div>
                <div class="toolcard-body">
                  <div class="toolcard-title">Registrar apartado</div>
                  <div class="toolcard-desc">Crea apartados, registra abonos y genera ticket PDF.</div>
                  <div class="toolcard-actions">
                    <a class="btn btn-primary" href="/apartados">Abrir</a>
                  </div>
                </div>
              </div>

              <div class="toolcard" aria-label="Abrir Plan de lealtad">
                <div class="toolcard-icon" aria-hidden="true">
                  <svg viewBox="0 0 24 24" fill="none">
                    <path d="M12 3.5l2.63 5.33 5.88.85-4.25 4.15 1 5.86L12 17l-5.26 2.69 1-5.86L3.49 9.68l5.88-.85L12 3.5Z" stroke="currentColor" stroke-width="2" stroke-linejoin="round"/>
                  </svg>
                </div>
                <div class="toolcard-body">
                  <div class="toolcard-title">Plan de lealtad</div>
                  <div class="toolcard-desc">Registra clientes, puntos, compras y canjes.</div>
                  <div class="toolcard-actions">
                    <a class="btn btn-primary" href="/lealtad/">Abrir</a>
                  </div>
                </div>
              </div>
            </div>
          </div>
        </section>

        <section id="view-registro" class="view">
        <section class="section" id="registro">
          <button type="button" id="btnBackRegistro" class="secondary js-back">← Volver al panel</button>
          <h2>Registro de nuevas prendas</h2>
          <p>Selecciona los atributos clave para generar el código y guardar la prenda en Firestore.</p>
          <form class="form form-row" id="registro-form">
            <div>
              <label for="registro-producto">Tipo / Producto *</label>
              <select id="registro-producto" name="producto" required>
                <option value="">Seleccionar</option>
              </select>
            </div>
            <div>
              <label for="registro-proveedor">Proveedor *</label>
              <select id="registro-proveedor" name="proveedor" required>
                <option value="">Seleccionar</option>
              </select>
            </div>
            <div>
              <label for="registro-color">Color *</label>
              <select id="registro-color" name="color" required>
                <option value="">Seleccionar</option>
              </select>
            </div>
            <div>
              <label for="registro-talla">Talla *</label>
              <select id="registro-talla" name="talla" required>
                <option value="">Seleccionar</option>
              </select>
            </div>
            <div>
              <label for="registro-created-by">Creado por (opcional)</label>
              <input id="registro-created-by" name="createdBy" type="text" placeholder="Nombre" />
            </div>
            <div>
              <label for="registro-detalles">Detalles (opcional)</label>
              <input id="registro-detalles" name="detalles" type="text" placeholder="Ej: Pelly estampada" />
            </div>
            <div id="adminCreateFields" class="admin-create-card hidden" aria-hidden="true">
              <div class="admin-create-title">Admin (opcional)</div>
              <div class="admin-create-grid">
                <div>
                  <label for="adminCreateCosto">Costo</label>
                  <input id="adminCreateCosto" type="number" step="0.01" min="0" placeholder="Costo (admin)" />
                </div>
                <div>
                  <label for="adminCreatePVenta">P.Venta override (opcional)</label>
                  <input id="adminCreatePVenta" type="number" step="0.01" min="0" placeholder="P.Venta override (admin)" />
                </div>
              </div>
              <small>Solo en Modo Admin</small>
            </div>
            <div class="result-actions">
              <button type="submit">Generar código</button>
              <button type="button" id="registro-save" class="secondary">Guardar prenda</button>
            </div>
          </form>
          <p id="registro-status" class="status"></p>
          <div id="registro-result" class="result-card hidden">
            <span class="muted">Código generado</span>
            <div id="registro-codigo" class="result-code">HA00000/--</div>
            <div class="result-actions">
              <button type="button" id="registro-copy">Copiar</button>
              <button type="button" id="registro-reset">Crear otro</button>
            </div>
          </div>
        </section>
        </section>

        

        <section id="view-codigos" class="view">
        <section class="section" id="base-datos-codigos">
          <button type="button" id="btnBackCodigos" class="secondary js-back">← Volver al panel</button>
          <div id="dbCodigosSection" class="card section-card">
  <div class="card-header">
    <div class="card-title">Base de datos códigos HarujaGdl</div>
    <div class="card-subtitle">Explora la base de prendas 2025 con búsqueda, filtros y estado de novedades.</div>
  </div>

  <div class="db-controls">
    <div class="db-controls-row">
      <input id="prendas-search" class="input" type="text" placeholder="Buscar: código o descripción (ej. HA12A003)" />
      <button id="btnMoreFilters" class="btn btn-ghost" type="button">
        Más filtros <span id="moreFiltersDot" class="dot" style="display:none"></span>
      </button>
    </div>

    <div id="moreFiltersPanel" class="more-filters-panel" style="display:none">
      <div class="more-filters-grid">
        <input id="prendas-precio-min" class="input" type="number" inputmode="numeric" placeholder="Precio mín" />
        <input id="prendas-precio-max" class="input" type="number" inputmode="numeric" placeholder="Precio máx" />
        <label class="check">
          <input id="prendas-precio-sin" type="checkbox" />
          <span>Incluir sin precio</span>
        </label>
      </div>

      <div class="more-filters-actions">
        <button id="prendas-filters-clear" class="btn btn-muted" type="button">Limpiar</button>
        <button id="prendas-precio-apply" class="btn btn-primary" type="button">Aplicar</button>

        <div class="admin-only-block admin-import">
          </div>
      </div>
    </div>

    <div class="db-metrics">
      <div class="metric"><div class="metric-label">Total</div><div id="prendas-total" class="metric-value">—</div></div>
      <div class="metric"><div class="metric-label">Nuevos (7 días)</div><div id="prendas-nuevos" class="metric-value">—</div></div>
      <div class="metric"><div class="metric-label">Existentes</div><div id="prendas-existentes" class="metric-value">—</div></div>
    </div>
  </div>

  <div class="db-table">
    <div class="db-table-toolbar">
      <button id="admin-mode-btn" class="btn btn-ghost" type="button">Modo admin</button>
      <button id="labels-btn" class="btn btn-ghost" type="button">Etiquetas</button>
      <button id="admin-logout-quick" class="btn btn-muted hidden" type="button">Salir de admin</button>
    </div>
    <div id="labels-panel" class="labels-panel hidden" aria-hidden="true">
      <div class="labels-panel-title">Imprimir etiquetas</div>
      <div class="labels-scope-options">
        <label><input type="radio" name="labels-scope" value="page" checked /> Página actual</label>
        <label><input type="radio" name="labels-scope" value="filtered" /> Todo filtrado</label>
        <label><input type="radio" name="labels-scope" value="selected" /> Seleccionados</label>
      </div>
      <button id="labels-print-btn" class="btn btn-primary" type="button">Imprimir (Ctrl+P)</button>
    </div>

    <div id="prendas-loader" class="loader-row" style="display:none">
      <div class="spinner"></div>
      <div class="loader-text">Cargando base de datos…</div>
    </div>
    <div id="prendas-alert" class="prendas-alert" style="display:none; margin:10px 0;"></div>
    <template id="prendas-empty-template"><tr><td colspan="99" style="padding:18px; text-align:center; color:#6b7280;">Sin resultados</td></tr></template>

    <div class="table-wrap tableWrap">
      <table id="tablaPrendas" class="table">
        <thead>
                  <tr>
                    <th class="col-select"><input id="select-all-labels" type="checkbox" aria-label="Seleccionar todo" /></th>
                    <th class="col-orden" data-filter-key="orden"><button id="ordenSortBtn" class="th-sort" type="button" aria-label="Ordenar por Orden">Orden <span id="ordenSortIcon">↑</span></button></th>
                    <th class="col-codigo">Código</th>
                    <th class="col-descripcion">Descripción</th>
                    <th class="col-tipo" data-filter-key="tipo"><span class="th-filter">Tipo <button type="button" class="filter-btn" data-open-header-filter="tipo" aria-label="Filtrar Tipo">⌄</button></span></th>
                    <th class="col-color" data-filter-key="color"><span class="th-filter">Color <button type="button" class="filter-btn" data-open-header-filter="color" aria-label="Filtrar Color">⌄</button></span></th>
                    <th class="col-talla" data-filter-key="talla"><span class="th-filter">Talla <button type="button" class="filter-btn" data-open-header-filter="talla" aria-label="Filtrar Talla">⌄</button></span></th>
                    <th class="col-proveedor" data-filter-key="proveedor"><span class="th-filter">Proveedor <button type="button" class="filter-btn" data-open-header-filter="proveedor" aria-label="Filtrar Proveedor">⌄</button></span></th>
                    <th class="col-status" data-filter-key="status"><span class="th-filter">Status <button type="button" class="filter-btn" data-open-header-filter="status" aria-label="Filtrar Status">⌄</button></span></th>
                    <th class="col-disponibilidad" data-filter-key="disponibilidad"><span class="th-filter">Disponibilidad <button type="button" class="filter-btn" data-open-header-filter="disponibilidad" aria-label="Filtrar Disponibilidad">⌄</button></span></th>
                    <th class="col-fecha" data-filter-key="fecha"><span class="th-filter">Fecha <button type="button" class="filter-btn" data-open-header-filter="fecha" aria-label="Filtrar Fecha">⌄</button></span></th>
                    <th class="col-pventa" data-filter-key="pventa"><span class="th-filter">P. Venta <button type="button" class="filter-btn" data-open-header-filter="pventa" aria-label="Filtrar P. Venta">⌄</button></span></th>
                    <th class="admin-only">(Admin) Costo</th>
                    <th class="admin-only">(Admin) Margen</th>
                    <th class="admin-only">(Admin) Utilidad</th>
                    <th class="admin-only col-actions">Acciones</th>
                  </tr>
                </thead>
        <tbody id="prendas-tbody">
          <tr id="loadingRow" data-db-loader>
            <td colspan="17" class="muted" style="padding:14px 16px;">Cargando…</td>
          </tr>
          <tr id="noResultsRow" data-empty-row style="display:none">
            <td colspan="17" class="muted" style="padding:14px 16px;">Sin resultados.</td>
          </tr>
</tbody>
      </table>
<template id="emptyRowTemplate">
  <tr data-empty-row>
    <td colspan="99" style="padding:14px; color:#667085; text-align:center;">Sin resultados con estos filtros.</td>
  </tr>
</template>

    </div>

    <div class="pager">
      <div id="prendas-showing" class="pager-left">Mostrando 0</div>
      <div id="prendas-page" class="pager-center">Página 1</div>
      <div class="pager-right">
        <button id="prendas-prev" class="btn btn-primary" type="button">Anterior</button>
        <button id="prendas-next" class="btn btn-primary" type="button">Siguiente</button>
      </div>
    </div>

    <div class="pager-bottom">
      <div class="pager-spacer"></div>
      <div class="pager-size">
        <span>Registros por página</span>
        <select id="prendas-page-size" class="select">
          <option value="40">40</option>
          <option value="80" selected>80</option>
          <option value="120">120</option>
          <option value="200">200</option>
        </select>
      </div>
    </div>
  </div>
</div>
        </section>
        </section>

        <div id="printRoot" aria-hidden="true"></div>

</main>

<div id="editModal" class="edit-modal hidden" aria-hidden="true">
  <div id="editModalOverlay" class="edit-modal-overlay"></div>
  <div class="edit-modal-sheet" role="dialog" aria-modal="true" aria-labelledby="editModalTitle">
    <h3 id="editModalTitle" style="margin:0 0 12px;">Editar fila</h3>
    <div class="edit-modal-grid">
      <div>
        <label for="editPVenta">P.Venta override (vacío = usar público)</label>
        <input id="editPVenta" type="number" min="0" step="0.01" />
      </div>
      <div>
        <label for="editCosto">Costo</label>
        <input id="editCosto" type="number" min="0" step="0.01" />
      </div>
    </div>
    <div class="edit-modal-meta">
      <div>Utilidad: <strong id="editUtilidadPreview">$0.00</strong></div>
      <div>Margen: <strong id="editMargenPreview">0.0%</strong></div>
    </div>
    <p id="editModalError" class="status error hidden" style="margin:10px 0 0;"></p>
    <div class="edit-modal-actions">
      <button id="editModalCancel" type="button" class="secondary">Cancelar</button>
      <button id="editModalSave" type="button">Guardar</button>
    </div>
  </div>
</div>

<script src="/__/firebase/8.10.1/firebase-app.js"></script>
<script src="/__/firebase/8.10.1/firebase-auth.js"></script>
<script src="/__/firebase/init.js"></script>
<script src="/shared/firebase-init.js"></script>

<script type="module">
      import { initializeApp } from "https://www.gstatic.com/firebasejs/9.22.2/firebase-app.js";
      import {
        getFirestore,
        initializeFirestore,
        collection,
        doc,
        getDoc,
        getDocs,
        query,
        orderBy,
        documentId,
        runTransaction,
        serverTimestamp,
        setDoc,
        deleteField,
        startAfter,
        where,
        limit,
        persistentLocalCache,
        persistentMultipleTabManager,
        memoryLocalCache
      } from "https://www.gstatic.com/firebasejs/9.22.2/firebase-firestore.js";
      import {
        getAuth,
        GoogleAuthProvider,
        onAuthStateChanged,
        signInWithPopup,
        signOut
      } from "https://www.gstatic.com/firebasejs/9.22.2/firebase-auth.js";

      // ✅ CONFIG FIREBASE (EDITA SOLO ESTE BLOQUE SI CAMBIAS DE PROYECTO)
// Pega aquí TU CONFIG real de Firebase (Project settings > Your apps > Firebase SDK snippet > Config)
const firebaseConfig = window.HARUJA_FIREBASE_CONFIG || window.__HARUJA_FIREBASE_CONFIG__ || {};

if (!firebaseConfig?.apiKey || firebaseConfig.apiKey.includes("PEGA_AQUI") || firebaseConfig.apiKey.includes("REEMPLAZAR")) {
  console.error("[Firebase] Falta configurar firebaseConfig.apiKey (y/o appId/messagingSenderId).");
}
console.log("[Firebase] projectId:", firebaseConfig?.projectId);

      if(!firebaseConfig.apiKey || String(firebaseConfig.apiKey).includes("PEGA") || String(firebaseConfig.apiKey).includes("AQUI")){
  console.warn("[Firebase] Falta configurar firebaseConfig.apiKey (y/o appId/messagingSenderId).");
}
const app = initializeApp(firebaseConfig);
const auth = getAuth(app);
      const googleProvider = new GoogleAuthProvider();
      let db;
      try {
        db = initializeFirestore(app, {
          localCache: persistentLocalCache({
            tabManager: persistentMultipleTabManager()
          })
        });
      } catch (error) {
        console.warn(
          "[Firestore] Persistencia multi-tab no disponible, usando caché en memoria",
          error?.code || error?.message
        );
        db = initializeFirestore(app, {
          localCache: memoryLocalCache()
        });
      }
      let prendasRef = collection(db, "prendas");
      const registroForm = document.getElementById("registro-form");
      const registroStatus = document.getElementById("registro-status");
      const registroResult = document.getElementById("registro-result");
      const registroCodigo = document.getElementById("registro-codigo");
      const registroCopy = document.getElementById("registro-copy");
      const registroReset = document.getElementById("registro-reset");
      const registroSave = document.getElementById("registro-save");
      const registroSubmit = registroForm.querySelector("button[type='submit']");
      const registroProducto = document.getElementById("registro-producto");
      const registroProveedor = document.getElementById("registro-proveedor");
      const registroColor = document.getElementById("registro-color");
      const registroTalla = document.getElementById("registro-talla");
      const registroDetalles = document.getElementById("registro-detalles");
      const adminCreateFields = document.getElementById("adminCreateFields");
      const adminCreateCostoInput = document.getElementById("adminCreateCosto");
      const adminCreatePVentaInput = document.getElementById("adminCreatePVenta");

      const zplForm = document.getElementById("zpl-form");
      const zplStatus = document.getElementById("zpl-status");
      const labelSkuInput = document.getElementById("labelSkuInput");
      const labelQtyInput = document.getElementById("labelQtyInput");
      const labelPrintBtn = document.getElementById("labelPrintBtn");
      const printRoot = document.getElementById("printRoot");

      const prendasSearch = document.getElementById("prendas-search");
      const headerFilterButtons = document.querySelectorAll("[data-open-header-filter]");
      const ordenSortBtn = document.getElementById("ordenSortBtn");
      const ordenSortIcon = document.getElementById("ordenSortIcon");
      const prendasYear = document.getElementById("prendas-year");
      const prendasMonth = document.getElementById("prendas-month");
      const prendasPrecioMin = document.getElementById("prendas-precio-min");
      const prendasPrecioMax = document.getElementById("prendas-precio-max");
      const prendasPrecioSin = document.getElementById("prendas-precio-sin");
      const prendasPrecioApply = document.getElementById("prendas-precio-apply");
      const prendasFiltersClear = document.getElementById("prendas-filters-clear");
      const prendasPageSize = document.getElementById("prendas-page-size");
      const prendasTotal = document.querySelector("[data-count-total]") || document.getElementById("prendas-total");
      const prendasNuevos = document.getElementById("prendas-nuevos");
      const prendasExistentes = document.getElementById("prendas-existentes");
      const prendasCountNote = document.getElementById("prendas-count-note");
      const prendasTable =
        document.querySelector("[data-prendas-table]") ||
        document.getElementById("tablaPrendas");
      const prendasTbody =
        prendasTable?.querySelector("tbody") ||
        document.querySelector("[data-prendas-tbody]") ||
        document.getElementById("prendas-tbody");
      const prendasShowing =
        document.querySelector("[data-count-shown]") || document.getElementById("prendas-showing");
      const prendasPrev = document.getElementById("prendas-prev");
      const prendasNext = document.getElementById("prendas-next");
      const prendasPageIndicator = document.getElementById("prendas-page-indicator");
      const loadingRow =
        document.querySelector("[data-db-loader]") || document.getElementById("loadingRow");
      const prendasEmptyRow =
        document.querySelector("[data-empty-row]") || document.getElementById("noResultsRow");
      const prendasAlert = document.getElementById("prendas-alert");
      const prendasPanel = document.getElementById("base-datos-codigos");
      const dbCodigosSection = document.getElementById("dbCodigosSection");
      const adminToggleDb = prendasPanel?.querySelector("#adminToggleDb");
      const labelsButton = document.getElementById("labels-btn");
      const labelsPanel = document.getElementById("labels-panel");
      const labelsPrintButton = document.getElementById("labels-print-btn");
      const labelsScopeInputs = document.querySelectorAll("input[name='labels-scope']");
      const selectAllLabelsCheckbox = document.getElementById("select-all-labels");

      const adminSplitButton = document.getElementById("admin-split-collections");
      const adminLoginButton = document.getElementById("admin-login");
      const adminLogoutButton = document.getElementById("admin-logout");
      const adminLoginStatus = document.getElementById("admin-login-status");
      const adminPanel = document.getElementById("admin-panel");
      const adminActions = document.getElementById("admin-actions");
            const adminOptional = document.getElementById("admin-optional");
      const adminOptionalToggle = document.getElementById("admin-optional-toggle");
      const adminLogoutQuickButton = document.getElementById("admin-logout-quick");
      const editModal = document.getElementById("editModal");
      const editModalOverlay = document.getElementById("editModalOverlay");
      const editPVentaInput = document.getElementById("editPVenta");
      const editCostoInput = document.getElementById("editCosto");
      const editUtilidadPreview = document.getElementById("editUtilidadPreview");
      const editMargenPreview = document.getElementById("editMargenPreview");
      const editModalError = document.getElementById("editModalError");
      const editModalSaveButton = document.getElementById("editModalSave");
      const editModalCancelButton = document.getElementById("editModalCancel");
      const VIEWS = ["panel", "registro", "codigos"];

      let registroInited = false;
      let dbInited = false;

      function setView(name) {
        const nextView = VIEWS.includes(name) ? name : "panel";
        VIEWS.forEach((viewName) => {
          const view = document.getElementById(`view-${viewName}`);
          if (!view) return;
          view.classList.toggle("is-active", viewName === nextView);
        });

        if (nextView === "registro") initRegistroView();
        if (nextView === "codigos") initDbView();

        window.scrollTo({ top: 0, behavior: "smooth" });
      }

      function navigateTo(view, { replace = false } = {}) {
        const nextView = VIEWS.includes(view) ? view : "panel";
        const state = { view: nextView };
        const url = `#/${nextView}`;
        if (replace) {
          history.replaceState(state, "", url);
        } else {
          history.pushState(state, "", url);
        }
        setView(nextView);
      }

      function getViewFromUrl() {
        const hash = location.hash || "#/panel";
        const match = hash.match(/^#\/(panel|registro|codigos)$/);
        return match ? match[1] : "panel";
      }

      window.addEventListener("popstate", (event) => {
        const view = event.state?.view || getViewFromUrl();
        setView(view);
      });

      window.addEventListener("hashchange", () => {
        setView(getViewFromUrl());
      });

      const btnOpenRegistro = document.getElementById("btnOpenRegistro");
      if (btnOpenRegistro) {
        btnOpenRegistro.addEventListener("click", () => navigateTo("registro"));
      }

      const btnOpenCodigos = document.getElementById("btnOpenCodigos");
      if (btnOpenCodigos) {
        btnOpenCodigos.addEventListener("click", () => navigateTo("codigos"));
      }

      document.querySelectorAll(".js-back").forEach((button) => {
        if (!button) return;
        button.addEventListener("click", () => {
          if (history.length > 1) {
            history.back();
            return;
          }
          navigateTo("panel", { replace: true });
        });
      });
      console.assert(prendasTable, "No existe tabla de prendas");
      console.assert(prendasTbody, "No existe tbody de prendas");
      console.assert(loadingRow, "No existe loader de prendas");
      console.assert(prendasShowing, "No existe contador de prendas mostradas");
      console.assert(prendasTotal, "No existe contador total de prendas");
      console.assert(prendasEmptyRow, "No existe template de filas vacías");

      const setRegistroStatus = (message, type = "") => {
        if (!registroStatus) return;
        registroStatus.textContent = message;
        registroStatus.className = `status ${type}`.trim();
      };

      const setZplStatus = (message, type = "") => {
        if (!zplStatus) return;
        zplStatus.textContent = message;
        zplStatus.className = `status ${type}`.trim();
      };

      const safeString = (value) => {
        if (value === null || value === undefined) return "";
        return String(value);
      };

      const normalizeText = (value) =>
        safeString(value)
          .toLowerCase()
          .trim()
          .normalize("NFD")
          .replace(/[\u0300-\u036f]/g, "");

      const normalizeDictionaryValue = (value) =>
        safeString(value).trim().replace(/\s+/g, " ");

      const normalizeSku = (input) =>
        safeString(input)
          .trim()
          .toUpperCase()
          .replace(/\s+/g, " ")
          .replace(/\//g, "__");

      const safeDocId = (codigo) => normalizeSku(codigo);

      const normalizeSkuPrefix = (input) =>
        safeString(input)
          .trim()
          .toLowerCase()
          .replace(/\s+/g, "");

      const toNumberOrNull = (value) => {
        if (value === null || value === undefined) return null;
        if (String(value).trim() === "") return null;
        const parsed = Number(value);
        return Number.isFinite(parsed) ? parsed : null;
      };

      const toNumber = (value) => toNumberOrNull(value);

      const debounce = (fn, wait = 200) => {
        let timeoutId;
        return (...args) => {
          if (timeoutId) {
            clearTimeout(timeoutId);
          }
          timeoutId = setTimeout(() => fn(...args), wait);
        };
      };

      const formatDateDDMMYYYY = (date) => {
        if (!(date instanceof Date) || Number.isNaN(date.getTime())) {
          return "--";
        }
        const day = String(date.getDate()).padStart(2, "0");
        const month = String(date.getMonth() + 1).padStart(2, "0");
        const year = date.getFullYear();
        return `${day}/${month}/${year}`;
      };

      const toDateValue = (value) => {
        if (!value) return null;
        if (value instanceof Date) return value;
        if (typeof value?.toDate === "function") return value.toDate();
        if (typeof value === "number") return new Date(value);
        if (typeof value === "string") {
          const parsed = new Date(value);
          return Number.isNaN(parsed.getTime()) ? null : parsed;
        }
        return null;
      };

      const parseDateTextValue = (value) => {
        const raw = safeString(value).trim();
        if (!raw) return null;
        const match = /^(\d{1,2})\/(\d{1,2})\/(\d{4})$/.exec(raw);
        if (!match) return null;
        const day = Number(match[1]);
        const month = Number(match[2]);
        const year = Number(match[3]);
        if (!Number.isInteger(day) || !Number.isInteger(month) || !Number.isInteger(year)) {
          return null;
        }
        const parsed = new Date(year, month - 1, day, 0, 0, 0, 0);
        if (
          Number.isNaN(parsed.getTime()) ||
          parsed.getFullYear() !== year ||
          parsed.getMonth() !== month - 1 ||
          parsed.getDate() !== day
        ) {
          return null;
        }
        return parsed;
      };

      const resolveComparableDate = (item) => {
        const d1 = toDateValue(item?.fechaAlta);
        if (d1 instanceof Date && d1.getTime() !== 0) return d1;

        const d2 = toDateValue(item?.fecha);
        if (d2 instanceof Date && d2.getTime() !== 0) return d2;

        return (
          parseDateTextValue(item?.fechaAltaTexto) ||
          parseDateTextValue(item?.fechaTexto) ||
          null
        );
      };

      const isInDateRange = (item, dateRange) => {
        if (!dateRange?.start || !dateRange?.end) return true;
        const value = resolveComparableDate(item);
        if (!value) return false;
        return value >= dateRange.start && value < dateRange.end;
      };

      const compareItemsByDateDesc = (a, b) => {
        const dateA = resolveComparableDate(a);
        const dateB = resolveComparableDate(b);
        const timeA = dateA ? dateA.getTime() : Number.NEGATIVE_INFINITY;
        const timeB = dateB ? dateB.getTime() : Number.NEGATIVE_INFINITY;
        if (timeA !== timeB) return timeB - timeA;
        return safeString(b?.codigo).localeCompare(safeString(a?.codigo));
      };

      const compareItemsByOrdenAsc = (a, b) => {
        const ordenA = toNumberOrNull(a?.orden);
        const ordenB = toNumberOrNull(b?.orden);
        const hasA = Number.isFinite(ordenA);
        const hasB = Number.isFinite(ordenB);

        if (hasA && hasB && ordenA !== ordenB) {
          return ordenA - ordenB;
        }
        if (hasA && !hasB) return -1;
        if (!hasA && hasB) return 1;

        return compareItemsByDateDesc(a, b);
      };

      const isNew = (createdAt, days = 7) => {
        const createdDate = toDateValue(createdAt);
        if (!createdDate) return false;
        const diff = Date.now() - createdDate.getTime();
        return diff <= days * 24 * 60 * 60 * 1000;
      };

      const buildOption = ({ clave, valor }) => {
        const option = document.createElement("option");
        option.value = clave;
        option.textContent = `${clave} - ${valor}`;
        option.dataset.nombre = valor;
        return option;
      };

      const setSelectLoading = (selectEl, message) => {
        selectEl.innerHTML = "";
        const option = document.createElement("option");
        option.value = "";
        option.textContent = message;
        selectEl.appendChild(option);
        selectEl.disabled = true;
      };

      const fillDictionarySelect = (selectEl, entries) => {
        selectEl.innerHTML = "";
        const placeholder = document.createElement("option");
        placeholder.value = "";
        placeholder.textContent = "Seleccionar";
        selectEl.appendChild(placeholder);
        entries.forEach((item) => selectEl.appendChild(buildOption(item)));
        selectEl.disabled = false;
      };

      const buildUniqueSelectValues = (values) => {
        const map = new Map();
        values.forEach((value) => {
          const trimmed = safeString(value).trim();
          if (!trimmed) return;
          const normalized = normalizeText(trimmed);
          if (!map.has(normalized)) {
            map.set(normalized, trimmed);
          }
        });
        return [...map.values()].sort((a, b) => a.localeCompare(b));
      };

      const fillSelect = (selectEl, values) => {
        const current = selectEl.value;
        selectEl.innerHTML = "";
        const allOption = document.createElement("option");
        allOption.value = "todos";
        allOption.textContent = "Todos";
        selectEl.appendChild(allOption);
        const uniqueValues = buildUniqueSelectValues(values);
        uniqueValues.forEach((value) => {
          const option = document.createElement("option");
          option.value = value;
          option.textContent = value;
          selectEl.appendChild(option);
        });
        if (current) {
          const normalizedCurrent = normalizeText(current);
          const matched = uniqueValues.find(
            (value) => normalizeText(value) === normalizedCurrent
          );
          selectEl.value = matched || "todos";
        } else {
          selectEl.value = "todos";
        }
        selectEl.disabled = false;
      };

      const collectOption = (map, codigo, nombre) => {
        if (!codigo) return;
        if (!map.has(codigo)) {
          map.set(codigo, nombre || codigo);
        }
      };

      const COLLECTIONS = {
        tipos: "diccionario_tipos",
        proveedores: "diccionario_proveedores",
        colores: "diccionario_colores",
        tallas: "diccionario_tallas"
      };
      const DICTIONARY_FALLBACK_COLLECTION = "diccionario";

      const CODE_PATTERN = /^HA(\d+)([A-Z])(\d{3})\/([A-Z0-9]+)-([A-Z0-9]+)$/;
      const PRENDAS_PUBLIC_COLLECTION = "HarujaPrendas_2025_public";
      const PRENDAS_ADMIN_COLLECTION = "HarujaPrendas_2025_admin";
      const PRENDAS_MASTER_COLLECTION = "HarujaPrendas_2025";
      const MODELOS_COLLECTION = "modelos";
      const MODELOS_INDEX_COLLECTION = "modelos_index";
      const MODELOS_COUNTER_DOC = "modelos";
      const PRENDAS_COLLECTION_CANDIDATES = [
        PRENDAS_PUBLIC_COLLECTION,
        "prendas",
        PRENDAS_MASTER_COLLECTION
      ];
      const API_BASE = `https://us-central1-${firebaseConfig.projectId}.cloudfunctions.net`;
      const SPLIT_FUNCTION_NAME = "migrateSplitCollections";
      const SPLIT_FUNCTION_URL = `${API_BASE}/${SPLIT_FUNCTION_NAME}`;
      const ADMIN_ALLOWLIST = new Set([
        "yair.tenorio.silva@gmail.com",
        "harujagdl@gmail.com",
        "harujagdl.ventas@gmail.com"
      ]);
      const PRENDAS_PAGE_SIZE_DEFAULT = 80;
      const PRENDAS_SCAN_PAGE_SIZE = 200;
      const PRENDAS_SCAN_MAX_PAGES = 12;
      const PRENDAS_DATE_FALLBACK_LIMIT = 1200;
      const PRENDAS_COUNT_SCAN_LIMIT = 2000;
      const PRENDAS_COUNT_BATCH_SIZE = 250;
      const PRENDAS_RENDER_CHUNK = 20;
      const PRENDAS_SEARCH_DEBOUNCE = 250;
      const PRENDAS_YEAR_MIN = 2024;
      const DATE_FIELD_PRIMARY = "fechaAlta";
      const DATE_FIELD_FALLBACK = "fecha";
      const QUERY_MODE_EQUALITY = "equality";
      const QUERY_MODE_DATE = "dateRange";
      const QUERY_MODE_PRICE = "priceRange";
      const MONTH_OPTIONS = [
        { value: 1, label: "Enero" },
        { value: 2, label: "Febrero" },
        { value: 3, label: "Marzo" },
        { value: 4, label: "Abril" },
        { value: 5, label: "Mayo" },
        { value: 6, label: "Junio" },
        { value: 7, label: "Julio" },
        { value: 8, label: "Agosto" },
        { value: 9, label: "Septiembre" },
        { value: 10, label: "Octubre" },
        { value: 11, label: "Noviembre" },
        { value: 12, label: "Diciembre" }
      ];
      const HEADER_FILTER_KEYS = [
        "status",
        "proveedor",
        "tipo",
        "color",
        "talla",
        "disponibilidad"
      ];
      const HEADER_RANGE_KEY = "pventa";
      const HEADER_POPOVER_MARGIN = 12;
      const HEADER_POPOVER_OFFSET = 8;
      const createEmptyHeaderFilters = () => ({
        status: new Set(),
        proveedor: new Set(),
        tipo: new Set(),
        color: new Set(),
        talla: new Set(),
        disponibilidad: new Set(),
        pventaMin: null,
        pventaMax: null,
        fechaYear: "",
        fechaMonth: ""
      });
      const DEFAULT_PRENDAS_SORT = Object.freeze({ key: "orden", dir: "asc" });
      const PRENDAS_SORT_KEY_STORAGE = "prendas_sort_key";
      const PRENDAS_SORT_DIR_STORAGE = "prendas_sort_dir";
      const ADMIN_VIEW_KEY = "haruja_admin_view";
      const DICTS_CACHE_KEY = "haruja_dicts_cache_v2";
      const METADATA_COUNTS_DOC = {
        collection: "metadata",
        doc: "counters"
      };

      let activePrendasPublicCollection = PRENDAS_PUBLIC_COLLECTION;
      let prendasPublicRef = collection(db, activePrendasPublicCollection);
      const prendasState = {
        filtered: [],
        baseRows: [],
        baseRowsCacheKey: "public",
        rowsAfterGlobal: [],
        rowsAfterAll: [],
        uniqueOptions: {},
        isAdmin: false,
        adminUser: null,
        adminEmail: "",
        adminByAuth: false,
        pageIndex: 0,
        hasNextPage: false,
        dicts: {
          proveedores: [],
          tipos: [],
          colores: [],
          tallas: []
        },
        dictsLoaded: false,
        isDone: false,
        isLoadingInitial: false,
        filters: {
          global: null,
          header: createEmptyHeaderFilters()
        },
        filtersActive: false,
        renderToken: 0,
        searchToken: 0,
        isSkuSearch: false,
        showingTotal: null,
        queryKey: "",
        reqId: 0,
        countToken: 0,
        metadataTotal: null,
        metadataLoaded: false,
        headerPopover: null,
        sort: { ...DEFAULT_PRENDAS_SORT },
        adminMap: new Map(),
        selected: new Set(),
        labelsScope: "page",
        labelsPanelOpen: false
      };
      prendasState.editing = null;
      let isBooting = true;
      let isAdminMode = false;

      const setPrendasCollections = ({ publicCollection }) => {
        activePrendasPublicCollection = publicCollection || PRENDAS_PUBLIC_COLLECTION;
        prendasRef = collection(db, activePrendasPublicCollection);
        prendasPublicRef = collection(db, activePrendasPublicCollection);
        console.log("[Prendas] ✅ Usando colección:", activePrendasPublicCollection);
      };

      const loadCategoryEntries = async (category, collectionName) => {
        const snapshot = await getDocs(collection(db, collectionName));
        if (snapshot.empty) {
          return { category, entries: [], empty: true };
        }

        const entries = snapshot.docs
          .map((docSnap) => {
            const data = docSnap.data() || {};
            const clave = data.clave || docSnap.id;
            const valor = data.valor || data.nombre || clave;
            return { clave, valor };
          })
          .filter((entry) => entry.clave && entry.valor);

        return { category, entries, empty: entries.length === 0 };
      };

      const loadCategoryEntriesFromFallback = async (category) => {
        const snapshot = await getDocs(collection(db, DICTIONARY_FALLBACK_COLLECTION));
        if (snapshot.empty) return { category, entries: [], empty: true };

        const entries = snapshot.docs
          .map((docSnap) => {
            const data = docSnap.data() || {};
            const categoria = safeString(data.categoria || data.category || data.tipo).trim().toLowerCase();
            if (categoria && categoria !== category) return null;
            const clave = safeString(data.clave || data.codigo || docSnap.id).trim();
            const valor = safeString(data.valor || data.nombre || data.label || clave).trim();
            if (!clave || !valor) return null;
            return { clave, valor };
          })
          .filter(Boolean);

        return { category, entries, empty: entries.length === 0 };
      };

      const resolvePrendasCollection = async () => {
        const probe = await Promise.all(
          PRENDAS_COLLECTION_CANDIDATES.map(async (collectionName) => {
            try {
              const sample = await getDocs(query(collection(db, collectionName), limit(1)));
              return { collectionName, ok: true, hasDocs: !sample.empty };
            } catch (error) {
              return { collectionName, ok: false, hasDocs: false, error };
            }
          })
        );

        const best = probe.find((item) => item.ok && item.hasDocs) || probe.find((item) => item.ok);
        if (!best) {
          const firstError = probe.find((item) => item.error)?.error;
          throw firstError || new Error("No se pudo resolver colección de prendas.");
        }
        if (best.collectionName !== PRENDAS_PUBLIC_COLLECTION) {
          console.warn("[Prendas] colección alternativa detectada:", best.collectionName);
        }
        return best.collectionName;
      };

      const loadDictionary = async () => {
        const categories = Object.keys(COLLECTIONS);
        let results = await Promise.all(
          categories.map((category) =>
            loadCategoryEntries(category, COLLECTIONS[category])
          )
        );
        const totalEntries = results.reduce((acc, result) => acc + result.entries.length, 0);
        if (!totalEntries) {
          results = await Promise.all(
            categories.map((category) => loadCategoryEntriesFromFallback(category))
          );
        }
        const missing = results.filter((result) => result.empty).map((result) => result.category);

        return {
          empty: missing.length === categories.length,
          missing,
          tipos: results.find((result) => result.category === "tipos")?.entries ?? [],
          proveedores: results.find((result) => result.category === "proveedores")?.entries ?? [],
          colores: results.find((result) => result.category === "colores")?.entries ?? [],
          tallas: results.find((result) => result.category === "tallas")?.entries ?? []
        };
      };

      const loadDictionariesOnce = async () => {
        if (prendasState.dictsLoaded) {
          return prendasState.dicts;
        }
        const cached = localStorage.getItem(DICTS_CACHE_KEY);
        if (cached) {
          try {
            const parsed = JSON.parse(cached);
            if (
              parsed?.version === "2" &&
              parsed?.dicts &&
              ["proveedores", "tipos", "colores", "tallas"].every((key) =>
                Array.isArray(parsed.dicts[key])
              )
            ) {
              prendasState.dicts = parsed.dicts;
              prendasState.dictsLoaded = true;
              return prendasState.dicts;
            }
          } catch (error) {
            console.warn("Cache de diccionarios inválida, recargando.", error);
          }
        }
        const categories = Object.keys(COLLECTIONS);
        let results = await Promise.all(
          categories.map(async (category) => {
            const snapshot = await getDocs(collection(db, COLLECTIONS[category]));
            const values = snapshot.docs
              .map((docSnap) => {
                const data = docSnap.data() || {};
                return (
                  data.valor ??
                  data.Valor ??
                  data.nombre ??
                  data.Nombre ??
                  data.clave ??
                  data.Clave ??
                  docSnap.id
                );
              })
              .map((value) => safeString(value).trim())
              .filter((value) => value);
            return { category, values };
          })
        );
        const totalValues = results.reduce((acc, result) => acc + result.values.length, 0);
        if (!totalValues) {
          const fallbackSnapshot = await getDocs(collection(db, DICTIONARY_FALLBACK_COLLECTION));
          results = categories.map((category) => {
            const values = fallbackSnapshot.docs
              .map((docSnap) => {
                const data = docSnap.data() || {};
                const categoria = safeString(data.categoria || data.category || data.tipo).trim().toLowerCase();
                if (categoria && categoria !== category) return "";
                return (
                  data.valor ??
                  data.Valor ??
                  data.nombre ??
                  data.Nombre ??
                  data.clave ??
                  data.Clave ??
                  docSnap.id
                );
              })
              .map((value) => safeString(value).trim())
              .filter((value) => value);
            return { category, values };
          });
        }

        prendasState.dicts.proveedores =
          results.find((result) => result.category === "proveedores")?.values ?? [];
        prendasState.dicts.tipos =
          results.find((result) => result.category === "tipos")?.values ?? [];
        prendasState.dicts.colores =
          results.find((result) => result.category === "colores")?.values ?? [];
        prendasState.dicts.tallas =
          results.find((result) => result.category === "tallas")?.values ?? [];
        prendasState.dictsLoaded = true;
        localStorage.setItem(
          DICTS_CACHE_KEY,
          JSON.stringify({ version: "2", dicts: prendasState.dicts })
        );
        return prendasState.dicts;
      };

      const setLoading = (isLoading, message = "Cargando base de datos...") => {
        if (!loadingRow) return;
        const text = loadingRow.querySelector(".loading-text");
        if (text) {
          text.textContent = message;
        }
        loadingRow.style.display = isLoading ? "flex" : "none";
      };

      const setCounter = (shown, total) => {
        if (prendasShowing) {
          if (Number.isFinite(total)) {
            prendasShowing.textContent = `Mostrando ${shown} de ${total}`;
          } else {
            prendasShowing.textContent = `Mostrando ${shown} de ?`;
          }
        }
      };

      const resetCounters = () => {
        if (prendasTotal) {
          prendasTotal.textContent = "—";
        }
        if (prendasNuevos) {
          prendasNuevos.textContent = "—";
        }
        if (prendasExistentes) {
          prendasExistentes.textContent = "—";
        }
        if (prendasCountNote) {
          prendasCountNote.textContent = "";
        }
      };

      const updatePaginationUi = () => {
        if (!prendasPrev || !prendasNext || !prendasPageIndicator) return;
        const isSkuSearch = prendasState.isSkuSearch;
        const pageIndex = prendasState.pageIndex;
        const hasPrev = pageIndex > 0;
        const hasNext = prendasState.hasNextPage;
        const isBusy = prendasState.isLoadingInitial;
        prendasPrev.disabled = isSkuSearch || isBusy || !hasPrev;
        prendasNext.disabled = isSkuSearch || isBusy || !hasNext;
        prendasPrev.classList.toggle("hidden", isSkuSearch);
        prendasNext.classList.toggle("hidden", isSkuSearch);
        prendasPageIndicator.textContent = `Página ${pageIndex + 1}`;
      };

      const formatApproxCount = (value, isApprox) =>
        isApprox ? `≈ ${value}+` : `${value}`;

      const setApproxCounts = ({
        total,
        nuevos,
        existentes,
        isApprox,
        preferMetadata = false
      }) => {
        const useMetadata =
          preferMetadata && Number.isFinite(prendasState.metadataTotal);
        if (prendasTotal) {
          prendasTotal.textContent = useMetadata
            ? formatApproxCount(prendasState.metadataTotal, false)
            : Number.isFinite(total)
              ? formatApproxCount(total, isApprox)
            : "—";
        }
        if (prendasNuevos) {
          prendasNuevos.textContent = Number.isFinite(nuevos)
            ? formatApproxCount(nuevos, isApprox)
            : "—";
        }
        if (prendasExistentes) {
          prendasExistentes.textContent = Number.isFinite(existentes)
            ? formatApproxCount(existentes, isApprox)
            : "—";
        }
        if (prendasCountNote) {
          if (useMetadata) {
            prendasCountNote.textContent =
              "Total global leído desde metadata (sin filtros).";
          } else {
            prendasCountNote.textContent = isApprox
              ? "Conteos aproximados para evitar errores de índices."
              : "Conteos basados en escaneo para evitar errores de índices.";
          }
        }
      };

      const setExactCountsFromItems = (items) => {
        const total = items.length;
        const nuevos = items.filter((item) => isNew(getPrendaDate(item))).length;
        const existentes = total - nuevos;
        setApproxCounts({ total, nuevos, existentes, isApprox: false });
      };

      const setPrendasAlert = (message = "", { isHtml = false } = {}) => {
        if (message) {
          if (isHtml) {
            prendasAlert.innerHTML = message;
          } else {
            prendasAlert.textContent = message;
          }
          prendasAlert.classList.remove("hidden");
        } else {
          prendasAlert.textContent = "";
          prendasAlert.classList.add("hidden");
        }
      };

      const isFullSku = (input) => {
        const value = safeString(input).trim().toUpperCase();
        if (!value) return false;
        return CODE_PATTERN.test(value);
      };

      const getPrendaDate = (data) => {
        const resolved =
          resolveComparableDate(data) ||
          toDateValue(data?.fechaAlta) ||
          toDateValue(data?.fecha) ||
          toDateValue(data?.updatedAt) ||
          toDateValue(data?.createdAt);

        if (resolved instanceof Date && resolved.getTime() === 0) return null;
        return resolved;
      };

      const normalizeStatus = (raw) => {
        const normalized = normalizeText(raw);
        if (!normalized) return "";
        if (normalized === "vendido") return "Vendido";
        if (["existente", "en stock", "disponible", "activo"].includes(normalized)) {
          return "Disponible";
        }
        return "";
      };

      const normalizeDisponibilidad = (raw, statusCanon) => {
        if (statusCanon === "Vendido") return "No disponible";
        const normalized = normalizeText(raw);
        if (!normalized) return "Disponible";
        if (["no disponible", "agotado", "sin stock", "0"].includes(normalized)) {
          return "No disponible";
        }
        if (["disponible", "en stock", "1", "si"].includes(normalized)) {
          return "Disponible";
        }
        return "Disponible";
      };

      const getBadgeClassByLabel = (label) => {
        if (label === "Disponible") return "badge-success";
        if (label === "No disponible" || label === "Vendido") return "badge-danger";
        return "";
      };

      const renderBadgeCell = (label) => {
        const cell = document.createElement("td");
        if (label === "--") {
          cell.textContent = "--";
          return cell;
        }
        cell.appendChild(buildBadge(label, getBadgeClassByLabel(label)));
        return cell;
      };

      const renderStatusCell = (status) =>
        renderBadgeCell(normalizeStatus(status) || "--");

      const renderDisponibilidadCell = (disponibilidad, status) =>
        renderBadgeCell(normalizeDisponibilidad(disponibilidad, status));

      const resolvePVenta = (data) => {
        const precioConIva = toNumberOrNull(
          pickFirstValue(data?.precioConIva, data?.precioConIVA)
        );
        const precioBase = toNumberOrNull(
          pickFirstValue(data?.precio, data?.Precio, data?.price)
        );
        const pVenta = toNumberOrNull(
          pickFirstValue(data?.pVenta, data?.PVenta, data?.p_venta)
        );
        if (Number.isFinite(precioConIva)) return precioConIva;
        if (Number.isFinite(precioBase)) return precioBase;
        if (Number.isFinite(pVenta)) return pVenta;
        return null;
      };

      const getPrendaPrice = (data) => resolvePVenta(data);

      const currencyFormatter = new Intl.NumberFormat("es-MX", {
        style: "currency",
        currency: "MXN",
        maximumFractionDigits: 2
      });

      const formatCurrency = (value) => currencyFormatter.format(value);

      const formatPercent = (value) => {
        if (!Number.isFinite(value)) return "";
        const n = Number(value);

        // Si viene como ratio (ej 0.742 => 74.2% o 1.111 => 111.1%)
        // Si viene como “porcentaje” (ej 74.2), lo detectamos y lo tratamos.
        const ratio = (n > 5) ? (n / 100) : n;

        return (ratio * 100).toFixed(1) + "%";
      };

      const formatMoney = (value) => {
        const amount = Number(value);
        if (!Number.isFinite(amount)) return "--";
        return formatCurrency(amount);
      };

      const moneyFmt = (value) => formatMoney(value);
      const pctFmt = (value) => {
        const formatted = formatPercent(value);
        return formatted || "—";
      };

      const formatDateCell = (item) => {
        const date = getPrendaDate(item);
        return date ? formatDateDDMMYYYY(date) : "--";
      };

      const labelCurrencyFormatter = new Intl.NumberFormat("es-MX", {
        style: "currency",
        currency: "MXN",
        maximumFractionDigits: 0
      });

      const formatLabelPrice = (value) => {
        const amount = Number(value);
        if (!Number.isFinite(amount)) return "$0";
        return labelCurrencyFormatter.format(amount);
      };

      const getLabelPriceNumber = (row) => {
        const adminEnabled = isAdminViewEnabled();
        const override = toNumberOrNull(row?.pVentaOverride);
        const publicPrice = toNumberOrNull(row?.pVenta);
        if (adminEnabled && Number.isFinite(override)) {
          return override;
        }
        return Number.isFinite(publicPrice) ? publicPrice : null;
      };

      const updateSelectAllCheckbox = () => {
        if (!selectAllLabelsCheckbox) return;
        const rows = prendasState.filtered || [];
        const visibleIds = rows
          .map((row) => safeString(row.docId || row.id).trim())
          .filter((id) => id);
        if (!visibleIds.length) {
          selectAllLabelsCheckbox.checked = false;
          selectAllLabelsCheckbox.indeterminate = false;
          return;
        }
        const selectedCount = visibleIds.filter((id) => prendasState.selected.has(id)).length;
        selectAllLabelsCheckbox.checked = selectedCount === visibleIds.length;
        selectAllLabelsCheckbox.indeterminate = selectedCount > 0 && selectedCount < visibleIds.length;
      };

      const getRowsForScope = (scope = "page") => {
        if (scope === "filtered") {
          return prendasState.rowsAfterAll || [];
        }
        if (scope === "selected") {
          const allRows = prendasState.rowsAfterAll || [];
          return allRows.filter((row) => {
            const docId = safeString(row.docId || row.id).trim();
            return docId && prendasState.selected.has(docId);
          });
        }
        return prendasState.filtered || [];
      };

      const getLabelLogoSrc = () => {
        const preferred = document.querySelector("img#headerLogo, header img, .app img");
        if (preferred?.src) return preferred.src;
        const fallbackSvg = `<svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 320 90'><rect width='100%' height='100%' fill='white'/><text x='8' y='62' font-family='Arial,sans-serif' font-size='56' font-weight='700' fill='black'>HARUJA</text></svg>`;
        return `data:image/svg+xml;utf8,${encodeURIComponent(fallbackSvg)}`;
      };

      // Pega aquí el ZPL completo de Haruja2025.zpl si no lo inyectas por window.__HARUJA_2025_ZPL__.
      const HARUJA_2025_ZPL = window.__HARUJA_2025_ZPL__ || String.raw``;

      const extractGfaCommandFromZpl = (zplSource) => {
        const source = safeString(zplSource);
        const match = source.match(/\^GFA,(\d+),(\d+),(\d+),([\s\S]*?)\^FS/i);
        if (!match) {
          throw new Error("No se encontró bloque ^GFA ... ^FS en Haruja2025.zpl");
        }
        return {
          bytesTotal: Number(match[1]),
          bytesUsed: Number(match[2]),
          bytesPerRow: Number(match[3]),
          data: match[4]
        };
      };

      const isHexDigit = (char) => /^[0-9A-Fa-f]$/.test(char);

      const decodeCountCode = (char) => {
        if (char >= "0" && char <= "9") return Number(char);
        if (char >= "G" && char <= "Z") return char.charCodeAt(0) - 69;
        if (char >= "g" && char <= "z") return (char.charCodeAt(0) - 102) * 20;
        return null;
      };

      const decodeGfaToBitmap = ({ bytesTotal, bytesPerRow, data }) => {
        if (!Number.isInteger(bytesTotal) || !Number.isInteger(bytesPerRow) || bytesPerRow <= 0) {
          throw new Error("Parámetros GFA inválidos");
        }

        const rows = [];
        let row = [];
        let cursor = 0;
        const source = safeString(data).trim();

        const pushRow = () => {
          while (row.length < bytesPerRow) row.push(0x00);
          if (row.length > bytesPerRow) {
            throw new Error("Fila GFA excede bytesPerRow");
          }
          rows.push(row);
          row = [];
        };

        const pushByte = (value) => {
          row.push(value);
          if (row.length === bytesPerRow) pushRow();
          if (row.length > bytesPerRow) {
            throw new Error("Overflow de fila durante decode GFA");
          }
        };

        while (cursor < source.length) {
          const current = source[cursor];
          if (/\s/.test(current)) {
            cursor += 1;
            continue;
          }

          let count = 0;
          let hasCount = false;
          while (cursor < source.length) {
            const countValue = decodeCountCode(source[cursor]);
            if (countValue === null) break;
            hasCount = true;
            count += countValue;
            cursor += 1;
          }
          const repeat = hasCount ? count : 1;
          if (repeat <= 0) {
            throw new Error("Conteo inválido en compresión GFA");
          }

          const token = source[cursor];
          if (!token) break;

          if (token === ",") {
            cursor += 1;
            for (let i = 0; i < repeat; i += 1) pushRow();
            continue;
          }

          if (token === "!") {
            cursor += 1;
            for (let i = 0; i < repeat; i += 1) {
              while (row.length < bytesPerRow) row.push(0xff);
              pushRow();
            }
            continue;
          }

          if (token === ":") {
            cursor += 1;
            if (!rows.length) {
              throw new Error("Token ':' sin fila previa en GFA");
            }
            for (let i = 0; i < repeat; i += 1) {
              rows.push(rows[rows.length - 1].slice());
            }
            continue;
          }

          const pairA = source[cursor];
          const pairB = source[cursor + 1];
          if (!isHexDigit(pairA) || !isHexDigit(pairB)) {
            throw new Error(`Token inválido en GFA cerca de "${source.slice(cursor, cursor + 8)}"`);
          }
          const byteValue = parseInt(`${pairA}${pairB}`, 16);
          cursor += 2;
          for (let i = 0; i < repeat; i += 1) {
            pushByte(byteValue);
          }
        }

        if (row.length) pushRow();

        const flattened = new Uint8Array(rows.flat());
        if (flattened.length !== bytesTotal) {
          throw new Error("GFA decode mismatch");
        }
        return flattened;
      };

      const renderGfaToPngDataUrl = ({ bytesTotal, bytesPerRow, data }) => {
        const bitmap = decodeGfaToBitmap({ bytesTotal, bytesPerRow, data });
        const widthDots = bytesPerRow * 8;
        const heightDots = bytesTotal / bytesPerRow;
        if (!Number.isInteger(heightDots)) {
          throw new Error("Altura inválida para bitmap GFA");
        }

        const canvas = document.createElement("canvas");
        canvas.width = widthDots;
        canvas.height = heightDots;
        const ctx = canvas.getContext("2d");
        if (!ctx) throw new Error("No se pudo obtener contexto 2D para logo GFA");

        ctx.clearRect(0, 0, widthDots, heightDots);
        ctx.fillStyle = "#000";

        let offset = 0;
        for (let y = 0; y < heightDots; y += 1) {
          for (let byteIndex = 0; byteIndex < bytesPerRow; byteIndex += 1) {
            const byteValue = bitmap[offset++];
            for (let bit = 7; bit >= 0; bit -= 1) {
              const x = byteIndex * 8 + (7 - bit);
              if (((byteValue >> bit) & 1) === 1) {
                ctx.fillRect(x, y, 1, 1);
              }
            }
          }
        }

        return canvas.toDataURL("image/png");
      };

      const getZplLogoDataUrl = (() => {
        let cachedDataUrl = "";
        return () => {
          if (cachedDataUrl) return cachedDataUrl;
          const gfa = extractGfaCommandFromZpl(HARUJA_2025_ZPL);
          cachedDataUrl = renderGfaToPngDataUrl(gfa);
          return cachedDataUrl;
        };
      })();

      const getZplLogoCommand = (() => {
        let cachedCommand = "";
        return () => {
          if (cachedCommand) return cachedCommand;
          const gfa = extractGfaCommandFromZpl(HARUJA_2025_ZPL);
          cachedCommand = `^GFA,${gfa.bytesTotal},${gfa.bytesUsed},${gfa.bytesPerRow},${gfa.data}`;
          return cachedCommand;
        };
      })();

      const LABEL_ZPL_DEBUG = window.localStorage.getItem("label-zpl-debug") === "1";

      
const buildLabelZpl = ({ sku, price, qty = 1 }) => {
  const codigo = safeString(sku).trim();
  const precio = safeString(price).trim();

  const template = `
^XA
^CI28
^PW406
^LL203
^LH0,0

^FO25,40
^A0N,30,30
^FD${codigo}^FS

^FO25,100
^A0N,55,55
^FD${precio}^FS

^FO260,17
^BQN,2,6
^FDLA,${codigo}^FS

^FO290,165^GFA,390,390,13,,:1EP01CM07FF,1EP01EM03CF,0EP01EM01CF,0EQ0CM03CF,0EY03CF,0E301E001L0E01C031CF,0EF87F9E7F8F3E3F877EFFCF,0FBCE38EFF8F1E63CE39E3CF,0F1CE3CFBF8F1EF3DE39C3CF,0E1CE3CF078F1EF3DE3FC1CF,0E1C47CF078F1E63DE3FC3CF,0E1C0FCF078F1E0FDE3FC3CF,0E1C33CE078F1E3BCE3BC3CF,0E1C63CE078F1E73C773C3CF,0E1CE3CE078F1EE3C7C3C1CF,0E1DE3CE078F1EF3CC01E3CF,1E1DFFCE079F1EFFDC01E3CF,1F3FFBFF03FF9EF9IF8JF,J0608001C01E20CFFE79,R01EI0FFE,R01EI0C0E,Q019C001806,Q01DC00180C,R0F8I0FF8,,:7gIFC,,^FS

^XZ`;

  return Array.from({ length: qty }, () => template).join("\n");
}; // fin buildLabelZpl

      const escapeHtml = (value) => safeString(value)
        .replace(/&/g, "&amp;")
        .replace(/</g, "&lt;")
        .replace(/>/g, "&gt;")
        .replace(/\"/g, "&quot;")
        .replace(/'/g, "&#39;");

      const getPrintHtml = (labels = []) => {
        const LOGO_DATA_URI = "data:image/png;base64,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";
        const pages = labels.map((label) => `
          <section class="page">
            <div class="codigo">${escapeHtml(label.codigo)}</div>
            <div class="precio">${escapeHtml(label.precioTexto)}</div>
            <div class="qr" data-qr="${escapeHtml(label.qrValue)}"></div>
            <img class="logoImg" alt="harujagdl" src="${LOGO_DATA_URI}" />
          </section>
        `).join("\n");
return `<!doctype html>
<html lang="es">
<head>
  <meta charset="utf-8" />
  <base href="${location.origin}/">
  <title>Etiquetas 51x25</title>
<style>
  @page { size: 51mm 25mm; margin: 0; }
  html,body { margin:0; padding:0; }
  .print-actions { position: fixed; top: 8px; left: 8px; z-index: 10; }
  .page { width:51mm; height:25mm; page-break-after:always; position:relative; overflow:hidden; }
  .codigo { position:absolute; left:3.13mm; top:5.0mm; font-size:3.3mm; font-weight:600; font-family: Arial, sans-serif; }
  .precio { position:absolute; left:3.13mm; top:12.5mm; font-size:6.2mm; line-height:1; font-weight:700; font-family: Arial, sans-serif; }
  .qr { position:absolute; left:32.53mm; top:2.13mm; width:15.5mm; height:15.5mm; }
  .qr img { width:100%; height:100%; display:block; }
  
.logoImg {
  position:absolute;
  left:32.3mm;
  top:17.5mm;
  width:16.5mm;
  height:auto;
  display:block;

    /* para evitar la “rayita blanca” por reescalado */
  image-rendering: -webkit-optimize-contrast;
  image-rendering: crisp-edges;
}

  @media print { .print-actions { display:none; } }
</style></head>
<body>
  <div class="print-actions"><button onclick="window.print()">Imprimir</button></div>
  ${pages}
  <script>
    (function(){
      document.querySelectorAll('.qr').forEach(function(el){
        var value = el.dataset.qr || '';
        var img = document.createElement('img');
        img.alt = 'QR';
        img.src = 'https://api.qrserver.com/v1/create-qr-code/?size=220x220&data=' + encodeURIComponent(value);
        el.appendChild(img);
      });
    })();
    setTimeout(function(){ window.print(); }, 300);
  <\/script>
</body></html>`;
      };

      const openPrintLabels = (scope = "page") => {
        const rows = getRowsForScope(scope);
        if (!rows.length) {
          setPrendasAlert("No hay filas para imprimir en el alcance seleccionado.");
          return;
        }
        
        const logoSrc = "";
                // Nota: el layout objetivo usa el logo como texto (harujagdl) debajo del QR,
                // así que no intentamos renderizar ^GFA aquí para evitar errores por compresión.
                const labels = rows.map((row) => {
          const codigo = safeString(row.codigo || row.code).trim().toUpperCase();
          const precioNum = getLabelPriceNumber(row);
          return {
            codigo,
            precioTexto: formatLabelPrice(precioNum),
            qrValue: codigo,
            logoSrc
          };
        });
        const printWindow = window.open("", "_blank");
        if (!printWindow) {
          setPrendasAlert("No se pudo abrir la ventana de impresión. Revisa bloqueador de popups.");
          return;
        }
        printWindow.document.write(getPrintHtml(labels));
        printWindow.document.close();
        printWindow.focus();
      };

      const computeMarginUtility = (pVenta, costo) => {
        const p = toNumberOrNull(pVenta) ?? 0;
        const c = toNumberOrNull(costo) ?? 0;
        const utilidad = Number((p - c).toFixed(2));
        const margenPct = p > 0 ? Number(((utilidad / p) * 100).toFixed(1)) : 0;
        return { utilidad, margenPct };
      };

      const buildSearchKey = (data) => {
        const codigo = safeString(data.codigo || data.code || data.Codigo || data.Code);
        const descripcion = safeString(data.descripcion || data.Descripcion || data.detalles);
        return normalizeText(`${codigo} ${descripcion}`.trim());
      };

      const pickFirstValue = (...values) => {
        for (const value of values) {
          if (value !== undefined && value !== null && value !== "") {
            return value;
          }
        }
        return null;
      };

      const normalizeDoc = (docSnap) => {
        const data = docSnap.data() || {};
        const codigo = safeString(
          data.codigo ??
            data.Codigo ??
            data.CODIGO ??
            data.SKU ??
            data.code ??
            data.Code ??
            docSnap.id
        ).trim();
        const descripcion = safeString(
          data.descripcion ??
            data.Descripcion ??
            data.detalles ??
            data.Detalles ??
            ""
        ).trim();
        const proveedor = safeString(data.proveedor || data.Proveedor || "").trim();
        const tipo = safeString(data.tipo || data.Tipo || "").trim();
        const color = safeString(data.color || data.Color || "").trim();
        const talla = safeString(data.talla || data.Talla || "").trim();
        const statusRaw = safeString(data.statusCanon ?? data.status ?? data.Status ?? "").trim();
        const statusCanon = normalizeStatus(statusRaw);
        const precioRaw = pickFirstValue(
          data.precio,
          data.Precio,
          data.price,
          data.precioFinal,
          data.precio_final
        );
        const precio = toNumberOrNull(precioRaw);
        const precioConIva = toNumberOrNull(
          pickFirstValue(data.precioConIva, data.precioConIVA)
        );
        const iva = toNumberOrNull(data.iva ?? data.IVA);
        const pVenta = toNumberOrNull(data.pVenta ?? data.precioConIva ?? data.precio);
        const costo = toNumberOrNull(data.costo);
        const precioConIvaFinal = Number.isFinite(precioConIva)
          ? precioConIva
          : (Number.isFinite(pVenta) ? pVenta : null);

        const { utilidad: utilidadCalculada, margenPct: margenCalculado } =
          computeMarginUtility(precioConIvaFinal, costo);

        let utilidad = Number(data.utilidad ?? data.Utilidad ?? 0);
        if ((!utilidad || utilidad === 0) && costo > 0 && precioConIvaFinal > 0) {
          utilidad = Math.round((precioConIvaFinal - costo) * 100) / 100;
        }

        let margen = Number(data.margen ?? data.Margen ?? 0);
        if ((!margen || margen === 0) && precioConIvaFinal > 0) {
          margen = Math.round(((utilidad / precioConIvaFinal) * 100) * 10) / 10;
        }
        const createdAt = data.createdAt ?? data.CreatedAt ?? null;
        const fechaAlta = data.fechaAlta ?? data.FechaAlta ?? null;
        const fecha = data.fecha ?? data.Fecha ?? null;
        const orden = toNumberOrNull(data.orden ?? data.Orden);
        const seqNumber = toNumberOrNull(data.seqNumber ?? data.seq ?? data.secuencia);
        const fechaAltaTexto = safeString(
          data.fechaAltaTexto ?? data.FechaAltaTexto ?? data.fechaTexto ?? data.FechaTexto ?? ""
        ).trim();
        const fechaTexto = safeString(data.fechaTexto ?? data.FechaTexto ?? "").trim();
        const descripcionLower = descripcion.toLowerCase();
        const codigoUpper = codigo.toUpperCase();
        const _searchKey = `${codigo} ${descripcion}`.toLowerCase().trim();

        return {
          id: docSnap.id,
          docId: safeString(data.docId ?? docSnap.id),
          orden: Number.isFinite(orden) ? orden : seqNumber,
          seqNumber,
          codigo,
          descripcion,
          color,
          talla,
          proveedor,
          tipo,
          status: statusCanon,
          statusCanon,
          disponibilidad: normalizeDisponibilidad(
            safeString((data.disponibilidadCanon ?? data.disponibilidad ?? data.Disponibilidad ?? "")).trim(),
            statusCanon
          ),
          disponibilidadCanon: normalizeDisponibilidad(
            safeString((data.disponibilidadCanon ?? data.disponibilidad ?? data.Disponibilidad ?? "")).trim(),
            statusCanon
          ),
          precio,
          pVenta,
          precioConIva: precioConIvaFinal,
          iva,
          costo,
          margen: Number.isFinite(margen) ? margen : margenCalculado,
          utilidad: Number.isFinite(utilidad) ? utilidad : utilidadCalculada,
          createdAt,
          fechaAlta,
          fecha,
          fechaAltaTexto,
          fechaTexto,
          descripcionLower,
          codigoUpper,
          _searchKey
        };
      };

      const getSearchInput = () => safeString(prendasSearch.value);
      const getSearchTerm = () => normalizeText(prendasSearch.value);
      const getSearchRaw = () => safeString(prendasSearch.value).trim();
      const normalizeSelectValue = (value) => (isAllFilter(value) ? null : value);
      const getDateRangeFromFilters = (yearValue, monthValue) => {
        const year = Number(yearValue);
        if (!Number.isInteger(year) || year < 1900) {
          return null;
        }

        const month = Number(monthValue);
        if (Number.isInteger(month) && month >= 1 && month <= 12) {
          return {
            start: new Date(year, month - 1, 1, 0, 0, 0, 0),
            end: new Date(year, month, 1, 0, 0, 0, 0),
            granularity: "month"
          };
        }

        return {
          start: new Date(year, 0, 1, 0, 0, 0, 0),
          end: new Date(year + 1, 0, 1, 0, 0, 0, 0),
          granularity: "year"
        };
      };

      const populateYearFilter = () => {
        if (!prendasYear) return;
        const current = prendasYear.value;
        const thisYear = new Date().getFullYear();
        const years = [];
        for (let year = thisYear; year >= PRENDAS_YEAR_MIN; year -= 1) {
          years.push(year);
        }
        prendasYear.innerHTML = '<option value="">Todos</option>';
        years.forEach((year) => {
          const option = document.createElement("option");
          option.value = String(year);
          option.textContent = String(year);
          prendasYear.appendChild(option);
        });
        prendasYear.value = years.includes(Number(current)) ? current : "";
      };

      const populateMonthFilter = () => {
        if (!prendasMonth) return;
        const current = prendasMonth.value;
        prendasMonth.innerHTML = '<option value="">Todos</option>';
        MONTH_OPTIONS.forEach(({ value, label }) => {
          const option = document.createElement("option");
          option.value = String(value);
          option.textContent = `${String(value).padStart(2, "0")} - ${label}`;
          prendasMonth.appendChild(option);
        });
        prendasMonth.value = MONTH_OPTIONS.some(({ value }) => String(value) === current)
          ? current
          : "";
      };

      const syncDateFilterUi = () => {
        if (!prendasYear || !prendasMonth) return;
        const hasYear = Boolean(safeString(prendasYear.value).trim());
        prendasMonth.disabled = !hasYear;
        if (!hasYear) {
          prendasMonth.value = "";
        }
      };

      const clearFiltersUi = () => {
        prendasSearch.value = "";
        if (prendasYear) prendasYear.value = "";
        if (prendasMonth) prendasMonth.value = "";
        prendasPrecioMin.value = "";
        prendasPrecioMax.value = "";
        if (prendasPrecioSin) prendasPrecioSin.checked = true;
        syncDateFilterUi();
      };

      const clearHeaderFilters = () => {
        prendasState.filters.header = createEmptyHeaderFilters();
        updateHeaderFilterButtonsState();
      };

      const looksLikeCodeSearch = (value) => {
        const raw = safeString(value).trim().toUpperCase();
        if (!raw) return false;
        return raw.startsWith("HA") || raw.includes("/") || raw.includes("-");
      };

      const getCurrentGlobalFilters = () => ({
        searchText: getSearchRaw(),
        year: safeString(prendasYear?.value).trim(),
        month: safeString(prendasMonth?.value).trim(),
        priceMin: toNumberOrNull(prendasPrecioMin.value),
        priceMax: toNumberOrNull(prendasPrecioMax.value),
        includeNoPrice: prendasPrecioSin?.checked ?? true
      });

      const getCurrentFilters = () => ({
        global: getCurrentGlobalFilters(),
        header: prendasState.filters.header
      });

      const isHeaderFilterActive = (key) => {
        if (key === "pventa") {
          return (
            prendasState.filters.header.pventaMin !== null ||
            prendasState.filters.header.pventaMax !== null
          );
        }
        if (key === "orden") {
          return (prendasState.sort?.dir || DEFAULT_PRENDAS_SORT.dir) !== DEFAULT_PRENDAS_SORT.dir;
        }
        if (key === "fecha") {
          return Boolean(prendasState.filters.header.fechaYear || prendasState.filters.header.fechaMonth);
        }
        return (prendasState.filters.header[key]?.size || 0) > 0;
      };

      const applyGlobalFilters = (rows, globalFilters) => {
        const searchText = normalizeText(globalFilters.searchText);
        const dateRange = getDateRangeFromFilters(globalFilters.year, globalFilters.month);
        return rows.filter((item) => {
          const precio = toNum(item.pVenta);
          if (globalFilters.priceMin != null || globalFilters.priceMax != null) {
            if (!Number.isFinite(precio)) return false;
            if (globalFilters.priceMin != null && precio < globalFilters.priceMin) return false;
            if (globalFilters.priceMax != null && precio > globalFilters.priceMax) return false;
          }
          if (dateRange?.start && dateRange?.end && !isInDateRange(item, dateRange)) {
            return false;
          }
          if (!searchText) return true;
          const codigo = normalizeFilterValue(item.codigo);
          const descripcion = normalizeFilterValue(item.descripcion);
          if (looksLikeCodeSearch(searchText)) {
            return codigo.toUpperCase().startsWith(searchText.toUpperCase());
          }
          return descripcion.includes(searchText);
        });
      };

      const applyHeaderFilters = (rows, headerFilters) =>
        rows.filter((item) => {
          const hasChecklistMatch = HEADER_FILTER_KEYS.every((key) => {
            const selected = headerFilters[key];
            if (!selected || !selected.size) return true;
            const itemValue = normalizeFilterValue(item[key]);
            return selected.has(itemValue);
          });
          if (!hasChecklistMatch) return false;

          // Fecha (año/mes)
          const hasFechaFilter = Boolean(headerFilters.fechaYear || headerFilters.fechaMonth);
          if (hasFechaFilter) {
            const d = resolveComparableDate(item);
            if (!d) return false;
            const year = String(d.getFullYear());
            const month = String(d.getMonth() + 1).padStart(2, "0");
            if (headerFilters.fechaYear && year !== String(headerFilters.fechaYear)) return false;
            if (headerFilters.fechaMonth && month !== String(headerFilters.fechaMonth)) return false;
          }

          // P. Venta (rango)
          const hasPriceRange = headerFilters.pventaMin != null || headerFilters.pventaMax != null;
          if (hasPriceRange) {
            const price = toNum(item.pVenta);
            if (price === null) return false;
            if (headerFilters.pventaMin != null && price < headerFilters.pventaMin) return false;
            if (headerFilters.pventaMax != null && price > headerFilters.pventaMax) return false;
          }

          return true;
        });

      const normalizeSortConfig = (sort) => {
        const rawKey = normalizeText(sort?.key || DEFAULT_PRENDAS_SORT.key);
        const key = rawKey === "fecha" ? "fecha" : "orden";
        const dir = normalizeText(sort?.dir) === "desc" ? "desc" : "asc";
        return { key, dir };
      };

      const updateOrdenSortToggleUi = () => {
        if (!ordenSortBtn || !ordenSortIcon) return;
        const sort = normalizeSortConfig(prendasState.sort);
        ordenSortIcon.textContent = sort.dir === "desc" ? "↓" : "↑";
        ordenSortBtn.setAttribute("aria-label", `Ordenar por Orden (${sort.dir === "desc" ? "descendente" : "ascendente"})`);
      };

      const persistSort = (sort) => {
        try {
          localStorage.setItem(PRENDAS_SORT_KEY_STORAGE, sort.key);
          localStorage.setItem(PRENDAS_SORT_DIR_STORAGE, sort.dir);
        } catch (_) {}
      };

      const restorePersistedSort = () => {
        try {
          const key = localStorage.getItem(PRENDAS_SORT_KEY_STORAGE);
          const dir = localStorage.getItem(PRENDAS_SORT_DIR_STORAGE);
          return normalizeSortConfig({ key, dir });
        } catch (_) {
          return { ...DEFAULT_PRENDAS_SORT };
        }
      };

      const setPrendasSort = async (nextSort, { refresh = true } = {}) => {
        prendasState.sort = normalizeSortConfig(nextSort);
        prendasState.pageIndex = 0;
        persistSort(prendasState.sort);
        updateOrdenSortToggleUi();
        updateHeaderFilterButtonsState();
        if (refresh && !isBooting) {
          await loadPrendasPage({ reset: true, reason: "sort-change" });
        }
      };

      const resolveRowOrderValue = (row, index) => {
        const candidates = [row?.orden, row?._index, row?.__i, row?._rowNumber, row?.__order];
        for (const value of candidates) {
          const parsed = toNumberOrNull(value);
          if (Number.isFinite(parsed)) return parsed;
        }
        return index + 1;
      };

      const sortRows = (rows = [], sort = prendasState.sort) => {
        const activeSort = normalizeSortConfig(sort);
        const direction = activeSort.dir === "desc" ? -1 : 1;
        const indexedRows = rows.map((row, index) => ({ row, index }));
        return indexedRows.sort((a, b) => {
          if (activeSort.key === "orden") {
            const orderA = resolveRowOrderValue(a.row, a.index);
            const orderB = resolveRowOrderValue(b.row, b.index);
            if (orderA !== orderB) {
              return (orderA - orderB) * direction;
            }
            return safeString(a.row?.codigo).localeCompare(safeString(b.row?.codigo), "es", { numeric: true, sensitivity: "base" }) * direction;
          }

          if (activeSort.key === "fecha") {
            const timeA = resolveComparableDate(a.row)?.getTime() ?? 0;
            const timeB = resolveComparableDate(b.row)?.getTime() ?? 0;
            if (timeA !== timeB) {
              return (timeA - timeB) * direction;
            }
            return safeString(a.row?.codigo).localeCompare(safeString(b.row?.codigo), "es", { numeric: true, sensitivity: "base" }) * direction;
          }

          return safeString(a.row?.[activeSort.key]).localeCompare(safeString(b.row?.[activeSort.key]), "es", {
            numeric: true,
            sensitivity: "base"
          }) * direction;
        }).map(({ row }) => row);
      };

      const applyAllFilters = (rows) => {
        const globalFilters = getCurrentGlobalFilters();
        prendasState.filters.global = globalFilters;
        const hasPrice = (row) => {
          const p = row?.pVenta;
          if (p === null || p === undefined) return false;
          const n = Number(p);
          return Number.isFinite(n) && n > 0;
        };
        let rowsAfterNoPrice = rows;
        if (!globalFilters.includeNoPrice) {
          rowsAfterNoPrice = rows.filter(hasPrice);
        }
        console.log(
          "[Prendas] incluirSinPrecio:",
          globalFilters.includeNoPrice,
          "rows:",
          rowsAfterNoPrice.length
        );
        const rowsAfterGlobal = applyGlobalFilters(rowsAfterNoPrice, globalFilters);
        prendasState.rowsAfterGlobal = rowsAfterGlobal;
        let rowsAfterAll = applyHeaderFilters(rowsAfterGlobal, prendasState.filters.header);
        rowsAfterAll = sortRows(rowsAfterAll, prendasState.sort);
        prendasState.rowsAfterAll = rowsAfterAll;
        return rowsAfterAll;
      };

      const hasActiveFilters = (filters) => {
        if (!filters) return false;
        const globalFilters = filters.global || {};
        const headerFilters = filters.header || {};
        const hasSearch = Boolean(safeString(globalFilters.searchText).trim());
        const hasDate = Boolean(globalFilters.year);
        const hasPriceRange = globalFilters.priceMin !== null || globalFilters.priceMax !== null;
        const excludeNoPrice = globalFilters.includeNoPrice === false;
        const hasHeaderFilters = HEADER_FILTER_KEYS.some((key) => (headerFilters[key]?.size || 0) > 0);
        const hasHeaderPrice = headerFilters.pventaMin !== null || headerFilters.pventaMax !== null;
        return hasSearch || hasDate || hasPriceRange || excludeNoPrice || hasHeaderFilters || hasHeaderPrice;
      };

      const getUniqueOptions = (rows, key) => {
        const set = new Set();
        rows.forEach((row) => {
          const value = safeString(row[key]).trim();
          if (value) set.add(value);
        });
        return [...set].sort((a, b) => a.localeCompare(b, "es", { sensitivity: "base" }));
      };

      const handleIndexError = (error) => {
        const message = error?.message || "";
        const isIndexError =
          error?.code === "failed-precondition" ||
          /requires an index/i.test(message) ||
          /indexes/i.test(message);
        if (!isIndexError) {
          return false;
        }
        console.warn("[Prendas] Index error", error);
        return true;
      };

      const updateHeaderFilterButtonsState = () => {
        headerFilterButtons.forEach((button) => {
          const key = button.dataset.openHeaderFilter;
          button.classList.toggle("active", isHeaderFilterActive(key));
        });
        updateOrdenSortToggleUi();
      };

      const closeHeaderPopover = () => {
        if (prendasState.headerPopover?.cleanup) {
          prendasState.headerPopover.cleanup();
        }
        if (prendasState.headerPopover?.container) {
          prendasState.headerPopover.container.remove();
        }
        prendasState.headerPopover = null;
      };

      const clamp = (value, min, max) => Math.min(Math.max(value, min), max);
      const isMobileViewport = () => window.matchMedia("(max-width: 768px)").matches;

      const positionHeaderPopover = () => {
        if (!prendasState.headerPopover?.container || !prendasState.headerPopover?.anchorButton) {
          return;
        }
        if (prendasState.headerPopover?.isMobileSheet) {
          return;
        }
        const { container, anchorButton } = prendasState.headerPopover;
        const anchorRect = anchorButton.getBoundingClientRect();
        const popoverRect = container.getBoundingClientRect();

        let left = anchorRect.right - popoverRect.width;
        let top = anchorRect.bottom + HEADER_POPOVER_OFFSET;

        const maxLeft = window.innerWidth - popoverRect.width - HEADER_POPOVER_MARGIN;
        const maxTop = window.innerHeight - popoverRect.height - HEADER_POPOVER_MARGIN;

        if (top + popoverRect.height > window.innerHeight - HEADER_POPOVER_MARGIN) {
          top = anchorRect.top - popoverRect.height - HEADER_POPOVER_OFFSET;
        }

        left = clamp(left, HEADER_POPOVER_MARGIN, maxLeft);
        top = clamp(top, HEADER_POPOVER_MARGIN, maxTop);

        container.style.left = `${left}px`;
        container.style.top = `${top}px`;
      };

      const bindHeaderPopoverPositioning = (container, anchorButton, key) => {
        const mobileSheet = isMobileViewport();
        if (mobileSheet) {
          container.classList.add("mobile-sheet");
        }
        const handleResize = () => positionHeaderPopover();
        const handleScroll = () => positionHeaderPopover();

        window.addEventListener("resize", handleResize);
        window.addEventListener("scroll", handleScroll, true);

        prendasState.headerPopover = {
          key,
          container,
          anchorButton,
          isMobileSheet: mobileSheet,
          cleanup: () => {
            window.removeEventListener("resize", handleResize);
            window.removeEventListener("scroll", handleScroll, true);
          }
        };

        requestAnimationFrame(positionHeaderPopover);
      };

      const renderHeaderFilterPopover = (key, anchorButton) => {
        closeHeaderPopover();
        const container = document.createElement("div");
        container.className = "filter-popover";

        if (key === HEADER_RANGE_KEY) {
          container.classList.add("range-popover");
          const currentMin = prendasState.filters.header.pventaMin;
          const currentMax = prendasState.filters.header.pventaMax;
          container.innerHTML = `
            <div class="popover-head"><p class="popover-title">Filtrar P. Venta</p></div>
            <div class="range-fields">
              <div class="range-field">
                <label for="range-min">Mínimo</label>
                <input id="range-min" type="number" min="0" step="0.01" placeholder="0.00" value="${currentMin ?? ""}" data-range-min />
              </div>
              <div class="range-field">
                <label for="range-max">Máximo</label>
                <input id="range-max" type="number" min="0" step="0.01" placeholder="0.00" value="${currentMax ?? ""}" data-range-max />
              </div>
            </div>
            <div class="hint" data-range-hint></div>
            <div class="actions">
              <button type="button" data-apply>Aplicar</button>
              <button type="button" class="secondary" data-clear>Limpiar</button>
            </div>
          `;
          document.body.appendChild(container);
          const minInput = container.querySelector("[data-range-min]");
          const maxInput = container.querySelector("[data-range-max]");
          const hintEl = container.querySelector("[data-range-hint]");

          container.querySelector("[data-clear]").addEventListener("click", async () => {
            prendasState.filters.header.pventaMin = null;
            prendasState.filters.header.pventaMax = null;
            closeHeaderPopover();
            await applyFilters();
          });

          container.querySelector("[data-apply]").addEventListener("click", async () => {
            let minValue = toNumberOrNull(minInput.value);
            let maxValue = toNumberOrNull(maxInput.value);
            if (minValue !== null && maxValue !== null && minValue > maxValue) {
              [minValue, maxValue] = [maxValue, minValue];
              hintEl.textContent = "Se ajustó el rango automáticamente (mín ↔ máx).";
            }
            prendasState.filters.header.pventaMin = minValue;
            prendasState.filters.header.pventaMax = maxValue;
            closeHeaderPopover();
            await applyFilters();
          });

          bindHeaderPopoverPositioning(container, anchorButton, key);
          return;

        }

        if (key === "fecha") {
          const monthNames = [
            "enero","febrero","marzo","abril","mayo","junio",
            "julio","agosto","septiembre","octubre","noviembre","diciembre"
          ];
          const availableYears = Array.from(new Set((prendasState.baseRows || [])
            .map((it) => resolveComparableDate(it))
            .filter(Boolean)
            .map((d) => d.getFullYear())))
            .sort((a,b) => b - a);

          const currentYear = safeString(prendasState.filters.header.fechaYear).trim();
          const currentMonth = safeString(prendasState.filters.header.fechaMonth).trim();

          const yearOptions = ['<option value="">Todos</option>']
            .concat(availableYears.map((y) => `<option value="${y}" ${String(y)===currentYear ? "selected" : ""}>${y}</option>`))
            .join("");

          const monthOptions = ['<option value="">Todos</option>']
            .concat(monthNames.map((name, i) => {
              const v = String(i + 1).padStart(2, "0");
              return `<option value="${v}" ${v===currentMonth ? "selected" : ""}>${name}</option>`;
            }))
            .join("");

          container.innerHTML = `
            <div class="popover-head"><p class="popover-title">Filtrar Fecha</p></div>
            <div class="range-fields">
              <div class="range-field">
                <label for="fecha-year">Año</label>
                <select id="fecha-year" data-fecha-year>${yearOptions}</select>
              </div>
              <div class="range-field">
                <label for="fecha-month">Mes</label>
                <select id="fecha-month" data-fecha-month>${monthOptions}</select>
              </div>
            </div>
            <div class="actions">
              <button type="button" data-apply>Aplicar</button>
              <button type="button" class="secondary" data-clear>Limpiar</button>
            </div>
          `;
          document.body.appendChild(container);

          const yearSelect = container.querySelector("[data-fecha-year]");
          const monthSelect = container.querySelector("[data-fecha-month]");

          container.querySelector("[data-clear]").addEventListener("click", async () => {
            prendasState.filters.header.fechaYear = "";
            prendasState.filters.header.fechaMonth = "";
            closeHeaderPopover();
            await applyFilters();
          });

          container.querySelector("[data-apply]").addEventListener("click", async () => {
            prendasState.filters.header.fechaYear = safeString(yearSelect.value).trim();
            prendasState.filters.header.fechaMonth = safeString(monthSelect.value).trim();
            closeHeaderPopover();
            await applyFilters();
          });

          bindHeaderPopoverPositioning(container, anchorButton, key);
          return;
        }

        const options = prendasState.uniqueOptions[key] || [];
        const selected = new Set(prendasState.filters.header[key] || []);
        container.innerHTML = `
          <div class="popover-head"><p class="popover-title">Filtrar ${key}</p></div>
          <div class="search-wrap"><input type="text" placeholder="Buscar..." data-filter-search /></div>
          <div class="meta" data-filter-count></div>
          <label class="option-all"><input type="checkbox" data-select-all /> Seleccionar todo</label>
          <div class="options" data-options></div>
          <div class="actions">
            <button type="button" data-apply>Aplicar</button>
            <button type="button" class="secondary" data-clear>Limpiar</button>
          </div>
        `;
        document.body.appendChild(container);

        const optionsEl = container.querySelector("[data-options]");
        const searchEl = container.querySelector("[data-filter-search]");
        const selectAllEl = container.querySelector("[data-select-all]");
        const countEl = container.querySelector("[data-filter-count]");

        const updateCounters = () => {
          const total = options.length;
          const selectedCount = selected.size;
          countEl.textContent = `(${selectedCount} seleccionados / ${total} total)`;
          selectAllEl.checked = total > 0 && selectedCount === total;
        };

        const refreshList = () => {
          const q = normalizeText(searchEl.value);
          const visible = options.filter((value) => normalizeText(value).includes(q));
          optionsEl.textContent = "";
          visible.forEach((value) => {
            const row = document.createElement("label");
            row.className = "option-row";
            const checked = selected.has(normalizeFilterValue(value));
            row.innerHTML = `<input type="checkbox" value="${value}" ${checked ? "checked" : ""} /> ${value}`;
            const checkbox = row.querySelector("input");
            checkbox.addEventListener("change", () => {
              const normalized = normalizeFilterValue(value);
              if (checkbox.checked) selected.add(normalized);
              else selected.delete(normalized);
              updateCounters();
            });
            optionsEl.appendChild(row);
          });
          updateCounters();
        };

        selectAllEl.addEventListener("change", () => {
          if (selectAllEl.checked) {
            options.forEach((value) => selected.add(normalizeFilterValue(value)));
          } else {
            selected.clear();
          }
          refreshList();
        });

        searchEl.addEventListener("input", refreshList);

        container.querySelector("[data-clear]").addEventListener("click", async () => {
          prendasState.filters.header[key] = new Set();
          closeHeaderPopover();
          await applyFilters();
        });

        container.querySelector("[data-apply]").addEventListener("click", async () => {
          prendasState.filters.header[key] = selected;
          closeHeaderPopover();
          await applyFilters();
        });

        bindHeaderPopoverPositioning(container, anchorButton, key);
        refreshList();
      };

      const chunkArray = (items, size) => {
        const chunks = [];
        for (let i = 0; i < items.length; i += size) {
          chunks.push(items.slice(i, i + size));
        }
        return chunks;
      };

      const loadAdminCostMap = async (rows = []) => {
        const map = new Map();
        const rowDocIds = rows
          .map((row) => safeString(row.docId || row.id).trim())
          .filter(Boolean);

        if (!rowDocIds.length) {
          return map;
        }

        const ids = [...new Set(rowDocIds)];
        const chunks = chunkArray(ids, 30);

        for (const chunk of chunks) {
          const snap = await getDocs(
            query(collection(db, PRENDAS_ADMIN_COLLECTION), where(documentId(), "in", chunk))
          );
          snap.docs.forEach((docSnap) => {
            const data = docSnap.data() || {};
            const lookupId = safeString(docSnap.id).trim();
            if (!lookupId) return;
            map.set(lookupId, {
              costo: toNumberOrNull(data.costo),
              pVentaOverride: toNumberOrNull(data.pVentaOverride ?? data.pVenta),
              margen: toNumberOrNull(data.margen),
              utilidad: toNumberOrNull(data.utilidad),
            });
          });
        }

        prendasState.adminMap = map;
        return map;
      };

      const mergeAdminFields = async (rows = []) => {
        if (!(isAdminViewEnabled() && rows.length)) {
          prendasState.adminMap.clear();
          return rows;
        }

        const adminCostMap = await loadAdminCostMap(rows);
        rows.forEach((row) => {
          const lookupId = safeString(row.docId || row.id).trim();
          const adminExtra = adminCostMap.get(lookupId);
          if (!adminExtra) return;

          const costo = toNumberOrNull(adminExtra.costo);
          const utilidadFromAdmin = toNumberOrNull(adminExtra.utilidad);
          const margenFromAdmin = toNumberOrNull(adminExtra.margen);
          const pVentaOverride = toNumberOrNull(adminExtra.pVentaOverride);

          row.costo = Number.isFinite(costo) ? costo : null;
          row.pVentaOverride = Number.isFinite(pVentaOverride) ? pVentaOverride : null;
          const precioVisible = Number.isFinite(row.pVentaOverride)
            ? row.pVentaOverride
            : (Number.isFinite(row.pVenta) ? row.pVenta : null);
          row.pVentaDisplay = precioVisible;
          const { utilidad: utilidadCalculada, margenPct: margenCalculado } =
            computeMarginUtility(precioVisible, row.costo);

          row.utilidad = (Number.isFinite(utilidadFromAdmin) && utilidadFromAdmin !== 0)
            ? utilidadFromAdmin
            : utilidadCalculada;
          row.margen = (Number.isFinite(margenFromAdmin) && margenFromAdmin !== 0)
            ? Number(margenFromAdmin.toFixed(1))
            : margenCalculado;
        });

        return rows;
      };

      const loadBaseRows = async () => {
        const cacheKey = "public";
        if (prendasState.baseRows.length && prendasState.baseRowsCacheKey === cacheKey) {
          return prendasState.baseRows;
        }
        let cursor = null;
        let hasMore = true;
        const rows = [];
        while (hasMore) {
          const constraints = [orderBy("orden", "asc"), limit(PRENDAS_COUNT_BATCH_SIZE)];
          if (cursor) constraints.splice(1, 0, startAfter(cursor));
          const snap = await getDocs(query(prendasPublicRef, ...constraints));
          console.log("[Prendas] snapshot size:", snap.size);
          if (snap.empty) {
            hasMore = false;
            break;
          }
          snap.docs.forEach((docSnap) => rows.push(normalizeDoc(docSnap)));
          cursor = snap.docs[snap.docs.length - 1];
          if (snap.docs.length < PRENDAS_COUNT_BATCH_SIZE) {
            hasMore = false;
          }
        }

        if (!rows.length) {
          try {
            const fallbackProbe = await getDocs(query(collection(db, PRENDAS_MASTER_COLLECTION), limit(1)));
            if (!fallbackProbe.empty) {
              setPrendasAlert("Colección public vacía: cargando respaldo temporal desde master.", "warning");
              console.warn("[Prendas] fallback temporal activado desde master.");
              cursor = null;
              hasMore = true;

              while (hasMore) {
                const fallbackConstraints = [orderBy("orden", "asc"), limit(PRENDAS_COUNT_BATCH_SIZE)];
                if (cursor) fallbackConstraints.splice(1, 0, startAfter(cursor));
                const fallbackSnap = await getDocs(
                  query(collection(db, PRENDAS_MASTER_COLLECTION), ...fallbackConstraints)
                );
                if (fallbackSnap.empty) {
                  hasMore = false;
                  break;
                }
                fallbackSnap.docs.forEach((docSnap) => {
                  const row = normalizeDoc(docSnap);
                  row.costo = null;
                  row.iva = null;
                  row.margen = null;
                  row.utilidad = null;
                  rows.push(row);
                });
                cursor = fallbackSnap.docs[fallbackSnap.docs.length - 1];
                if (fallbackSnap.docs.length < PRENDAS_COUNT_BATCH_SIZE) {
                  hasMore = false;
                }
              }
            }
          } catch (error) {
            console.warn("[Prendas] fallback a master no disponible", error);
          }
        }

        rows.forEach((row) => {
          row.costo = null;
          row.utilidad = null;
          row.margen = null;
        });

        const orderedRows = rows.sort(compareItemsByOrdenAsc);
        orderedRows.forEach((row, index) => {
          const generatedOrder = index + 1;
          row.__order = generatedOrder;
          row._rowNumber = generatedOrder;
          if (!Number.isFinite(toNumberOrNull(row.orden))) {
            row.orden = generatedOrder;
          }
        });

        prendasState.baseRows = orderedRows;
        prendasState.baseRowsCacheKey = cacheKey;
        return prendasState.baseRows;
      };

      const resetPrendasState = () => {
        prendasState.filtered = [];
        prendasState.baseRows = [];
        prendasState.baseRowsCacheKey = prendasState.isAdmin ? "admin" : "public";
        prendasState.rowsAfterGlobal = [];
        prendasState.rowsAfterAll = [];
        prendasState.isDone = false;
        prendasState.filtersActive = false;
        prendasState.showingTotal = null;
        prendasState.queryKey = "";
        prendasState.pageIndex = 0;
        prendasState.hasNextPage = false;
        prendasState.filters.global = getCurrentGlobalFilters();
        prendasState.filters.header = createEmptyHeaderFilters();
        prendasState.sort = restorePersistedSort();
        prendasState.uniqueOptions = {};
        prendasState.adminMap.clear();
        prendasState.selected.clear();
        closeHeaderPopover();
        resetCounters();
      };

      const renderLoadingPlaceholder = () => {
        if (!prendasTbody) return;
        prendasTbody.textContent = "";
        const row = document.createElement("tr");
        const cell = document.createElement("td");
        cell.colSpan = 17;
        cell.textContent = "Cargando base de datos...";
        row.appendChild(cell);
        prendasTbody.appendChild(row);
        setCounter(0, prendasState.showingTotal);
      };

      const refreshExactCounts = (rowsAfterAll) => {
        const total = rowsAfterAll.length;
        const nuevos = rowsAfterAll.filter((item) => isNew(getPrendaDate(item))).length;
        const existentes = total - nuevos;
        setApproxCounts({ total, nuevos, existentes, isApprox: false });
      };

      const getLoadingMessageByReason = (reason) => {
        if (["filters", "filters-clear", "search-clear"].includes(reason)) {
          return "Aplicando filtros...";
        }
        if (["pagination-prev", "pagination-next"].includes(reason)) {
          return "Cargando página...";
        }
        if (reason === "page-size") {
          return "Actualizando cantidad por página...";
        }
        return "Cargando base de datos...";
      };

      const loadPrendasPage = async ({
        pageIndex = null,
        reset = false,
        reason = "manual"
      } = {}) => {
        if (prendasState.isLoadingInitial) {
          return;
        }
        setSkuSearchMode(false);
        setPrendasAlert("");
        prendasState.isLoadingInitial = true;
        setLoading(true, getLoadingMessageByReason(reason));
        try {
          if (reset) {
            prendasState.pageIndex = 0;
            renderLoadingPlaceholder();
          }
          const baseRows = await loadBaseRows();
          console.log("[Prendas] baseRows:", baseRows.length);
          const rowsAfterAll = applyAllFilters(baseRows);
          HEADER_FILTER_KEYS.forEach((key) => {
            prendasState.uniqueOptions[key] = getUniqueOptions(prendasState.rowsAfterGlobal, key);
          });
          updateHeaderFilterButtonsState();
          const pageSize = getPageSize();
          const totalRows = rowsAfterAll.length;
          const totalPages = Math.max(1, Math.ceil(totalRows / pageSize));
          const requestedPageIndex = Number.isFinite(Number(pageIndex))
            ? Number(pageIndex)
            : prendasState.pageIndex;
          const safePageIndex = Math.min(Math.max(requestedPageIndex, 0), totalPages - 1);
          const start = safePageIndex * pageSize;
          const items = rowsAfterAll.slice(start, start + pageSize);

          prendasState.filtered = items;

          await mergeAdminFields(items);

          prendasState.pageIndex = safePageIndex;
          prendasState.hasNextPage = safePageIndex < totalPages - 1;
          prendasState.filtersActive = hasActiveFilters(getCurrentFilters());
          prendasState.showingTotal = totalRows;

          await renderDocs(items);
          refreshExactCounts(rowsAfterAll);

          if (prendasState.filtersActive && !items.length) {
            setPrendasAlert("No hay resultados con los filtros actuales.");
          }
        } catch (error) {
          console.error(error);
          setPrendasAlert("No se pudo cargar la base de datos de códigos.");
        } finally {
          prendasState.isLoadingInitial = false;
          setLoading(false);
          updatePaginationUi();
        }
      };

      const applyFilters = async () => {
        await loadPrendasPage({ reset: true, reason: "filters" });
      };


      const normalizeFilterValue = (value) => normalizeText(value);
      const toNum = (value) => {
        const parsed = Number(value);
        return Number.isFinite(parsed) ? parsed : null;
      };

      const getPageSize = () => {
        const selected = Number(prendasPageSize?.value);
        if (Number.isFinite(selected) && selected > 0) {
          return selected;
        }
        return PRENDAS_PAGE_SIZE_DEFAULT;
      };

      const renderRowsChunked = (
        rows,
        tbody,
        chunkSize = PRENDAS_RENDER_CHUNK,
        token
      ) =>
        new Promise((resolve) => {
          let index = 0;
          const appendChunk = () => {
            if (token && token !== prendasState.renderToken) {
              resolve(0);
              return;
            }
            const fragment = document.createDocumentFragment();
            for (let i = 0; i < chunkSize && index < rows.length; i += 1) {
              fragment.appendChild(createPrendaRow(rows[index]));
              index += 1;
            }
            tbody.appendChild(fragment);
            if (index < rows.length) {
              requestAnimationFrame(appendChunk);
              return;
            }
            resolve(0);
          };
          requestAnimationFrame(appendChunk);
        });

      const buildBadge = (text, className) => {
        const badge = document.createElement("span");
        badge.className = `badge ${className}`;
        badge.textContent = text;
        return badge;
      };

      const createPrendaRow = (item) => {
        const adminEnabled = isAdminViewEnabled();
        const ordenValue = Number(item.orden);
        const orden = Number.isFinite(ordenValue) ? String(ordenValue) : "";
        const codigo = safeString(item.codigo || item.code) || "--";
        const descripcion = safeString(item.descripcion) || "--";
        const tipo = safeString(item.tipo) || "--";
        const color = safeString(item.color) || "--";
        const talla = safeString(item.talla) || "--";
        const proveedor = safeString(item.proveedor) || "--";
        const statusCell = renderStatusCell(item.statusCanon || item.status);
        const disponibilidadCell = renderDisponibilidadCell(item.disponibilidadCanon || item.disponibilidad, item.statusCanon || item.status);
        const fecha = formatDateCell(item);
        const pVentaVisible = adminEnabled
          ? (toNumber(item.pVentaDisplay) ?? toNumber(item.pVenta))
          : toNumber(item.pVenta);
        const pVenta = moneyFmt(pVentaVisible);
        const costo = moneyFmt(item.costo);
        const margen = pctFmt(item.margen);
        const utilidad = moneyFmt(item.utilidad);

        const row = document.createElement("tr");
        const docId = safeString(item.docId || item.id).trim();
        row.dataset.docId = docId;
        row.className = isNew(getPrendaDate(item)) ? "row-new" : "row-old";

        const selectCell = document.createElement("td");
        selectCell.className = "col-select";
        const selectInput = document.createElement("input");
        selectInput.type = "checkbox";
        selectInput.className = "row-select";
        selectInput.dataset.docId = docId;
        selectInput.checked = prendasState.selected.has(docId);
        selectCell.appendChild(selectInput);
        row.appendChild(selectCell);

        const baseCells = [orden, codigo, descripcion, tipo, color, talla, proveedor, statusCell, disponibilidadCell, fecha, pVenta];
        const baseClasses = [
          "col-orden","col-codigo","col-descripcion","col-tipo","col-color","col-talla","col-proveedor","col-status","col-disponibilidad","col-fecha","col-pventa"
        ];
        baseCells.forEach((value, index) => {
          if (value instanceof HTMLElement) {
            value.classList.add(baseClasses[index] || "");
            row.appendChild(value);
            return;
          }
          const cell = document.createElement("td");
          cell.textContent = value;
          cell.classList.add(baseClasses[index] || "");
          if (index === 2) {
            cell.classList.add("cell-desc");
            cell.title = value;
          }
          row.appendChild(cell);
        });

        if (adminEnabled) {
          const adminValues = [costo, margen, utilidad];
          const adminClasses = ["col-costo", "col-margen", "col-utilidad"];
          adminValues.forEach((value, index) => {
            const cell = document.createElement("td");
            cell.textContent = value;
            cell.classList.add("admin-only", adminClasses[index]);
            row.appendChild(cell);
          });

          const actionCell = document.createElement("td");
          actionCell.className = "admin-only col-actions";
          const editButton = document.createElement("button");
          editButton.type = "button";
          editButton.className = "rowEditBtn";
          editButton.dataset.editDoc = safeString(item.docId || item.id).trim();
          editButton.setAttribute("aria-label", "Editar fila");
          editButton.textContent = "✎";
          actionCell.appendChild(editButton);
          row.appendChild(actionCell);
        }
        return row;
      };

      const updateEditPreview = () => {
        if (!editPVentaInput || !editCostoInput) return;
        const pOverride = toNumber(editPVentaInput.value);
        const pPublic = toNumber(prendasState.editing?.publicPVenta);
        const p = Number.isFinite(pOverride) ? pOverride : (pPublic ?? 0);
        const c = toNumber(editCostoInput.value) ?? 0;
        const { utilidad, margenPct } = computeMarginUtility(p, c);
        if (editUtilidadPreview) editUtilidadPreview.textContent = moneyFmt(utilidad);
        if (editMargenPreview) editMargenPreview.textContent = pctFmt(margenPct);
      };

      const closeEditModal = () => {
        prendasState.editing = null;
        if (editModal) {
          editModal.classList.add("hidden");
          editModal.setAttribute("aria-hidden", "true");
        }
        if (editModalError) {
          editModalError.textContent = "";
          editModalError.classList.add("hidden");
        }
      };

      const openEditModal = (rowData) => {
        if (!editModal || !rowData) return;
        const publicPVenta = toNumber(rowData.pVenta);
        const pVentaOverride = toNumber(rowData.pVentaOverride);
        prendasState.editing = {
          docId: safeString(rowData.docId || rowData.id).trim(),
          publicPVenta,
          rowDataSnapshot: { ...rowData }
        };
        if (editPVentaInput) editPVentaInput.value = Number.isFinite(pVentaOverride) ? pVentaOverride : "";
        if (editCostoInput) editCostoInput.value = toNumber(rowData.costo) ?? "";
        if (editModalError) {
          editModalError.textContent = "";
          editModalError.classList.add("hidden");
        }
        updateEditPreview();
        editModal.classList.remove("hidden");
        editModal.setAttribute("aria-hidden", "false");
      };

      const updateRowInMemory = (docId, updates) => {
        const applyTo = (rows = []) => {
          rows.forEach((row) => {
            const rowDocId = safeString(row.docId || row.id).trim();
            if (rowDocId !== docId) return;
            Object.assign(row, updates);
          });
        };
        applyTo(prendasState.baseRows);
        applyTo(prendasState.rowsAfterAll);
        applyTo(prendasState.rowsAfterGlobal);
        applyTo(prendasState.filtered);
      };

      const ensureAdminSession = async () => {
        let user = auth.currentUser;
        if (!user) {
          const response = await signInWithPopup(auth, googleProvider);
          user = response?.user || null;
        }
        const email = safeString(user?.email).trim().toLowerCase();
        if (!isAllowlistedAdmin(email)) {
          if (user) {
            await signOut(auth);
          }
          throw new Error("Usuario no autorizado para editar.");
        }
        return user;
      };

      const saveEdit = async () => {
        try {
          if (!ensureAdminMode()) return;
          if (!prendasState.editing?.docId) return;
          const docId = prendasState.editing.docId;
          const pVentaOverride = toNumber(editPVentaInput?.value);
          const costo = toNumber(editCostoInput?.value);
          if (Number.isFinite(pVentaOverride) && pVentaOverride < 0) {
            throw new Error("P.Venta debe ser mayor o igual a 0.");
          }
          if (Number.isFinite(costo) && costo < 0) {
            throw new Error("Costo debe ser mayor o igual a 0.");
          }
          editModalSaveButton.disabled = true;
          const user = await ensureAdminSession();
          const pVentaVisible = Number.isFinite(pVentaOverride)
            ? pVentaOverride
            : toNumber(prendasState.editing?.publicPVenta);
          const { utilidad, margenPct } = computeMarginUtility(pVentaVisible, costo);
          const adminRef = doc(db, PRENDAS_ADMIN_COLLECTION, docId);
          await setDoc(adminRef, {
            docId,
            costo: Number.isFinite(costo) ? costo : deleteField(),
            pVentaOverride: Number.isFinite(pVentaOverride) ? pVentaOverride : deleteField(),
            utilidad: (Number.isFinite(pVentaVisible) && Number.isFinite(costo)) ? utilidad : deleteField(),
            margen: (Number.isFinite(pVentaVisible) && Number.isFinite(costo)) ? margenPct : deleteField(),
            updatedAt: serverTimestamp(),
            updatedBy: safeString(user?.email).trim().toLowerCase()
          }, { merge: true });

          prendasState.adminMap.set(docId, {
            costo: Number.isFinite(costo) ? costo : null,
            pVentaOverride: Number.isFinite(pVentaOverride) ? pVentaOverride : null,
            utilidad: (Number.isFinite(pVentaVisible) && Number.isFinite(costo)) ? utilidad : null,
            margen: (Number.isFinite(pVentaVisible) && Number.isFinite(costo)) ? margenPct : null
          });

          const nextPVenta = Number.isFinite(pVentaOverride)
            ? pVentaOverride
            : toNumber(prendasState.editing?.publicPVenta);
          const hasMarginData = Number.isFinite(nextPVenta) && Number.isFinite(costo);
          updateRowInMemory(docId, {
            costo: Number.isFinite(costo) ? costo : null,
            pVentaOverride: Number.isFinite(pVentaOverride) ? pVentaOverride : null,
            pVentaDisplay: Number.isFinite(nextPVenta) ? nextPVenta : null,
            utilidad: hasMarginData ? utilidad : null,
            margen: hasMarginData ? Number(margenPct.toFixed(1)) : null
          });
          await loadPrendasPage({ reset: false, reason: "edit-save" });
          closeEditModal();
        } catch (error) {
          if (editModalError) {
            editModalError.textContent = error?.message || "No se pudo guardar.";
            editModalError.classList.remove("hidden");
          }
          console.error(error);
        } finally {
          if (editModalSaveButton) {
            editModalSaveButton.disabled = false;
          }
        }
      };

      const renderDocs = async (rows) => {
        prendasState.renderToken += 1;
        const token = prendasState.renderToken;
        const showingTotal = Number.isFinite(prendasState.showingTotal)
          ? prendasState.showingTotal
          : null;
        setCounter(rows.length, showingTotal);
        updatePaginationUi();

        prendasTbody.textContent = "";
        if (!rows.length) {
          let emptyNode = null;
          if (prendasEmptyRow) {
            emptyNode = prendasEmptyRow instanceof HTMLTemplateElement
              ? prendasEmptyRow.content.cloneNode(true)
              : prendasEmptyRow.cloneNode(true);
          }
          if (!emptyNode) {
            const emptyRow = document.createElement("tr");
            const cell = document.createElement("td");
            cell.colSpan = 17;
            cell.textContent = "No hay resultados con los filtros actuales.";
            emptyRow.appendChild(cell);
            emptyNode = emptyRow;
          }
          prendasTbody.appendChild(emptyNode);
          setCounter(0, showingTotal);
          updateSelectAllCheckbox();
          return;
        }
        await renderRowsChunked(rows, prendasTbody, PRENDAS_RENDER_CHUNK, token);
        updateSelectAllCheckbox();
      };

      const setSkuSearchMode = (enabled) => {
        prendasState.isSkuSearch = enabled;
        updatePaginationUi();
      };

      const fetchBySku = async (rawInput) => {
        const rawUpper = safeString(rawInput).trim().toUpperCase();
        const normalizedSku = normalizeSku(rawUpper);
        if (!rawUpper) return null;
        const directSnap = await getDoc(doc(db, activePrendasPublicCollection, normalizedSku));
        const altSnap = directSnap.exists()
          ? null
          : await getDoc(doc(db, activePrendasPublicCollection, rawUpper));
        const baseSnap = directSnap.exists() ? directSnap : altSnap;
        if (!baseSnap?.exists()) return null;
        const item = normalizeDoc(baseSnap);
        return item;
      };

      const runSkuSearch = async (rawInput) => {
        const rawUpper = safeString(rawInput).trim().toUpperCase();
        if (!rawUpper) return;
        setSkuSearchMode(true);
        setLoading(true, "Buscando código...");
        try {
          const result = await fetchBySku(rawUpper);
          const items = result ? [result] : [];
          await mergeAdminFields(items);
          prendasState.filtered = items;
          prendasState.showingTotal = items.length;
          prendasState.pageIndex = 0;
          prendasState.hasNextPage = false;
          await renderDocs(items);
          refreshExactCounts(items);
        } finally {
          setLoading(false);
        }
      };

      const ensureRequired = () => {
        if (!registroProveedor.value || !registroProducto.value || !registroColor.value || !registroTalla.value) {
          setRegistroStatus("Completa Proveedor, Producto, Color y Talla.", "error");
          return false;
        }
        return true;
      };

      const getSelectedName = (selectEl) => {
        const option = selectEl.options[selectEl.selectedIndex];
        return option?.dataset?.nombre || option?.textContent?.split(" - ")[1] || option?.textContent || "";
      };

      const HISTORICOS_URL = "../Data/codigos_historicos.json";
      let historicosCache = null;
      let registroPreview = null;

      const loadHistoricosMap = async () => {
        if (historicosCache) {
          return historicosCache;
        }
        historicosCache = fetch(HISTORICOS_URL)
          .then((response) => {
            if (!response.ok) {
              throw new Error("No se pudo cargar el histórico de códigos.");
            }
            return response.json();
          })
          .then((codes) => {
            const maxPorKey = {};
            const pattern = /^HA(\d+)([A-Z])(\d{3})\//i;
            codes.forEach((code) => {
              const match = pattern.exec(String(code).trim().toUpperCase());
              if (!match) return;
              const key = `prov${match[1]}_tipo${match[2]}`;
              const seq = Number(match[3]);
              if (!Number.isFinite(seq)) return;
              if (!maxPorKey[key] || seq > maxPorKey[key]) {
                maxPorKey[key] = seq;
              }
            });
            return maxPorKey;
          })
          .catch((error) => {
            console.warn("No se pudo cargar el histórico de códigos.", error);
            return {};
          });
        return historicosCache;
      };

      const buildModelKey = ({ providerCode, typeCode, detallesValue }) => {
        const detallesNorm = safeString(detallesValue).trim().toUpperCase().replace(/\s+/g, " ");
        return [providerCode, typeCode, detallesNorm || "SINDETALLE"].join("_");
      };

      const buildModelCode = ({ providerCode, typeCode, seqNumber, colorClave, tallaClave }) => {
        const consecutivo = String(seqNumber).padStart(3, "0");
        const baseCode = `HA${providerCode}${typeCode}${consecutivo}`;
        const variantKey = `${colorClave}_${tallaClave}`;
        const codigo = `${baseCode}/${colorClave}-${tallaClave}`;
        return { baseCode, variantKey, codigo };
      };

      const readModelCounter = async () => {
        const counterRef = doc(db, "counters", MODELOS_COUNTER_DOC);
        const snapshot = await getDoc(counterRef);
        const data = snapshot.data() || {};
        let counterValue = Number(data.value);
        if (!Number.isFinite(counterValue)) {
          counterValue = Number(data.lastNumber);
        }
        if (!Number.isFinite(counterValue)) {
          const maxPorKey = await loadHistoricosMap();
          counterValue = Object.values(maxPorKey).reduce((max, value) => {
            const num = Number(value);
            return Number.isFinite(num) && num > max ? num : max;
          }, 0);
        }
        if (!Number.isFinite(counterValue)) {
          throw new Error("Contador inválido para modelos. Revisa counters/modelos.");
        }
        return counterValue;
      };

      const buildRegistroPreview = async () => {
        if (!ensureRequired()) {
          return null;
        }
        const providerCode = registroProveedor.value;
        const typeCode = registroProducto.value;
        const colorClave = registroColor.value;
        const tallaClave = registroTalla.value;
        const createdByValue = document.getElementById("registro-created-by").value.trim();
        const detallesValue = registroDetalles.value.trim();
        const tipoNombre = getSelectedName(registroProducto).trim();
        const proveedorNombre = getSelectedName(registroProveedor).trim();
        const colorNombre = getSelectedName(registroColor).trim();
        const tallaNombre = getSelectedName(registroTalla).trim();
        const descripcion = [tipoNombre, proveedorNombre, colorNombre, tallaNombre]
          .filter(Boolean)
          .join(" ");

        const modelKey = buildModelKey({ providerCode, typeCode, detallesValue });
        const modelIndexRef = doc(db, MODELOS_INDEX_COLLECTION, safeDocId(modelKey));
        const modelIndexSnap = await getDoc(modelIndexRef);
        let seqNumber;
        if (modelIndexSnap.exists()) {
          const baseCodeFromIndex = safeString(modelIndexSnap.data()?.baseCode).trim().toUpperCase();
          const match = /^HA\d+[A-Z](\d{3,})$/i.exec(baseCodeFromIndex);
          seqNumber = match ? Number(match[1]) : NaN;
        }
        if (!Number.isFinite(seqNumber)) {
          const counterValue = await readModelCounter();
          seqNumber = counterValue + 1;
        }

        const { baseCode, variantKey, codigo } = buildModelCode({
          providerCode,
          typeCode,
          seqNumber,
          colorClave,
          tallaClave
        });

        return {
          providerCode,
          typeCode,
          colorClave,
          tallaClave,
          createdByValue,
          detallesValue,
          descripcion,
          modelKey,
          baseCode,
          variantKey,
          codigo,
          seqNumber
        };
      };

      const handleRegistroSubmit = async (event) => {
        event.preventDefault();
        setRegistroStatus("");

        try {
          registroSubmit.disabled = true;
          registroPreview = await buildRegistroPreview();
          if (!registroPreview) return;
          registroCodigo.textContent = registroPreview.codigo;
          registroResult.classList.remove("hidden");
          setRegistroStatus("Preview generado. Ahora puedes guardar la prenda en Modo admin.", "success");
        } catch (error) {
          const message =
            error?.message?.includes("contador") || error?.message?.includes("Contador")
              ? error.message
              : "No se pudo generar el código. Intenta nuevamente.";
          setRegistroStatus(message, "error");
          console.error(error);
        } finally {
          registroSubmit.disabled = false;
        }
      };

      const handleRegistroSave = async () => {
        try {
          if (!isAdminMode) {
            setRegistroStatus("Guardar requiere Modo admin. Usa 'Modo admin' para activarlo.", "warning");
            const wantsAdmin = window.confirm("Guardar requiere Modo admin. ¿Deseas activarlo ahora?");
            if (wantsAdmin) {
              await handleAdminToggle();
            }
            if (!isAdminMode) return;
          }
          const preview = registroPreview || await buildRegistroPreview();
          if (!preview) return;

          registroSave.disabled = true;
          registroSubmit.disabled = true;

          const user = await ensureAdminSession();
          const counterRef = doc(db, "counters", MODELOS_COUNTER_DOC);
          const modelIndexRef = doc(db, MODELOS_INDEX_COLLECTION, safeDocId(preview.modelKey));

          const transactionResult = await runTransaction(db, async (transaction) => {
            const indexSnap = await transaction.get(modelIndexRef);
            let baseCode = safeString(indexSnap.data()?.baseCode).trim().toUpperCase();
            let seqNumber = Number(indexSnap.data()?.seqNumber);
            let createdModel = false;

            if (baseCode && !Number.isFinite(seqNumber)) {
              const match = /^HA\d+[A-Z](\d{3,})$/i.exec(baseCode);
              seqNumber = match ? Number(match[1]) : NaN;
            }

            if (!baseCode) {
              const counterSnap = await transaction.get(counterRef);
              const counterData = counterSnap.data() || {};
              let counterValue = Number(counterData.value);
              if (!Number.isFinite(counterValue)) counterValue = Number(counterData.lastNumber);
              if (!Number.isFinite(counterValue)) {
                throw new Error("Contador inválido para modelos. Revisa counters/modelos.");
              }
              seqNumber = counterValue + 1;
              baseCode = buildModelCode({
                providerCode: preview.providerCode,
                typeCode: preview.typeCode,
                seqNumber,
                colorClave: preview.colorClave,
                tallaClave: preview.tallaClave
              }).baseCode;
              transaction.set(counterRef, { value: seqNumber, lastNumber: seqNumber }, { merge: true });
              transaction.set(modelIndexRef, {
                modelKey: preview.modelKey,
                baseCode,
                seqNumber,
                updatedAt: serverTimestamp(),
                updatedBy: safeString(user?.email).trim().toLowerCase()
              }, { merge: true });
              createdModel = true;
            }

            const modelRef = doc(db, MODELOS_COLLECTION, baseCode);
            const modelSnap = await transaction.get(modelRef);
            if (!modelSnap.exists()) {
              createdModel = true;
              transaction.set(modelRef, {
                baseCode,
                seqNumber,
                modelKey: preview.modelKey,
                proveedor: preview.providerCode,
                tipo: preview.typeCode,
                descripcion: preview.descripcion || null,
                detalles: preview.detallesValue || null,
                createdBy: preview.createdByValue || null,
                createdAt: serverTimestamp(),
                updatedAt: serverTimestamp(),
                updatedBy: safeString(user?.email).trim().toLowerCase()
              }, { merge: true });
            } else {
              transaction.set(modelRef, {
                descripcion: preview.descripcion || null,
                detalles: preview.detallesValue || null,
                updatedAt: serverTimestamp(),
                updatedBy: safeString(user?.email).trim().toLowerCase()
              }, { merge: true });
            }

            const variantRef = doc(db, MODELOS_COLLECTION, baseCode, "variantes", preview.variantKey);
            const codigo = `${baseCode}/${preview.colorClave}-${preview.tallaClave}`;
            const docId = safeDocId(codigo);
            transaction.set(variantRef, {
              variantKey: preview.variantKey,
              codigo,
              color: preview.colorClave,
              talla: preview.tallaClave,
              createdBy: preview.createdByValue || null,
              updatedBy: safeString(user?.email).trim().toLowerCase(),
              createdAt: serverTimestamp(),
              updatedAt: serverTimestamp()
            }, { merge: true });

            const publicRef = doc(db, PRENDAS_PUBLIC_COLLECTION, docId);
            transaction.set(publicRef, {
              docId,
              codigo,
              baseCode,
              variantKey: preview.variantKey,
              proveedor: preview.providerCode,
              tipo: preview.typeCode,
              color: preview.colorClave,
              talla: preview.tallaClave,
              descripcion: preview.descripcion || null,
              detalles: preview.detallesValue || null,
              code: codigo,
              providerCode: preview.providerCode,
              typeCode: preview.typeCode,
              seqNumber,
              orden: seqNumber,
              colorCode: preview.colorClave,
              sizeCode: preview.tallaClave,
              status: "Disponible",
              statusCanon: "Disponible",
              disponibilidad: "Disponible",
              disponibilidadCanon: "Disponible",
              fecha: new Date().toISOString(),
              fechaAlta: serverTimestamp(),
              creadoPor: preview.createdByValue || null,
              createdAt: serverTimestamp(),
              updatedAt: serverTimestamp()
            }, { merge: true });

            return { codigo, baseCode, createdModel };
          });

          const costo = toNumber(adminCreateCostoInput?.value);
          const pVentaOverride = toNumber(adminCreatePVentaInput?.value);
          const pVentaVisible = Number.isFinite(pVentaOverride) ? pVentaOverride : NaN;
          const { utilidad, margenPct } = computeMarginUtility(pVentaVisible, costo);
          const payloadAdmin = {
            docId: safeDocId(transactionResult.codigo),
            updatedAt: serverTimestamp(),
            updatedBy: safeString(user?.email).trim().toLowerCase()
          };
          if (Number.isFinite(costo)) payloadAdmin.costo = costo;
          if (Number.isFinite(pVentaOverride)) payloadAdmin.pVentaOverride = pVentaOverride;
          if (Number.isFinite(pVentaVisible) && Number.isFinite(costo)) {
            payloadAdmin.utilidad = utilidad;
            payloadAdmin.margen = margenPct;
          }
          await setDoc(doc(db, PRENDAS_ADMIN_COLLECTION, payloadAdmin.docId), payloadAdmin, { merge: true });

          if (adminCreateCostoInput) adminCreateCostoInput.value = "";
          if (adminCreatePVentaInput) adminCreatePVentaInput.value = "";
          registroPreview = { ...preview, codigo: transactionResult.codigo, baseCode: transactionResult.baseCode };
          registroCodigo.textContent = transactionResult.codigo;
          registroResult.classList.remove("hidden");
          await loadPrendasPage({ reset: true, reason: "save-garment" });
          setRegistroStatus(
            transactionResult.createdModel
              ? "Prenda guardada. Se creó nuevo modelo y variante."
              : "Prenda guardada. Se agregó/actualizó variante del modelo existente.",
            "success"
          );
        } catch (error) {
          console.error(error);
          setRegistroStatus(error?.message || "No se pudo guardar la prenda.", "error");
        } finally {
          registroSave.disabled = false;
          registroSubmit.disabled = false;
        }
      };

      const handleRegistroCopy = async () => {
        try {
          await navigator.clipboard.writeText(registroCodigo.textContent.trim());
          setRegistroStatus("Código copiado al portapapeles.", "success");
        } catch (error) {
          setRegistroStatus("No se pudo copiar el código.", "error");
          console.error(error);
        }
      };

      const handleRegistroReset = () => {
        registroForm.reset();
        registroPreview = null;
        registroResult.classList.add("hidden");
        setRegistroStatus("");
      };

      function initRegistroView() {
        if (registroInited) return;
        registroInited = true;
        if (registroForm) registroForm.addEventListener("submit", handleRegistroSubmit);
        if (registroSave) registroSave.addEventListener("click", handleRegistroSave);
        if (registroCopy) registroCopy.addEventListener("click", handleRegistroCopy);
        if (registroReset) registroReset.addEventListener("click", handleRegistroReset);
      }

      const formatPrice = (value) => {
        const amount = Number(value);
        if (!Number.isFinite(amount)) return "$0.00";
        return `$${amount.toFixed(2)}`;
      };

      const fetchRowBySku = async (skuRaw) => {
        const sku = safeString(skuRaw).trim().toUpperCase();
        if (!sku) return null;
        const docId = safeDocId(sku);

        const publicSnap = await getDoc(doc(db, activePrendasPublicCollection, docId));
        const publicData = publicSnap.exists() ? publicSnap.data() || {} : null;

        if (isAdminViewEnabled()) {
          const adminSnap = await getDoc(doc(db, PRENDAS_ADMIN_COLLECTION, docId));
          if (adminSnap.exists()) {
            const adminData = adminSnap.data() || {};
            return {
              ...(publicData || {}),
              ...adminData,
              codigo: safeString(publicData?.codigo || adminData?.codigo || sku).toUpperCase()
            };
          }
        }

        if (publicData) {
          return {
            ...publicData,
            codigo: safeString(publicData?.codigo || sku).toUpperCase()
          };
        }
        return null;
      };

      const buildLabelPrintPages = ({ sku, qty, price, logoSrc }) => {
        if (!printRoot) return;
        printRoot.innerHTML = "";

        for (let i = 0; i < qty; i += 1) {
          const page = document.createElement("div");
          page.className = "label-page";

          const left = document.createElement("div");
          left.className = "label-left";

          const codeTitle = document.createElement("div");
          codeTitle.className = "label-code-title";
          codeTitle.textContent = "CODIGO$";

          const skuText = document.createElement("div");
          skuText.className = "label-sku";
          skuText.textContent = sku;

          const priceTitle = document.createElement("div");
          priceTitle.className = "label-price-title";
          priceTitle.textContent = "PRECIO$";

          const priceValue = document.createElement("div");
          priceValue.className = "label-price-value";
          priceValue.textContent = price;

          left.append(codeTitle, skuText, priceTitle, priceValue);

          const right = document.createElement("div");
          right.className = "label-right";

          const qrContainer = document.createElement("div");
          qrContainer.className = "label-qr";
          qrContainer.id = `label-qr-${i}`;

          const logo = document.createElement("img");
          logo.className = "label-logo";
          logo.src = logoSrc;
          logo.alt = "harujagdl";

          right.append(qrContainer, logo);
          page.append(left, right);
          printRoot.appendChild(page);

          if (window.QRCode) {
            new QRCode(qrContainer, {
              text: sku,
              width: 140,
              height: 140,
              correctLevel: QRCode.CorrectLevel.M
            });
          }
        }
      };

      const handlePrintLabel = async (event) => {
        event.preventDefault();
        setZplStatus("");

        const sku = safeString(labelSkuInput?.value).trim().toUpperCase();
        const qtyValue = Number(labelQtyInput?.value);
        const qty = Number.isInteger(qtyValue) ? qtyValue : 0;

        if (!sku) {
          setZplStatus("Ingresa un SKU.", "error");
          return;
        }

        if (qty < 1 || qty > 200) {
          setZplStatus("La cantidad debe estar entre 1 y 200.", "error");
          return;
        }

        if (!printRoot) {
          setZplStatus("No se encontró el contenedor de impresión (#printRoot).", "error");
          return;
        }

        try {
          labelPrintBtn.disabled = true;
          const row = await fetchRowBySku(sku);
          if (!row) {
            setZplStatus("No se encontró el SKU en Firestore.", "error");
            return;
          }

          const priceRaw = row?.precioVenta ?? row?.pVentaOverride ?? row?.pVenta ?? row?.precio ?? 0;
          const formattedPrice = formatPrice(priceRaw);

          const zpl = buildLabelZpl({ sku, price: formattedPrice, qty });
          console.log("[label-zpl] ZPL generado:\n", zpl);

          if (LABEL_ZPL_DEBUG) {
            try {
              console.log("[label-zpl-debug] ZPL generado:\n", zpl);
            } catch (error) {
              console.error("[label-zpl-debug] No se pudo generar ZPL de depuración:", error);
            }
          }

          buildLabelPrintPages({
            sku,
            qty,
            price: formattedPrice,
            logoSrc: getZplLogoDataUrl()
          });

          setZplStatus(`Imprimiendo ${qty} etiqueta(s)…`, "success");
          window.print();
        } catch (error) {
          console.error(error);
          setZplStatus("No se pudo preparar la impresión de etiquetas.", "error");
        } finally {
          labelPrintBtn.disabled = false;
        }
      };

      function initDbView() {
        if (dbInited) return;
        dbInited = true;
        if (zplForm) zplForm.addEventListener("submit", handlePrintLabel);
      }

      // ADMIN DB MODE START
      const DB_TAB_HASH = "#/codigos";

      const isAllowlistedAdmin = (email) =>
        ADMIN_ALLOWLIST.has(safeString(email).trim().toLowerCase());

      const getAdminViewEnabled = () =>
        sessionStorage.getItem(ADMIN_VIEW_KEY) === "1";

      const isAdminAuthenticated = () => prendasState.adminByAuth === true;
      const isAdminViewEnabled = () => getAdminViewEnabled() === true && isAdminAuthenticated();

      const ensureAdminMode = () => {
        if (isAdminMode) return true;
        alert("Activa Modo admin para esta acción.");
        return false;
      };

      const setAdminViewEnabled = (enabled) => {
        // Solo permitir modo admin si el usuario está autenticado y en allowlist
        const adminByAuth = Boolean(prendasState.adminByAuth);
        const finalEnabled = adminByAuth ? Boolean(enabled) : false;
        sessionStorage.setItem(ADMIN_VIEW_KEY, finalEnabled ? "1" : "0");
        document.body.classList.toggle("is-admin", finalEnabled);
      };

      const setAdminLoginStatus = (message, type = "") => {
        if (!adminLoginStatus) return;
        adminLoginStatus.textContent = message;
        adminLoginStatus.className = `status ${type}`.trim();
      };

      let adminPanelVisible = false;

      const setAdminPanelVisible = (visible) => {
        adminPanelVisible = visible;
        if (adminPanel) {
          adminPanel.classList.toggle("hidden", !visible);
        }
        if (adminOptionalToggle) {
          adminOptionalToggle.textContent = visible ? "Ocultar admin" : "Admin";
        }
      };

      const applyAdminUI = ({ refresh = true } = {}) => {
        const byAuth = Boolean(prendasState.adminByAuth);
        const enabled = byAuth && getAdminViewEnabled();
        isAdminMode = enabled;
        prendasState.isAdmin = enabled;
        document.body.classList.toggle("is-admin", enabled);
        if (dbCodigosSection) {
          dbCodigosSection.classList.toggle("admin-enabled", enabled);
        }
        if (adminToggleDb) {
          adminToggleDb.checked = enabled;
          adminToggleDb.disabled = !byAuth;
        }
        if (adminActions) {
          adminActions.classList.toggle("hidden", !byAuth);
        }
        if (adminLoginButton) {
          adminLoginButton.classList.toggle("hidden", byAuth);
        }
        if (adminLogoutButton) {
          adminLogoutButton.classList.toggle("hidden", !byAuth);
        }
        if (adminLogoutQuickButton) {
          adminLogoutQuickButton.classList.toggle("hidden", !byAuth);
        }
        if (byAuth) {
          setAdminLoginStatus(`Admin autenticado: ${prendasState.adminEmail}`, "success");
        } else {
          setAdminLoginStatus("Inicia sesión con un correo admin permitido.");
          setAdminViewEnabled(false);
        }
        if (adminCreateFields) {
          adminCreateFields.classList.toggle("hidden", !enabled);
          adminCreateFields.setAttribute("aria-hidden", enabled ? "false" : "true");
        }
        if (adminCreateCostoInput) {
          adminCreateCostoInput.disabled = !enabled;
          if (!enabled) adminCreateCostoInput.value = "";
        }
        if (adminCreatePVentaInput) {
          adminCreatePVentaInput.disabled = !enabled;
          if (!enabled) adminCreatePVentaInput.value = "";
        }
        if (!enabled) {
          prendasState.adminMap.clear();
          closeEditModal();
        }
        setAdminPanelVisible(adminPanelVisible);
        if (refresh) {
          loadPrendasPage({ reset: true, reason: "admin-toggle" });
        }
        updateAdminModeBtn();

      };

      const handleAdminToggle = async () => {
        // Si no está autenticado como admin, el botón funciona como login
        if (!prendasState.adminByAuth) {
          await handleAdminLogin();
          if (prendasState.adminByAuth) {
            setAdminViewEnabled(true);
            applyAdminUI();
            try { await applyFilters(); } catch (_) {}
          }
          return;
        }
        const nextEnabled = !getAdminViewEnabled();
        setAdminViewEnabled(nextEnabled);
        applyAdminUI();
        try { await applyFilters(); } catch (_) {}
      };

      const handleAdminLogin = async () => {
        if (adminLoginButton) {
          adminLoginButton.disabled = true;
        }
        try {
          const response = await signInWithPopup(auth, googleProvider);
          const email = safeString(response?.user?.email).trim().toLowerCase();
          if (!isAllowlistedAdmin(email)) {
            setAdminLoginStatus("Tu cuenta no está permitida como admin.", "error");
            await signOut(auth);
            return;
          }
          setAdminViewEnabled(true);
          applyAdminUI();
        } catch (error) {
          console.error(error);
          setAdminLoginStatus("No se pudo iniciar sesión con Google.", "error");
        } finally {
          if (adminLoginButton) {
            adminLoginButton.disabled = false;
          }
        }
      };

      const handleAdminLogout = async () => {
        try {
          isAdminMode = false;
          await signOut(auth);
        } catch (error) {
          console.error(error);
        }
      };

      // (XLSX import removed)


      const handleAdminSplitCollections = async () => {
        if (!ensureAdminMode()) return;
        if (adminSplitButton) {
          adminSplitButton.disabled = true;
        }
        try {
          let user = auth.currentUser;
          if (!user) {
            const response = await signInWithPopup(auth, googleProvider);
            user = response?.user || null;
          }
          const email = safeString(user?.email).trim().toLowerCase();
          if (!isAllowlistedAdmin(email)) {
            setAdminLoginStatus("Tu cuenta no está permitida como admin.", "error");
            await signOut(auth);
            return;
          }
          const idToken = await user.getIdToken(true);
          setAdminLoginStatus("Migrando colección base a public/admin por lotes...", "warning");

          let totalProcessed = 0;
          let totalPublic = 0;
          let totalAdmin = 0;
          let cursor = "";
          let hasMore = true;

          while (hasMore) {
            const response = await fetch(SPLIT_FUNCTION_URL, {
              method: "POST",
              headers: {
                "Content-Type": "application/json",
                Authorization: `Bearer ${idToken}`
              },
              body: JSON.stringify({
                batchSize: 300,
                startAfter: cursor || undefined
              })
            });
            const payload = await response.json();
            if (!response.ok || !payload?.ok) {
              throw new Error(payload?.error || `HTTP ${response.status}`);
            }

            totalProcessed += Number(payload?.processed || 0);
            totalPublic += Number(payload?.writtenPublic || 0);
            totalAdmin += Number(payload?.writtenAdmin || 0);
            cursor = safeString(payload?.lastDocCursor).trim();
            hasMore = Boolean(payload?.hasMore) && Boolean(cursor);

            setAdminLoginStatus(
              `Migrando... lote=${payload?.processed || 0}, acumulado=${totalProcessed}, último=${cursor || "fin"}`,
              "warning"
            );

            if (!payload?.processed) {
              hasMore = false;
            }
          }

          setAdminLoginStatus(
            `Migración OK. procesados=${totalProcessed}, public=${totalPublic}, admin=${totalAdmin}.`,
            "success"
          );
          setPrendasAlert("");
          await loadPrendasPage({ reset: true, reason: "migrate-collections" });
        } catch (error) {
          console.error(error);
          setAdminLoginStatus(`Error al migrar colecciones: ${error.message || error}`, "error");
        } finally {
          if (adminSplitButton) {
            adminSplitButton.disabled = false;
          }
        }
      };

      onAuthStateChanged(auth, async (user) => {
        const email = safeString(user?.email).trim().toLowerCase();
        prendasState.adminUser = user || null;
        prendasState.adminEmail = email;
        prendasState.adminByAuth = Boolean(user) && isAllowlistedAdmin(email);
        if (!prendasState.adminByAuth) {
          setAdminViewEnabled(false);
          if (user) {
            setAdminLoginStatus("Sesión activa sin permisos de admin.", "warning");
          }
        }
        applyAdminUI();
      });

      const handleTabChange = (hash) => {
        if (hash === DB_TAB_HASH) {
          applyAdminUI({ refresh: false });
        }
      };

      if (adminToggleDb) {
        adminToggleDb.addEventListener("change", handleAdminToggle);
      }
      if (adminLoginButton) {
        adminLoginButton.addEventListener("click", handleAdminLogin);
      }
      if (adminLogoutButton) {
        adminLogoutButton.addEventListener("click", handleAdminLogout);
      }
      if (adminLogoutQuickButton) {
        adminLogoutQuickButton.addEventListener("click", handleAdminLogout);
      }
      if (adminOptionalToggle) {
        adminOptionalToggle.addEventListener("click", () => {
          setAdminPanelVisible(!adminPanelVisible);
        });
      }
      
      const adminModeBtn = document.getElementById("admin-mode-btn");

      const updateAdminModeBtn = () => {
        if (!adminModeBtn) return;
        const enabled = isAdminViewEnabled();
        adminModeBtn.classList.toggle("is-on", enabled);
        adminModeBtn.setAttribute("aria-pressed", enabled ? "true" : "false");
        if (!prendasState.adminByAuth) {
          adminModeBtn.textContent = "Modo admin";
          adminModeBtn.title = "Inicia sesión con Google para ver Costos/Margen/Utilidad";
          return;
        }
        adminModeBtn.textContent = enabled ? "Salir admin" : "Modo admin";
        adminModeBtn.title = enabled ? "Salir de la vista admin" : "Mostrar columnas admin";
      };

      
      if (adminModeBtn) {
        adminModeBtn.addEventListener("click", async () => {
          try {
            await handleAdminToggle();
          } catch (e) {
            console.error(e);
          }
        });
      }

      if (prendasTable) {
        prendasTable.addEventListener("click", (event) => {
          const rowSelect = event.target.closest(".row-select");
          if (rowSelect) {
            const docId = safeString(rowSelect.dataset.docId).trim();
            if (!docId) return;
            if (rowSelect.checked) prendasState.selected.add(docId);
            else prendasState.selected.delete(docId);
            updateSelectAllCheckbox();
            return;
          }

          const button = event.target.closest(".rowEditBtn");
          if (!button) return;
          if (!isAdminViewEnabled()) return;
          const docId = safeString(button.dataset.editDoc).trim();
          if (!docId) return;
          const rowData = prendasState.filtered.find((row) => safeString(row.docId || row.id).trim() === docId)
            || prendasState.baseRows.find((row) => safeString(row.docId || row.id).trim() === docId);
          const adminData = prendasState.adminMap.get(docId) || {};
          openEditModal(rowData ? { ...rowData, ...adminData } : rowData);
        });
      }

      if (selectAllLabelsCheckbox) {
        selectAllLabelsCheckbox.addEventListener("change", () => {
          const checked = Boolean(selectAllLabelsCheckbox.checked);
          (prendasState.filtered || []).forEach((row) => {
            const docId = safeString(row.docId || row.id).trim();
            if (!docId) return;
            if (checked) prendasState.selected.add(docId);
            else prendasState.selected.delete(docId);
          });
          prendasTbody.querySelectorAll(".row-select").forEach((input) => {
            input.checked = checked;
          });
          updateSelectAllCheckbox();
        });
      }

      if (labelsButton && labelsPanel) {
        labelsButton.addEventListener("click", () => {
          prendasState.labelsPanelOpen = !prendasState.labelsPanelOpen;
          labelsPanel.classList.toggle("hidden", !prendasState.labelsPanelOpen);
          labelsPanel.setAttribute("aria-hidden", prendasState.labelsPanelOpen ? "false" : "true");
        });
      }

      labelsScopeInputs.forEach((input) => {
        input.addEventListener("change", () => {
          if (input.checked) {
            prendasState.labelsScope = input.value;
          }
        });
      });

      if (labelsPrintButton) {
        labelsPrintButton.addEventListener("click", () => {
          openPrintLabels(prendasState.labelsScope || "page");
        });
      }

      if (editPVentaInput) {
        editPVentaInput.addEventListener("input", updateEditPreview);
      }
      if (editCostoInput) {
        editCostoInput.addEventListener("input", updateEditPreview);
      }
      if (editModalCancelButton) {
        editModalCancelButton.addEventListener("click", closeEditModal);
      }
      if (editModalOverlay) {
        editModalOverlay.addEventListener("click", closeEditModal);
      }
      if (editModalSaveButton) {
        editModalSaveButton.addEventListener("click", saveEdit);
      }
      document.addEventListener("keydown", (event) => {
        if (event.key === "Escape" && editModal && !editModal.classList.contains("hidden")) {
          closeEditModal();
        }
      });

window.addEventListener("hashchange", () => {
        handleTabChange(window.location.hash);
      });

      document.querySelectorAll('a.card[href^="#"]').forEach((link) => {
        link.addEventListener("click", (event) => {
          const hash = event.currentTarget.getAttribute("href") || "";
          handleTabChange(hash);
        });
      });

      // ADMIN DB MODE END

      const handleSearchInput = debounce(async () => {
        if (isBooting) return;
        const rawInput = getSearchInput();
        if (!rawInput.trim()) {
          await loadPrendasPage({ reset: true, reason: "search-clear" });
          return;
        }
        if (isFullSku(rawInput)) {
          await runSkuSearch(rawInput);
          return;
        }
        setSkuSearchMode(false);
        await applyFilters();
      }, PRENDAS_SEARCH_DEBOUNCE);

      const handleFilterApply = async () => {
        if (isBooting) return;
        const rawInput = getSearchInput();
        if (rawInput.trim() && isFullSku(rawInput)) {
          await runSkuSearch(rawInput);
          return;
        }
        await applyFilters();
      };

      const handleFilterClear = async () => {
        if (isBooting) return;
        setSkuSearchMode(false);
        clearFiltersUi();
        clearHeaderFilters();
        await loadPrendasPage({ reset: true, reason: "filters-clear" });
      };

      
    // ---- Más filtros (panel) ----
    const updateMoreFiltersDot = () => {
      const hasPriceMin = !!(prendasPrecioMin && String(prendasPrecioMin.value || "").trim());
      const hasPriceMax = !!(prendasPrecioMax && String(prendasPrecioMax.value || "").trim());
      const hasNoPrice = !!(prendasPrecioSin && prendasPrecioSin.checked);
      const active = hasPriceMin || hasPriceMax || hasNoPrice;
      if (moreFiltersDot) moreFiltersDot.style.display = active ? "inline-block" : "none";
    };

    const setMoreFiltersOpen = (open) => {
      if (!moreFiltersPanel) return;
      moreFiltersPanel.style.display = open ? "block" : "none";
    };

    if (btnMoreFilters) {
      btnMoreFilters.addEventListener("pointerdown", (e) => {
        e.preventDefault();
        e.stopPropagation();
        const isOpen = moreFiltersPanel && moreFiltersPanel.style.display !== "none";
        setMoreFiltersOpen(!isOpen);
      });
    }

    // Cerrar al dar click fuera
    document.addEventListener("pointerdown", (e) => {
      if (!moreFiltersPanel || moreFiltersPanel.style.display === "none") return;
      const t = e.target;
      if (!(t instanceof HTMLElement)) return;
      if (t.closest("#moreFiltersPanel") || t.closest("#btnMoreFilters")) return;
      setMoreFiltersOpen(false);
    });

    // Actualiza dot cuando cambia algo
    [prendasPrecioMin, prendasPrecioMax].forEach((el) => el && el.addEventListener("input", updateMoreFiltersDot));
    if (prendasPrecioSin) prendasPrecioSin.addEventListener("change", updateMoreFiltersDot);
if (prendasSearch) prendasSearch.addEventListener("input", handleSearchInput);
      headerFilterButtons.forEach((button) => {
        button.addEventListener("pointerdown", (event) => {
          event.stopPropagation();
          const key = button.dataset.openHeaderFilter;
          if (prendasState.headerPopover?.key === key) {
            closeHeaderPopover();
            return;
          }
          renderHeaderFilterPopover(key, button);
        });
      });
      document.addEventListener("pointerdown", (event) => {
        const target = event.target;
        if (prendasState.headerPopover?.container && !prendasState.headerPopover.container.contains(target)) {
          closeHeaderPopover();
        }
      });
      document.addEventListener("keydown", (event) => {
        if (event.key === "Escape") {
          closeHeaderPopover();
        }
      });
      if (prendasPrecioApply) prendasPrecioApply.addEventListener("pointerdown", (event) => { event.preventDefault(); handleFilterApply(); });
      if (prendasFiltersClear) {
        prendasFiltersClear.addEventListener("pointerdown", (event) => { event.preventDefault(); handleFilterClear(); });
      }
      if (prendasYear) {
        prendasYear.addEventListener("change", () => {
          syncDateFilterUi();
        });
      }
      if (prendasPageSize) {
        prendasPageSize.addEventListener("change", async () => {
          if (isBooting) return;
          await loadPrendasPage({ reset: true, reason: "page-size" });
        });
      }
      if (ordenSortBtn) {
        ordenSortBtn.addEventListener("click", async () => {
          const current = normalizeSortConfig(prendasState.sort);
          const nextDir = current.dir === "asc" ? "desc" : "asc";
          await setPrendasSort({ key: "orden", dir: nextDir });
        }, { passive: true });
      }

      [prendasPrecioMin, prendasPrecioMax].forEach((input) => {
        if (!input) return;
        input.addEventListener("keydown", (event) => {
          if (isBooting) return;
          if (event.key === "Enter") {
            event.preventDefault();
            handleFilterApply();
          }
        });
      });

      if (prendasPrev) {
        prendasPrev.addEventListener("pointerdown", async (event) => {
          event.preventDefault();
          if (isBooting) return;
          const prevIndex = Math.max(prendasState.pageIndex - 1, 0);
          await loadPrendasPage({ pageIndex: prevIndex, reason: "pagination-prev" });
        });
      }

      if (prendasNext) {
        prendasNext.addEventListener("pointerdown", async (event) => {
          event.preventDefault();
          if (isBooting) return;
          const nextIndex = prendasState.pageIndex + 1;
          await loadPrendasPage({ pageIndex: nextIndex, reason: "pagination-next" });
        });
      }

      const init = async () => {
        isBooting = true;
        resetPrendasState();
        updateOrdenSortToggleUi();
        resetCounters();
        populateYearFilter();
        populateMonthFilter();
        clearFiltersUi();
        try {
          setRegistroStatus("Cargando diccionario...");
          registroSubmit.disabled = true;
          setSelectLoading(registroProducto, "Cargando...");
          setSelectLoading(registroProveedor, "Cargando...");
          setSelectLoading(registroColor, "Cargando...");
          setSelectLoading(registroTalla, "Cargando...");

          const dictionary = await loadDictionary();
          const dictionaryReady = !dictionary.empty && dictionary.missing.length === 0;
          if (dictionary.empty) {
            setRegistroStatus("Diccionario vacío: corre el workflow Seed Firestore.", "error");
          } else if (dictionary.missing.length) {
            setRegistroStatus(
              `Faltan datos en: ${dictionary.missing.join(", ")}.`,
              "error"
            );
          } else {
            setRegistroStatus("");
          }

          if (dictionary.tipos.length) {
            fillDictionarySelect(
              registroProducto,
              dictionary.tipos.sort((a, b) => a.clave.localeCompare(b.clave))
            );
          } else {
            setSelectLoading(registroProducto, "Sin opciones disponibles");
          }

          if (dictionary.proveedores.length) {
            fillDictionarySelect(
              registroProveedor,
              dictionary.proveedores.sort((a, b) => a.clave.localeCompare(b.clave))
            );
          } else {
            setSelectLoading(registroProveedor, "Sin opciones disponibles");
          }

          if (dictionary.colores.length) {
            fillDictionarySelect(
              registroColor,
              dictionary.colores.sort((a, b) => a.clave.localeCompare(b.clave))
            );
          } else {
            setSelectLoading(registroColor, "Sin opciones disponibles");
          }

          if (dictionary.tallas.length) {
            fillDictionarySelect(
              registroTalla,
              dictionary.tallas.sort((a, b) => a.clave.localeCompare(b.clave))
            );
          } else {
            setSelectLoading(registroTalla, "Sin opciones disponibles");
          }

          registroSubmit.disabled = !dictionaryReady;
        } catch (error) {
          setRegistroStatus("No pudimos cargar el diccionario.", "error");
          registroSubmit.disabled = true;
          console.error(error);
          alert(`Error cargando diccionario: ${error?.message || error}`);
        } finally {
          // ADMIN DB MODE START
          setAdminPanelVisible(false);
          applyAdminUI();
          handleTabChange(window.location.hash);
          // ADMIN DB MODE END
          setSkuSearchMode(false);

          let prendasCollection = PRENDAS_PUBLIC_COLLECTION;
          try {
            prendasCollection = await resolvePrendasCollection();
          } catch (error) {
            console.error("[Prendas] No se pudo resolver colección, usando default", error);
          }
          setPrendasCollections({
            publicCollection: prendasCollection
          });

          try {
            const baseSnapshot = await getDocs(query(prendasPublicRef, limit(10)));
            console.log("[Prendas] Base query (sin filtros) docs", {
              collection: activePrendasPublicCollection,
              docs: baseSnapshot.size
            });
            console.log("[Prendas] snapshot size:", baseSnapshot.size);
            if (baseSnapshot.empty) {
              setPrendasAlert("Aún no se ha migrado la colección public. Entra a Admin y corre ‘Migrar a public/admin’.");
            }
          } catch (error) {
            console.error("[Prendas] ❌ No se pudo leer la colección pública", error);
            setPrendasAlert("No se encontró la colección pública o las reglas de Firestore la están bloqueando.");
            return;
          }
          try {
            if (typeof loadMetadataCounts === "function") {
              const total = await loadMetadataCounts();
              if (Number.isFinite(total) && !hasActiveFilters(getCurrentFilters())) {
                prendasState.showingTotal = total;
                setCounter(prendasState.filtered.length, total);
              }
            } else {
              console.warn("loadMetadataCounts() no existe, se omite.");
            }
          } catch (error) {
            console.warn("[Prendas] loadMetadataCounts falló", error);
          }
          try {
            console.log("query filters", getCurrentFilters());
            console.log("baseRows", prendasState.baseRows?.length ?? 0, "filtered", prendasState.filtered?.length ?? 0);
            await loadPrendasPage({ reset: true, reason: "init" });
            console.log("baseRows", prendasState.baseRows?.length ?? 0, "filtered", prendasState.filtered?.length ?? 0);
          } finally {
            prendasState.isLoadingInitial = false;
            setLoading(false);
            isBooting = false;
          }
        }
      };

      document.addEventListener("DOMContentLoaded", () => {
        init();
        navigateTo(getViewFromUrl(), { replace: true });
      });
    </script>
  </body>
</html>
