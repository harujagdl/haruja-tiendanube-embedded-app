<!DOCTYPE html>
<html lang="es">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <title>Panel Haruja – v0.0 | Panel</title>
    <style>
      :root {
        color-scheme: light;
        --bg: #f6f7fb;
        --card: #ffffff;
        --text: #1f2937;
        --muted: #6b7280;
        --primary: #1f6feb;
        --primary-dark: #1a55b5;
        --border: #e5e7eb;
        --shadow: 0 10px 24px rgba(15, 23, 42, 0.08);
        --radius: 16px;
      }

      * {
        box-sizing: border-box;
      }

      body {
        margin: 0;
        font-family: "Inter", "Segoe UI", system-ui, -apple-system, sans-serif;
        color: var(--text);
        background: var(--bg);
      }

      .app {
        min-height: 100vh;
        display: flex;
        flex-direction: column;
      }

      header {
        background: var(--card);
        border-bottom: 1px solid var(--border);
        padding: 24px 32px;
      }

      header h1 {
        margin: 0 0 8px;
        font-size: 24px;
      }

      header p {
        margin: 0;
        color: var(--muted);
        font-size: 14px;
      }

      main {
        padding: 32px;
        display: flex;
        flex-direction: column;
        gap: 24px;
      }

      .grid {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(220px, 1fr));
        gap: 20px;
      }

      .card {
        background: var(--card);
        border: 1px solid var(--border);
        border-radius: var(--radius);
        box-shadow: var(--shadow);
        padding: 20px;
        display: flex;
        flex-direction: column;
        gap: 12px;
        text-decoration: none;
        color: inherit;
      }

      .card h2 {
        margin: 0;
        font-size: 18px;
      }

      .card p {
        margin: 0;
        color: var(--muted);
        font-size: 14px;
      }

      .card .cta {
        margin-top: auto;
        font-weight: 600;
        color: var(--primary);
      }

      .section {
        background: var(--card);
        border: 1px solid var(--border);
        border-radius: var(--radius);
        box-shadow: var(--shadow);
        padding: 24px;
      }

      .section h2 {
        margin: 0 0 12px;
        font-size: 20px;
      }

      .section p {
        margin: 0 0 20px;
        color: var(--muted);
        font-size: 14px;
      }

      .form {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(180px, 1fr));
        gap: 16px;
        align-items: end;
      }

      label {
        display: block;
        font-size: 13px;
        color: var(--muted);
        margin-bottom: 6px;
      }

      input {
        width: 100%;
        padding: 10px 12px;
        border-radius: 10px;
        border: 1px solid var(--border);
        font-size: 14px;
      }

      select {
        width: 100%;
        padding: 10px 12px;
        border-radius: 10px;
        border: 1px solid var(--border);
        font-size: 14px;
        background: #fff;
      }

      button {
        padding: 12px 16px;
        border-radius: 12px;
        border: none;
        background: var(--primary);
        color: #fff;
        font-weight: 600;
        cursor: pointer;
      }

      button:hover {
        background: var(--primary-dark);
      }

      .status {
        font-size: 14px;
        color: var(--muted);
        min-height: 20px;
      }

      .status.success {
        color: #15803d;
      }

      .status.error {
        color: #b91c1c;
      }

      .status.warning {
        color: #b45309;
      }

      .result-card {
        margin-top: 16px;
        padding: 16px;
        border-radius: 12px;
        border: 1px solid var(--border);
        background: #f8fafc;
      }

      .result-code {
        font-size: 24px;
        font-weight: 700;
        letter-spacing: 0.5px;
        margin: 8px 0 16px;
      }

      .result-actions {
        display: flex;
        flex-wrap: wrap;
        gap: 12px;
      }

      .muted {
        color: var(--muted);
        font-size: 13px;
      }

      .zpl-output {
        margin-top: 16px;
      }

      textarea {
        width: 100%;
        min-height: 180px;
        padding: 12px;
        border-radius: 12px;
        border: 1px solid var(--border);
        font-size: 13px;
        font-family: "SFMono-Regular", "Consolas", "Liberation Mono", monospace;
      }

      .hidden {
        display: none;
      }

      table {
        width: 100%;
        border-collapse: collapse;
        font-size: 14px;
      }

      th,
      td {
        padding: 10px 12px;
        border-bottom: 1px solid var(--border);
        text-align: left;
      }

      th {
        color: var(--muted);
        font-weight: 600;
      }

      @media (max-width: 600px) {
        header,
        main {
          padding: 20px;
        }
      }
    </style>
  </head>
  <body>
    <div class="app">
      <header>
        <h1>Panel Haruja</h1>
        <p>Gestión rápida de prendas, precios y etiquetas dentro de Tiendanube.</p>
      </header>

      <main>
        <section class="grid">
          <a class="card" href="#registro">
            <h2>Registro de nuevas prendas</h2>
            <p>Carga nuevas prendas y atributos esenciales en minutos.</p>
            <span class="cta">Empezar</span>
          </a>
          <a class="card" href="#precios">
            <h2>Asignar precios</h2>
            <p>Define precios finales por categoría y canal de venta.</p>
            <span class="cta">Configurar</span>
          </a>
          <a class="card" href="#calculadora">
            <h2>Calculadora de precios</h2>
            <p>Calcula márgenes y proyecciones de rentabilidad.</p>
            <span class="cta">Abrir</span>
          </a>
          <a class="card" href="#etiquetas">
            <h2>Impresión de etiquetas (ZPL)</h2>
            <p>Genera etiquetas listas para impresión y control interno.</p>
            <span class="cta">Preparar</span>
          </a>
        </section>

        <section class="section" id="registro">
          <h2>Registro de nuevas prendas</h2>
          <p>Selecciona los atributos clave para generar el código y guardar la prenda en Firestore.</p>
          <form class="form" id="registro-form">
            <div>
              <label for="registro-producto">Tipo / Producto *</label>
              <select id="registro-producto" name="producto" required>
                <option value="">Seleccionar</option>
              </select>
            </div>
            <div>
              <label for="registro-proveedor">Proveedor *</label>
              <select id="registro-proveedor" name="proveedor" required>
                <option value="">Seleccionar</option>
              </select>
            </div>
            <div>
              <label for="registro-color">Color *</label>
              <select id="registro-color" name="color" required>
                <option value="">Seleccionar</option>
              </select>
            </div>
            <div>
              <label for="registro-talla">Talla *</label>
              <select id="registro-talla" name="talla" required>
                <option value="">Seleccionar</option>
              </select>
            </div>
            <div>
              <label for="registro-costo">Costo (opcional)</label>
              <input id="registro-costo" name="costo" type="number" min="0" step="0.01" placeholder="0" />
            </div>
            <div>
              <label for="registro-created-by">Creado por (opcional)</label>
              <input id="registro-created-by" name="createdBy" type="text" placeholder="Nombre" />
            </div>
            <div>
              <label for="registro-detalles">Detalles (opcional)</label>
              <input id="registro-detalles" name="detalles" type="text" placeholder="Ej: Pelly estampada" />
            </div>
            <button type="submit">Generar código</button>
          </form>
          <p id="registro-status" class="status"></p>
          <div id="registro-result" class="result-card hidden">
            <span class="muted">Código generado</span>
            <div id="registro-codigo" class="result-code">HA00000/--</div>
            <div class="result-actions">
              <button type="button" id="registro-copy">Copiar</button>
              <button type="button" id="registro-reset">Crear otro</button>
            </div>
          </div>
        </section>

        <section class="section" id="etiquetas">
          <h2>Impresión de etiquetas</h2>
          <p>Ingresa el código y la cantidad de etiquetas a generar.</p>
          <form class="form" id="zpl-form">
            <div>
              <label for="zpl-codigo">Código (SKU)</label>
              <input id="zpl-codigo" name="codigo" type="text" placeholder="HA22007/NG-M" />
            </div>
            <div>
              <label for="zpl-cantidad">Cantidad</label>
              <input id="zpl-cantidad" name="cantidad" type="number" min="1" value="1" />
            </div>
            <button type="submit">Imprimir etiqueta</button>
          </form>
          <p id="zpl-status" class="status"></p>
          <div class="zpl-output hidden" id="zpl-output">
            <label for="zpl-textarea">ZPL generado</label>
            <textarea id="zpl-textarea" readonly></textarea>
            <div class="result-actions" style="margin-top: 12px;">
              <button type="button" id="zpl-copy">Copiar ZPL</button>
            </div>
          </div>
        </section>
      </main>
    </div>
    <script type="module">
      import { initializeApp } from "https://www.gstatic.com/firebasejs/9.22.2/firebase-app.js";
      import {
        getFirestore,
        collection,
        addDoc,
        doc,
        getDocs,
        query,
        runTransaction,
        serverTimestamp,
        where
      } from "https://www.gstatic.com/firebasejs/9.22.2/firebase-firestore.js";

      // TODO: Reemplazar estos valores con la configuración real del proyecto Firebase.
      const firebaseConfig = {
        apiKey: "REEMPLAZAR_API_KEY",
        authDomain: "haruja-tiendanube.firebaseapp.com",
        projectId: "haruja-tiendanube",
        storageBucket: "haruja-tiendanube.appspot.com",
        messagingSenderId: "REEMPLAZAR_SENDER_ID",
        appId: "REEMPLAZAR_APP_ID"
      };

      const app = initializeApp(firebaseConfig);
      const db = getFirestore(app);
      const prendasRef = collection(db, "prendas");
      const registroForm = document.getElementById("registro-form");
      const registroStatus = document.getElementById("registro-status");
      const registroResult = document.getElementById("registro-result");
      const registroCodigo = document.getElementById("registro-codigo");
      const registroCopy = document.getElementById("registro-copy");
      const registroReset = document.getElementById("registro-reset");
      const registroSubmit = registroForm.querySelector("button[type='submit']");
      const registroProducto = document.getElementById("registro-producto");
      const registroProveedor = document.getElementById("registro-proveedor");
      const registroColor = document.getElementById("registro-color");
      const registroTalla = document.getElementById("registro-talla");
      const registroDetalles = document.getElementById("registro-detalles");

      const zplForm = document.getElementById("zpl-form");
      const zplStatus = document.getElementById("zpl-status");
      const zplOutput = document.getElementById("zpl-output");
      const zplTextarea = document.getElementById("zpl-textarea");
      const zplCopy = document.getElementById("zpl-copy");

      const setRegistroStatus = (message, type = "") => {
        registroStatus.textContent = message;
        registroStatus.className = `status ${type}`.trim();
      };

      const setZplStatus = (message, type = "") => {
        zplStatus.textContent = message;
        zplStatus.className = `status ${type}`.trim();
      };

      const buildOption = ({ clave, valor }) => {
        const option = document.createElement("option");
        option.value = clave;
        option.textContent = `${clave} - ${valor}`;
        option.dataset.nombre = valor;
        return option;
      };

      const setSelectLoading = (selectEl, message) => {
        selectEl.innerHTML = "";
        const option = document.createElement("option");
        option.value = "";
        option.textContent = message;
        selectEl.appendChild(option);
        selectEl.disabled = true;
      };

      const fillSelect = (selectEl, entries) => {
        selectEl.innerHTML = "";
        const placeholder = document.createElement("option");
        placeholder.value = "";
        placeholder.textContent = "Seleccionar";
        selectEl.appendChild(placeholder);
        entries.forEach((item) => selectEl.appendChild(buildOption(item)));
        selectEl.disabled = false;
      };

      const collectOption = (map, codigo, nombre) => {
        if (!codigo) return;
        if (!map.has(codigo)) {
          map.set(codigo, nombre || codigo);
        }
      };

      const COLLECTIONS = {
        tipos: "diccionario_tipos",
        proveedores: "diccionario_proveedores",
        colores: "diccionario_colores",
        tallas: "diccionario_tallas"
      };

      const CODE_PATTERN = /^HA(\d{5})\/([A-Z]{2})-([A-Z0-9]+)$/;

      const parseConsecutivo = (rawCode) => {
        if (!rawCode) return null;
        const match = String(rawCode).trim().toUpperCase().match(CODE_PATTERN);
        if (!match) return null;
        const numberValue = Number(match[1]);
        return Number.isFinite(numberValue) ? numberValue : null;
      };

      const loadCategoryEntries = async (category, collectionName) => {
        const snapshot = await getDocs(collection(db, collectionName));
        if (snapshot.empty) {
          return { category, entries: [], empty: true };
        }

        const entries = snapshot.docs
          .map((docSnap) => {
            const data = docSnap.data() || {};
            const clave = data.clave || docSnap.id;
            const valor = data.valor || data.nombre || clave;
            return { clave, valor };
          })
          .filter((entry) => entry.clave && entry.valor);

        return { category, entries, empty: entries.length === 0 };
      };

      const loadDictionary = async () => {
        const categories = Object.keys(COLLECTIONS);
        const results = await Promise.all(
          categories.map((category) =>
            loadCategoryEntries(category, COLLECTIONS[category])
          )
        );
        const missing = results.filter((result) => result.empty).map((result) => result.category);

        return {
          empty: missing.length === categories.length,
          missing,
          tipos: results.find((result) => result.category === "tipos")?.entries ?? [],
          proveedores: results.find((result) => result.category === "proveedores")?.entries ?? [],
          colores: results.find((result) => result.category === "colores")?.entries ?? [],
          tallas: results.find((result) => result.category === "tallas")?.entries ?? []
        };
      };

      const ensureRequired = () => {
        if (!registroProveedor.value || !registroProducto.value || !registroColor.value || !registroTalla.value) {
          setRegistroStatus("Completa Proveedor, Producto, Color y Talla.", "error");
          return false;
        }
        return true;
      };

      const getSelectedName = (selectEl) => {
        const option = selectEl.options[selectEl.selectedIndex];
        return option?.dataset?.nombre || option?.textContent?.split(" - ")[1] || option?.textContent || "";
      };

      const fetchFallbackMax = async () => {
        const snapshot = await getDocs(prendasRef);
        let maxValue = 0;
        let validCount = 0;

        snapshot.forEach((docSnap) => {
          const data = docSnap.data() || {};
          const fromCode = parseConsecutivo(data.code);
          const fromLegacy = fromCode ?? parseConsecutivo(data.codigo);
          if (Number.isFinite(fromLegacy)) {
            validCount += 1;
            maxValue = Math.max(maxValue, fromLegacy);
          }
        });

        console.info(`Fallback contador: ${validCount} códigos válidos detectados.`);
        return validCount > 0 ? maxValue : null;
      };

      const getNextCounter = async () => {
        const counterRef = doc(db, "counters", "codigos");
        const attemptTransaction = () =>
          runTransaction(db, async (transaction) => {
            const snapshot = await transaction.get(counterRef);
            if (!snapshot.exists()) {
              throw new Error("COUNTER_MISSING");
            }
            const lastNumber = Number(snapshot.data().lastNumber);
            if (!Number.isFinite(lastNumber)) {
              throw new Error("COUNTER_INVALID");
            }
            const nextValue = lastNumber + 1;
            transaction.set(counterRef, { lastNumber: nextValue }, { merge: true });
            return nextValue;
          });

        try {
          return await attemptTransaction();
        } catch (error) {
          if (!["COUNTER_MISSING", "COUNTER_INVALID"].includes(error.message)) {
            throw error;
          }
          console.warn("Counter inválido o inexistente. Buscando fallback en prendas.");
          const fallbackMax = await fetchFallbackMax();
          if (!Number.isFinite(fallbackMax)) {
            throw new Error(
              "No se pudo inicializar el contador de códigos. Revisa counters/codigos en Firestore."
            );
          }
          await runTransaction(db, async (transaction) => {
            transaction.set(counterRef, { lastNumber: fallbackMax }, { merge: true });
          });
          console.info(`Counter inicializado con ${fallbackMax}. Reintentando transacción.`);
          return attemptTransaction();
        }
      };

      registroForm.addEventListener("submit", async (event) => {
        event.preventDefault();
        setRegistroStatus("");

        if (!ensureRequired()) {
          return;
        }

        const colorClave = registroColor.value;
        const tallaClave = registroTalla.value;
        try {
          registroSubmit.disabled = true;
          const nextValue = await getNextCounter();
          const consecutivo = String(nextValue).padStart(5, "0");
          const codigo = `HA${consecutivo}/${colorClave}-${tallaClave}`;

          const costoValue = Number(document.getElementById("registro-costo").value);
          const createdByValue = document.getElementById("registro-created-by").value.trim();
          const detallesValue = registroDetalles.value.trim();
          const tipoNombre = getSelectedName(registroProducto).trim();
          const colorNombre = getSelectedName(registroColor).trim();
          const tallaNombre = getSelectedName(registroTalla).trim();
          let descripcion = [tipoNombre, colorNombre, tallaNombre].filter(Boolean).join(" ");
          if (detallesValue) {
            descripcion = descripcion ? `${descripcion} - ${detallesValue}` : detallesValue;
          }

          const data = {
            code: codigo,
            tipo: registroProducto.value,
            proveedor: registroProveedor.value,
            color: colorClave,
            talla: tallaClave,
            descripcion: descripcion || null,
            detalles: detallesValue || null,
            creadoPor: createdByValue || null,
            createdAt: serverTimestamp()
          };

          if (Number.isFinite(costoValue) && costoValue > 0) {
            data.costo = costoValue;
          }

          const codeQuery = query(prendasRef, where("code", "==", codigo));
          const legacyQuery = query(prendasRef, where("codigo", "==", codigo));
          const [codeSnapshot, legacySnapshot] = await Promise.all([
            getDocs(codeQuery),
            getDocs(legacyQuery)
          ]);
          const duplicateFound = !codeSnapshot.empty || !legacySnapshot.empty;

          await addDoc(prendasRef, data);

          registroCodigo.textContent = codigo;
          registroResult.classList.remove("hidden");
          if (duplicateFound) {
            setRegistroStatus("Ya existe, se guardará como duplicado.", "warning");
          } else {
            setRegistroStatus("Prenda guardada correctamente.", "success");
          }
        } catch (error) {
          const message =
            error?.message?.includes("contador")
              ? error.message
              : "No se pudo generar el código. Intenta nuevamente.";
          setRegistroStatus(message, "error");
          console.error(error);
        } finally {
          registroSubmit.disabled = false;
        }
      });

      registroCopy.addEventListener("click", async () => {
        try {
          await navigator.clipboard.writeText(registroCodigo.textContent.trim());
          setRegistroStatus("Código copiado al portapapeles.", "success");
        } catch (error) {
          setRegistroStatus("No se pudo copiar el código.", "error");
          console.error(error);
        }
      });

      registroReset.addEventListener("click", () => {
        registroForm.reset();
        registroResult.classList.add("hidden");
        setRegistroStatus("");
      });

      zplForm.addEventListener("submit", (event) => {
        event.preventDefault();
        setZplStatus("");

        const codigo = document.getElementById("zpl-codigo").value.trim();
        const cantidadValue = Number(document.getElementById("zpl-cantidad").value);
        const cantidad = Number.isFinite(cantidadValue) && cantidadValue > 0 ? cantidadValue : 1;

        const formatoValido = /^HA\d{5}\/[A-Z0-9]+-[A-Z0-9]+$/i.test(codigo);
        if (!codigo || !formatoValido) {
          setZplStatus("Ingresa un código válido (HA{NNNNN}/COLOR-TALLA).", "error");
          zplOutput.classList.add("hidden");
          return;
        }

        const template = `^XA
^CF0,40
^FO30,30^FD${codigo}^FS
^CF0,30
^FO30,90^FDPRECIO$^FS
^FO30,140^BQN,2,6^FDLA,${codigo}^FS
^XZ`;

        const zpl = Array.from({ length: cantidad }, () => template).join("\n");
        zplTextarea.value = zpl;
        zplOutput.classList.remove("hidden");
        setZplStatus("ZPL generado correctamente.", "success");
      });

      zplCopy.addEventListener("click", async () => {
        try {
          await navigator.clipboard.writeText(zplTextarea.value);
          setZplStatus("ZPL copiado al portapapeles.", "success");
        } catch (error) {
          setZplStatus("No se pudo copiar el ZPL.", "error");
          console.error(error);
        }
      });

      const init = async () => {
        try {
          setRegistroStatus("Cargando diccionario...");
          registroSubmit.disabled = true;
          setSelectLoading(registroProducto, "Cargando...");
          setSelectLoading(registroProveedor, "Cargando...");
          setSelectLoading(registroColor, "Cargando...");
          setSelectLoading(registroTalla, "Cargando...");

          const dictionary = await loadDictionary();
          const dictionaryReady = !dictionary.empty && dictionary.missing.length === 0;
          if (dictionary.empty) {
            setRegistroStatus("Diccionario vacío: corre el workflow Seed Firestore.", "error");
          } else if (dictionary.missing.length) {
            setRegistroStatus(
              `Faltan datos en: ${dictionary.missing.join(", ")}.`,
              "error"
            );
          } else {
            setRegistroStatus("");
          }

          if (dictionary.tipos.length) {
            fillSelect(
              registroProducto,
              dictionary.tipos.sort((a, b) => a.clave.localeCompare(b.clave))
            );
          } else {
            setSelectLoading(registroProducto, "Sin opciones disponibles");
          }

          if (dictionary.proveedores.length) {
            fillSelect(
              registroProveedor,
              dictionary.proveedores.sort((a, b) => a.clave.localeCompare(b.clave))
            );
          } else {
            setSelectLoading(registroProveedor, "Sin opciones disponibles");
          }

          if (dictionary.colores.length) {
            fillSelect(
              registroColor,
              dictionary.colores.sort((a, b) => a.clave.localeCompare(b.clave))
            );
          } else {
            setSelectLoading(registroColor, "Sin opciones disponibles");
          }

          if (dictionary.tallas.length) {
            fillSelect(
              registroTalla,
              dictionary.tallas.sort((a, b) => a.clave.localeCompare(b.clave))
            );
          } else {
            setSelectLoading(registroTalla, "Sin opciones disponibles");
          }

          registroSubmit.disabled = !dictionaryReady;
        } catch (error) {
          setRegistroStatus("No pudimos cargar el diccionario.", "error");
          registroSubmit.disabled = true;
          console.error(error);
        }
      };

      init();
    </script>
  </body>
</html>
