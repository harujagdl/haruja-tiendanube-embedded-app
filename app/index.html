<!DOCTYPE html>
<html lang="es">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <title>Panel Haruja ‚Äì TD | Panel</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/qrcodejs/1.0.0/qrcode.min.js"></script>
    <style>
      :root {
        color-scheme: light;
        --bg: #f6f7fb;
        --card: #ffffff;
        --text: #1f2937;
        --muted: #6b7280;
        --primary: #1f6feb;
        --primary-dark: #1a55b5;
        --border: #e5e7eb;
        --shadow: 0 10px 24px rgba(15, 23, 42, 0.08);
        --radius: 16px;
      }

      * {
        box-sizing: border-box;
      }

      body {
        margin: 0;
        font-family: "Inter", "Segoe UI", system-ui, -apple-system, sans-serif;
        color: var(--text);
        background: var(--bg);
      }

      .app {
        min-height: 100vh;
        display: flex;
        flex-direction: column;
      }

      header {
        background: var(--card);
        border-bottom: 1px solid var(--border);
        padding: 24px 32px;
      }

      header h1 {
        margin: 0 0 8px;
        font-size: 24px;
      }

      header p {
        margin: 0;
        color: var(--muted);
        font-size: 14px;
      }

      main {
        padding: 32px;
        display: flex;
        flex-direction: column;
        gap: 24px;
      }

      .grid {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(220px, 1fr));
        gap: 20px;
      }

      .card {
        background: var(--card);
        border: 1px solid var(--border);
        border-radius: var(--radius);
        box-shadow: var(--shadow);
        padding: 20px;
        display: flex;
        flex-direction: column;
        gap: 12px;
        text-decoration: none;
        color: inherit;
      }

      .card h2 {
        margin: 0;
        font-size: 18px;
      }

      .card p {
        margin: 0;
        color: var(--muted);
        font-size: 14px;
      }

      .card .cta {
        margin-top: auto;
        font-weight: 600;
        color: var(--primary);
      }

      .section {
        background: var(--card);
        border: 1px solid var(--border);
        border-radius: var(--radius);
        box-shadow: var(--shadow);
        padding: 24px;
      }

      .section h2 {
        margin: 0 0 12px;
        font-size: 20px;
      }

      .section p {
        margin: 0 0 20px;
        color: var(--muted);
        font-size: 14px;
      }

      .form {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(180px, 1fr));
        gap: 16px;
        align-items: end;
      }

      label {
        display: block;
        font-size: 13px;
        color: var(--muted);
        margin-bottom: 6px;
      }

      input {
        width: 100%;
        padding: 10px 12px;
        border-radius: 10px;
        border: 1px solid var(--border);
        font-size: 14px;
      }

      select {
        width: 100%;
        padding: 10px 12px;
        border-radius: 10px;
        border: 1px solid var(--border);
        font-size: 14px;
        background: #fff;
      }

      button {
        padding: 12px 16px;
        border-radius: 12px;
        border: none;
        background: var(--primary);
        color: #fff;
        font-weight: 600;
        cursor: pointer;
      }

      button:hover {
        background: var(--primary-dark);
      }

      button.secondary {
        background: #e5e7eb;
        color: #1f2937;
      }

      button.secondary:hover {
        background: #d1d5db;
      }

      .status {
        font-size: 14px;
        color: var(--muted);
        min-height: 20px;
      }

      .status.success {
        color: #15803d;
      }

      .status.error {
        color: #b91c1c;
      }

      .status.warning {
        color: #b45309;
      }

      .result-card {
        margin-top: 16px;
        padding: 16px;
        border-radius: 12px;
        border: 1px solid var(--border);
        background: #f8fafc;
      }

      .result-code {
        font-size: 24px;
        font-weight: 700;
        letter-spacing: 0.5px;
        margin: 8px 0 16px;
      }

      .result-actions {
        display: flex;
        flex-wrap: wrap;
        gap: 12px;
      }

      .muted {
        color: var(--muted);
        font-size: 13px;
      }

      .zpl-output {
        margin-top: 16px;
      }

      textarea {
        width: 100%;
        min-height: 180px;
        padding: 12px;
        border-radius: 12px;
        border: 1px solid var(--border);
        font-size: 13px;
        font-family: "SFMono-Regular", "Consolas", "Liberation Mono", monospace;
      }

      .hidden {
        display: none;
      }

      table {
        width: 100%;
        border-collapse: collapse;
        font-size: 14px;
      }

      th,
      td {
        padding: 10px 12px;
        border-bottom: 1px solid var(--border);
        text-align: left;
      }


      th {
        color: var(--muted);
        font-weight: 600;
      }

      th[data-filter-key] {
        white-space: nowrap;
      }

      .th-filter {
        position: relative;
        display: inline-flex;
        align-items: center;
        gap: 8px;
      }

      .filter-btn {
        position: relative;
        border: 1px solid #d0d5dd;
        background: linear-gradient(180deg, #ffffff 0%, #f8fafc 100%);
        border-radius: 10px;
        font-size: 12px;
        width: 26px;
        height: 26px;
        line-height: 1;
        color: #475467;
        cursor: pointer;
        display: inline-flex;
        align-items: center;
        justify-content: center;
        box-shadow: 0 1px 2px rgba(16, 24, 40, 0.08);
        transition: all 0.2s ease;
      }

      .filter-btn:hover {
        border-color: #98a2b3;
        background: #f8fafc;
        transform: translateY(-1px);
      }

      .filter-btn:focus-visible {
        outline: 3px solid #bfdbfe;
        outline-offset: 1px;
      }

      .filter-btn.active {
        border-color: #2563eb;
        color: #2563eb;
        background: #eff6ff;
      }

      .filter-btn.active::after {
        content: "";
        position: absolute;
        top: -2px;
        right: -2px;
        width: 8px;
        height: 8px;
        border-radius: 999px;
        background: #2563eb;
        border: 2px solid #fff;
      }

      .filter-popover {
        position: fixed;
        z-index: 9999;
        width: 300px;
        max-height: min(430px, calc(100vh - 24px));
        overflow: hidden;
        border-radius: 16px;
        border: 1px solid #e4e7ec;
        background: #fff;
        box-shadow:
          0 20px 36px rgba(16, 24, 40, 0.14),
          0 4px 10px rgba(16, 24, 40, 0.08);
        display: grid;
        grid-template-rows: auto auto auto 1fr auto;
        font-size: 13px;
      }

      .filter-popover.range-popover {
        width: clamp(280px, 30vw, 320px);
        grid-template-rows: auto auto auto;
      }

      .filter-popover .popover-head {
        padding: 12px 12px 8px;
        border-bottom: 1px solid #f2f4f7;
      }

      .filter-popover .popover-title {
        margin: 0;
        font-size: 13px;
        color: #344054;
        font-weight: 600;
      }

      .filter-popover .search-wrap {
        position: relative;
        padding: 10px 12px 0;
      }

      .filter-popover .search-wrap::before {
        content: "‚åï";
        position: absolute;
        left: 21px;
        top: 18px;
        font-size: 14px;
        opacity: 0.7;
      }

      .filter-popover input[type="text"],
      .filter-popover input[type="number"] {
        width: 100%;
        border: 1px solid #d0d5dd;
        border-radius: 10px;
        font-size: 13px;
        padding: 8px 10px;
        background: #fff;
      }

      .filter-popover .search-wrap input {
        padding-left: 28px;
      }

      .filter-popover input:focus-visible {
        outline: 3px solid #bfdbfe;
        border-color: #93c5fd;
      }

      .filter-popover .meta {
        font-size: 12px;
        color: #667085;
        padding: 8px 12px 0;
      }

      .filter-popover .option-all {
        display: flex;
        align-items: center;
        gap: 8px;
        padding: 8px 12px;
        font-size: 13px;
        border-bottom: 1px solid #f2f4f7;
      }

      .filter-popover .options {
        padding: 8px;
        max-height: 220px;
        overflow: auto;
      }

      .filter-popover .option-row {
        display: flex;
        align-items: center;
        gap: 8px;
        padding: 7px 8px;
        border-radius: 8px;
        font-size: 13px;
        cursor: pointer;
      }

      .filter-popover .option-row input {
        margin: 0;
        width: 15px;
        height: 15px;
        flex: 0 0 auto;
      }

      .filter-popover .option-row:hover {
        background: #f2f4f7;
      }

      .filter-popover .actions {
        position: sticky;
        bottom: 0;
        display: flex;
        gap: 8px;
        padding: 10px;
        border-top: 1px solid #f2f4f7;
        background: #fff;
      }

      .filter-popover .actions button {
        flex: 1;
        padding: 9px 12px;
        border-radius: 10px;
        font-size: 13px;
      }

      .filter-popover .range-fields {
        display: grid;
        grid-template-columns: repeat(2, minmax(0, 1fr));
        gap: 10px;
        padding: 10px 12px;
      }

      .filter-popover .range-field {
        display: grid;
        gap: 6px;
      }

      .filter-popover .range-field label {
        margin: 0;
        font-size: 12px;
        color: #667085;
      }

      .filter-popover .hint {
        font-size: 12px;
        color: #b45309;
        padding: 0 12px 8px;
      }

      .panel-controls {
        display: flex;
        flex-direction: column;
        gap: 16px;
        margin-bottom: 16px;
      }

      .filters-grid {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(180px, 1fr));
        gap: 12px;
        align-items: end;
      }

      .filters-grid .price-range {
        display: flex;
        gap: 8px;
      }

      .filters-grid .price-range input {
        width: 100%;
      }

      .filters-grid .inline-toggle {
        display: flex;
        align-items: center;
        gap: 10px;
        padding: 10px 12px;
        border-radius: 10px;
        border: 1px solid var(--border);
        background: #f8fafc;
      }

      .filters-grid .inline-toggle input {
        width: auto;
      }

      .counters {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(140px, 1fr));
        gap: 12px;
      }

      .counter-card {
        border-radius: 12px;
        padding: 12px;
        border: 1px solid var(--border);
        background: #f8fafc;
      }

      .counter-card span {
        display: block;
        font-size: 12px;
        color: var(--muted);
      }

      .counter-card strong {
        font-size: 18px;
      }

      .table-wrapper {
        width: 100%;
        overflow-x: auto;
      }

      .badge {
        display: inline-block;
        padding: 4px 8px;
        border-radius: 999px;
        font-size: 12px;
        font-weight: 600;
      }

      .badge-success {
        background: #e8f5e9;
        color: #166534;
      }

      .badge-danger {
        background: #fee2e2;
        color: #b91c1c;
      }

      .row-new {
        background: #f5f8ff;
      }

      .row-old {
        background: #f3fbf6;
      }

      .loading-row {
        display: flex;
        align-items: center;
        gap: 8px;
        padding: 8px 0;
        color: #667085;
        font-size: 13px;
      }

      .loading-spinner {
        width: 14px;
        height: 14px;
        border-radius: 50%;
        border: 2px solid #e4e7ec;
        border-top-color: #667085;
        animation: spin 0.8s linear infinite;
      }

      @keyframes spin {
        to {
          transform: rotate(360deg);
        }
      }

      .loading-text {
        user-select: none;
      }

      .alert {
        padding: 12px 16px;
        border-radius: 10px;
        border: 1px solid #fecaca;
        background: #fef2f2;
        color: #991b1b;
        font-size: 14px;
      }

      .pagination {
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin-top: 16px;
        gap: 12px;
        flex-wrap: wrap;
      }

      .pagination span {
        color: var(--muted);
        font-size: 14px;
      }

      .pagination button {
        min-width: 120px;
      }

      .pagination .page-indicator {
        font-weight: 600;
        color: var(--text);
      }



      .admin-create-card {
        grid-column: 1 / -1;
        border: 1px solid #e5e7eb;
        background: #f8fafc;
        border-radius: 12px;
        padding: 12px;
        display: grid;
        gap: 10px;
      }

      .admin-create-card .admin-create-title {
        font-size: 13px;
        font-weight: 600;
        color: #374151;
      }

      .admin-create-card .admin-create-grid {
        display: grid;
        grid-template-columns: repeat(2, minmax(0, 1fr));
        gap: 12px;
      }

      @media (max-width: 720px) {
        .admin-create-card .admin-create-grid {
          grid-template-columns: 1fr;
        }
      }

      .admin-create-card small {
        color: #6b7280;
        font-size: 12px;
      }
      .admin-optional {
        display: flex;
        align-items: center;
        justify-content: space-between;
        gap: 12px;
        flex-wrap: wrap;
        padding: 12px;
        border-radius: 12px;
        border: 1px dashed #d1d5db;
        background: #f8fafc;
      }

      #dbCodigosSection .admin-only{display:none !important;}
    body.is-admin .admin-only{display:table-cell !important;}
    body.is-admin .admin-only.flex{display:flex !important;}

    /* Ensure table stays inside module and scrolls horizontally on small screens */
    #dbCodigosSection .table-wrapper{max-width:100%; overflow-x:auto; border-radius:16px;}
    #dbCodigosSection table{width:100%; border-collapse:separate; border-spacing:0;}
#dbCodigosSection th, #dbCodigosSection td{padding:10px 10px; font-size:13px;}
#dbCodigosSection th{white-space:nowrap;}
    #dbCodigosSection .table-toolbar{position:sticky; top:0; background:transparent;}


      #dbCodigosSection.admin-enabled .admin-only {
        display: revert !important;
      }

      #dbCodigosSection .admin-panel {
        display: grid;
        gap: 12px;
        padding: 12px;
        border-radius: 12px;
        border: 1px solid #e5e7eb;
        background: #f8fafc;
        margin-top: 12px;
      }

      #dbCodigosSection .admin-login-row {
        display: flex;
        gap: 8px;
        flex-wrap: wrap;
        align-items: center;
      }

      #dbCodigosSection .admin-login-row input {
        flex: 1;
        min-width: 180px;
      }

      #dbCodigosSection .admin-actions {
        display: grid;
        gap: 8px;
      }

      #dbCodigosSection .admin-actions.hidden {
        display: none;
      }

      #dbCodigosSection .rowEditBtn {
        width: 32px;
        height: 32px;
        border-radius: 10px;
        border: 1px solid #d0d5dd;
        background: #fff;
        color: #344054;
        display: inline-flex;
        align-items: center;
        justify-content: center;
        font-size: 16px;
        padding: 0;
      }

      #dbCodigosSection .rowEditBtn:hover {
        background: #f2f4f7;
      }

      #dbCodigosSection .col-actions {
        text-align: center;
      }

      #dbCodigosSection .labels-panel {
        display: grid;
        gap: 10px;
        margin: 0 10px 12px;
        padding: 12px;
        border: 1px solid #d0d5dd;
        border-radius: 12px;
        background: #f8fafc;
      }

      #dbCodigosSection .labels-panel.hidden {
        display: none;
      }

      #dbCodigosSection .labels-panel-title {
        font-size: 13px;
        font-weight: 700;
      }

      #dbCodigosSection .labels-scope-options {
        display: flex;
        flex-wrap: wrap;
        gap: 14px;
        font-size: 13px;
      }

      #dbCodigosSection .labels-scope-options label {
        display: inline-flex;
        align-items: center;
        gap: 6px;
        margin: 0;
      }

      #dbCodigosSection .col-select {
        width: 36px;
        text-align: center;
      }

      #dbCodigosSection .row-select {
        width: 16px;
        height: 16px;
      }

      .edit-modal {
        position: fixed;
        inset: 0;
        z-index: 10000;
      }

      .edit-modal.hidden {
        display: none;
      }

      .edit-modal-overlay {
        position: absolute;
        inset: 0;
        background: rgba(15, 23, 42, 0.5);
      }

      .edit-modal-sheet {
        position: relative;
        z-index: 1;
        max-width: 520px;
        margin: 8vh auto;
        background: #fff;
        border-radius: 16px;
        border: 1px solid #e5e7eb;
        box-shadow: 0 20px 40px rgba(15, 23, 42, 0.25);
        padding: 16px;
      }

      .edit-modal-grid {
        display: grid;
        grid-template-columns: repeat(2, minmax(0, 1fr));
        gap: 12px;
      }

      .edit-modal-meta {
        margin-top: 12px;
        display: grid;
        grid-template-columns: repeat(2, minmax(0, 1fr));
        gap: 8px;
        font-size: 13px;
        color: #475467;
      }

      .edit-modal-actions {
        margin-top: 14px;
        display: flex;
        justify-content: flex-end;
        gap: 8px;
      }

      @media (max-width: 640px) {
        #dbCodigosSection .rowEditBtn {
          width: 40px;
          height: 40px;
        }

        .edit-modal-sheet {
          position: fixed;
          left: 0;
          right: 0;
          bottom: 0;
          margin: 0;
          max-width: none;
          border-radius: 16px 16px 0 0;
        }
      }

      @media (max-width: 600px) {
        header,
        main {
          padding: 20px;
        }
      }
    
/* --- Pro filters bar (compact, professional) --- */
#dbCodigosSection .panel-controls{
  display:flex;
  flex-direction:column;
  gap:14px;
  margin-top: 16px;
}
#dbCodigosSection .filters-grid{
  display:grid;
  grid-template-columns: 2.2fr 1.2fr;
  gap:14px;
}
#dbCodigosSection .filters-grid label{
  font-size: 12px;
  color: var(--muted, #6b7280);
  margin-bottom: 6px;
}
#dbCodigosSection .filters-row{
  display:flex;
  flex-wrap:wrap;
  gap:12px;
  align-items:center;
  justify-content:space-between;
}
#dbCodigosSection .filters-row .inline-toggle{
  display:flex;
  align-items:center;
  gap:10px;
  margin:0;
}
#dbCodigosSection .filters-actions{
  display:flex;
  gap:10px;
  align-items:center;
}
#dbCodigosSection #prendas-precio-apply,
#dbCodigosSection #prendas-filters-clear{
  height: 44px;
  padding: 0 16px;
  border-radius: 14px;
}
#dbCodigosSection .filters-pagesize > div{
  display:flex;
  flex-direction:column;
}
#dbCodigosSection .filters-pagesize label{
  font-size:12px;
  color: var(--muted, #6b7280);
  margin-bottom: 6px;
}

/* --- Table toolbar + Admin button --- */
.table-toolbar{
  display:flex;
  align-items:center;
  justify-content:space-between;
  gap:12px;
  padding: 10px 10px 12px 10px;
}
.admin-mode-btn{
  height: 38px;
  padding: 0 14px;
  border-radius: 12px;
  border: 1px solid rgba(15, 23, 42, 0.14);
  background: #ffffff;
  color: #0f172a;
  font-weight: 600;
  cursor: pointer;
}
.admin-mode-btn.is-on{
  background: #0b5cff;
  border-color: #0b5cff;
  color: #ffffff;
}
.admin-mode-btn.is-disabled{
  opacity: 0.55;
  cursor: not-allowed;
}

/* Reduce extra whitespace around db header */
#dbCodigosSection h2{ margin-bottom: 6px; }
#dbCodigosSection p{ margin-top: 0; }

/* --- Cleaner filter bar tweaks --- */
#dbCodigosSection .filters-grid{
  grid-template-columns: 2.4fr 1.2fr;
}
#dbCodigosSection .filters-row{
  justify-content: flex-start;
}
#dbCodigosSection .filters-actions{ display:none; } /* we auto-apply */
#dbCodigosSection #prendas-precio-apply.hidden{ display:none !important; }
#dbCodigosSection #prendas-filters-clear{
  height: 38px;
  padding: 0 12px;
  border-radius: 12px;
}
#dbCodigosSection .filters-pagesize{
  margin-left: auto;
}
#dbCodigosSection .inline-toggle label{
  color: var(--muted, #6b7280);
}
/* Reduce section padding a bit */
#dbCodigosSection .section{ padding-top: 12px; }

/* --- Minimal mode tweaks --- */
#admin-panel{ display:none !important; }
.dashboard-stats, .stats-grid, #statsSection{ display:none !important; }

#dbCodigosSection .panel-controls{ padding-bottom: 6px; }

/* --- Align checkbox with search + price --- */
#dbCodigosSection .filters-grid{
  grid-template-columns: 2.3fr 1.2fr auto;
  align-items: end;
}
#dbCodigosSection .inline-toggle-top{
  display:flex;
  gap:10px;
  align-items:center;
  padding-bottom: 8px;
}
#dbCodigosSection .inline-toggle-top label{
  margin:0;
  font-size: 13px;
  color: var(--muted, #6b7280);
}

/* --- Page size under table (pagination bar) --- */
.pagination{
  display:flex;
  flex-wrap:wrap;
  gap:12px;
  align-items:center;
}
.page-size-inline{
  display:flex;
  gap:8px;
  align-items:center;
}
.page-size-inline label{
  font-size:12px;
  color: var(--muted, #6b7280);
}
.page-size-inline select{
  height: 36px;
  border-radius: 12px;
  padding: 0 10px;
}

/* Make reset button subtler */
button.secondary.small{
  height: 38px;
  padding: 0 12px;
  border-radius: 12px;
  background: rgba(15, 23, 42, 0.06);
}

/* --- Filters row aligned (single line) --- */
#dbCodigosSection .filters-grid.filters-grid-4{
  display:grid;
  grid-template-columns: 2.2fr 0.9fr 0.9fr auto;
  gap:14px;
  align-items:end;
}
#dbCodigosSection .filters-grid.filters-grid-4 input[type="text"],
#dbCodigosSection .filters-grid.filters-grid-4 input[type="number"]{
  height: 46px;
  border-radius: 14px;
}
#dbCodigosSection .filters-grid.filters-grid-4 label{
  font-size:12px;
  color: var(--muted, #6b7280);
  margin-bottom: 6px;
}
#dbCodigosSection .filters-grid.filters-grid-4 .inline-toggle-top{
  height: 46px;
  padding: 0 14px;
  border-radius: 14px;
  border: 1px solid rgba(15, 23, 42, 0.08);
  background: rgba(15, 23, 42, 0.02);
  display:flex;
  align-items:center;
  gap:10px;
  margin-bottom: 0;
}
#dbCodigosSection .filters-grid.filters-grid-4 .inline-toggle-top label{
  margin:0;
  font-size: 13px;
}

/* --- Minimal header filters --- */
#dbCodigosSection .filters-grid.filters-grid-min{
  display:grid;
  grid-template-columns: 1fr auto;
  gap: 12px;
  align-items:center;
  margin-top: 14px;
}
#dbCodigosSection .filters-grid.filters-grid-min input{
  height: 46px;
  border-radius: 14px;
}
.btn-more-filters{
  height: 46px;
  padding: 0 14px;
  border-radius: 14px;
  border: 1px solid rgba(15, 23, 42, 0.14);
  background: #fff;
  color: #0f172a;
  font-weight: 600;
  cursor:pointer;
  display:flex;
  align-items:center;
  gap:10px;
}
.btn-more-filters .dot{
  width: 8px;
  height: 8px;
  border-radius: 999px;
  background: transparent;
}
.btn-more-filters.has-active .dot{ background: #0b5cff; }

.more-filters-panel{
  margin-top: 10px;
  padding: 12px;
  border-radius: 16px;
  border: 1px solid rgba(15, 23, 42, 0.08);
  background: rgba(15, 23, 42, 0.02);
}
.more-filters-row{
  display:flex;
  flex-wrap:wrap;
  gap: 10px;
  align-items:center;
}
.more-filters-row input[type="number"]{
  height: 42px;
  border-radius: 14px;
  min-width: 140px;
}
.check-pill{
  height: 42px;
  padding: 0 12px;
  border-radius: 999px;
  border: 1px solid rgba(15, 23, 42, 0.08);
  background: #fff;
  display:flex;
  align-items:center;
  gap:10px;
  color: rgba(15, 23, 42, 0.75);
}
.check-pill input{ width:16px; height:16px; }
.btn-link{
  background: transparent;
  border: none;
  color: rgba(15, 23, 42, 0.65);
  font-weight: 600;
  cursor: pointer;
  padding: 6px 8px;
}
.btn-link:hover{ text-decoration: underline; }

/* --- Keep table inside section --- */
.table-wrapper{
  width: 100%;
  overflow-x: auto;
  -webkit-overflow-scrolling: touch;
}
#tablaPrendas{
  width: 100%;
  min-width: 1100px;
}

/* --- Page size at very bottom --- */
.page-size-bottom{
  display:flex;
  justify-content:center;
  align-items:center;
  gap:10px;
  margin-top: 10px;
  padding-bottom: 6px;
  color: rgba(15, 23, 42, 0.65);
  font-size: 12px;
}
.page-size-bottom select{
  height: 36px;
  border-radius: 12px;
  padding: 0 10px;
}

/* --- Keep table inside same white module --- */
#dbCodigosSection{
  background: #ffffff;
  border: 1px solid rgba(15, 23, 42, 0.08);
  border-radius: 24px;
  padding: 28px;
  box-shadow: 0 10px 30px rgba(15, 23, 42, 0.06);
  overflow: hidden; /* keeps table/pagination visually inside */
}
@media (max-width: 900px){
  #dbCodigosSection{ padding: 18px; border-radius: 20px; }
}
/* ensure table scroll stays inside the module */
#dbCodigosSection .table-wrapper{
  border-radius: 18px;
  border: 1px solid rgba(15, 23, 42, 0.08);
  background: #fff;
  overflow-x: auto;
}
#dbCodigosSection table{ min-width: 980px; } /* horizontal scroll instead of breaking */

/* --- Unified module (filters + table) --- */
.db-module{
  background:#fff;
  border:1px solid rgba(15, 23, 42, 0.08);
  border-radius:24px;
  padding:28px;
  box-shadow:0 10px 30px rgba(15, 23, 42, 0.06);
  overflow:hidden; /* keeps table/pagination inside */
}
@media (max-width: 900px){
  .db-module{ padding:18px; border-radius:20px; }
}

/* Remove inner "card" look so it doesn't feel like 2 m√≥dulos */
#dbCodigosSection .panel-controls{
  background: transparent !important;
  border: 0 !important;
  box-shadow: none !important;
  padding: 0 !important;
  margin: 14px 0 14px !important;
}

/* Table stays within module on any screen */
#dbCodigosSection .table-wrapper{
  width: 100%;
  max-width: 100%;
  border-radius: 18px;
  border: 1px solid rgba(15, 23, 42, 0.08);
  background: #fff;
  overflow-x: auto;
  -webkit-overflow-scrolling: touch;
}
#dbCodigosSection table{
  width: 100%;
  min-width: 980px; /* horizontal scroll instead of breaking layout */
}
@media (max-width: 1100px){
  #dbCodigosSection table{ min-width: 900px; }
}
@media (max-width: 900px){
  #dbCodigosSection table{ min-width: 760px; }
}
@media (max-width: 700px){
  #dbCodigosSection table{ min-width: 680px; }
}

/* Bottom controls inside module */
.page-size-bottom{ padding-bottom: 0; }

/* === Make the WHOLE DB section a single module (so table doesn't look "outside") === */
#base-datos-codigos{
  background:#fff;
  border:1px solid rgba(15,23,42,0.08);
  border-radius:24px;
  padding:28px;
  box-shadow:0 10px 30px rgba(15,23,42,0.06);
  overflow:hidden;
  margin-bottom: 18px;
}
@media (max-width: 900px){
  #base-datos-codigos{ padding:18px; border-radius:20px; }
}

/* Turn the inner wrapper into a simple layout container (no second card) */
#base-datos-codigos > #dbCodigosSection.db-module{
  background:transparent !important;
  border:0 !important;
  box-shadow:none !important;
  padding:0 !important;
  border-radius:0 !important;
  overflow:visible !important;
}

/* Ensure table stays within module and scrolls horizontally when needed */
#base-datos-codigos .table-wrapper{
  width:100%;
  max-width:100%;
  overflow-x:auto;
  -webkit-overflow-scrolling:touch;
  border:1px solid rgba(15,23,42,0.08);
  border-radius:18px;
  background:#fff;
}
#base-datos-codigos table{
  width:100%;
  min-width: 980px;
}
@media (max-width: 900px){
  #base-datos-codigos table{ min-width: 760px; }
}
@media (max-width: 700px){
  #base-datos-codigos table{ min-width: 680px; }
}

/* Keep bottom bar inside the module */
#base-datos-codigos .pagination-bar,
#base-datos-codigos .page-size-bottom{
  max-width:100%;
}

/* --- DB meta + loader (auto-added) --- */
.prendas-meta{display:flex;gap:12px;align-items:center;justify-content:space-between;margin:10px 0 0 0;}
.prendas-count{font-size:14px;color:#6b7280;}
.prendas-alert{padding:10px 12px;border-radius:12px;border:1px solid #e5e7eb;background:#fff7ed;color:#9a3412;font-size:14px;}
.db-loader{display:flex;align-items:center;gap:10px;margin:12px 0;}
.spinner{width:16px;height:16px;border-radius:50%;border:2px solid #e5e7eb;border-top-color:#2563eb;animation:spin 1s linear infinite;}
@keyframes spin{to{transform:rotate(360deg);}}


/* --- DB module unified + responsive table --- */
#dbCodigosSection { overflow: hidden; }
#dbCodigosSection .db-controls { padding: 0 24px 10px 24px; }
#dbCodigosSection .db-controls-row { display:flex; gap:12px; align-items:center; padding: 18px 24px 0 24px; }
#dbCodigosSection .db-controls-row .input { flex:1; min-width: 220px; }
#dbCodigosSection .more-filters-panel { margin: 10px 24px 0 24px; padding: 14px; border:1px solid #e6e8ef; border-radius:16px; background:#fff; }
#dbCodigosSection .more-filters-grid { display:flex; gap:12px; align-items:center; flex-wrap:wrap; }
#dbCodigosSection .more-filters-grid .input { width: 160px; }
#dbCodigosSection .check { display:flex; gap:10px; align-items:center; padding: 10px 12px; border:1px solid #e6e8ef; border-radius:14px; background:#fafbff; }
#dbCodigosSection .check span { color:#6b7280; }
#dbCodigosSection .more-filters-actions { display:flex; justify-content:space-between; gap:12px; align-items:center; margin-top: 12px; flex-wrap:wrap; }

#dbCodigosSection .admin-only { display:none !important; }
#dbCodigosSection.admin-enabled .admin-only { display:table-cell !important; }
#dbCodigosSection .admin-only-block { display:none !important; width: 100%; }
#dbCodigosSection.admin-enabled .admin-only-block { display:block !important; }

#dbCodigosSection .db-metrics { display:grid; grid-template-columns: repeat(3, minmax(0,1fr)); gap:12px; padding: 14px 24px 0 24px; }
#dbCodigosSection .metric { background:#fafbff; border:1px solid #e6e8ef; border-radius:16px; padding:14px; }
#dbCodigosSection .metric-label { color:#6b7280; font-size:14px; }
#dbCodigosSection .metric-value { font-size:20px; font-weight:700; margin-top:2px; }

#dbCodigosSection .db-table { padding: 18px 24px 24px 24px; }
#dbCodigosSection .db-table-toolbar { display:flex; justify-content:flex-end; margin-bottom: 10px; }
#dbCodigosSection .table-wrap { width:100%; overflow:auto; border:1px solid #e6e8ef; border-radius:16px; background:#fff; }
#dbCodigosSection table.table { width: 100%; border-collapse: collapse; min-width: 980px; table-layout: fixed; }
#dbCodigosSection table.table th,
#dbCodigosSection table.table td {
  padding: 6px 8px;
  font-size: 13px;
  line-height: 1.25;
  vertical-align: middle;
}
#dbCodigosSection table.table td {
  overflow: hidden;
  text-overflow: ellipsis;
  white-space: nowrap;
}
#dbCodigosSection table.table .col-orden { min-width: 70px; width: 70px; }
#dbCodigosSection table.table .col-codigo { min-width: 140px; width: 140px; }
#dbCodigosSection table.table .col-descripcion { min-width: 320px; max-width: 420px; }
#dbCodigosSection table.table .col-tipo { min-width: 110px; }
#dbCodigosSection table.table .col-color { min-width: 110px; }
#dbCodigosSection table.table .col-talla { min-width: 90px; }
#dbCodigosSection table.table .col-proveedor { min-width: 130px; }
#dbCodigosSection table.table .col-status { min-width: 120px; }
#dbCodigosSection table.table .col-disponibilidad { min-width: 130px; }
#dbCodigosSection table.table .col-fecha { min-width: 120px; }
#dbCodigosSection table.table .col-pventa { min-width: 110px; }
#dbCodigosSection table.table .badge { padding: 2px 6px; font-size: 11px; }
#dbCodigosSection thead th { position: sticky; top: 0; background:#fff; z-index:2; }
#dbCodigosSection .th-filter { margin-left: 8px; border:1px solid #e6e8ef; background:#fff; border-radius: 10px; padding: 4px 8px; cursor:pointer; }
#dbCodigosSection .pager { display:flex; justify-content:space-between; align-items:center; gap:12px; margin-top: 12px; flex-wrap:wrap; }
#dbCodigosSection .pager-bottom { display:flex; justify-content:flex-end; margin-top: 10px; }
#dbCodigosSection .pager-size { display:flex; gap:10px; align-items:center; color:#6b7280; }

@media (max-width: 900px) {
  #dbCodigosSection .db-controls-row { flex-direction:column; align-items:stretch; }
  #dbCodigosSection .db-controls-row .btn { width:100%; }
  #dbCodigosSection .db-metrics { grid-template-columns: 1fr; }
  #dbCodigosSection .more-filters-grid .input { width: 100%; min-width: 180px; }
}

/* Admin-only cols hidden by default */
.admin-only{ display:none; }
body.admin-on .admin-only{ display:table-cell; }

#dbCodigosSection .th-sort {
  display: inline-flex;
  align-items: center;
  gap: 6px;
  padding: 8px 10px;
  border-radius: 12px;
  border: 1px solid #e5e7eb;
  background: #fff;
  color: #475467;
  font-weight: 600;
  cursor: pointer;
}
#dbCodigosSection .th-sort:active {
  transform: translateY(1px);
}
#dbCodigosSection .tableWrap {
  width: 100%;
  overflow-x: auto;
  -webkit-overflow-scrolling: touch;
}
#dbCodigosSection table.table {
  width: 100%;
  border-collapse: separate;
  border-spacing: 0;
  min-width: 920px;
}
#dbCodigosSection table.table .cell-desc {
  max-width: 320px;
  white-space: nowrap;
  overflow: hidden;
  text-overflow: ellipsis;
}
#dbCodigosSection .pager-right {
  display: flex;
  gap: 8px;
  flex-wrap: wrap;
}
@media (max-width: 768px) {
  #dbCodigosSection table.table th,
  #dbCodigosSection table.table td {
    padding: 8px 8px;
    font-size: 13px;
  }
  #dbCodigosSection .th-sort {
    padding: 10px 12px;
    white-space: nowrap;
  }
  #dbCodigosSection table.table .badge {
    padding: 1px 5px;
    font-size: 10px;
  }
  #dbCodigosSection table.table .cell-desc { max-width: 220px; }
  #dbCodigosSection .pager,
  #dbCodigosSection .pager-bottom {
    justify-content: flex-start;
    flex-wrap: wrap;
  }
  .filter-popover.mobile-sheet {
    left: 0 !important;
    right: 0 !important;
    bottom: 0 !important;
    top: auto !important;
    width: 100vw;
    max-width: 100vw;
    max-height: 78vh;
    border-radius: 16px 16px 0 0;
  }
}

#printRoot {
  display: none;
}

.label-page {
  width: 51mm;
  height: 25mm;
  page-break-after: always;
  overflow: hidden;
  background: #fff;
  color: #000;
  padding: 1.5mm;
  display: grid;
  grid-template-columns: 1fr 17.5mm;
  gap: 1.5mm;
  font-family: Arial, sans-serif;
}

.label-left {
  display: flex;
  flex-direction: column;
}

.label-code-title,
.label-price-title {
  font-size: 3.2mm;
  font-weight: 700;
  line-height: 1;
}

.label-sku {
  margin-top: 1mm;
  min-height: 3mm;
  font-size: 2.2mm;
  line-height: 1.1;
}

.label-price-title {
  margin-top: auto;
}

.label-price-value {
  margin-top: 0.8mm;
  font-size: 5.8mm;
  font-weight: 800;
  line-height: 1;
}

.label-right {
  display: flex;
  flex-direction: column;
  align-items: flex-end;
  justify-content: space-between;
}

.label-qr {
  width: 14mm;
  height: 14mm;
}

.label-qr img,
.label-qr canvas {
  width: 100% !important;
  height: 100% !important;
  display: block;
}

.label-logo {
  width: 13.5mm;
  height: 3.8mm;
  object-fit: contain;
}

@page {
  size: 51mm 25mm;
  margin: 0;
}

@media print {
  body {
    margin: 0;
    background: #fff;
    box-shadow: none;
  }

  body * {
    visibility: hidden;
  }

  #printRoot,
  #printRoot * {
    visibility: visible;
  }

  #printRoot {
    display: block;
  }
}

</style>
  </head>
  <body>
    <div style="
  background: red;
  color: white;
  padding: 12px;
  text-align: center;
  font-weight: bold;
">
  TEST DEPLOY NUEVO üöÄ
</div>
    <div class="app">
      <header>
        <h1>Panel Haruja-Prueba </h1>
        <p>Gesti√≥n r√°pida de prendas, precios y etiquetas dentro de Tiendanube.</p>
      </header>

      <main>
        <section class="grid">
          <a class="card" href="#registro">
            <h2>Registro de nuevas prendas</h2>
            <p>Carga nuevas prendas y atributos esenciales en minutos.</p>
            <span class="cta">Empezar</span>
          </a>
          <a class="card" href="#precios">
            <h2>Asignar precios</h2>
            <p>Define precios finales por categor√≠a y canal de venta.</p>
            <span class="cta">Configurar</span>
          </a>
          <a class="card" href="#calculadora">
            <h2>Calculadora de precios</h2>
            <p>Calcula m√°rgenes y proyecciones de rentabilidad.</p>
            <span class="cta">Abrir</span>
          </a>
          <a class="card" href="#etiquetas">
            <h2>Impresi√≥n de etiquetas (ZPL)</h2>
            <p>Genera etiquetas listas para impresi√≥n y control interno.</p>
            <span class="cta">Preparar</span>
          </a>
          <a class="card" href="#base-datos-codigos">
            <h2>Base de datos c√≥digos HarujaGdl</h2>
            <p>Consulta c√≥digos existentes, nuevos y detalles clave de prendas.</p>
            <span class="cta">Abrir</span>
          </a>
        </section>

        <section class="section" id="registro">
          <h2>Registro de nuevas prendas</h2>
          <p>Selecciona los atributos clave para generar el c√≥digo y guardar la prenda en Firestore.</p>
          <form class="form" id="registro-form">
            <div>
              <label for="registro-producto">Tipo / Producto *</label>
              <select id="registro-producto" name="producto" required>
                <option value="">Seleccionar</option>
              </select>
            </div>
            <div>
              <label for="registro-proveedor">Proveedor *</label>
              <select id="registro-proveedor" name="proveedor" required>
                <option value="">Seleccionar</option>
              </select>
            </div>
            <div>
              <label for="registro-color">Color *</label>
              <select id="registro-color" name="color" required>
                <option value="">Seleccionar</option>
              </select>
            </div>
            <div>
              <label for="registro-talla">Talla *</label>
              <select id="registro-talla" name="talla" required>
                <option value="">Seleccionar</option>
              </select>
            </div>
            <div>
              <label for="registro-created-by">Creado por (opcional)</label>
              <input id="registro-created-by" name="createdBy" type="text" placeholder="Nombre" />
            </div>
            <div>
              <label for="registro-detalles">Detalles (opcional)</label>
              <input id="registro-detalles" name="detalles" type="text" placeholder="Ej: Pelly estampada" />
            </div>
            <div id="adminCreateFields" class="admin-create-card hidden" aria-hidden="true">
              <div class="admin-create-title">Admin (opcional)</div>
              <div class="admin-create-grid">
                <div>
                  <label for="adminCreateCosto">Costo</label>
                  <input id="adminCreateCosto" type="number" step="0.01" min="0" placeholder="Costo (admin)" />
                </div>
                <div>
                  <label for="adminCreatePVenta">P.Venta override (opcional)</label>
                  <input id="adminCreatePVenta" type="number" step="0.01" min="0" placeholder="P.Venta override (admin)" />
                </div>
              </div>
              <small>Solo en Modo Admin</small>
            </div>
            <button type="submit">Generar c√≥digo</button>
          </form>
          <p id="registro-status" class="status"></p>
          <div id="registro-result" class="result-card hidden">
            <span class="muted">C√≥digo generado</span>
            <div id="registro-codigo" class="result-code">HA00000/--</div>
            <div class="result-actions">
              <button type="button" id="registro-copy">Copiar</button>
              <button type="button" id="registro-reset">Crear otro</button>
            </div>
          </div>
        </section>

        <section class="section" id="etiquetas">
          <h2>Impresi√≥n de etiquetas</h2>
          <p>Ingresa el c√≥digo y la cantidad de etiquetas a generar.</p>
          <form class="form" id="zpl-form">
            <div>
              <label for="labelSkuInput">C√≥digo (SKU)</label>
              <input id="labelSkuInput" name="codigo" type="text" placeholder="HA2A007/NG-M" />
            </div>
            <div>
              <label for="labelQtyInput">Cantidad</label>
              <input id="labelQtyInput" name="cantidad" type="number" min="1" value="1" />
            </div>
            <button id="labelPrintBtn" type="submit">Imprimir etiqueta</button>
          </form>
          <p id="zpl-status" class="status"></p>
        </section>

        <div id="printRoot" aria-hidden="true"></div>

        <section class="section" id="base-datos-codigos">
          <div id="dbCodigosSection" class="card section-card">
  <div class="card-header">
    <div class="card-title">Base de datos c√≥digos HarujaGdl</div>
    <div class="card-subtitle">Explora la base de prendas 2025 con b√∫squeda, filtros y estado de novedades.</div>
  </div>

  <div class="db-controls">
    <div class="db-controls-row">
      <input id="prendas-search" class="input" type="text" placeholder="Buscar: c√≥digo o descripci√≥n (ej. HA12A003)" />
      <button id="btnMoreFilters" class="btn btn-ghost" type="button">
        M√°s filtros <span id="moreFiltersDot" class="dot" style="display:none"></span>
      </button>
    </div>

    <div id="moreFiltersPanel" class="more-filters-panel" style="display:none">
      <div class="more-filters-grid">
        <input id="prendas-precio-min" class="input" type="number" inputmode="numeric" placeholder="Precio m√≠n" />
        <input id="prendas-precio-max" class="input" type="number" inputmode="numeric" placeholder="Precio m√°x" />
        <label class="check">
          <input id="prendas-precio-sin" type="checkbox" />
          <span>Incluir sin precio</span>
        </label>
      </div>

      <div class="more-filters-actions">
        <button id="prendas-filters-clear" class="btn btn-muted" type="button">Limpiar</button>
        <button id="prendas-precio-apply" class="btn btn-primary" type="button">Aplicar</button>

        <div class="admin-only-block admin-import">
          </div>
      </div>
    </div>

    <div class="db-metrics">
      <div class="metric"><div class="metric-label">Total</div><div id="prendas-total" class="metric-value">‚Äî</div></div>
      <div class="metric"><div class="metric-label">Nuevos (7 d√≠as)</div><div id="prendas-nuevos" class="metric-value">‚Äî</div></div>
      <div class="metric"><div class="metric-label">Existentes</div><div id="prendas-existentes" class="metric-value">‚Äî</div></div>
    </div>
  </div>

  <div class="db-table">
    <div class="db-table-toolbar">
      <button id="admin-mode-btn" class="btn btn-ghost" type="button">Modo admin</button>
      <button id="labels-btn" class="btn btn-ghost" type="button">Etiquetas</button>
      <button id="admin-logout-quick" class="btn btn-muted hidden" type="button">Salir de admin</button>
    </div>
    <div id="labels-panel" class="labels-panel hidden" aria-hidden="true">
      <div class="labels-panel-title">Imprimir etiquetas</div>
      <div class="labels-scope-options">
        <label><input type="radio" name="labels-scope" value="page" checked /> P√°gina actual</label>
        <label><input type="radio" name="labels-scope" value="filtered" /> Todo filtrado</label>
        <label><input type="radio" name="labels-scope" value="selected" /> Seleccionados</label>
      </div>
      <button id="labels-print-btn" class="btn btn-primary" type="button">Imprimir (Ctrl+P)</button>
    </div>

    <div id="prendas-loader" class="loader-row" style="display:none">
      <div class="spinner"></div>
      <div class="loader-text">Cargando base de datos‚Ä¶</div>
    </div>
    <div id="prendas-alert" class="prendas-alert" style="display:none; margin:10px 0;"></div>
    <template id="prendas-empty-template"><tr><td colspan="99" style="padding:18px; text-align:center; color:#6b7280;">Sin resultados</td></tr></template>

    <div class="table-wrap tableWrap">
      <table id="tablaPrendas" class="table">
        <thead>
                  <tr>
                    <th class="col-select"><input id="select-all-labels" type="checkbox" aria-label="Seleccionar todo" /></th>
                    <th class="col-orden" data-filter-key="orden"><button id="ordenSortBtn" class="th-sort" type="button" aria-label="Ordenar por Orden">Orden <span id="ordenSortIcon">‚Üë</span></button></th>
                    <th class="col-codigo">C√≥digo</th>
                    <th class="col-descripcion">Descripci√≥n</th>
                    <th class="col-tipo" data-filter-key="tipo"><span class="th-filter">Tipo <button type="button" class="filter-btn" data-open-header-filter="tipo" aria-label="Filtrar Tipo">‚åÑ</button></span></th>
                    <th class="col-color" data-filter-key="color"><span class="th-filter">Color <button type="button" class="filter-btn" data-open-header-filter="color" aria-label="Filtrar Color">‚åÑ</button></span></th>
                    <th class="col-talla" data-filter-key="talla"><span class="th-filter">Talla <button type="button" class="filter-btn" data-open-header-filter="talla" aria-label="Filtrar Talla">‚åÑ</button></span></th>
                    <th class="col-proveedor" data-filter-key="proveedor"><span class="th-filter">Proveedor <button type="button" class="filter-btn" data-open-header-filter="proveedor" aria-label="Filtrar Proveedor">‚åÑ</button></span></th>
                    <th class="col-status" data-filter-key="status"><span class="th-filter">Status <button type="button" class="filter-btn" data-open-header-filter="status" aria-label="Filtrar Status">‚åÑ</button></span></th>
                    <th class="col-disponibilidad" data-filter-key="disponibilidad"><span class="th-filter">Disponibilidad <button type="button" class="filter-btn" data-open-header-filter="disponibilidad" aria-label="Filtrar Disponibilidad">‚åÑ</button></span></th>
                    <th class="col-fecha" data-filter-key="fecha"><span class="th-filter">Fecha <button type="button" class="filter-btn" data-open-header-filter="fecha" aria-label="Filtrar Fecha">‚åÑ</button></span></th>
                    <th class="col-pventa" data-filter-key="pventa"><span class="th-filter">P. Venta <button type="button" class="filter-btn" data-open-header-filter="pventa" aria-label="Filtrar P. Venta">‚åÑ</button></span></th>
                    <th class="admin-only">(Admin) Costo</th>
                    <th class="admin-only">(Admin) Margen</th>
                    <th class="admin-only">(Admin) Utilidad</th>
                    <th class="admin-only col-actions">Acciones</th>
                  </tr>
                </thead>
        <tbody id="prendas-tbody">
          <tr id="loadingRow" data-db-loader>
            <td colspan="17" class="muted" style="padding:14px 16px;">Cargando‚Ä¶</td>
          </tr>
          <tr id="noResultsRow" data-empty-row style="display:none">
            <td colspan="17" class="muted" style="padding:14px 16px;">Sin resultados.</td>
          </tr>
</tbody>
      </table>
<template id="emptyRowTemplate">
  <tr data-empty-row>
    <td colspan="99" style="padding:14px; color:#667085; text-align:center;">Sin resultados con estos filtros.</td>
  </tr>
</template>

    </div>

    <div class="pager">
      <div id="prendas-showing" class="pager-left">Mostrando 0</div>
      <div id="prendas-page" class="pager-center">P√°gina 1</div>
      <div class="pager-right">
        <button id="prendas-prev" class="btn btn-primary" type="button">Anterior</button>
        <button id="prendas-next" class="btn btn-primary" type="button">Siguiente</button>
      </div>
    </div>

    <div class="pager-bottom">
      <div class="pager-spacer"></div>
      <div class="pager-size">
        <span>Registros por p√°gina</span>
        <select id="prendas-page-size" class="select">
          <option value="40">40</option>
          <option value="80" selected>80</option>
          <option value="120">120</option>
          <option value="200">200</option>
        </select>
      </div>
    </div>
  </div>
</div>

<div id="editModal" class="edit-modal hidden" aria-hidden="true">
  <div id="editModalOverlay" class="edit-modal-overlay"></div>
  <div class="edit-modal-sheet" role="dialog" aria-modal="true" aria-labelledby="editModalTitle">
    <h3 id="editModalTitle" style="margin:0 0 12px;">Editar fila</h3>
    <div class="edit-modal-grid">
      <div>
        <label for="editPVenta">P.Venta override (vac√≠o = usar p√∫blico)</label>
        <input id="editPVenta" type="number" min="0" step="0.01" />
      </div>
      <div>
        <label for="editCosto">Costo</label>
        <input id="editCosto" type="number" min="0" step="0.01" />
      </div>
    </div>
    <div class="edit-modal-meta">
      <div>Utilidad: <strong id="editUtilidadPreview">$0.00</strong></div>
      <div>Margen: <strong id="editMargenPreview">0.0%</strong></div>
    </div>
    <p id="editModalError" class="status error hidden" style="margin:10px 0 0;"></p>
    <div class="edit-modal-actions">
      <button id="editModalCancel" type="button" class="secondary">Cancelar</button>
      <button id="editModalSave" type="button">Guardar</button>
    </div>
  </div>
</div>

<script type="module">
      import { initializeApp } from "https://www.gstatic.com/firebasejs/9.22.2/firebase-app.js";
      import {
        getFirestore,
        initializeFirestore,
        collection,
        doc,
        getDoc,
        getDocs,
        query,
        orderBy,
        documentId,
        runTransaction,
        serverTimestamp,
        setDoc,
        deleteField,
        startAfter,
        where,
        limit,
        persistentLocalCache,
        persistentMultipleTabManager,
        memoryLocalCache
      } from "https://www.gstatic.com/firebasejs/9.22.2/firebase-firestore.js";
      import {
        getAuth,
        GoogleAuthProvider,
        onAuthStateChanged,
        signInWithPopup,
        signOut
      } from "https://www.gstatic.com/firebasejs/9.22.2/firebase-auth.js";

      // ‚úÖ CONFIG FIREBASE (EDITA SOLO ESTE BLOQUE SI CAMBIAS DE PROYECTO)
// Pega aqu√≠ TU CONFIG real de Firebase (Project settings > Your apps > Firebase SDK snippet > Config)
const firebaseConfig = window.__HARUJA_FIREBASE_CONFIG__ || {
  apiKey: "AIzaSyAK5_MuMseQm58AeRZlrPtGyEZ216-Xkno",
  authDomain: "haruja-tiendanube.firebaseapp.com",
  projectId: "haruja-tiendanube",
  // OJO: Firebase ahora puede mostrarlo como *.firebasestorage.app; cualquiera de los 2 suele funcionar.
  storageBucket: "haruja-tiendanube.firebasestorage.app",
  messagingSenderId: "396461447684",
  appId: "1:396461447684:web:770dc3bc9bbb40a2873351"
};

if (!firebaseConfig?.apiKey || firebaseConfig.apiKey.includes("PEGA_AQUI") || firebaseConfig.apiKey.includes("REEMPLAZAR")) {
  console.error("[Firebase] Falta configurar firebaseConfig.apiKey (y/o appId/messagingSenderId).");
}
console.log("[Firebase] projectId:", firebaseConfig?.projectId);

      if(!firebaseConfig.apiKey || String(firebaseConfig.apiKey).includes("PEGA") || String(firebaseConfig.apiKey).includes("AQUI")){
  console.warn("[Firebase] Falta configurar firebaseConfig.apiKey (y/o appId/messagingSenderId).");
}
const app = initializeApp(firebaseConfig);
const auth = getAuth(app);
      const googleProvider = new GoogleAuthProvider();
      let db;
      try {
        db = initializeFirestore(app, {
          localCache: persistentLocalCache({
            tabManager: persistentMultipleTabManager()
          })
        });
      } catch (error) {
        console.warn(
          "[Firestore] Persistencia multi-tab no disponible, usando cach√© en memoria",
          error?.code || error?.message
        );
        db = initializeFirestore(app, {
          localCache: memoryLocalCache()
        });
      }
      let prendasRef = collection(db, "prendas");
      const registroForm = document.getElementById("registro-form");
      const registroStatus = document.getElementById("registro-status");
      const registroResult = document.getElementById("registro-result");
      const registroCodigo = document.getElementById("registro-codigo");
      const registroCopy = document.getElementById("registro-copy");
      const registroReset = document.getElementById("registro-reset");
      const registroSubmit = registroForm.querySelector("button[type='submit']");
      const registroProducto = document.getElementById("registro-producto");
      const registroProveedor = document.getElementById("registro-proveedor");
      const registroColor = document.getElementById("registro-color");
      const registroTalla = document.getElementById("registro-talla");
      const registroDetalles = document.getElementById("registro-detalles");
      const adminCreateFields = document.getElementById("adminCreateFields");
      const adminCreateCostoInput = document.getElementById("adminCreateCosto");
      const adminCreatePVentaInput = document.getElementById("adminCreatePVenta");

      const zplForm = document.getElementById("zpl-form");
      const zplStatus = document.getElementById("zpl-status");
      const labelSkuInput = document.getElementById("labelSkuInput");
      const labelQtyInput = document.getElementById("labelQtyInput");
      const labelPrintBtn = document.getElementById("labelPrintBtn");
      const printRoot = document.getElementById("printRoot");

      const prendasSearch = document.getElementById("prendas-search");
      const headerFilterButtons = document.querySelectorAll("[data-open-header-filter]");
      const ordenSortBtn = document.getElementById("ordenSortBtn");
      const ordenSortIcon = document.getElementById("ordenSortIcon");
      const prendasYear = document.getElementById("prendas-year");
      const prendasMonth = document.getElementById("prendas-month");
      const prendasPrecioMin = document.getElementById("prendas-precio-min");
      const prendasPrecioMax = document.getElementById("prendas-precio-max");
      const prendasPrecioSin = document.getElementById("prendas-precio-sin");
      const prendasPrecioApply = document.getElementById("prendas-precio-apply");
      const prendasFiltersClear = document.getElementById("prendas-filters-clear");
      const prendasPageSize = document.getElementById("prendas-page-size");
      const prendasTotal = document.querySelector("[data-count-total]") || document.getElementById("prendas-total");
      const prendasNuevos = document.getElementById("prendas-nuevos");
      const prendasExistentes = document.getElementById("prendas-existentes");
      const prendasCountNote = document.getElementById("prendas-count-note");
      const prendasTable =
        document.querySelector("[data-prendas-table]") ||
        document.getElementById("tablaPrendas");
      const prendasTbody =
        prendasTable?.querySelector("tbody") ||
        document.querySelector("[data-prendas-tbody]") ||
        document.getElementById("prendas-tbody");
      const prendasShowing =
        document.querySelector("[data-count-shown]") || document.getElementById("prendas-showing");
      const prendasPrev = document.getElementById("prendas-prev");
      const prendasNext = document.getElementById("prendas-next");
      const prendasPageIndicator = document.getElementById("prendas-page-indicator");
      const loadingRow =
        document.querySelector("[data-db-loader]") || document.getElementById("loadingRow");
      const prendasEmptyRow =
        document.querySelector("[data-empty-row]") || document.getElementById("noResultsRow");
      const prendasAlert = document.getElementById("prendas-alert");
      const prendasPanel = document.getElementById("base-datos-codigos");
      const dbCodigosSection = document.getElementById("dbCodigosSection");
      const adminToggleDb = prendasPanel.querySelector("#adminToggleDb");
      const labelsButton = document.getElementById("labels-btn");
      const labelsPanel = document.getElementById("labels-panel");
      const labelsPrintButton = document.getElementById("labels-print-btn");
      const labelsScopeInputs = document.querySelectorAll("input[name='labels-scope']");
      const selectAllLabelsCheckbox = document.getElementById("select-all-labels");

      const adminSplitButton = document.getElementById("admin-split-collections");
      const adminLoginButton = document.getElementById("admin-login");
      const adminLogoutButton = document.getElementById("admin-logout");
      const adminLoginStatus = document.getElementById("admin-login-status");
      const adminPanel = document.getElementById("admin-panel");
      const adminActions = document.getElementById("admin-actions");
            const adminOptional = document.getElementById("admin-optional");
      const adminOptionalToggle = document.getElementById("admin-optional-toggle");
      const adminLogoutQuickButton = document.getElementById("admin-logout-quick");
      const editModal = document.getElementById("editModal");
      const editModalOverlay = document.getElementById("editModalOverlay");
      const editPVentaInput = document.getElementById("editPVenta");
      const editCostoInput = document.getElementById("editCosto");
      const editUtilidadPreview = document.getElementById("editUtilidadPreview");
      const editMargenPreview = document.getElementById("editMargenPreview");
      const editModalError = document.getElementById("editModalError");
      const editModalSaveButton = document.getElementById("editModalSave");
      const editModalCancelButton = document.getElementById("editModalCancel");
      console.assert(prendasTable, "No existe tabla de prendas");
      console.assert(prendasTbody, "No existe tbody de prendas");
      console.assert(loadingRow, "No existe loader de prendas");
      console.assert(prendasShowing, "No existe contador de prendas mostradas");
      console.assert(prendasTotal, "No existe contador total de prendas");
      console.assert(prendasEmptyRow, "No existe template de filas vac√≠as");

      const setRegistroStatus = (message, type = "") => {
        registroStatus.textContent = message;
        registroStatus.className = `status ${type}`.trim();
      };

      const setZplStatus = (message, type = "") => {
        zplStatus.textContent = message;
        zplStatus.className = `status ${type}`.trim();
      };

      const safeString = (value) => {
        if (value === null || value === undefined) return "";
        return String(value);
      };

      const normalizeText = (value) =>
        safeString(value)
          .toLowerCase()
          .trim()
          .normalize("NFD")
          .replace(/[\u0300-\u036f]/g, "");

      const normalizeDictionaryValue = (value) =>
        safeString(value).trim().replace(/\s+/g, " ");

      const normalizeSku = (input) =>
        safeString(input)
          .trim()
          .toUpperCase()
          .replace(/\s+/g, " ")
          .replace(/\//g, "__");

      const safeDocId = (codigo) => normalizeSku(codigo);

      const normalizeSkuPrefix = (input) =>
        safeString(input)
          .trim()
          .toLowerCase()
          .replace(/\s+/g, "");

      const toNumberOrNull = (value) => {
        if (value === null || value === undefined) return null;
        if (String(value).trim() === "") return null;
        const parsed = Number(value);
        return Number.isFinite(parsed) ? parsed : null;
      };

      const toNumber = (value) => toNumberOrNull(value);

      const debounce = (fn, wait = 200) => {
        let timeoutId;
        return (...args) => {
          if (timeoutId) {
            clearTimeout(timeoutId);
          }
          timeoutId = setTimeout(() => fn(...args), wait);
        };
      };

      const formatDateDDMMYYYY = (date) => {
        if (!(date instanceof Date) || Number.isNaN(date.getTime())) {
          return "--";
        }
        const day = String(date.getDate()).padStart(2, "0");
        const month = String(date.getMonth() + 1).padStart(2, "0");
        const year = date.getFullYear();
        return `${day}/${month}/${year}`;
      };

      const toDateValue = (value) => {
        if (!value) return null;
        if (value instanceof Date) return value;
        if (typeof value?.toDate === "function") return value.toDate();
        if (typeof value === "number") return new Date(value);
        if (typeof value === "string") {
          const parsed = new Date(value);
          return Number.isNaN(parsed.getTime()) ? null : parsed;
        }
        return null;
      };

      const parseDateTextValue = (value) => {
        const raw = safeString(value).trim();
        if (!raw) return null;
        const match = /^(\d{1,2})\/(\d{1,2})\/(\d{4})$/.exec(raw);
        if (!match) return null;
        const day = Number(match[1]);
        const month = Number(match[2]);
        const year = Number(match[3]);
        if (!Number.isInteger(day) || !Number.isInteger(month) || !Number.isInteger(year)) {
          return null;
        }
        const parsed = new Date(year, month - 1, day, 0, 0, 0, 0);
        if (
          Number.isNaN(parsed.getTime()) ||
          parsed.getFullYear() !== year ||
          parsed.getMonth() !== month - 1 ||
          parsed.getDate() !== day
        ) {
          return null;
        }
        return parsed;
      };

      const resolveComparableDate = (item) => {
        const d1 = toDateValue(item?.fechaAlta);
        if (d1 instanceof Date && d1.getTime() !== 0) return d1;

        const d2 = toDateValue(item?.fecha);
        if (d2 instanceof Date && d2.getTime() !== 0) return d2;

        return (
          parseDateTextValue(item?.fechaAltaTexto) ||
          parseDateTextValue(item?.fechaTexto) ||
          null
        );
      };

      const isInDateRange = (item, dateRange) => {
        if (!dateRange?.start || !dateRange?.end) return true;
        const value = resolveComparableDate(item);
        if (!value) return false;
        return value >= dateRange.start && value < dateRange.end;
      };

      const compareItemsByDateDesc = (a, b) => {
        const dateA = resolveComparableDate(a);
        const dateB = resolveComparableDate(b);
        const timeA = dateA ? dateA.getTime() : Number.NEGATIVE_INFINITY;
        const timeB = dateB ? dateB.getTime() : Number.NEGATIVE_INFINITY;
        if (timeA !== timeB) return timeB - timeA;
        return safeString(b?.codigo).localeCompare(safeString(a?.codigo));
      };

      const compareItemsByOrdenAsc = (a, b) => {
        const ordenA = toNumberOrNull(a?.orden);
        const ordenB = toNumberOrNull(b?.orden);
        const hasA = Number.isFinite(ordenA);
        const hasB = Number.isFinite(ordenB);

        if (hasA && hasB && ordenA !== ordenB) {
          return ordenA - ordenB;
        }
        if (hasA && !hasB) return -1;
        if (!hasA && hasB) return 1;

        return compareItemsByDateDesc(a, b);
      };

      const isNew = (createdAt, days = 7) => {
        const createdDate = toDateValue(createdAt);
        if (!createdDate) return false;
        const diff = Date.now() - createdDate.getTime();
        return diff <= days * 24 * 60 * 60 * 1000;
      };

      const buildOption = ({ clave, valor }) => {
        const option = document.createElement("option");
        option.value = clave;
        option.textContent = `${clave} - ${valor}`;
        option.dataset.nombre = valor;
        return option;
      };

      const setSelectLoading = (selectEl, message) => {
        selectEl.innerHTML = "";
        const option = document.createElement("option");
        option.value = "";
        option.textContent = message;
        selectEl.appendChild(option);
        selectEl.disabled = true;
      };

      const fillDictionarySelect = (selectEl, entries) => {
        selectEl.innerHTML = "";
        const placeholder = document.createElement("option");
        placeholder.value = "";
        placeholder.textContent = "Seleccionar";
        selectEl.appendChild(placeholder);
        entries.forEach((item) => selectEl.appendChild(buildOption(item)));
        selectEl.disabled = false;
      };

      const buildUniqueSelectValues = (values) => {
        const map = new Map();
        values.forEach((value) => {
          const trimmed = safeString(value).trim();
          if (!trimmed) return;
          const normalized = normalizeText(trimmed);
          if (!map.has(normalized)) {
            map.set(normalized, trimmed);
          }
        });
        return [...map.values()].sort((a, b) => a.localeCompare(b));
      };

      const fillSelect = (selectEl, values) => {
        const current = selectEl.value;
        selectEl.innerHTML = "";
        const allOption = document.createElement("option");
        allOption.value = "todos";
        allOption.textContent = "Todos";
        selectEl.appendChild(allOption);
        const uniqueValues = buildUniqueSelectValues(values);
        uniqueValues.forEach((value) => {
          const option = document.createElement("option");
          option.value = value;
          option.textContent = value;
          selectEl.appendChild(option);
        });
        if (current) {
          const normalizedCurrent = normalizeText(current);
          const matched = uniqueValues.find(
            (value) => normalizeText(value) === normalizedCurrent
          );
          selectEl.value = matched || "todos";
        } else {
          selectEl.value = "todos";
        }
        selectEl.disabled = false;
      };

      const collectOption = (map, codigo, nombre) => {
        if (!codigo) return;
        if (!map.has(codigo)) {
          map.set(codigo, nombre || codigo);
        }
      };

      const COLLECTIONS = {
        tipos: "diccionario_tipos",
        proveedores: "diccionario_proveedores",
        colores: "diccionario_colores",
        tallas: "diccionario_tallas"
      };

      const CODE_PATTERN = /^HA(\d+)([A-Z])(\d{3})\/([A-Z0-9]+)-([A-Z0-9]+)$/;
      const PRENDAS_PUBLIC_COLLECTION = "HarujaPrendas_2025_public";
      const PRENDAS_ADMIN_COLLECTION = "HarujaPrendas_2025_admin";
      const PRENDAS_MASTER_COLLECTION = "HarujaPrendas_2025";
      const API_BASE = `https://us-central1-${firebaseConfig.projectId}.cloudfunctions.net`;
      const SPLIT_FUNCTION_NAME = "migrateSplitCollections";
      const SPLIT_FUNCTION_URL = `${API_BASE}/${SPLIT_FUNCTION_NAME}`;
      const ADMIN_ALLOWLIST = new Set([
        "yair.tenorio.silva@gmail.com",
        "harujagdl@gmail.com",
        "harujagdl.ventas@gmail.com"
      ]);
      const PRENDAS_PAGE_SIZE_DEFAULT = 80;
      const PRENDAS_SCAN_PAGE_SIZE = 200;
      const PRENDAS_SCAN_MAX_PAGES = 12;
      const PRENDAS_DATE_FALLBACK_LIMIT = 1200;
      const PRENDAS_COUNT_SCAN_LIMIT = 2000;
      const PRENDAS_COUNT_BATCH_SIZE = 250;
      const PRENDAS_RENDER_CHUNK = 20;
      const PRENDAS_SEARCH_DEBOUNCE = 250;
      const PRENDAS_YEAR_MIN = 2024;
      const DATE_FIELD_PRIMARY = "fechaAlta";
      const DATE_FIELD_FALLBACK = "fecha";
      const QUERY_MODE_EQUALITY = "equality";
      const QUERY_MODE_DATE = "dateRange";
      const QUERY_MODE_PRICE = "priceRange";
      const MONTH_OPTIONS = [
        { value: 1, label: "Enero" },
        { value: 2, label: "Febrero" },
        { value: 3, label: "Marzo" },
        { value: 4, label: "Abril" },
        { value: 5, label: "Mayo" },
        { value: 6, label: "Junio" },
        { value: 7, label: "Julio" },
        { value: 8, label: "Agosto" },
        { value: 9, label: "Septiembre" },
        { value: 10, label: "Octubre" },
        { value: 11, label: "Noviembre" },
        { value: 12, label: "Diciembre" }
      ];
      const HEADER_FILTER_KEYS = [
        "status",
        "proveedor",
        "tipo",
        "color",
        "talla",
        "disponibilidad"
      ];
      const HEADER_RANGE_KEY = "pventa";
      const HEADER_POPOVER_MARGIN = 12;
      const HEADER_POPOVER_OFFSET = 8;
      const createEmptyHeaderFilters = () => ({
        status: new Set(),
        proveedor: new Set(),
        tipo: new Set(),
        color: new Set(),
        talla: new Set(),
        disponibilidad: new Set(),
        pventaMin: null,
        pventaMax: null,
        fechaYear: "",
        fechaMonth: ""
      });
      const DEFAULT_PRENDAS_SORT = Object.freeze({ key: "orden", dir: "asc" });
      const PRENDAS_SORT_KEY_STORAGE = "prendas_sort_key";
      const PRENDAS_SORT_DIR_STORAGE = "prendas_sort_dir";
      const ADMIN_VIEW_KEY = "haruja_admin_view";
      const DICTS_CACHE_KEY = "haruja_dicts_cache_v2";
      const METADATA_COUNTS_DOC = {
        collection: "metadata",
        doc: "counters"
      };

      let activePrendasPublicCollection = PRENDAS_PUBLIC_COLLECTION;
      let prendasPublicRef = collection(db, activePrendasPublicCollection);
      const prendasState = {
        filtered: [],
        baseRows: [],
        baseRowsCacheKey: "public",
        rowsAfterGlobal: [],
        rowsAfterAll: [],
        uniqueOptions: {},
        isAdmin: false,
        adminUser: null,
        adminEmail: "",
        adminByAuth: false,
        pageIndex: 0,
        hasNextPage: false,
        dicts: {
          proveedores: [],
          tipos: [],
          colores: [],
          tallas: []
        },
        dictsLoaded: false,
        isDone: false,
        isLoadingInitial: false,
        filters: {
          global: null,
          header: createEmptyHeaderFilters()
        },
        filtersActive: false,
        renderToken: 0,
        searchToken: 0,
        isSkuSearch: false,
        showingTotal: null,
        queryKey: "",
        reqId: 0,
        countToken: 0,
        metadataTotal: null,
        metadataLoaded: false,
        headerPopover: null,
        sort: { ...DEFAULT_PRENDAS_SORT },
        adminMap: new Map(),
        selected: new Set(),
        labelsScope: "page",
        labelsPanelOpen: false
      };
      prendasState.editing = null;
      let isBooting = true;

      const setPrendasCollections = ({ publicCollection }) => {
        activePrendasPublicCollection = publicCollection || PRENDAS_PUBLIC_COLLECTION;
        prendasRef = collection(db, activePrendasPublicCollection);
        prendasPublicRef = collection(db, activePrendasPublicCollection);
        console.log("[Prendas] ‚úÖ Usando colecci√≥n:", activePrendasPublicCollection);
      };

      const loadCategoryEntries = async (category, collectionName) => {
        const snapshot = await getDocs(collection(db, collectionName));
        if (snapshot.empty) {
          return { category, entries: [], empty: true };
        }

        const entries = snapshot.docs
          .map((docSnap) => {
            const data = docSnap.data() || {};
            const clave = data.clave || docSnap.id;
            const valor = data.valor || data.nombre || clave;
            return { clave, valor };
          })
          .filter((entry) => entry.clave && entry.valor);

        return { category, entries, empty: entries.length === 0 };
      };

      const loadDictionary = async () => {
        const categories = Object.keys(COLLECTIONS);
        const results = await Promise.all(
          categories.map((category) =>
            loadCategoryEntries(category, COLLECTIONS[category])
          )
        );
        const missing = results.filter((result) => result.empty).map((result) => result.category);

        return {
          empty: missing.length === categories.length,
          missing,
          tipos: results.find((result) => result.category === "tipos")?.entries ?? [],
          proveedores: results.find((result) => result.category === "proveedores")?.entries ?? [],
          colores: results.find((result) => result.category === "colores")?.entries ?? [],
          tallas: results.find((result) => result.category === "tallas")?.entries ?? []
        };
      };

      const loadDictionariesOnce = async () => {
        if (prendasState.dictsLoaded) {
          return prendasState.dicts;
        }
        const cached = localStorage.getItem(DICTS_CACHE_KEY);
        if (cached) {
          try {
            const parsed = JSON.parse(cached);
            if (
              parsed?.version === "2" &&
              parsed?.dicts &&
              ["proveedores", "tipos", "colores", "tallas"].every((key) =>
                Array.isArray(parsed.dicts[key])
              )
            ) {
              prendasState.dicts = parsed.dicts;
              prendasState.dictsLoaded = true;
              return prendasState.dicts;
            }
          } catch (error) {
            console.warn("Cache de diccionarios inv√°lida, recargando.", error);
          }
        }
        const categories = Object.keys(COLLECTIONS);
        const results = await Promise.all(
          categories.map(async (category) => {
            const snapshot = await getDocs(collection(db, COLLECTIONS[category]));
            const values = snapshot.docs
              .map((docSnap) => {
                const data = docSnap.data() || {};
                return (
                  data.valor ??
                  data.Valor ??
                  data.nombre ??
                  data.Nombre ??
                  data.clave ??
                  data.Clave ??
                  docSnap.id
                );
              })
              .map((value) => safeString(value).trim())
              .filter((value) => value);
            return { category, values };
          })
        );

        prendasState.dicts.proveedores =
          results.find((result) => result.category === "proveedores")?.values ?? [];
        prendasState.dicts.tipos =
          results.find((result) => result.category === "tipos")?.values ?? [];
        prendasState.dicts.colores =
          results.find((result) => result.category === "colores")?.values ?? [];
        prendasState.dicts.tallas =
          results.find((result) => result.category === "tallas")?.values ?? [];
        prendasState.dictsLoaded = true;
        localStorage.setItem(
          DICTS_CACHE_KEY,
          JSON.stringify({ version: "2", dicts: prendasState.dicts })
        );
        return prendasState.dicts;
      };

      const setLoading = (isLoading, message = "Cargando base de datos...") => {
        if (!loadingRow) return;
        const text = loadingRow.querySelector(".loading-text");
        if (text) {
          text.textContent = message;
        }
        loadingRow.style.display = isLoading ? "flex" : "none";
      };

      const setCounter = (shown, total) => {
        if (prendasShowing) {
          if (Number.isFinite(total)) {
            prendasShowing.textContent = `Mostrando ${shown} de ${total}`;
          } else {
            prendasShowing.textContent = `Mostrando ${shown} de ?`;
          }
        }
      };

      const resetCounters = () => {
        if (prendasTotal) {
          prendasTotal.textContent = "‚Äî";
        }
        if (prendasNuevos) {
          prendasNuevos.textContent = "‚Äî";
        }
        if (prendasExistentes) {
          prendasExistentes.textContent = "‚Äî";
        }
        if (prendasCountNote) {
          prendasCountNote.textContent = "";
        }
      };

      const updatePaginationUi = () => {
        if (!prendasPrev || !prendasNext || !prendasPageIndicator) return;
        const isSkuSearch = prendasState.isSkuSearch;
        const pageIndex = prendasState.pageIndex;
        const hasPrev = pageIndex > 0;
        const hasNext = prendasState.hasNextPage;
        const isBusy = prendasState.isLoadingInitial;
        prendasPrev.disabled = isSkuSearch || isBusy || !hasPrev;
        prendasNext.disabled = isSkuSearch || isBusy || !hasNext;
        prendasPrev.classList.toggle("hidden", isSkuSearch);
        prendasNext.classList.toggle("hidden", isSkuSearch);
        prendasPageIndicator.textContent = `P√°gina ${pageIndex + 1}`;
      };

      const formatApproxCount = (value, isApprox) =>
        isApprox ? `‚âà ${value}+` : `${value}`;

      const setApproxCounts = ({
        total,
        nuevos,
        existentes,
        isApprox,
        preferMetadata = false
      }) => {
        const useMetadata =
          preferMetadata && Number.isFinite(prendasState.metadataTotal);
        if (prendasTotal) {
          prendasTotal.textContent = useMetadata
            ? formatApproxCount(prendasState.metadataTotal, false)
            : Number.isFinite(total)
              ? formatApproxCount(total, isApprox)
            : "‚Äî";
        }
        if (prendasNuevos) {
          prendasNuevos.textContent = Number.isFinite(nuevos)
            ? formatApproxCount(nuevos, isApprox)
            : "‚Äî";
        }
        if (prendasExistentes) {
          prendasExistentes.textContent = Number.isFinite(existentes)
            ? formatApproxCount(existentes, isApprox)
            : "‚Äî";
        }
        if (prendasCountNote) {
          if (useMetadata) {
            prendasCountNote.textContent =
              "Total global le√≠do desde metadata (sin filtros).";
          } else {
            prendasCountNote.textContent = isApprox
              ? "Conteos aproximados para evitar errores de √≠ndices."
              : "Conteos basados en escaneo para evitar errores de √≠ndices.";
          }
        }
      };

      const setExactCountsFromItems = (items) => {
        const total = items.length;
        const nuevos = items.filter((item) => isNew(getPrendaDate(item))).length;
        const existentes = total - nuevos;
        setApproxCounts({ total, nuevos, existentes, isApprox: false });
      };

      const setPrendasAlert = (message = "", { isHtml = false } = {}) => {
        if (message) {
          if (isHtml) {
            prendasAlert.innerHTML = message;
          } else {
            prendasAlert.textContent = message;
          }
          prendasAlert.classList.remove("hidden");
        } else {
          prendasAlert.textContent = "";
          prendasAlert.classList.add("hidden");
        }
      };

      const isFullSku = (input) => {
        const value = safeString(input).trim().toUpperCase();
        if (!value) return false;
        return CODE_PATTERN.test(value);
      };

      const getPrendaDate = (data) => {
        const resolved =
          resolveComparableDate(data) ||
          toDateValue(data?.fechaAlta) ||
          toDateValue(data?.fecha) ||
          toDateValue(data?.updatedAt) ||
          toDateValue(data?.createdAt);

        if (resolved instanceof Date && resolved.getTime() === 0) return null;
        return resolved;
      };

      const normalizeStatus = (raw) => {
        const normalized = normalizeText(raw);
        if (!normalized) return "";
        if (normalized === "vendido") return "Vendido";
        if (["existente", "en stock", "disponible", "activo"].includes(normalized)) {
          return "Disponible";
        }
        return "";
      };

      const normalizeDisponibilidad = (raw, statusCanon) => {
        if (statusCanon === "Vendido") return "No disponible";
        const normalized = normalizeText(raw);
        if (!normalized) return "Disponible";
        if (["no disponible", "agotado", "sin stock", "0"].includes(normalized)) {
          return "No disponible";
        }
        if (["disponible", "en stock", "1", "si"].includes(normalized)) {
          return "Disponible";
        }
        return "Disponible";
      };

      const getBadgeClassByLabel = (label) => {
        if (label === "Disponible") return "badge-success";
        if (label === "No disponible" || label === "Vendido") return "badge-danger";
        return "";
      };

      const renderBadgeCell = (label) => {
        const cell = document.createElement("td");
        if (label === "--") {
          cell.textContent = "--";
          return cell;
        }
        cell.appendChild(buildBadge(label, getBadgeClassByLabel(label)));
        return cell;
      };

      const renderStatusCell = (status) =>
        renderBadgeCell(normalizeStatus(status) || "--");

      const renderDisponibilidadCell = (disponibilidad, status) =>
        renderBadgeCell(normalizeDisponibilidad(disponibilidad, status));

      const resolvePVenta = (data) => {
        const precioConIva = toNumberOrNull(
          pickFirstValue(data?.precioConIva, data?.precioConIVA)
        );
        const precioBase = toNumberOrNull(
          pickFirstValue(data?.precio, data?.Precio, data?.price)
        );
        const pVenta = toNumberOrNull(
          pickFirstValue(data?.pVenta, data?.PVenta, data?.p_venta)
        );
        if (Number.isFinite(precioConIva)) return precioConIva;
        if (Number.isFinite(precioBase)) return precioBase;
        if (Number.isFinite(pVenta)) return pVenta;
        return null;
      };

      const getPrendaPrice = (data) => resolvePVenta(data);

      const currencyFormatter = new Intl.NumberFormat("es-MX", {
        style: "currency",
        currency: "MXN",
        maximumFractionDigits: 2
      });

      const formatCurrency = (value) => currencyFormatter.format(value);

      const formatPercent = (value) => {
        if (!Number.isFinite(value)) return "";
        const n = Number(value);

        // Si viene como ratio (ej 0.742 => 74.2% o 1.111 => 111.1%)
        // Si viene como ‚Äúporcentaje‚Äù (ej 74.2), lo detectamos y lo tratamos.
        const ratio = (n > 5) ? (n / 100) : n;

        return (ratio * 100).toFixed(1) + "%";
      };

      const formatMoney = (value) => {
        const amount = Number(value);
        if (!Number.isFinite(amount)) return "--";
        return formatCurrency(amount);
      };

      const moneyFmt = (value) => formatMoney(value);
      const pctFmt = (value) => {
        const formatted = formatPercent(value);
        return formatted || "‚Äî";
      };

      const formatDateCell = (item) => {
        const date = getPrendaDate(item);
        return date ? formatDateDDMMYYYY(date) : "--";
      };

      const labelCurrencyFormatter = new Intl.NumberFormat("es-MX", {
        style: "currency",
        currency: "MXN",
        maximumFractionDigits: 0
      });

      const formatLabelPrice = (value) => {
        const amount = Number(value);
        if (!Number.isFinite(amount)) return "$0";
        return labelCurrencyFormatter.format(amount);
      };

      const getLabelPriceNumber = (row) => {
        const adminEnabled = isAdminViewEnabled();
        const override = toNumberOrNull(row?.pVentaOverride);
        const publicPrice = toNumberOrNull(row?.pVenta);
        if (adminEnabled && Number.isFinite(override)) {
          return override;
        }
        return Number.isFinite(publicPrice) ? publicPrice : null;
      };

      const updateSelectAllCheckbox = () => {
        if (!selectAllLabelsCheckbox) return;
        const rows = prendasState.filtered || [];
        const visibleIds = rows
          .map((row) => safeString(row.docId || row.id).trim())
          .filter((id) => id);
        if (!visibleIds.length) {
          selectAllLabelsCheckbox.checked = false;
          selectAllLabelsCheckbox.indeterminate = false;
          return;
        }
        const selectedCount = visibleIds.filter((id) => prendasState.selected.has(id)).length;
        selectAllLabelsCheckbox.checked = selectedCount === visibleIds.length;
        selectAllLabelsCheckbox.indeterminate = selectedCount > 0 && selectedCount < visibleIds.length;
      };

      const getRowsForScope = (scope = "page") => {
        if (scope === "filtered") {
          return prendasState.rowsAfterAll || [];
        }
        if (scope === "selected") {
          const allRows = prendasState.rowsAfterAll || [];
          return allRows.filter((row) => {
            const docId = safeString(row.docId || row.id).trim();
            return docId && prendasState.selected.has(docId);
          });
        }
        return prendasState.filtered || [];
      };

      const getLabelLogoSrc = () => {
        const preferred = document.querySelector("img#headerLogo, header img, .app img");
        if (preferred?.src) return preferred.src;
        const fallbackSvg = `<svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 320 90'><rect width='100%' height='100%' fill='white'/><text x='8' y='62' font-family='Arial,sans-serif' font-size='56' font-weight='700' fill='black'>HARUJA</text></svg>`;
        return `data:image/svg+xml;utf8,${encodeURIComponent(fallbackSvg)}`;
      };

      // Pega aqu√≠ el ZPL completo de Haruja2025.zpl si no lo inyectas por window.__HARUJA_2025_ZPL__.
      const HARUJA_2025_ZPL = window.__HARUJA_2025_ZPL__ || String.raw``;

      const extractGfaCommandFromZpl = (zplSource) => {
        const source = safeString(zplSource);
        const match = source.match(/\^GFA,(\d+),(\d+),(\d+),([\s\S]*?)\^FS/i);
        if (!match) {
          throw new Error("No se encontr√≥ bloque ^GFA ... ^FS en Haruja2025.zpl");
        }
        return {
          bytesTotal: Number(match[1]),
          bytesUsed: Number(match[2]),
          bytesPerRow: Number(match[3]),
          data: match[4]
        };
      };

      const isHexDigit = (char) => /^[0-9A-Fa-f]$/.test(char);

      const decodeCountCode = (char) => {
        if (char >= "0" && char <= "9") return Number(char);
        if (char >= "G" && char <= "Z") return char.charCodeAt(0) - 69;
        if (char >= "g" && char <= "z") return (char.charCodeAt(0) - 102) * 20;
        return null;
      };

      const decodeGfaToBitmap = ({ bytesTotal, bytesPerRow, data }) => {
        if (!Number.isInteger(bytesTotal) || !Number.isInteger(bytesPerRow) || bytesPerRow <= 0) {
          throw new Error("Par√°metros GFA inv√°lidos");
        }

        const rows = [];
        let row = [];
        let cursor = 0;
        const source = safeString(data).trim();

        const pushRow = () => {
          while (row.length < bytesPerRow) row.push(0x00);
          if (row.length > bytesPerRow) {
            throw new Error("Fila GFA excede bytesPerRow");
          }
          rows.push(row);
          row = [];
        };

        const pushByte = (value) => {
          row.push(value);
          if (row.length === bytesPerRow) pushRow();
          if (row.length > bytesPerRow) {
            throw new Error("Overflow de fila durante decode GFA");
          }
        };

        while (cursor < source.length) {
          const current = source[cursor];
          if (/\s/.test(current)) {
            cursor += 1;
            continue;
          }

          let count = 0;
          let hasCount = false;
          while (cursor < source.length) {
            const countValue = decodeCountCode(source[cursor]);
            if (countValue === null) break;
            hasCount = true;
            count += countValue;
            cursor += 1;
          }
          const repeat = hasCount ? count : 1;
          if (repeat <= 0) {
            throw new Error("Conteo inv√°lido en compresi√≥n GFA");
          }

          const token = source[cursor];
          if (!token) break;

          if (token === ",") {
            cursor += 1;
            for (let i = 0; i < repeat; i += 1) pushRow();
            continue;
          }

          if (token === "!") {
            cursor += 1;
            for (let i = 0; i < repeat; i += 1) {
              while (row.length < bytesPerRow) row.push(0xff);
              pushRow();
            }
            continue;
          }

          if (token === ":") {
            cursor += 1;
            if (!rows.length) {
              throw new Error("Token ':' sin fila previa en GFA");
            }
            for (let i = 0; i < repeat; i += 1) {
              rows.push(rows[rows.length - 1].slice());
            }
            continue;
          }

          const pairA = source[cursor];
          const pairB = source[cursor + 1];
          if (!isHexDigit(pairA) || !isHexDigit(pairB)) {
            throw new Error(`Token inv√°lido en GFA cerca de "${source.slice(cursor, cursor + 8)}"`);
          }
          const byteValue = parseInt(`${pairA}${pairB}`, 16);
          cursor += 2;
          for (let i = 0; i < repeat; i += 1) {
            pushByte(byteValue);
          }
        }

        if (row.length) pushRow();

        const flattened = new Uint8Array(rows.flat());
        if (flattened.length !== bytesTotal) {
          throw new Error("GFA decode mismatch");
        }
        return flattened;
      };

      const renderGfaToPngDataUrl = ({ bytesTotal, bytesPerRow, data }) => {
        const bitmap = decodeGfaToBitmap({ bytesTotal, bytesPerRow, data });
        const widthDots = bytesPerRow * 8;
        const heightDots = bytesTotal / bytesPerRow;
        if (!Number.isInteger(heightDots)) {
          throw new Error("Altura inv√°lida para bitmap GFA");
        }

        const canvas = document.createElement("canvas");
        canvas.width = widthDots;
        canvas.height = heightDots;
        const ctx = canvas.getContext("2d");
        if (!ctx) throw new Error("No se pudo obtener contexto 2D para logo GFA");

        ctx.clearRect(0, 0, widthDots, heightDots);
        ctx.fillStyle = "#000";

        let offset = 0;
        for (let y = 0; y < heightDots; y += 1) {
          for (let byteIndex = 0; byteIndex < bytesPerRow; byteIndex += 1) {
            const byteValue = bitmap[offset++];
            for (let bit = 7; bit >= 0; bit -= 1) {
              const x = byteIndex * 8 + (7 - bit);
              if (((byteValue >> bit) & 1) === 1) {
                ctx.fillRect(x, y, 1, 1);
              }
            }
          }
        }

        return canvas.toDataURL("image/png");
      };

      const getZplLogoDataUrl = (() => {
        let cachedDataUrl = "";
        return () => {
          if (cachedDataUrl) return cachedDataUrl;
          const gfa = extractGfaCommandFromZpl(HARUJA_2025_ZPL);
          cachedDataUrl = renderGfaToPngDataUrl(gfa);
          return cachedDataUrl;
        };
      })();

      const getZplLogoCommand = (() => {
        let cachedCommand = "";
        return () => {
          if (cachedCommand) return cachedCommand;
          const gfa = extractGfaCommandFromZpl(HARUJA_2025_ZPL);
          cachedCommand = `^GFA,${gfa.bytesTotal},${gfa.bytesUsed},${gfa.bytesPerRow},${gfa.data}`;
          return cachedCommand;
        };
      })();

      const LABEL_ZPL_DEBUG = window.localStorage.getItem("label-zpl-debug") === "1";

      const buildLabelZpl = ({ sku, price, qty = 1 }) => {
        const logoCommand = getZplLogoCommand();
        const single = [
          "^XA",
          "^CI28",
          "^PW406",
          "^LL203",
          "^LH0,0",
          "^FO25,40",
          "^A0N,30,30",
          `^FD${sku}^FS`,
          "^FO25,100",
          "^A0N,55,55",
          `^FD${price}^FS`,
          "^FO260,17",
          "^BQN,2,6",
          `^FD${sku}^FS`,
          "^FO260,145",
          logoCommand,
          "^FS",
          "^XZ"
        ].join("\n");
        return Array.from({ length: qty }, () => single).join("\n");
      };

      const escapeHtml = (value) => safeString(value)
        .replace(/&/g, "&amp;")
        .replace(/</g, "&lt;")
        .replace(/>/g, "&gt;")
        .replace(/\"/g, "&quot;")
        .replace(/'/g, "&#39;");

      const getPrintHtml = (labels = []) => {
        const pages = labels.map((label) => `
          <section class="page">
            <div class="codigo">${escapeHtml(label.codigo)}</div>
            <div class="precio">${escapeHtml(label.precioTexto)}</div>
            <div class="qr" data-qr="${escapeHtml(label.qrValue)}"></div>
            <img class="logo" src="${escapeHtml(label.logoSrc)}" alt="logo" />
          </section>
        `).join("\n");
        return `<!doctype html>
<html lang="es"><head><meta charset="utf-8" /><title>Etiquetas 51x25</title>
<style>
  @page { size: 51mm 25mm; margin: 0; }
  html,body { margin:0; padding:0; }
  .print-actions { position: fixed; top: 8px; left: 8px; z-index: 10; }
  .page { width:51mm; height:25mm; page-break-after:always; position:relative; overflow:hidden; }
  .codigo { position:absolute; left:3.13mm; top:5mm; font-size:3.75mm; font-weight:600; font-family: Arial, sans-serif; }
  .precio { position:absolute; left:3.13mm; top:12.51mm; font-size:6.88mm; line-height:1; font-weight:700; font-family: Arial, sans-serif; }
  .qr { position:absolute; left:32.53mm; top:2.13mm; width:16.5mm; height:16.5mm; }
  .qr img { width:100%; height:100%; display:block; }
  .logo { position:absolute; left:36.28mm; top:20.65mm; width:13.01mm; height:3.75mm; object-fit:contain; image-rendering:pixelated; }
  @media print { .print-actions { display:none; } }
</style></head>
<body>
  <div class="print-actions"><button onclick="window.print()">Imprimir</button></div>
  ${pages}
  <script>
    (function(){
      document.querySelectorAll('.qr').forEach(function(el){
        var value = el.dataset.qr || '';
        var img = document.createElement('img');
        img.alt = 'QR';
        img.src = 'https://api.qrserver.com/v1/create-qr-code/?size=220x220&data=' + encodeURIComponent(value);
        el.appendChild(img);
      });
    })();
    setTimeout(function(){ window.print(); }, 300);
  <\/script>
</body></html>`;
      };

      const openPrintLabels = (scope = "page") => {
        const rows = getRowsForScope(scope);
        if (!rows.length) {
          setPrendasAlert("No hay filas para imprimir en el alcance seleccionado.");
          return;
        }
        let logoSrc = getLabelLogoSrc();
        try {
          logoSrc = getZplLogoDataUrl();
        } catch (error) {
          console.error("No se pudo renderizar el logo desde ^GFA:", error);
          setPrendasAlert("No se pudo renderizar el logo ZPL (^GFA). Se usar√° logo alterno.");
        }
        const labels = rows.map((row) => {
          const codigo = safeString(row.codigo || row.code).trim().toUpperCase();
          const precioNum = getLabelPriceNumber(row);
          return {
            codigo,
            precioTexto: formatLabelPrice(precioNum),
            qrValue: codigo,
            logoSrc
          };
        });
        const printWindow = window.open("", "_blank");
        if (!printWindow) {
          setPrendasAlert("No se pudo abrir la ventana de impresi√≥n. Revisa bloqueador de popups.");
          return;
        }
        printWindow.document.write(getPrintHtml(labels));
        printWindow.document.close();
        printWindow.focus();
      };

      const computeMarginUtility = (pVenta, costo) => {
        const p = toNumberOrNull(pVenta) ?? 0;
        const c = toNumberOrNull(costo) ?? 0;
        const utilidad = Number((p - c).toFixed(2));
        const margenPct = p > 0 ? Number(((utilidad / p) * 100).toFixed(1)) : 0;
        return { utilidad, margenPct };
      };

      const buildSearchKey = (data) => {
        const codigo = safeString(data.codigo || data.code || data.Codigo || data.Code);
        const descripcion = safeString(data.descripcion || data.Descripcion || data.detalles);
        return normalizeText(`${codigo} ${descripcion}`.trim());
      };

      const pickFirstValue = (...values) => {
        for (const value of values) {
          if (value !== undefined && value !== null && value !== "") {
            return value;
          }
        }
        return null;
      };

      const normalizeDoc = (docSnap) => {
        const data = docSnap.data() || {};
        const codigo = safeString(
          data.codigo ??
            data.Codigo ??
            data.CODIGO ??
            data.SKU ??
            data.code ??
            data.Code ??
            docSnap.id
        ).trim();
        const descripcion = safeString(
          data.descripcion ??
            data.Descripcion ??
            data.detalles ??
            data.Detalles ??
            ""
        ).trim();
        const proveedor = safeString(data.proveedor || data.Proveedor || "").trim();
        const tipo = safeString(data.tipo || data.Tipo || "").trim();
        const color = safeString(data.color || data.Color || "").trim();
        const talla = safeString(data.talla || data.Talla || "").trim();
        const statusRaw = safeString(data.statusCanon ?? data.status ?? data.Status ?? "").trim();
        const statusCanon = normalizeStatus(statusRaw);
        const precioRaw = pickFirstValue(
          data.precio,
          data.Precio,
          data.price,
          data.precioFinal,
          data.precio_final
        );
        const precio = toNumberOrNull(precioRaw);
        const precioConIva = toNumberOrNull(
          pickFirstValue(data.precioConIva, data.precioConIVA)
        );
        const iva = toNumberOrNull(data.iva ?? data.IVA);
        const pVenta = toNumberOrNull(data.pVenta ?? data.precioConIva ?? data.precio);
        const costo = toNumberOrNull(data.costo);
        const precioConIvaFinal = Number.isFinite(precioConIva)
          ? precioConIva
          : (Number.isFinite(pVenta) ? pVenta : null);

        const { utilidad: utilidadCalculada, margenPct: margenCalculado } =
          computeMarginUtility(precioConIvaFinal, costo);

        let utilidad = Number(data.utilidad ?? data.Utilidad ?? 0);
        if ((!utilidad || utilidad === 0) && costo > 0 && precioConIvaFinal > 0) {
          utilidad = Math.round((precioConIvaFinal - costo) * 100) / 100;
        }

        let margen = Number(data.margen ?? data.Margen ?? 0);
        if ((!margen || margen === 0) && precioConIvaFinal > 0) {
          margen = Math.round(((utilidad / precioConIvaFinal) * 100) * 10) / 10;
        }
        const createdAt = data.createdAt ?? data.CreatedAt ?? null;
        const fechaAlta = data.fechaAlta ?? data.FechaAlta ?? null;
        const fecha = data.fecha ?? data.Fecha ?? null;
        const orden = toNumberOrNull(data.orden ?? data.Orden);
        const seqNumber = toNumberOrNull(data.seqNumber ?? data.seq ?? data.secuencia);
        const fechaAltaTexto = safeString(
          data.fechaAltaTexto ?? data.FechaAltaTexto ?? data.fechaTexto ?? data.FechaTexto ?? ""
        ).trim();
        const fechaTexto = safeString(data.fechaTexto ?? data.FechaTexto ?? "").trim();
        const descripcionLower = descripcion.toLowerCase();
        const codigoUpper = codigo.toUpperCase();
        const _searchKey = `${codigo} ${descripcion}`.toLowerCase().trim();

        return {
          id: docSnap.id,
          docId: safeString(data.docId ?? docSnap.id),
          orden: Number.isFinite(orden) ? orden : seqNumber,
          seqNumber,
          codigo,
          descripcion,
          color,
          talla,
          proveedor,
          tipo,
          status: statusCanon,
          statusCanon,
          disponibilidad: normalizeDisponibilidad(
            safeString((data.disponibilidadCanon ?? data.disponibilidad ?? data.Disponibilidad ?? "")).trim(),
            statusCanon
          ),
          disponibilidadCanon: normalizeDisponibilidad(
            safeString((data.disponibilidadCanon ?? data.disponibilidad ?? data.Disponibilidad ?? "")).trim(),
            statusCanon
          ),
          precio,
          pVenta,
          precioConIva: precioConIvaFinal,
          iva,
          costo,
          margen: Number.isFinite(margen) ? margen : margenCalculado,
          utilidad: Number.isFinite(utilidad) ? utilidad : utilidadCalculada,
          createdAt,
          fechaAlta,
          fecha,
          fechaAltaTexto,
          fechaTexto,
          descripcionLower,
          codigoUpper,
          _searchKey
        };
      };

      const getSearchInput = () => safeString(prendasSearch.value);
      const getSearchTerm = () => normalizeText(prendasSearch.value);
      const getSearchRaw = () => safeString(prendasSearch.value).trim();
      const normalizeSelectValue = (value) => (isAllFilter(value) ? null : value);
      const getDateRangeFromFilters = (yearValue, monthValue) => {
        const year = Number(yearValue);
        if (!Number.isInteger(year) || year < 1900) {
          return null;
        }

        const month = Number(monthValue);
        if (Number.isInteger(month) && month >= 1 && month <= 12) {
          return {
            start: new Date(year, month - 1, 1, 0, 0, 0, 0),
            end: new Date(year, month, 1, 0, 0, 0, 0),
            granularity: "month"
          };
        }

        return {
          start: new Date(year, 0, 1, 0, 0, 0, 0),
          end: new Date(year + 1, 0, 1, 0, 0, 0, 0),
          granularity: "year"
        };
      };

      const populateYearFilter = () => {
        if (!prendasYear) return;
        const current = prendasYear.value;
        const thisYear = new Date().getFullYear();
        const years = [];
        for (let year = thisYear; year >= PRENDAS_YEAR_MIN; year -= 1) {
          years.push(year);
        }
        prendasYear.innerHTML = '<option value="">Todos</option>';
        years.forEach((year) => {
          const option = document.createElement("option");
          option.value = String(year);
          option.textContent = String(year);
          prendasYear.appendChild(option);
        });
        prendasYear.value = years.includes(Number(current)) ? current : "";
      };

      const populateMonthFilter = () => {
        if (!prendasMonth) return;
        const current = prendasMonth.value;
        prendasMonth.innerHTML = '<option value="">Todos</option>';
        MONTH_OPTIONS.forEach(({ value, label }) => {
          const option = document.createElement("option");
          option.value = String(value);
          option.textContent = `${String(value).padStart(2, "0")} - ${label}`;
          prendasMonth.appendChild(option);
        });
        prendasMonth.value = MONTH_OPTIONS.some(({ value }) => String(value) === current)
          ? current
          : "";
      };

      const syncDateFilterUi = () => {
        if (!prendasYear || !prendasMonth) return;
        const hasYear = Boolean(safeString(prendasYear.value).trim());
        prendasMonth.disabled = !hasYear;
        if (!hasYear) {
          prendasMonth.value = "";
        }
      };

      const clearFiltersUi = () => {
        prendasSearch.value = "";
        if (prendasYear) prendasYear.value = "";
        if (prendasMonth) prendasMonth.value = "";
        prendasPrecioMin.value = "";
        prendasPrecioMax.value = "";
        if (prendasPrecioSin) prendasPrecioSin.checked = true;
        syncDateFilterUi();
      };

      const clearHeaderFilters = () => {
        prendasState.filters.header = createEmptyHeaderFilters();
        updateHeaderFilterButtonsState();
      };

      const looksLikeCodeSearch = (value) => {
        const raw = safeString(value).trim().toUpperCase();
        if (!raw) return false;
        return raw.startsWith("HA") || raw.includes("/") || raw.includes("-");
      };

      const getCurrentGlobalFilters = () => ({
        searchText: getSearchRaw(),
        year: safeString(prendasYear?.value).trim(),
        month: safeString(prendasMonth?.value).trim(),
        priceMin: toNumberOrNull(prendasPrecioMin.value),
        priceMax: toNumberOrNull(prendasPrecioMax.value),
        includeNoPrice: prendasPrecioSin?.checked ?? true
      });

      const getCurrentFilters = () => ({
        global: getCurrentGlobalFilters(),
        header: prendasState.filters.header
      });

      const isHeaderFilterActive = (key) => {
        if (key === "pventa") {
          return (
            prendasState.filters.header.pventaMin !== null ||
            prendasState.filters.header.pventaMax !== null
          );
        }
        if (key === "orden") {
          return (prendasState.sort?.dir || DEFAULT_PRENDAS_SORT.dir) !== DEFAULT_PRENDAS_SORT.dir;
        }
        if (key === "fecha") {
          return Boolean(prendasState.filters.header.fechaYear || prendasState.filters.header.fechaMonth);
        }
        return (prendasState.filters.header[key]?.size || 0) > 0;
      };

      const applyGlobalFilters = (rows, globalFilters) => {
        const searchText = normalizeText(globalFilters.searchText);
        const dateRange = getDateRangeFromFilters(globalFilters.year, globalFilters.month);
        return rows.filter((item) => {
          const precio = toNum(item.pVenta);
          if (globalFilters.priceMin != null || globalFilters.priceMax != null) {
            if (!Number.isFinite(precio)) return false;
            if (globalFilters.priceMin != null && precio < globalFilters.priceMin) return false;
            if (globalFilters.priceMax != null && precio > globalFilters.priceMax) return false;
          }
          if (dateRange?.start && dateRange?.end && !isInDateRange(item, dateRange)) {
            return false;
          }
          if (!searchText) return true;
          const codigo = normalizeFilterValue(item.codigo);
          const descripcion = normalizeFilterValue(item.descripcion);
          if (looksLikeCodeSearch(searchText)) {
            return codigo.toUpperCase().startsWith(searchText.toUpperCase());
          }
          return descripcion.includes(searchText);
        });
      };

      const applyHeaderFilters = (rows, headerFilters) =>
        rows.filter((item) => {
          const hasChecklistMatch = HEADER_FILTER_KEYS.every((key) => {
            const selected = headerFilters[key];
            if (!selected || !selected.size) return true;
            const itemValue = normalizeFilterValue(item[key]);
            return selected.has(itemValue);
          });
          if (!hasChecklistMatch) return false;

          // Fecha (a√±o/mes)
          const hasFechaFilter = Boolean(headerFilters.fechaYear || headerFilters.fechaMonth);
          if (hasFechaFilter) {
            const d = resolveComparableDate(item);
            if (!d) return false;
            const year = String(d.getFullYear());
            const month = String(d.getMonth() + 1).padStart(2, "0");
            if (headerFilters.fechaYear && year !== String(headerFilters.fechaYear)) return false;
            if (headerFilters.fechaMonth && month !== String(headerFilters.fechaMonth)) return false;
          }

          // P. Venta (rango)
          const hasPriceRange = headerFilters.pventaMin != null || headerFilters.pventaMax != null;
          if (hasPriceRange) {
            const price = toNum(item.pVenta);
            if (price === null) return false;
            if (headerFilters.pventaMin != null && price < headerFilters.pventaMin) return false;
            if (headerFilters.pventaMax != null && price > headerFilters.pventaMax) return false;
          }

          return true;
        });

      const normalizeSortConfig = (sort) => {
        const rawKey = normalizeText(sort?.key || DEFAULT_PRENDAS_SORT.key);
        const key = rawKey === "fecha" ? "fecha" : "orden";
        const dir = normalizeText(sort?.dir) === "desc" ? "desc" : "asc";
        return { key, dir };
      };

      const updateOrdenSortToggleUi = () => {
        if (!ordenSortBtn || !ordenSortIcon) return;
        const sort = normalizeSortConfig(prendasState.sort);
        ordenSortIcon.textContent = sort.dir === "desc" ? "‚Üì" : "‚Üë";
        ordenSortBtn.setAttribute("aria-label", `Ordenar por Orden (${sort.dir === "desc" ? "descendente" : "ascendente"})`);
      };

      const persistSort = (sort) => {
        try {
          localStorage.setItem(PRENDAS_SORT_KEY_STORAGE, sort.key);
          localStorage.setItem(PRENDAS_SORT_DIR_STORAGE, sort.dir);
        } catch (_) {}
      };

      const restorePersistedSort = () => {
        try {
          const key = localStorage.getItem(PRENDAS_SORT_KEY_STORAGE);
          const dir = localStorage.getItem(PRENDAS_SORT_DIR_STORAGE);
          return normalizeSortConfig({ key, dir });
        } catch (_) {
          return { ...DEFAULT_PRENDAS_SORT };
        }
      };

      const setPrendasSort = async (nextSort, { refresh = true } = {}) => {
        prendasState.sort = normalizeSortConfig(nextSort);
        prendasState.pageIndex = 0;
        persistSort(prendasState.sort);
        updateOrdenSortToggleUi();
        updateHeaderFilterButtonsState();
        if (refresh && !isBooting) {
          await loadPrendasPage({ reset: true, reason: "sort-change" });
        }
      };

      const resolveRowOrderValue = (row, index) => {
        const candidates = [row?.orden, row?._index, row?.__i, row?._rowNumber, row?.__order];
        for (const value of candidates) {
          const parsed = toNumberOrNull(value);
          if (Number.isFinite(parsed)) return parsed;
        }
        return index + 1;
      };

      const sortRows = (rows = [], sort = prendasState.sort) => {
        const activeSort = normalizeSortConfig(sort);
        const direction = activeSort.dir === "desc" ? -1 : 1;
        const indexedRows = rows.map((row, index) => ({ row, index }));
        return indexedRows.sort((a, b) => {
          if (activeSort.key === "orden") {
            const orderA = resolveRowOrderValue(a.row, a.index);
            const orderB = resolveRowOrderValue(b.row, b.index);
            if (orderA !== orderB) {
              return (orderA - orderB) * direction;
            }
            return safeString(a.row?.codigo).localeCompare(safeString(b.row?.codigo), "es", { numeric: true, sensitivity: "base" }) * direction;
          }

          if (activeSort.key === "fecha") {
            const timeA = resolveComparableDate(a.row)?.getTime() ?? 0;
            const timeB = resolveComparableDate(b.row)?.getTime() ?? 0;
            if (timeA !== timeB) {
              return (timeA - timeB) * direction;
            }
            return safeString(a.row?.codigo).localeCompare(safeString(b.row?.codigo), "es", { numeric: true, sensitivity: "base" }) * direction;
          }

          return safeString(a.row?.[activeSort.key]).localeCompare(safeString(b.row?.[activeSort.key]), "es", {
            numeric: true,
            sensitivity: "base"
          }) * direction;
        }).map(({ row }) => row);
      };

      const applyAllFilters = (rows) => {
        const globalFilters = getCurrentGlobalFilters();
        prendasState.filters.global = globalFilters;
        const hasPrice = (row) => {
          const p = row?.pVenta;
          if (p === null || p === undefined) return false;
          const n = Number(p);
          return Number.isFinite(n) && n > 0;
        };
        let rowsAfterNoPrice = rows;
        if (!globalFilters.includeNoPrice) {
          rowsAfterNoPrice = rows.filter(hasPrice);
        }
        console.log(
          "[Prendas] incluirSinPrecio:",
          globalFilters.includeNoPrice,
          "rows:",
          rowsAfterNoPrice.length
        );
        const rowsAfterGlobal = applyGlobalFilters(rowsAfterNoPrice, globalFilters);
        prendasState.rowsAfterGlobal = rowsAfterGlobal;
        let rowsAfterAll = applyHeaderFilters(rowsAfterGlobal, prendasState.filters.header);
        rowsAfterAll = sortRows(rowsAfterAll, prendasState.sort);
        prendasState.rowsAfterAll = rowsAfterAll;
        return rowsAfterAll;
      };

      const hasActiveFilters = (filters) => {
        if (!filters) return false;
        const globalFilters = filters.global || {};
        const headerFilters = filters.header || {};
        const hasSearch = Boolean(safeString(globalFilters.searchText).trim());
        const hasDate = Boolean(globalFilters.year);
        const hasPriceRange = globalFilters.priceMin !== null || globalFilters.priceMax !== null;
        const excludeNoPrice = globalFilters.includeNoPrice === false;
        const hasHeaderFilters = HEADER_FILTER_KEYS.some((key) => (headerFilters[key]?.size || 0) > 0);
        const hasHeaderPrice = headerFilters.pventaMin !== null || headerFilters.pventaMax !== null;
        return hasSearch || hasDate || hasPriceRange || excludeNoPrice || hasHeaderFilters || hasHeaderPrice;
      };

      const getUniqueOptions = (rows, key) => {
        const set = new Set();
        rows.forEach((row) => {
          const value = safeString(row[key]).trim();
          if (value) set.add(value);
        });
        return [...set].sort((a, b) => a.localeCompare(b, "es", { sensitivity: "base" }));
      };

      const handleIndexError = (error) => {
        const message = error?.message || "";
        const isIndexError =
          error?.code === "failed-precondition" ||
          /requires an index/i.test(message) ||
          /indexes/i.test(message);
        if (!isIndexError) {
          return false;
        }
        console.warn("[Prendas] Index error", error);
        return true;
      };

      const updateHeaderFilterButtonsState = () => {
        headerFilterButtons.forEach((button) => {
          const key = button.dataset.openHeaderFilter;
          button.classList.toggle("active", isHeaderFilterActive(key));
        });
        updateOrdenSortToggleUi();
      };

      const closeHeaderPopover = () => {
        if (prendasState.headerPopover?.cleanup) {
          prendasState.headerPopover.cleanup();
        }
        if (prendasState.headerPopover?.container) {
          prendasState.headerPopover.container.remove();
        }
        prendasState.headerPopover = null;
      };

      const clamp = (value, min, max) => Math.min(Math.max(value, min), max);
      const isMobileViewport = () => window.matchMedia("(max-width: 768px)").matches;

      const positionHeaderPopover = () => {
        if (!prendasState.headerPopover?.container || !prendasState.headerPopover?.anchorButton) {
          return;
        }
        if (prendasState.headerPopover?.isMobileSheet) {
          return;
        }
        const { container, anchorButton } = prendasState.headerPopover;
        const anchorRect = anchorButton.getBoundingClientRect();
        const popoverRect = container.getBoundingClientRect();

        let left = anchorRect.right - popoverRect.width;
        let top = anchorRect.bottom + HEADER_POPOVER_OFFSET;

        const maxLeft = window.innerWidth - popoverRect.width - HEADER_POPOVER_MARGIN;
        const maxTop = window.innerHeight - popoverRect.height - HEADER_POPOVER_MARGIN;

        if (top + popoverRect.height > window.innerHeight - HEADER_POPOVER_MARGIN) {
          top = anchorRect.top - popoverRect.height - HEADER_POPOVER_OFFSET;
        }

        left = clamp(left, HEADER_POPOVER_MARGIN, maxLeft);
        top = clamp(top, HEADER_POPOVER_MARGIN, maxTop);

        container.style.left = `${left}px`;
        container.style.top = `${top}px`;
      };

      const bindHeaderPopoverPositioning = (container, anchorButton, key) => {
        const mobileSheet = isMobileViewport();
        if (mobileSheet) {
          container.classList.add("mobile-sheet");
        }
        const handleResize = () => positionHeaderPopover();
        const handleScroll = () => positionHeaderPopover();

        window.addEventListener("resize", handleResize);
        window.addEventListener("scroll", handleScroll, true);

        prendasState.headerPopover = {
          key,
          container,
          anchorButton,
          isMobileSheet: mobileSheet,
          cleanup: () => {
            window.removeEventListener("resize", handleResize);
            window.removeEventListener("scroll", handleScroll, true);
          }
        };

        requestAnimationFrame(positionHeaderPopover);
      };

      const renderHeaderFilterPopover = (key, anchorButton) => {
        closeHeaderPopover();
        const container = document.createElement("div");
        container.className = "filter-popover";

        if (key === HEADER_RANGE_KEY) {
          container.classList.add("range-popover");
          const currentMin = prendasState.filters.header.pventaMin;
          const currentMax = prendasState.filters.header.pventaMax;
          container.innerHTML = `
            <div class="popover-head"><p class="popover-title">Filtrar P. Venta</p></div>
            <div class="range-fields">
              <div class="range-field">
                <label for="range-min">M√≠nimo</label>
                <input id="range-min" type="number" min="0" step="0.01" placeholder="0.00" value="${currentMin ?? ""}" data-range-min />
              </div>
              <div class="range-field">
                <label for="range-max">M√°ximo</label>
                <input id="range-max" type="number" min="0" step="0.01" placeholder="0.00" value="${currentMax ?? ""}" data-range-max />
              </div>
            </div>
            <div class="hint" data-range-hint></div>
            <div class="actions">
              <button type="button" data-apply>Aplicar</button>
              <button type="button" class="secondary" data-clear>Limpiar</button>
            </div>
          `;
          document.body.appendChild(container);
          const minInput = container.querySelector("[data-range-min]");
          const maxInput = container.querySelector("[data-range-max]");
          const hintEl = container.querySelector("[data-range-hint]");

          container.querySelector("[data-clear]").addEventListener("click", async () => {
            prendasState.filters.header.pventaMin = null;
            prendasState.filters.header.pventaMax = null;
            closeHeaderPopover();
            await applyFilters();
          });

          container.querySelector("[data-apply]").addEventListener("click", async () => {
            let minValue = toNumberOrNull(minInput.value);
            let maxValue = toNumberOrNull(maxInput.value);
            if (minValue !== null && maxValue !== null && minValue > maxValue) {
              [minValue, maxValue] = [maxValue, minValue];
              hintEl.textContent = "Se ajust√≥ el rango autom√°ticamente (m√≠n ‚Üî m√°x).";
            }
            prendasState.filters.header.pventaMin = minValue;
            prendasState.filters.header.pventaMax = maxValue;
            closeHeaderPopover();
            await applyFilters();
          });

          bindHeaderPopoverPositioning(container, anchorButton, key);
          return;

        }

        if (key === "fecha") {
          const monthNames = [
            "enero","febrero","marzo","abril","mayo","junio",
            "julio","agosto","septiembre","octubre","noviembre","diciembre"
          ];
          const availableYears = Array.from(new Set((prendasState.baseRows || [])
            .map((it) => resolveComparableDate(it))
            .filter(Boolean)
            .map((d) => d.getFullYear())))
            .sort((a,b) => b - a);

          const currentYear = safeString(prendasState.filters.header.fechaYear).trim();
          const currentMonth = safeString(prendasState.filters.header.fechaMonth).trim();

          const yearOptions = ['<option value="">Todos</option>']
            .concat(availableYears.map((y) => `<option value="${y}" ${String(y)===currentYear ? "selected" : ""}>${y}</option>`))
            .join("");

          const monthOptions = ['<option value="">Todos</option>']
            .concat(monthNames.map((name, i) => {
              const v = String(i + 1).padStart(2, "0");
              return `<option value="${v}" ${v===currentMonth ? "selected" : ""}>${name}</option>`;
            }))
            .join("");

          container.innerHTML = `
            <div class="popover-head"><p class="popover-title">Filtrar Fecha</p></div>
            <div class="range-fields">
              <div class="range-field">
                <label for="fecha-year">A√±o</label>
                <select id="fecha-year" data-fecha-year>${yearOptions}</select>
              </div>
              <div class="range-field">
                <label for="fecha-month">Mes</label>
                <select id="fecha-month" data-fecha-month>${monthOptions}</select>
              </div>
            </div>
            <div class="actions">
              <button type="button" data-apply>Aplicar</button>
              <button type="button" class="secondary" data-clear>Limpiar</button>
            </div>
          `;
          document.body.appendChild(container);

          const yearSelect = container.querySelector("[data-fecha-year]");
          const monthSelect = container.querySelector("[data-fecha-month]");

          container.querySelector("[data-clear]").addEventListener("click", async () => {
            prendasState.filters.header.fechaYear = "";
            prendasState.filters.header.fechaMonth = "";
            closeHeaderPopover();
            await applyFilters();
          });

          container.querySelector("[data-apply]").addEventListener("click", async () => {
            prendasState.filters.header.fechaYear = safeString(yearSelect.value).trim();
            prendasState.filters.header.fechaMonth = safeString(monthSelect.value).trim();
            closeHeaderPopover();
            await applyFilters();
          });

          bindHeaderPopoverPositioning(container, anchorButton, key);
          return;
        }

        const options = prendasState.uniqueOptions[key] || [];
        const selected = new Set(prendasState.filters.header[key] || []);
        container.innerHTML = `
          <div class="popover-head"><p class="popover-title">Filtrar ${key}</p></div>
          <div class="search-wrap"><input type="text" placeholder="Buscar..." data-filter-search /></div>
          <div class="meta" data-filter-count></div>
          <label class="option-all"><input type="checkbox" data-select-all /> Seleccionar todo</label>
          <div class="options" data-options></div>
          <div class="actions">
            <button type="button" data-apply>Aplicar</button>
            <button type="button" class="secondary" data-clear>Limpiar</button>
          </div>
        `;
        document.body.appendChild(container);

        const optionsEl = container.querySelector("[data-options]");
        const searchEl = container.querySelector("[data-filter-search]");
        const selectAllEl = container.querySelector("[data-select-all]");
        const countEl = container.querySelector("[data-filter-count]");

        const updateCounters = () => {
          const total = options.length;
          const selectedCount = selected.size;
          countEl.textContent = `(${selectedCount} seleccionados / ${total} total)`;
          selectAllEl.checked = total > 0 && selectedCount === total;
        };

        const refreshList = () => {
          const q = normalizeText(searchEl.value);
          const visible = options.filter((value) => normalizeText(value).includes(q));
          optionsEl.textContent = "";
          visible.forEach((value) => {
            const row = document.createElement("label");
            row.className = "option-row";
            const checked = selected.has(normalizeFilterValue(value));
            row.innerHTML = `<input type="checkbox" value="${value}" ${checked ? "checked" : ""} /> ${value}`;
            const checkbox = row.querySelector("input");
            checkbox.addEventListener("change", () => {
              const normalized = normalizeFilterValue(value);
              if (checkbox.checked) selected.add(normalized);
              else selected.delete(normalized);
              updateCounters();
            });
            optionsEl.appendChild(row);
          });
          updateCounters();
        };

        selectAllEl.addEventListener("change", () => {
          if (selectAllEl.checked) {
            options.forEach((value) => selected.add(normalizeFilterValue(value)));
          } else {
            selected.clear();
          }
          refreshList();
        });

        searchEl.addEventListener("input", refreshList);

        container.querySelector("[data-clear]").addEventListener("click", async () => {
          prendasState.filters.header[key] = new Set();
          closeHeaderPopover();
          await applyFilters();
        });

        container.querySelector("[data-apply]").addEventListener("click", async () => {
          prendasState.filters.header[key] = selected;
          closeHeaderPopover();
          await applyFilters();
        });

        bindHeaderPopoverPositioning(container, anchorButton, key);
        refreshList();
      };

      const chunkArray = (items, size) => {
        const chunks = [];
        for (let i = 0; i < items.length; i += size) {
          chunks.push(items.slice(i, i + size));
        }
        return chunks;
      };

      const loadAdminCostMap = async (rows = []) => {
        const map = new Map();
        const rowDocIds = rows
          .map((row) => safeString(row.docId || row.id).trim())
          .filter(Boolean);

        if (!rowDocIds.length) {
          return map;
        }

        const ids = [...new Set(rowDocIds)];
        const chunks = chunkArray(ids, 30);

        for (const chunk of chunks) {
          const snap = await getDocs(
            query(collection(db, PRENDAS_ADMIN_COLLECTION), where(documentId(), "in", chunk))
          );
          snap.docs.forEach((docSnap) => {
            const data = docSnap.data() || {};
            const lookupId = safeString(docSnap.id).trim();
            if (!lookupId) return;
            map.set(lookupId, {
              costo: toNumberOrNull(data.costo),
              pVentaOverride: toNumberOrNull(data.pVentaOverride ?? data.pVenta),
              margen: toNumberOrNull(data.margen),
              utilidad: toNumberOrNull(data.utilidad),
            });
          });
        }

        prendasState.adminMap = map;
        return map;
      };

      const mergeAdminFields = async (rows = []) => {
        if (!(isAdminViewEnabled() && rows.length)) {
          prendasState.adminMap.clear();
          return rows;
        }

        const adminCostMap = await loadAdminCostMap(rows);
        rows.forEach((row) => {
          const lookupId = safeString(row.docId || row.id).trim();
          const adminExtra = adminCostMap.get(lookupId);
          if (!adminExtra) return;

          const costo = toNumberOrNull(adminExtra.costo);
          const utilidadFromAdmin = toNumberOrNull(adminExtra.utilidad);
          const margenFromAdmin = toNumberOrNull(adminExtra.margen);
          const pVentaOverride = toNumberOrNull(adminExtra.pVentaOverride);

          row.costo = Number.isFinite(costo) ? costo : null;
          row.pVentaOverride = Number.isFinite(pVentaOverride) ? pVentaOverride : null;
          const precioVisible = Number.isFinite(row.pVentaOverride)
            ? row.pVentaOverride
            : (Number.isFinite(row.pVenta) ? row.pVenta : null);
          row.pVentaDisplay = precioVisible;
          const { utilidad: utilidadCalculada, margenPct: margenCalculado } =
            computeMarginUtility(precioVisible, row.costo);

          row.utilidad = (Number.isFinite(utilidadFromAdmin) && utilidadFromAdmin !== 0)
            ? utilidadFromAdmin
            : utilidadCalculada;
          row.margen = (Number.isFinite(margenFromAdmin) && margenFromAdmin !== 0)
            ? Number(margenFromAdmin.toFixed(1))
            : margenCalculado;
        });

        return rows;
      };

      const loadBaseRows = async () => {
        const cacheKey = "public";
        if (prendasState.baseRows.length && prendasState.baseRowsCacheKey === cacheKey) {
          return prendasState.baseRows;
        }
        let cursor = null;
        let hasMore = true;
        const rows = [];
        while (hasMore) {
          const constraints = [orderBy("orden", "asc"), limit(PRENDAS_COUNT_BATCH_SIZE)];
          if (cursor) constraints.splice(1, 0, startAfter(cursor));
          const snap = await getDocs(query(prendasPublicRef, ...constraints));
          console.log("[Prendas] snapshot size:", snap.size);
          if (snap.empty) {
            hasMore = false;
            break;
          }
          snap.docs.forEach((docSnap) => rows.push(normalizeDoc(docSnap)));
          cursor = snap.docs[snap.docs.length - 1];
          if (snap.docs.length < PRENDAS_COUNT_BATCH_SIZE) {
            hasMore = false;
          }
        }

        if (!rows.length) {
          try {
            const fallbackProbe = await getDocs(query(collection(db, PRENDAS_MASTER_COLLECTION), limit(1)));
            if (!fallbackProbe.empty) {
              setPrendasAlert("Colecci√≥n public vac√≠a: cargando respaldo temporal desde master.", "warning");
              console.warn("[Prendas] fallback temporal activado desde master.");
              cursor = null;
              hasMore = true;

              while (hasMore) {
                const fallbackConstraints = [orderBy("orden", "asc"), limit(PRENDAS_COUNT_BATCH_SIZE)];
                if (cursor) fallbackConstraints.splice(1, 0, startAfter(cursor));
                const fallbackSnap = await getDocs(
                  query(collection(db, PRENDAS_MASTER_COLLECTION), ...fallbackConstraints)
                );
                if (fallbackSnap.empty) {
                  hasMore = false;
                  break;
                }
                fallbackSnap.docs.forEach((docSnap) => {
                  const row = normalizeDoc(docSnap);
                  row.costo = null;
                  row.iva = null;
                  row.margen = null;
                  row.utilidad = null;
                  rows.push(row);
                });
                cursor = fallbackSnap.docs[fallbackSnap.docs.length - 1];
                if (fallbackSnap.docs.length < PRENDAS_COUNT_BATCH_SIZE) {
                  hasMore = false;
                }
              }
            }
          } catch (error) {
            console.warn("[Prendas] fallback a master no disponible", error);
          }
        }

        rows.forEach((row) => {
          row.costo = null;
          row.utilidad = null;
          row.margen = null;
        });

        const orderedRows = rows.sort(compareItemsByOrdenAsc);
        orderedRows.forEach((row, index) => {
          const generatedOrder = index + 1;
          row.__order = generatedOrder;
          row._rowNumber = generatedOrder;
          if (!Number.isFinite(toNumberOrNull(row.orden))) {
            row.orden = generatedOrder;
          }
        });

        prendasState.baseRows = orderedRows;
        prendasState.baseRowsCacheKey = cacheKey;
        return prendasState.baseRows;
      };

      const resetPrendasState = () => {
        prendasState.filtered = [];
        prendasState.baseRows = [];
        prendasState.baseRowsCacheKey = prendasState.isAdmin ? "admin" : "public";
        prendasState.rowsAfterGlobal = [];
        prendasState.rowsAfterAll = [];
        prendasState.isDone = false;
        prendasState.filtersActive = false;
        prendasState.showingTotal = null;
        prendasState.queryKey = "";
        prendasState.pageIndex = 0;
        prendasState.hasNextPage = false;
        prendasState.filters.global = getCurrentGlobalFilters();
        prendasState.filters.header = createEmptyHeaderFilters();
        prendasState.sort = restorePersistedSort();
        prendasState.uniqueOptions = {};
        prendasState.adminMap.clear();
        prendasState.selected.clear();
        closeHeaderPopover();
        resetCounters();
      };

      const renderLoadingPlaceholder = () => {
        if (!prendasTbody) return;
        prendasTbody.textContent = "";
        const row = document.createElement("tr");
        const cell = document.createElement("td");
        cell.colSpan = 17;
        cell.textContent = "Cargando base de datos...";
        row.appendChild(cell);
        prendasTbody.appendChild(row);
        setCounter(0, prendasState.showingTotal);
      };

      const refreshExactCounts = (rowsAfterAll) => {
        const total = rowsAfterAll.length;
        const nuevos = rowsAfterAll.filter((item) => isNew(getPrendaDate(item))).length;
        const existentes = total - nuevos;
        setApproxCounts({ total, nuevos, existentes, isApprox: false });
      };

      const getLoadingMessageByReason = (reason) => {
        if (["filters", "filters-clear", "search-clear"].includes(reason)) {
          return "Aplicando filtros...";
        }
        if (["pagination-prev", "pagination-next"].includes(reason)) {
          return "Cargando p√°gina...";
        }
        if (reason === "page-size") {
          return "Actualizando cantidad por p√°gina...";
        }
        return "Cargando base de datos...";
      };

      const loadPrendasPage = async ({
        pageIndex = null,
        reset = false,
        reason = "manual"
      } = {}) => {
        if (prendasState.isLoadingInitial) {
          return;
        }
        setSkuSearchMode(false);
        setPrendasAlert("");
        prendasState.isLoadingInitial = true;
        setLoading(true, getLoadingMessageByReason(reason));
        try {
          if (reset) {
            prendasState.pageIndex = 0;
            renderLoadingPlaceholder();
          }
          const baseRows = await loadBaseRows();
          console.log("[Prendas] baseRows:", baseRows.length);
          const rowsAfterAll = applyAllFilters(baseRows);
          HEADER_FILTER_KEYS.forEach((key) => {
            prendasState.uniqueOptions[key] = getUniqueOptions(prendasState.rowsAfterGlobal, key);
          });
          updateHeaderFilterButtonsState();
          const pageSize = getPageSize();
          const totalRows = rowsAfterAll.length;
          const totalPages = Math.max(1, Math.ceil(totalRows / pageSize));
          const requestedPageIndex = Number.isFinite(Number(pageIndex))
            ? Number(pageIndex)
            : prendasState.pageIndex;
          const safePageIndex = Math.min(Math.max(requestedPageIndex, 0), totalPages - 1);
          const start = safePageIndex * pageSize;
          const items = rowsAfterAll.slice(start, start + pageSize);

          prendasState.filtered = items;

          await mergeAdminFields(items);

          prendasState.pageIndex = safePageIndex;
          prendasState.hasNextPage = safePageIndex < totalPages - 1;
          prendasState.filtersActive = hasActiveFilters(getCurrentFilters());
          prendasState.showingTotal = totalRows;

          await renderDocs(items);
          refreshExactCounts(rowsAfterAll);

          if (prendasState.filtersActive && !items.length) {
            setPrendasAlert("No hay resultados con los filtros actuales.");
          }
        } catch (error) {
          console.error(error);
          setPrendasAlert("No se pudo cargar la base de datos de c√≥digos.");
        } finally {
          prendasState.isLoadingInitial = false;
          setLoading(false);
          updatePaginationUi();
        }
      };

      const applyFilters = async () => {
        await loadPrendasPage({ reset: true, reason: "filters" });
      };


      const normalizeFilterValue = (value) => normalizeText(value);
      const toNum = (value) => {
        const parsed = Number(value);
        return Number.isFinite(parsed) ? parsed : null;
      };

      const getPageSize = () => {
        const selected = Number(prendasPageSize?.value);
        if (Number.isFinite(selected) && selected > 0) {
          return selected;
        }
        return PRENDAS_PAGE_SIZE_DEFAULT;
      };

      const renderRowsChunked = (
        rows,
        tbody,
        chunkSize = PRENDAS_RENDER_CHUNK,
        token
      ) =>
        new Promise((resolve) => {
          let index = 0;
          const appendChunk = () => {
            if (token && token !== prendasState.renderToken) {
              resolve(0);
              return;
            }
            const fragment = document.createDocumentFragment();
            for (let i = 0; i < chunkSize && index < rows.length; i += 1) {
              fragment.appendChild(createPrendaRow(rows[index]));
              index += 1;
            }
            tbody.appendChild(fragment);
            if (index < rows.length) {
              requestAnimationFrame(appendChunk);
              return;
            }
            resolve(0);
          };
          requestAnimationFrame(appendChunk);
        });

      const buildBadge = (text, className) => {
        const badge = document.createElement("span");
        badge.className = `badge ${className}`;
        badge.textContent = text;
        return badge;
      };

      const createPrendaRow = (item) => {
        const adminEnabled = isAdminViewEnabled();
        const ordenValue = Number(item.orden);
        const orden = Number.isFinite(ordenValue) ? String(ordenValue) : "";
        const codigo = safeString(item.codigo || item.code) || "--";
        const descripcion = safeString(item.descripcion) || "--";
        const tipo = safeString(item.tipo) || "--";
        const color = safeString(item.color) || "--";
        const talla = safeString(item.talla) || "--";
        const proveedor = safeString(item.proveedor) || "--";
        const statusCell = renderStatusCell(item.statusCanon || item.status);
        const disponibilidadCell = renderDisponibilidadCell(item.disponibilidadCanon || item.disponibilidad, item.statusCanon || item.status);
        const fecha = formatDateCell(item);
        const pVentaVisible = adminEnabled
          ? (toNumber(item.pVentaDisplay) ?? toNumber(item.pVenta))
          : toNumber(item.pVenta);
        const pVenta = moneyFmt(pVentaVisible);
        const costo = moneyFmt(item.costo);
        const margen = pctFmt(item.margen);
        const utilidad = moneyFmt(item.utilidad);

        const row = document.createElement("tr");
        const docId = safeString(item.docId || item.id).trim();
        row.dataset.docId = docId;
        row.className = isNew(getPrendaDate(item)) ? "row-new" : "row-old";

        const selectCell = document.createElement("td");
        selectCell.className = "col-select";
        const selectInput = document.createElement("input");
        selectInput.type = "checkbox";
        selectInput.className = "row-select";
        selectInput.dataset.docId = docId;
        selectInput.checked = prendasState.selected.has(docId);
        selectCell.appendChild(selectInput);
        row.appendChild(selectCell);

        const baseCells = [orden, codigo, descripcion, tipo, color, talla, proveedor, statusCell, disponibilidadCell, fecha, pVenta];
        const baseClasses = [
          "col-orden","col-codigo","col-descripcion","col-tipo","col-color","col-talla","col-proveedor","col-status","col-disponibilidad","col-fecha","col-pventa"
        ];
        baseCells.forEach((value, index) => {
          if (value instanceof HTMLElement) {
            value.classList.add(baseClasses[index] || "");
            row.appendChild(value);
            return;
          }
          const cell = document.createElement("td");
          cell.textContent = value;
          cell.classList.add(baseClasses[index] || "");
          if (index === 2) {
            cell.classList.add("cell-desc");
            cell.title = value;
          }
          row.appendChild(cell);
        });

        if (adminEnabled) {
          const adminValues = [costo, margen, utilidad];
          const adminClasses = ["col-costo", "col-margen", "col-utilidad"];
          adminValues.forEach((value, index) => {
            const cell = document.createElement("td");
            cell.textContent = value;
            cell.classList.add("admin-only", adminClasses[index]);
            row.appendChild(cell);
          });

          const actionCell = document.createElement("td");
          actionCell.className = "admin-only col-actions";
          const editButton = document.createElement("button");
          editButton.type = "button";
          editButton.className = "rowEditBtn";
          editButton.dataset.editDoc = safeString(item.docId || item.id).trim();
          editButton.setAttribute("aria-label", "Editar fila");
          editButton.textContent = "‚úé";
          actionCell.appendChild(editButton);
          row.appendChild(actionCell);
        }
        return row;
      };

      const updateEditPreview = () => {
        if (!editPVentaInput || !editCostoInput) return;
        const pOverride = toNumber(editPVentaInput.value);
        const pPublic = toNumber(prendasState.editing?.publicPVenta);
        const p = Number.isFinite(pOverride) ? pOverride : (pPublic ?? 0);
        const c = toNumber(editCostoInput.value) ?? 0;
        const { utilidad, margenPct } = computeMarginUtility(p, c);
        if (editUtilidadPreview) editUtilidadPreview.textContent = moneyFmt(utilidad);
        if (editMargenPreview) editMargenPreview.textContent = pctFmt(margenPct);
      };

      const closeEditModal = () => {
        prendasState.editing = null;
        if (editModal) {
          editModal.classList.add("hidden");
          editModal.setAttribute("aria-hidden", "true");
        }
        if (editModalError) {
          editModalError.textContent = "";
          editModalError.classList.add("hidden");
        }
      };

      const openEditModal = (rowData) => {
        if (!editModal || !rowData) return;
        const publicPVenta = toNumber(rowData.pVenta);
        const pVentaOverride = toNumber(rowData.pVentaOverride);
        prendasState.editing = {
          docId: safeString(rowData.docId || rowData.id).trim(),
          publicPVenta,
          rowDataSnapshot: { ...rowData }
        };
        if (editPVentaInput) editPVentaInput.value = Number.isFinite(pVentaOverride) ? pVentaOverride : "";
        if (editCostoInput) editCostoInput.value = toNumber(rowData.costo) ?? "";
        if (editModalError) {
          editModalError.textContent = "";
          editModalError.classList.add("hidden");
        }
        updateEditPreview();
        editModal.classList.remove("hidden");
        editModal.setAttribute("aria-hidden", "false");
      };

      const updateRowInMemory = (docId, updates) => {
        const applyTo = (rows = []) => {
          rows.forEach((row) => {
            const rowDocId = safeString(row.docId || row.id).trim();
            if (rowDocId !== docId) return;
            Object.assign(row, updates);
          });
        };
        applyTo(prendasState.baseRows);
        applyTo(prendasState.rowsAfterAll);
        applyTo(prendasState.rowsAfterGlobal);
        applyTo(prendasState.filtered);
      };

      const ensureAdminSession = async () => {
        let user = auth.currentUser;
        if (!user) {
          const response = await signInWithPopup(auth, googleProvider);
          user = response?.user || null;
        }
        const email = safeString(user?.email).trim().toLowerCase();
        if (!isAllowlistedAdmin(email)) {
          if (user) {
            await signOut(auth);
          }
          throw new Error("Usuario no autorizado para editar.");
        }
        return user;
      };

      const saveEdit = async () => {
        try {
          if (!prendasState.editing?.docId) return;
          const docId = prendasState.editing.docId;
          const pVentaOverride = toNumber(editPVentaInput?.value);
          const costo = toNumber(editCostoInput?.value);
          if (Number.isFinite(pVentaOverride) && pVentaOverride < 0) {
            throw new Error("P.Venta debe ser mayor o igual a 0.");
          }
          if (Number.isFinite(costo) && costo < 0) {
            throw new Error("Costo debe ser mayor o igual a 0.");
          }
          editModalSaveButton.disabled = true;
          const user = await ensureAdminSession();
          const pVentaVisible = Number.isFinite(pVentaOverride)
            ? pVentaOverride
            : toNumber(prendasState.editing?.publicPVenta);
          const { utilidad, margenPct } = computeMarginUtility(pVentaVisible, costo);
          const adminRef = doc(db, PRENDAS_ADMIN_COLLECTION, docId);
          await setDoc(adminRef, {
            docId,
            costo: Number.isFinite(costo) ? costo : deleteField(),
            pVentaOverride: Number.isFinite(pVentaOverride) ? pVentaOverride : deleteField(),
            utilidad: (Number.isFinite(pVentaVisible) && Number.isFinite(costo)) ? utilidad : deleteField(),
            margen: (Number.isFinite(pVentaVisible) && Number.isFinite(costo)) ? margenPct : deleteField(),
            updatedAt: serverTimestamp(),
            updatedBy: safeString(user?.email).trim().toLowerCase()
          }, { merge: true });

          prendasState.adminMap.set(docId, {
            costo: Number.isFinite(costo) ? costo : null,
            pVentaOverride: Number.isFinite(pVentaOverride) ? pVentaOverride : null,
            utilidad: (Number.isFinite(pVentaVisible) && Number.isFinite(costo)) ? utilidad : null,
            margen: (Number.isFinite(pVentaVisible) && Number.isFinite(costo)) ? margenPct : null
          });

          const nextPVenta = Number.isFinite(pVentaOverride)
            ? pVentaOverride
            : toNumber(prendasState.editing?.publicPVenta);
          const hasMarginData = Number.isFinite(nextPVenta) && Number.isFinite(costo);
          updateRowInMemory(docId, {
            costo: Number.isFinite(costo) ? costo : null,
            pVentaOverride: Number.isFinite(pVentaOverride) ? pVentaOverride : null,
            pVentaDisplay: Number.isFinite(nextPVenta) ? nextPVenta : null,
            utilidad: hasMarginData ? utilidad : null,
            margen: hasMarginData ? Number(margenPct.toFixed(1)) : null
          });
          await loadPrendasPage({ reset: false, reason: "edit-save" });
          closeEditModal();
        } catch (error) {
          if (editModalError) {
            editModalError.textContent = error?.message || "No se pudo guardar.";
            editModalError.classList.remove("hidden");
          }
          console.error(error);
        } finally {
          if (editModalSaveButton) {
            editModalSaveButton.disabled = false;
          }
        }
      };

      const renderDocs = async (rows) => {
        prendasState.renderToken += 1;
        const token = prendasState.renderToken;
        const showingTotal = Number.isFinite(prendasState.showingTotal)
          ? prendasState.showingTotal
          : null;
        setCounter(rows.length, showingTotal);
        updatePaginationUi();

        prendasTbody.textContent = "";
        if (!rows.length) {
          let emptyNode = null;
          if (prendasEmptyRow) {
            emptyNode = prendasEmptyRow instanceof HTMLTemplateElement
              ? prendasEmptyRow.content.cloneNode(true)
              : prendasEmptyRow.cloneNode(true);
          }
          if (!emptyNode) {
            const emptyRow = document.createElement("tr");
            const cell = document.createElement("td");
            cell.colSpan = 17;
            cell.textContent = "No hay resultados con los filtros actuales.";
            emptyRow.appendChild(cell);
            emptyNode = emptyRow;
          }
          prendasTbody.appendChild(emptyNode);
          setCounter(0, showingTotal);
          updateSelectAllCheckbox();
          return;
        }
        await renderRowsChunked(rows, prendasTbody, PRENDAS_RENDER_CHUNK, token);
        updateSelectAllCheckbox();
      };

      const setSkuSearchMode = (enabled) => {
        prendasState.isSkuSearch = enabled;
        updatePaginationUi();
      };

      const fetchBySku = async (rawInput) => {
        const rawUpper = safeString(rawInput).trim().toUpperCase();
        const normalizedSku = normalizeSku(rawUpper);
        if (!rawUpper) return null;
        const directSnap = await getDoc(doc(db, activePrendasPublicCollection, normalizedSku));
        const altSnap = directSnap.exists()
          ? null
          : await getDoc(doc(db, activePrendasPublicCollection, rawUpper));
        const baseSnap = directSnap.exists() ? directSnap : altSnap;
        if (!baseSnap?.exists()) return null;
        const item = normalizeDoc(baseSnap);
        return item;
      };

      const runSkuSearch = async (rawInput) => {
        const rawUpper = safeString(rawInput).trim().toUpperCase();
        if (!rawUpper) return;
        setSkuSearchMode(true);
        setLoading(true, "Buscando c√≥digo...");
        try {
          const result = await fetchBySku(rawUpper);
          const items = result ? [result] : [];
          await mergeAdminFields(items);
          prendasState.filtered = items;
          prendasState.showingTotal = items.length;
          prendasState.pageIndex = 0;
          prendasState.hasNextPage = false;
          await renderDocs(items);
          refreshExactCounts(items);
        } finally {
          setLoading(false);
        }
      };

      const ensureRequired = () => {
        if (!registroProveedor.value || !registroProducto.value || !registroColor.value || !registroTalla.value) {
          setRegistroStatus("Completa Proveedor, Producto, Color y Talla.", "error");
          return false;
        }
        return true;
      };

      const getSelectedName = (selectEl) => {
        const option = selectEl.options[selectEl.selectedIndex];
        return option?.dataset?.nombre || option?.textContent?.split(" - ")[1] || option?.textContent || "";
      };

      const HISTORICOS_URL = "../Data/codigos_historicos.json";
      let historicosCache = null;

      const loadHistoricosMap = async () => {
        if (historicosCache) {
          return historicosCache;
        }
        historicosCache = fetch(HISTORICOS_URL)
          .then((response) => {
            if (!response.ok) {
              throw new Error("No se pudo cargar el hist√≥rico de c√≥digos.");
            }
            return response.json();
          })
          .then((codes) => {
            const maxPorKey = {};
            const pattern = /^HA(\d+)([A-Z])(\d{3})\//i;
            codes.forEach((code) => {
              const match = pattern.exec(String(code).trim().toUpperCase());
              if (!match) return;
              const key = `prov${match[1]}_tipo${match[2]}`;
              const seq = Number(match[3]);
              if (!Number.isFinite(seq)) return;
              if (!maxPorKey[key] || seq > maxPorKey[key]) {
                maxPorKey[key] = seq;
              }
            });
            return maxPorKey;
          })
          .catch((error) => {
            console.warn("No se pudo cargar el hist√≥rico de c√≥digos.", error);
            return {};
          });
        return historicosCache;
      };

      const getNextCounter = async (providerCode, typeCode) => {
        const key = `prov${providerCode}_tipo${typeCode}`;
        const counterRef = doc(db, "counters", key);

        return runTransaction(db, async (transaction) => {
          const snapshot = await transaction.get(counterRef);
          const data = snapshot.data() || {};
          let counterValue = Number(data.value);

          if (!Number.isFinite(counterValue)) {
          counterValue = Number(data.lastNumber);
          }

          if (!Number.isFinite(counterValue)) {
          const maxPorKey = await loadHistoricosMap();
          counterValue = Number(maxPorKey[key] ?? 0);
          }
          if (!Number.isFinite(counterValue)) {
            throw new Error(`Contador inv√°lido para ${key}. Revisa counters/${key}.`);
          }
          console.log("COUNTER READ", { key, data, counterValue });
          const nextValue = counterValue + 1;
          transaction.set(counterRef, { value: nextValue, lastNumber: nextValue }, { merge: true });
          return { nextValue, key };
        });
      };

      registroForm.addEventListener("submit", async (event) => {
        event.preventDefault();
        setRegistroStatus("");

        if (!ensureRequired()) {
          return;
        }

        const providerCode = registroProveedor.value;
        const typeCode = registroProducto.value;
        const colorClave = registroColor.value;
        const tallaClave = registroTalla.value;
        try {
          registroSubmit.disabled = true;
          const { nextValue, key } = await getNextCounter(providerCode, typeCode);
          const consecutivo = String(nextValue).padStart(3, "0");
          const codigo = `HA${providerCode}${typeCode}${consecutivo}/${colorClave}-${tallaClave}`;
          console.info(`Generando c√≥digo ${codigo} para counter ${key}.`);

          const createdByValue = document.getElementById("registro-created-by").value.trim();
          const detallesValue = registroDetalles.value.trim();
          const tipoNombre = getSelectedName(registroProducto).trim();
          const proveedorNombre = getSelectedName(registroProveedor).trim();
          const colorNombre = getSelectedName(registroColor).trim();
          const tallaNombre = getSelectedName(registroTalla).trim();
          const descripcion = [tipoNombre, proveedorNombre, colorNombre, tallaNombre]
            .filter(Boolean)
            .join(" ");
          const docId = safeDocId(codigo);

          const payloadPublic = {
            docId,
            codigo,
            proveedor: providerCode,
            tipo: typeCode,
            color: colorClave,
            talla: tallaClave,
            descripcion: descripcion || null,
            detalles: detallesValue || null,
            code: codigo,
            providerCode,
            typeCode,
            seqNumber: nextValue,
            orden: nextValue,
            colorCode: colorClave,
            sizeCode: tallaClave,
            status: "Disponible",
            statusCanon: "Disponible",
            disponibilidad: "Disponible",
            disponibilidadCanon: "Disponible",
            fecha: new Date().toISOString(),
            fechaAlta: serverTimestamp(),
            creadoPor: createdByValue || null,
            createdAt: serverTimestamp(),
            updatedAt: serverTimestamp()
          };

          const publicRef = doc(db, PRENDAS_PUBLIC_COLLECTION, docId);
          const duplicateFound = (await getDoc(publicRef)).exists();
          await setDoc(publicRef, payloadPublic, { merge: true });

          if (isAdminViewEnabled()) {
            const costo = toNumber(adminCreateCostoInput?.value);
            const pVentaOverride = toNumber(adminCreatePVentaInput?.value);
            const pVentaVisible = Number.isFinite(pVentaOverride)
              ? pVentaOverride
              : toNumber(payloadPublic.pVenta);
            const { utilidad, margenPct } = computeMarginUtility(pVentaVisible, costo);
            const payloadAdmin = {
              docId,
              updatedAt: serverTimestamp(),
              updatedBy: safeString(auth.currentUser?.email).trim().toLowerCase()
            };
            if (Number.isFinite(costo)) payloadAdmin.costo = costo;
            if (Number.isFinite(pVentaOverride)) payloadAdmin.pVentaOverride = pVentaOverride;
            if (Number.isFinite(pVentaVisible) && Number.isFinite(costo)) {
              payloadAdmin.utilidad = utilidad;
              payloadAdmin.margen = margenPct;
            }
            await setDoc(doc(db, PRENDAS_ADMIN_COLLECTION, docId), payloadAdmin, { merge: true });
          }

          if (adminCreateCostoInput) adminCreateCostoInput.value = "";
          if (adminCreatePVentaInput) adminCreatePVentaInput.value = "";
          await loadPrendasPage({ reset: true, reason: "create-code" });

          registroCodigo.textContent = codigo;
          registroResult.classList.remove("hidden");
          if (duplicateFound) {
            setRegistroStatus("C√≥digo actualizado en public/admin.", "warning");
          } else if (isAdminViewEnabled()) {
            setRegistroStatus("Prenda guardada correctamente en colecciones public/admin.", "success");
          } else {
            setRegistroStatus("Prenda guardada correctamente en colecci√≥n public.", "success");
          }
        } catch (error) {
          const message =
            error?.message?.includes("contador") || error?.message?.includes("Contador")
              ? error.message
              : "No se pudo generar el c√≥digo. Intenta nuevamente.";
          setRegistroStatus(message, "error");
          console.error(error);
        } finally {
          registroSubmit.disabled = false;
        }
      });

      registroCopy.addEventListener("click", async () => {
        try {
          await navigator.clipboard.writeText(registroCodigo.textContent.trim());
          setRegistroStatus("C√≥digo copiado al portapapeles.", "success");
        } catch (error) {
          setRegistroStatus("No se pudo copiar el c√≥digo.", "error");
          console.error(error);
        }
      });

      registroReset.addEventListener("click", () => {
        registroForm.reset();
        registroResult.classList.add("hidden");
        setRegistroStatus("");
      });

      const formatPrice = (value) => {
        const amount = Number(value);
        if (!Number.isFinite(amount)) return "$0.00";
        return `$${amount.toFixed(2)}`;
      };

      const fetchRowBySku = async (skuRaw) => {
        const sku = safeString(skuRaw).trim().toUpperCase();
        if (!sku) return null;
        const docId = safeDocId(sku);

        const publicSnap = await getDoc(doc(db, activePrendasPublicCollection, docId));
        const publicData = publicSnap.exists() ? publicSnap.data() || {} : null;

        if (isAdminViewEnabled()) {
          const adminSnap = await getDoc(doc(db, PRENDAS_ADMIN_COLLECTION, docId));
          if (adminSnap.exists()) {
            const adminData = adminSnap.data() || {};
            return {
              ...(publicData || {}),
              ...adminData,
              codigo: safeString(publicData?.codigo || adminData?.codigo || sku).toUpperCase()
            };
          }
        }

        if (publicData) {
          return {
            ...publicData,
            codigo: safeString(publicData?.codigo || sku).toUpperCase()
          };
        }
        return null;
      };

      const buildLabelPrintPages = ({ sku, qty, price, logoSrc }) => {
        if (!printRoot) return;
        printRoot.innerHTML = "";

        for (let i = 0; i < qty; i += 1) {
          const page = document.createElement("div");
          page.className = "label-page";

          const left = document.createElement("div");
          left.className = "label-left";

          const codeTitle = document.createElement("div");
          codeTitle.className = "label-code-title";
          codeTitle.textContent = "CODIGO$";

          const skuText = document.createElement("div");
          skuText.className = "label-sku";
          skuText.textContent = sku;

          const priceTitle = document.createElement("div");
          priceTitle.className = "label-price-title";
          priceTitle.textContent = "PRECIO$";

          const priceValue = document.createElement("div");
          priceValue.className = "label-price-value";
          priceValue.textContent = price;

          left.append(codeTitle, skuText, priceTitle, priceValue);

          const right = document.createElement("div");
          right.className = "label-right";

          const qrContainer = document.createElement("div");
          qrContainer.className = "label-qr";
          qrContainer.id = `label-qr-${i}`;

          const logo = document.createElement("img");
          logo.className = "label-logo";
          logo.src = logoSrc;
          logo.alt = "harujagdl";

          right.append(qrContainer, logo);
          page.append(left, right);
          printRoot.appendChild(page);

          if (window.QRCode) {
            new QRCode(qrContainer, {
              text: sku,
              width: 140,
              height: 140,
              correctLevel: QRCode.CorrectLevel.M
            });
          }
        }
      };

      const handlePrintLabel = async (event) => {
        event.preventDefault();
        setZplStatus("");

        const sku = safeString(labelSkuInput?.value).trim().toUpperCase();
        const qtyValue = Number(labelQtyInput?.value);
        const qty = Number.isInteger(qtyValue) ? qtyValue : 0;

        if (!sku) {
          setZplStatus("Ingresa un SKU.", "error");
          return;
        }

        if (qty < 1 || qty > 200) {
          setZplStatus("La cantidad debe estar entre 1 y 200.", "error");
          return;
        }

        if (!printRoot) {
          setZplStatus("No se encontr√≥ el contenedor de impresi√≥n (#printRoot).", "error");
          return;
        }

        try {
          labelPrintBtn.disabled = true;
          const row = await fetchRowBySku(sku);
          if (!row) {
            setZplStatus("No se encontr√≥ el SKU en Firestore.", "error");
            return;
          }

          const priceRaw = row?.precioVenta ?? row?.pVentaOverride ?? row?.pVenta ?? row?.precio ?? 0;
          const formattedPrice = formatPrice(priceRaw);

          if (LABEL_ZPL_DEBUG) {
            try {
              const debugZpl = buildLabelZpl({ sku, price: formattedPrice, qty });
              console.log("[label-zpl-debug] ZPL generado:\n", debugZpl);
            } catch (error) {
              console.error("[label-zpl-debug] No se pudo generar ZPL de depuraci√≥n:", error);
            }
          }

          buildLabelPrintPages({
            sku,
            qty,
            price: formattedPrice,
            logoSrc: getZplLogoDataUrl()
          });

          setZplStatus(`Imprimiendo ${qty} etiqueta(s)‚Ä¶`, "success");
          window.print();
        } catch (error) {
          console.error(error);
          setZplStatus("No se pudo preparar la impresi√≥n de etiquetas.", "error");
        } finally {
          labelPrintBtn.disabled = false;
        }
      };

      zplForm.addEventListener("submit", handlePrintLabel);

      // ADMIN DB MODE START
      const DB_TAB_HASH = "#base-datos-codigos";

      const isAllowlistedAdmin = (email) =>
        ADMIN_ALLOWLIST.has(safeString(email).trim().toLowerCase());

      const getAdminViewEnabled = () =>
        sessionStorage.getItem(ADMIN_VIEW_KEY) === "1";

      const isAdminAuthenticated = () => prendasState.adminByAuth === true;
      const isAdminViewEnabled = () => getAdminViewEnabled() === true && isAdminAuthenticated();

      const setAdminViewEnabled = (enabled) => {
        // Solo permitir modo admin si el usuario est√° autenticado y en allowlist
        const adminByAuth = Boolean(prendasState.adminByAuth);
        const finalEnabled = adminByAuth ? Boolean(enabled) : false;
        sessionStorage.setItem(ADMIN_VIEW_KEY, finalEnabled ? "1" : "0");
        document.body.classList.toggle("is-admin", finalEnabled);
      };

      const setAdminLoginStatus = (message, type = "") => {
        if (!adminLoginStatus) return;
        adminLoginStatus.textContent = message;
        adminLoginStatus.className = `status ${type}`.trim();
      };

      let adminPanelVisible = false;

      const setAdminPanelVisible = (visible) => {
        adminPanelVisible = visible;
        if (adminPanel) {
          adminPanel.classList.toggle("hidden", !visible);
        }
        if (adminOptionalToggle) {
          adminOptionalToggle.textContent = visible ? "Ocultar admin" : "Admin";
        }
      };

      const applyAdminUI = ({ refresh = true } = {}) => {
        const byAuth = Boolean(prendasState.adminByAuth);
        const enabled = byAuth && getAdminViewEnabled();
        prendasState.isAdmin = enabled;
        document.body.classList.toggle("is-admin", enabled);
        if (dbCodigosSection) {
          dbCodigosSection.classList.toggle("admin-enabled", enabled);
        }
        if (adminToggleDb) {
          adminToggleDb.checked = enabled;
          adminToggleDb.disabled = !byAuth;
        }
        if (adminActions) {
          adminActions.classList.toggle("hidden", !byAuth);
        }
        if (adminLoginButton) {
          adminLoginButton.classList.toggle("hidden", byAuth);
        }
        if (adminLogoutButton) {
          adminLogoutButton.classList.toggle("hidden", !byAuth);
        }
        if (adminLogoutQuickButton) {
          adminLogoutQuickButton.classList.toggle("hidden", !byAuth);
        }
        if (byAuth) {
          setAdminLoginStatus(`Admin autenticado: ${prendasState.adminEmail}`, "success");
        } else {
          setAdminLoginStatus("Inicia sesi√≥n con un correo admin permitido.");
          setAdminViewEnabled(false);
        }
        if (adminCreateFields) {
          adminCreateFields.classList.toggle("hidden", !enabled);
          adminCreateFields.setAttribute("aria-hidden", enabled ? "false" : "true");
        }
        if (adminCreateCostoInput) {
          adminCreateCostoInput.disabled = !enabled;
          if (!enabled) adminCreateCostoInput.value = "";
        }
        if (adminCreatePVentaInput) {
          adminCreatePVentaInput.disabled = !enabled;
          if (!enabled) adminCreatePVentaInput.value = "";
        }
        if (!enabled) {
          prendasState.adminMap.clear();
          closeEditModal();
        }
        setAdminPanelVisible(adminPanelVisible);
        if (refresh) {
          loadPrendasPage({ reset: true, reason: "admin-toggle" });
        }
        updateAdminModeBtn();

      };

      const handleAdminToggle = async () => {
        // Si no est√° autenticado como admin, el bot√≥n funciona como login
        if (!prendasState.adminByAuth) {
          await handleAdminLogin();
          if (prendasState.adminByAuth) {
            setAdminViewEnabled(true);
            applyAdminUI();
            try { await applyFilters(); } catch (_) {}
          }
          return;
        }
        const nextEnabled = !getAdminViewEnabled();
        setAdminViewEnabled(nextEnabled);
        applyAdminUI();
        try { await applyFilters(); } catch (_) {}
      };

      const handleAdminLogin = async () => {
        if (adminLoginButton) {
          adminLoginButton.disabled = true;
        }
        try {
          const response = await signInWithPopup(auth, googleProvider);
          const email = safeString(response?.user?.email).trim().toLowerCase();
          if (!isAllowlistedAdmin(email)) {
            setAdminLoginStatus("Tu cuenta no est√° permitida como admin.", "error");
            await signOut(auth);
            return;
          }
          setAdminViewEnabled(true);
          applyAdminUI();
        } catch (error) {
          console.error(error);
          setAdminLoginStatus("No se pudo iniciar sesi√≥n con Google.", "error");
        } finally {
          if (adminLoginButton) {
            adminLoginButton.disabled = false;
          }
        }
      };

      const handleAdminLogout = async () => {
        try {
          await signOut(auth);
        } catch (error) {
          console.error(error);
        }
      };

      // (XLSX import removed)


      const handleAdminSplitCollections = async () => {
        if (adminSplitButton) {
          adminSplitButton.disabled = true;
        }
        try {
          let user = auth.currentUser;
          if (!user) {
            const response = await signInWithPopup(auth, googleProvider);
            user = response?.user || null;
          }
          const email = safeString(user?.email).trim().toLowerCase();
          if (!isAllowlistedAdmin(email)) {
            setAdminLoginStatus("Tu cuenta no est√° permitida como admin.", "error");
            await signOut(auth);
            return;
          }
          const idToken = await user.getIdToken(true);
          setAdminLoginStatus("Migrando colecci√≥n base a public/admin por lotes...", "warning");

          let totalProcessed = 0;
          let totalPublic = 0;
          let totalAdmin = 0;
          let cursor = "";
          let hasMore = true;

          while (hasMore) {
            const response = await fetch(SPLIT_FUNCTION_URL, {
              method: "POST",
              headers: {
                "Content-Type": "application/json",
                Authorization: `Bearer ${idToken}`
              },
              body: JSON.stringify({
                batchSize: 300,
                startAfter: cursor || undefined
              })
            });
            const payload = await response.json();
            if (!response.ok || !payload?.ok) {
              throw new Error(payload?.error || `HTTP ${response.status}`);
            }

            totalProcessed += Number(payload?.processed || 0);
            totalPublic += Number(payload?.writtenPublic || 0);
            totalAdmin += Number(payload?.writtenAdmin || 0);
            cursor = safeString(payload?.lastDocCursor).trim();
            hasMore = Boolean(payload?.hasMore) && Boolean(cursor);

            setAdminLoginStatus(
              `Migrando... lote=${payload?.processed || 0}, acumulado=${totalProcessed}, √∫ltimo=${cursor || "fin"}`,
              "warning"
            );

            if (!payload?.processed) {
              hasMore = false;
            }
          }

          setAdminLoginStatus(
            `Migraci√≥n OK. procesados=${totalProcessed}, public=${totalPublic}, admin=${totalAdmin}.`,
            "success"
          );
          setPrendasAlert("");
          await loadPrendasPage({ reset: true, reason: "migrate-collections" });
        } catch (error) {
          console.error(error);
          setAdminLoginStatus(`Error al migrar colecciones: ${error.message || error}`, "error");
        } finally {
          if (adminSplitButton) {
            adminSplitButton.disabled = false;
          }
        }
      };

      onAuthStateChanged(auth, async (user) => {
        const email = safeString(user?.email).trim().toLowerCase();
        if (user && !isAllowlistedAdmin(email)) {
          setAdminLoginStatus("No autorizado", "error");
          await signOut(auth);
          return;
        }
        prendasState.adminUser = user || null;
        prendasState.adminEmail = email;
        prendasState.adminByAuth = Boolean(user) && isAllowlistedAdmin(email);
        if (!prendasState.adminByAuth) {
          setAdminViewEnabled(false);
        }
        applyAdminUI();
      });

      const handleTabChange = (hash) => {
        if (hash === DB_TAB_HASH) {
          applyAdminUI({ refresh: false });
        }
      };

      if (adminToggleDb) {
        adminToggleDb.addEventListener("change", handleAdminToggle);
      }
      if (adminLoginButton) {
        adminLoginButton.addEventListener("click", handleAdminLogin);
      }
      if (adminLogoutButton) {
        adminLogoutButton.addEventListener("click", handleAdminLogout);
      }
      if (adminLogoutQuickButton) {
        adminLogoutQuickButton.addEventListener("click", handleAdminLogout);
      }
      if (adminOptionalToggle) {
        adminOptionalToggle.addEventListener("click", () => {
          setAdminPanelVisible(!adminPanelVisible);
        });
      }
      
      const adminModeBtn = document.getElementById("admin-mode-btn");

      const updateAdminModeBtn = () => {
        if (!adminModeBtn) return;
        const enabled = isAdminViewEnabled();
        adminModeBtn.classList.toggle("is-on", enabled);
        adminModeBtn.setAttribute("aria-pressed", enabled ? "true" : "false");
        if (!prendasState.adminByAuth) {
          adminModeBtn.textContent = "Modo admin";
          adminModeBtn.title = "Inicia sesi√≥n con Google para ver Costos/Margen/Utilidad";
          return;
        }
        adminModeBtn.textContent = enabled ? "Salir admin" : "Modo admin";
        adminModeBtn.title = enabled ? "Salir de la vista admin" : "Mostrar columnas admin";
      };

      
      if (adminModeBtn) {
        adminModeBtn.addEventListener("click", async () => {
          try {
            await handleAdminToggle();
          } catch (e) {
            console.error(e);
          }
        });
      }

      if (prendasTable) {
        prendasTable.addEventListener("click", (event) => {
          const rowSelect = event.target.closest(".row-select");
          if (rowSelect) {
            const docId = safeString(rowSelect.dataset.docId).trim();
            if (!docId) return;
            if (rowSelect.checked) prendasState.selected.add(docId);
            else prendasState.selected.delete(docId);
            updateSelectAllCheckbox();
            return;
          }

          const button = event.target.closest(".rowEditBtn");
          if (!button) return;
          if (!isAdminViewEnabled()) return;
          const docId = safeString(button.dataset.editDoc).trim();
          if (!docId) return;
          const rowData = prendasState.filtered.find((row) => safeString(row.docId || row.id).trim() === docId)
            || prendasState.baseRows.find((row) => safeString(row.docId || row.id).trim() === docId);
          const adminData = prendasState.adminMap.get(docId) || {};
          openEditModal(rowData ? { ...rowData, ...adminData } : rowData);
        });
      }

      if (selectAllLabelsCheckbox) {
        selectAllLabelsCheckbox.addEventListener("change", () => {
          const checked = Boolean(selectAllLabelsCheckbox.checked);
          (prendasState.filtered || []).forEach((row) => {
            const docId = safeString(row.docId || row.id).trim();
            if (!docId) return;
            if (checked) prendasState.selected.add(docId);
            else prendasState.selected.delete(docId);
          });
          prendasTbody.querySelectorAll(".row-select").forEach((input) => {
            input.checked = checked;
          });
          updateSelectAllCheckbox();
        });
      }

      if (labelsButton && labelsPanel) {
        labelsButton.addEventListener("click", () => {
          prendasState.labelsPanelOpen = !prendasState.labelsPanelOpen;
          labelsPanel.classList.toggle("hidden", !prendasState.labelsPanelOpen);
          labelsPanel.setAttribute("aria-hidden", prendasState.labelsPanelOpen ? "false" : "true");
        });
      }

      labelsScopeInputs.forEach((input) => {
        input.addEventListener("change", () => {
          if (input.checked) {
            prendasState.labelsScope = input.value;
          }
        });
      });

      if (labelsPrintButton) {
        labelsPrintButton.addEventListener("click", () => {
          openPrintLabels(prendasState.labelsScope || "page");
        });
      }

      if (editPVentaInput) {
        editPVentaInput.addEventListener("input", updateEditPreview);
      }
      if (editCostoInput) {
        editCostoInput.addEventListener("input", updateEditPreview);
      }
      if (editModalCancelButton) {
        editModalCancelButton.addEventListener("click", closeEditModal);
      }
      if (editModalOverlay) {
        editModalOverlay.addEventListener("click", closeEditModal);
      }
      if (editModalSaveButton) {
        editModalSaveButton.addEventListener("click", saveEdit);
      }
      document.addEventListener("keydown", (event) => {
        if (event.key === "Escape" && editModal && !editModal.classList.contains("hidden")) {
          closeEditModal();
        }
      });

window.addEventListener("hashchange", () => {
        handleTabChange(window.location.hash);
      });

      document.querySelectorAll('a.card[href^="#"]').forEach((link) => {
        link.addEventListener("click", (event) => {
          const hash = event.currentTarget.getAttribute("href") || "";
          handleTabChange(hash);
        });
      });
      // ADMIN DB MODE END

      const handleSearchInput = debounce(async () => {
        if (isBooting) return;
        const rawInput = getSearchInput();
        if (!rawInput.trim()) {
          await loadPrendasPage({ reset: true, reason: "search-clear" });
          return;
        }
        if (isFullSku(rawInput)) {
          await runSkuSearch(rawInput);
          return;
        }
        setSkuSearchMode(false);
        await applyFilters();
      }, PRENDAS_SEARCH_DEBOUNCE);

      const handleFilterApply = async () => {
        if (isBooting) return;
        const rawInput = getSearchInput();
        if (rawInput.trim() && isFullSku(rawInput)) {
          await runSkuSearch(rawInput);
          return;
        }
        await applyFilters();
      };

      const handleFilterClear = async () => {
        if (isBooting) return;
        setSkuSearchMode(false);
        clearFiltersUi();
        clearHeaderFilters();
        await loadPrendasPage({ reset: true, reason: "filters-clear" });
      };

      
    // ---- M√°s filtros (panel) ----
    const updateMoreFiltersDot = () => {
      const hasPriceMin = !!(prendasPrecioMin && String(prendasPrecioMin.value || "").trim());
      const hasPriceMax = !!(prendasPrecioMax && String(prendasPrecioMax.value || "").trim());
      const hasNoPrice = !!(prendasPrecioSin && prendasPrecioSin.checked);
      const active = hasPriceMin || hasPriceMax || hasNoPrice;
      if (moreFiltersDot) moreFiltersDot.style.display = active ? "inline-block" : "none";
    };

    const setMoreFiltersOpen = (open) => {
      if (!moreFiltersPanel) return;
      moreFiltersPanel.style.display = open ? "block" : "none";
    };

    if (btnMoreFilters) {
      btnMoreFilters.addEventListener("pointerdown", (e) => {
        e.preventDefault();
        e.stopPropagation();
        const isOpen = moreFiltersPanel && moreFiltersPanel.style.display !== "none";
        setMoreFiltersOpen(!isOpen);
      });
    }

    // Cerrar al dar click fuera
    document.addEventListener("pointerdown", (e) => {
      if (!moreFiltersPanel || moreFiltersPanel.style.display === "none") return;
      const t = e.target;
      if (!(t instanceof HTMLElement)) return;
      if (t.closest("#moreFiltersPanel") || t.closest("#btnMoreFilters")) return;
      setMoreFiltersOpen(false);
    });

    // Actualiza dot cuando cambia algo
    [prendasPrecioMin, prendasPrecioMax].forEach((el) => el && el.addEventListener("input", updateMoreFiltersDot));
    if (prendasPrecioSin) prendasPrecioSin.addEventListener("change", updateMoreFiltersDot);
prendasSearch.addEventListener("input", handleSearchInput);
      headerFilterButtons.forEach((button) => {
        button.addEventListener("pointerdown", (event) => {
          event.stopPropagation();
          const key = button.dataset.openHeaderFilter;
          if (prendasState.headerPopover?.key === key) {
            closeHeaderPopover();
            return;
          }
          renderHeaderFilterPopover(key, button);
        });
      });
      document.addEventListener("pointerdown", (event) => {
        const target = event.target;
        if (prendasState.headerPopover?.container && !prendasState.headerPopover.container.contains(target)) {
          closeHeaderPopover();
        }
      });
      document.addEventListener("keydown", (event) => {
        if (event.key === "Escape") {
          closeHeaderPopover();
        }
      });
      prendasPrecioApply.addEventListener("pointerdown", (event) => { event.preventDefault(); handleFilterApply(); });
      if (prendasFiltersClear) {
        prendasFiltersClear.addEventListener("pointerdown", (event) => { event.preventDefault(); handleFilterClear(); });
      }
      if (prendasYear) {
        prendasYear.addEventListener("change", () => {
          syncDateFilterUi();
        });
      }
      if (prendasPageSize) {
        prendasPageSize.addEventListener("change", async () => {
          if (isBooting) return;
          await loadPrendasPage({ reset: true, reason: "page-size" });
        });
      }
      if (ordenSortBtn) {
        ordenSortBtn.addEventListener("click", async () => {
          const current = normalizeSortConfig(prendasState.sort);
          const nextDir = current.dir === "asc" ? "desc" : "asc";
          await setPrendasSort({ key: "orden", dir: nextDir });
        }, { passive: true });
      }

      [prendasPrecioMin, prendasPrecioMax].forEach((input) => {
        input.addEventListener("keydown", (event) => {
          if (isBooting) return;
          if (event.key === "Enter") {
            event.preventDefault();
            handleFilterApply();
          }
        });
      });

      if (prendasPrev) {
        prendasPrev.addEventListener("pointerdown", async (event) => {
          event.preventDefault();
          if (isBooting) return;
          const prevIndex = Math.max(prendasState.pageIndex - 1, 0);
          await loadPrendasPage({ pageIndex: prevIndex, reason: "pagination-prev" });
        });
      }

      if (prendasNext) {
        prendasNext.addEventListener("pointerdown", async (event) => {
          event.preventDefault();
          if (isBooting) return;
          const nextIndex = prendasState.pageIndex + 1;
          await loadPrendasPage({ pageIndex: nextIndex, reason: "pagination-next" });
        });
      }

      const init = async () => {
        isBooting = true;
        resetPrendasState();
        updateOrdenSortToggleUi();
        resetCounters();
        populateYearFilter();
        populateMonthFilter();
        clearFiltersUi();
        try {
          setRegistroStatus("Cargando diccionario...");
          registroSubmit.disabled = true;
          setSelectLoading(registroProducto, "Cargando...");
          setSelectLoading(registroProveedor, "Cargando...");
          setSelectLoading(registroColor, "Cargando...");
          setSelectLoading(registroTalla, "Cargando...");

          const dictionary = await loadDictionary();
          const dictionaryReady = !dictionary.empty && dictionary.missing.length === 0;
          if (dictionary.empty) {
            setRegistroStatus("Diccionario vac√≠o: corre el workflow Seed Firestore.", "error");
          } else if (dictionary.missing.length) {
            setRegistroStatus(
              `Faltan datos en: ${dictionary.missing.join(", ")}.`,
              "error"
            );
          } else {
            setRegistroStatus("");
          }

          if (dictionary.tipos.length) {
            fillDictionarySelect(
              registroProducto,
              dictionary.tipos.sort((a, b) => a.clave.localeCompare(b.clave))
            );
          } else {
            setSelectLoading(registroProducto, "Sin opciones disponibles");
          }

          if (dictionary.proveedores.length) {
            fillDictionarySelect(
              registroProveedor,
              dictionary.proveedores.sort((a, b) => a.clave.localeCompare(b.clave))
            );
          } else {
            setSelectLoading(registroProveedor, "Sin opciones disponibles");
          }

          if (dictionary.colores.length) {
            fillDictionarySelect(
              registroColor,
              dictionary.colores.sort((a, b) => a.clave.localeCompare(b.clave))
            );
          } else {
            setSelectLoading(registroColor, "Sin opciones disponibles");
          }

          if (dictionary.tallas.length) {
            fillDictionarySelect(
              registroTalla,
              dictionary.tallas.sort((a, b) => a.clave.localeCompare(b.clave))
            );
          } else {
            setSelectLoading(registroTalla, "Sin opciones disponibles");
          }

          registroSubmit.disabled = !dictionaryReady;
        } catch (error) {
          setRegistroStatus("No pudimos cargar el diccionario.", "error");
          registroSubmit.disabled = true;
          console.error(error);
        } finally {
          // ADMIN DB MODE START
          setAdminPanelVisible(false);
          applyAdminUI();
          handleTabChange(window.location.hash);
          // ADMIN DB MODE END
          setSkuSearchMode(false);

          setPrendasCollections({
            publicCollection: PRENDAS_PUBLIC_COLLECTION
          });

          try {
            const baseSnapshot = await getDocs(query(prendasPublicRef, limit(10)));
            console.log("[Prendas] Base query (sin filtros) docs", {
              collection: activePrendasPublicCollection,
              docs: baseSnapshot.size
            });
            console.log("[Prendas] snapshot size:", baseSnapshot.size);
            if (baseSnapshot.empty) {
              setPrendasAlert("A√∫n no se ha migrado la colecci√≥n public. Entra a Admin y corre ‚ÄòMigrar a public/admin‚Äô.");
            }
          } catch (error) {
            console.error("[Prendas] ‚ùå No se pudo leer la colecci√≥n p√∫blica", error);
            setPrendasAlert("No se encontr√≥ la colecci√≥n p√∫blica o las reglas de Firestore la est√°n bloqueando.");
            return;
          }
          try {
            if (typeof loadMetadataCounts === "function") {
              const total = await loadMetadataCounts();
              if (Number.isFinite(total) && !hasActiveFilters(getCurrentFilters())) {
                prendasState.showingTotal = total;
                setCounter(prendasState.filtered.length, total);
              }
            } else {
              console.warn("loadMetadataCounts() no existe, se omite.");
            }
          } catch (error) {
            console.warn("[Prendas] loadMetadataCounts fall√≥", error);
          }
          try {
            console.log("query filters", getCurrentFilters());
            console.log("baseRows", prendasState.baseRows?.length ?? 0, "filtered", prendasState.filtered?.length ?? 0);
            await loadPrendasPage({ reset: true, reason: "init" });
            console.log("baseRows", prendasState.baseRows?.length ?? 0, "filtered", prendasState.filtered?.length ?? 0);
          } finally {
            prendasState.isLoadingInitial = false;
            setLoading(false);
            isBooting = false;
          }
        }
      };

      init();
    </script>
  </body>
</html>
