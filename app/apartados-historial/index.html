<!doctype html>
<html lang="es"><head><meta charset="utf-8"><meta name="viewport" content="width=device-width, initial-scale=1">
<title>Historial de Apartados - HarujaGDL</title>
<link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700;800&display=swap" rel="stylesheet">
<style>:root{--bg:#f7f7f8;--card:#fff;--text:#111827;--muted:#6b7280;--line:#e5e7eb;--brand:#5FA18E}*{box-sizing:border-box}body{margin:0;background:var(--bg);color:var(--text);font-family:Inter,system-ui,sans-serif}.container{max-width:1080px;margin:24px auto;padding:0 16px}.header{display:flex;align-items:center;justify-content:space-between}.title{font-size:28px;font-weight:800}.brand img{height:22px}.top-actions{display:flex;gap:10px;justify-content:flex-end;margin:10px 0 14px}.btn-ghost,.btn{appearance:none;border:1px solid var(--line);background:#fff;color:#111827;border-radius:12px;padding:10px 12px;font-weight:800;cursor:pointer;text-decoration:none}.btn{background:var(--brand);color:#fff;border:none}.card{background:#fff;border:1px solid var(--line);border-radius:14px;overflow:hidden}.card-bd{padding:14px}.tools{display:grid;grid-template-columns:1fr;gap:10px;margin-bottom:14px}.inpt,select{width:100%;border:1px solid var(--line);border-radius:10px;padding:12px;font-size:14px}table{width:100%;border-collapse:collapse}th,td{padding:10px;border-bottom:1px solid var(--line);text-align:left;font-size:13px}th{background:#fafafa}.actions{display:flex;gap:6px;flex-wrap:wrap}.mini{border:1px solid var(--line);background:#fff;border-radius:8px;padding:6px 8px;font-size:12px;cursor:pointer}.muted{color:var(--muted);font-size:13px}.cards{display:grid;gap:10px}.item{border:1px solid var(--line);border-radius:12px;background:#fff;padding:12px}.row{display:flex;justify-content:space-between;gap:8px;font-size:13px;margin:4px 0}@media (min-width:860px){.tools{grid-template-columns:2fr 1fr auto}.mobile-only{display:none}}@media (max-width:859px){.desktop-only{display:none}}</style>
</head><body><div class="container"><div class="header"><div class="title">Historial de Apartados</div><div class="brand"><img src="https://i.postimg.cc/nMphkZcC/haruja-logo.png" alt="harujagdl"></div></div><div class="top-actions"><button class="btn-ghost" onclick="window.location.href='/apartados'">← Volver</button><a class="btn-ghost" href="/">Panel</a><a class="btn-ghost" href="/apartados">Registrar apartado</a></div><div class="card"><div class="card-bd"><div class="tools"><input id="q" class="inpt" type="text" placeholder="Buscar folio o cliente…"><select id="status"><option value="">Todos</option><option value="activo">Activo</option><option value="liquidado">Liquidado</option></select><button class="btn" onclick="onSearch()">Buscar</button></div><div id="msg" class="muted"></div><div class="desktop-only"><table><thead><tr><th>Folio</th><th>Fecha</th><th>Cliente</th><th>Anticipo</th><th>Total</th><th>Acciones</th></tr></thead><tbody id="tbody"></tbody></table></div><div id="cards" class="cards mobile-only"></div><div style="margin-top:12px"><button id="more" class="btn-ghost" onclick="loadNextPage()" style="display:none">Cargar más</button></div></div></div></div>
<script>
const $=(id)=>document.getElementById(id);let nextCursor=null;let searching=false;const fmtMX=(n)=>(Number(n)||0).toLocaleString('es-MX',{style:'currency',currency:'MXN'});const fmtDate=(v)=>v?new Date(v).toLocaleString('es-MX'):'';
async function apiFetch(path,opts={}){const res=await fetch(path,{method:opts.method||'GET',headers:{'Content-Type':'application/json',...(opts.headers||{})},body:opts.body||undefined});const data=await res.json().catch(()=>({}));if(!res.ok||data?.ok===false)throw new Error(data?.error||`HTTP ${res.status}`);return data;}
function actionButtons(item){const open=item.pdfUrl?`<button class="mini" onclick="openPdf('${item.pdfUrl}')">Abrir PDF</button>`:'';const copy=item.pdfUrl?`<button class="mini" onclick="copyLink('${item.pdfUrl}')">Copiar link</button>`:'';const abonar=`<button class="mini" onclick="goAbono('${item.folio}')">Abonar</button>`;return `${open}${copy}${abonar}`;}
function render(items,append=false){const tbody=$('tbody');const cards=$('cards');if(!append){tbody.innerHTML='';cards.innerHTML='';}for(const item of items){const tr=document.createElement('tr');tr.innerHTML=`<td>${item.folio||''}</td><td>${item.fecha||fmtDate(item.createdAt)}</td><td>${item.cliente||''}</td><td>${fmtMX(item.anticipo)}</td><td>${fmtMX(item.total)}</td><td>${actionButtons(item)}</td>`;tbody.appendChild(tr);const card=document.createElement('div');card.className='item';card.innerHTML=`<div class="row"><b>${item.folio||''}</b><span>${item.fecha||fmtDate(item.createdAt)}</span></div><div class="row"><span>Cliente</span><span>${item.cliente||''}</span></div><div class="row"><span>Anticipo</span><span>${fmtMX(item.anticipo)}</span></div><div class="row"><span>Total</span><span>${fmtMX(item.total)}</span></div><div class="actions">${actionButtons(item)}</div>`;cards.appendChild(card);}}
function openPdf(url){window.open(url,'_blank','noopener');}async function copyLink(url){try{await navigator.clipboard.writeText(url);$('msg').textContent='Link copiado.';}catch(_){$('msg').textContent='No se pudo copiar.';}}function goAbono(folio){window.location.href=`/apartados?folio=${encodeURIComponent(folio)}&abono=1`;}
async function loadFirstPage(){searching=false;const data=await apiFetch('/api/apartados/list?limit=50');render(data.items||[]);nextCursor=data.nextCursor||null;$('more').style.display=nextCursor?'inline-block':'none';$('msg').textContent=(data.items||[]).length?'':'Sin resultados';}
async function loadNextPage(){if(!nextCursor||searching)return;const data=await apiFetch(`/api/apartados/list?limit=50&cursor=${encodeURIComponent(nextCursor)}`);render(data.items||[],true);nextCursor=data.nextCursor||null;$('more').style.display=nextCursor?'inline-block':'none';}
async function onSearch(){const q=$('q').value.trim().toUpperCase();if(!q)return loadFirstPage();searching=true;$('more').style.display='none';if(q.startsWith('HARUJA')){try{const data=await apiFetch(`/api/apartados/get?folio=${encodeURIComponent(q)}`);render(data.item?[data.item]:[]);$('msg').textContent=data.item?'':'No encontrado';}catch(err){render([]);$('msg').textContent=err.message||'No encontrado';}return;}const data=await apiFetch(`/api/apartados/list?limit=50&q=${encodeURIComponent(q)}`);render(data.items||[]);$('msg').textContent=(data.items||[]).length?'':'Sin resultados';}
loadFirstPage().catch((e)=>{$('msg').textContent=`Error: ${e.message}`;});
</script></body></html>
